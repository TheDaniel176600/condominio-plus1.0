<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Multi Condomínios</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #5dade2;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            display: flex;
            min-height: 100vh;
        }
        /* Estilos para os novos módulos */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-agendado {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .status-em-uso {
            background-color: #fff3e0;
            color: #f57c00;
        }
        .status-concluido {
            background-color: #e8f5e8;
            color: #388e3c;
        }
        .status-cancelado {
            background-color: #ffebee;
            color: #d32f2f;
        }
        /* Letreiro de Lembretes */
        .ticker-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #000000;
            color: white;
            padding: 8px 0;
            z-index: 2000;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .ticker-content {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
            animation: ticker 60s linear infinite;
        }
        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        .ticker-item {
            display: inline-block;
            margin-right: 40px;
            font-size: 14px;
        }
        .ticker-item i {
            margin-right: 5px;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--primary-color);
            color: white;
            transition: all 0.3s;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 3000;
        }
        .sidebar-header {
            padding: 20px;
            background-color: var(--dark-color);
            text-align: center;
            position: relative;
            border-bottom: 2px solid var(--secondary-color);
        }
        .connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #e74c3c;
        }
        .connection-status.connected {
            background-color: #2ecc71;
        }
        .sidebar-menu {
            padding: 0;
            list-style: none;
        }
        .sidebar-menu li {
            position: relative;
        }
        .sidebar-menu a {
            display: block;
            padding: 15px 20px;
            color: var(--light-color);
            text-decoration: none;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s;
        }
        .sidebar-menu a:hover {
            background-color: var(--dark-color);
            padding-left: 25px;
        }
        .sidebar-menu a.active {
            background-color: var(--secondary-color);
        }
        .sidebar-menu a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            transition: all 0.3s;
            margin-top: 40px;
        }
        .top-navbar {
            background-color: white;
            padding: 15px 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .toggle-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--dark-color);
        }
        .user-info {
            display: flex;
            align-items: center;
        }
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .content {
            padding: 30px;
        }
        .card {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .card-header {
            padding: 15px 20px;
            background-color: var(--light-color);
            border-bottom: 1px solid #eee;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body {
            padding: 20px;
        }
        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--primary-color);
        }
        .login-box {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 400px;
            padding: 30px;
            position: relative;
        }
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: #3498db;
        }
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        .btn-danger {
            background-color: var(--accent-color);
            color: white;
        }
        .btn-info {
            background-color: var(--info-color);
            color: white;
        }
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        .btn-sm {
            padding: 5px 10px;
            font-size: 14px;
        }
        /* Table Styles */
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .table th {
            background-color: var(--light-color);
            font-weight: 600;
        }
        .table tr:hover {
            background-color: #f9f9f9;
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 4000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 5px;
            width: 600px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-footer {
            margin-top: 20px;
            text-align: right;
        }
        /* Checkbox Grid */
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .permission-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .permission-item input {
            margin-right: 8px;
        }
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                text-align: center;
            }
            .sidebar-header h3, .sidebar-menu a span {
                display: none;
            }
            .sidebar-menu a i {
                margin-right: 0;
                font-size: 20px;
            }
            .main-content {
                margin-left: 70px;
            }
            .ticker-container {
                font-size: 12px;
            }
        }
        /* Module-specific styles */
        .module-content {
            display: none;
        }
        .module-content.active {
            display: block;
        }
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            flex: 1;
            min-width: 200px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-card h3 {
            font-size: 14px;
            color: #777;
            margin-bottom: 10px;
        }
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .password-strength {
            height: 5px;
            margin-top: 5px;
            border-radius: 2px;
            transition: all 0.3s;
        }
        .strength-weak { background-color: #e74c3c; width: 25%; }
        .strength-fair { background-color: #f39c12; width: 50%; }
        .strength-good { background-color: #3498db; width: 75%; }
        .strength-strong { background-color: #2ecc71; width: 100%; }
        .login-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 14px;
            border-left: 4px solid var(--secondary-color);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .condominio-badge {
            background: var(--secondary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
        .alert {
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .alert-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .alert-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success {
            background-color: var(--success-color);
            color: white;
        }
        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }
        .badge-danger {
            background-color: var(--accent-color);
            color: white;
        }
        .badge-info {
            background-color: var(--secondary-color);
            color: white;
        }
        /* Calendário */
        .calendar-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .calendar-title {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 0 20px;
        }
        .calendar-view-options {
            display: flex;
            gap: 5px;
        }
        .calendar-view-options .btn {
            padding: 8px 15px;
            font-size: 14px;
            background: #f8f9fa;
            border: 1px solid #ddd;
        }
        .calendar-view-options .btn.active {
            background: var(--secondary-color);
            color: white;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e0e0e0;
            border: 1px solid #e0e0e0;
        }
        .calendar-day-header {
            background-color: #f8f9fa;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #e0e0e0;
            font-size: 14px;
        }
        .calendar-day {
            background-color: white;
            padding: 10px 8px;
            min-height: 120px;
            border: 1px solid #e0e0e0;
            position: relative;
            font-size: 14px;
            cursor: pointer;
        }
        .calendar-day.other-month {
            background-color: #f8f9fa;
            color: #999;
        }
        .calendar-day.today {
            background-color: #e3f2fd;
        }
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 16px;
            color: #333;
        }
        .event-item {
            background-color: #e74c3c;
            color: white;
            padding: 2px 6px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 11px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            border-left: 3px solid #c0392b;
            cursor: pointer;
        }
        .event-item.salao-social {
            background-color: #3498db;
            border-left-color: #2980b9;
        }
        .event-item.churrasqueira {
            background-color: #e74c3c;
            border-left-color: #c0392b;
        }
        .event-item.quiosque {
            background-color: #2ecc71;
            border-left-color: #27ae60;
        }
        .event-item.pergolado {
            background-color: #9b59b6;
            border-left-color: #8e44ad;
        }
        /* Espaços para agendamento */
        .espacos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .espaco-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid var(--secondary-color);
            cursor: pointer;
            transition: all 0.3s;
        }
        .espaco-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .espaco-card.selected {
            border-left-color: var(--success-color);
            background-color: #f8fff9;
        }
        .espaco-card h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 16px;
        }
        .espaco-card p {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        /* Relatórios */
        .report-filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .report-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .report-preview {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-height: 500px;
            overflow-y: auto;
        }
        .report-line {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-family: 'Courier New', monospace;
        }
        .char-counter {
            font-size: 0.8em;
            color: #666;
            text-align: right;
            margin-top: 5px;
        }
        .terms-box {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
        }
        .calendar-legends {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        /* Menu lateral específico */
        .menu-agendamentos {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .menu-agendamentos h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 18px;
        }
        .menu-agendamentos select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 14px;
        }
        /* Layout fiel à imagem */
        .agendamentos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        .agendamentos-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
        .calendar-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .calendar-controls .btn {
            padding: 8px 15px;
            font-size: 14px;
        }
        .current-space {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary-color);
        }
        .current-space h4 {
            margin: 0;
            color: var(--primary-color);
            font-size: 16px;
        }
        /* Modal de ações para agendamento */
        .agendamento-actions-modal {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            padding: 10px;
            min-width: 150px;
        }
        .agendamento-actions-modal button {
            display: block;
            width: 100%;
            margin-bottom: 5px;
            text-align: left;
            padding: 8px 12px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 3px;
        }
        .agendamento-actions-modal button:hover {
            background: #f5f5f5;
        }
        .password-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        /* Novos estilos para Contas a Pagar e Lembretes */
        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .alert-success {
            background-color: #d1edff;
            border: 1px solid #b3d9ff;
            color: #004085;
        }
        .reminder-item, .conta-item {
            padding: 12px 15px;
            border-left: 4px solid var(--secondary-color);
            background: white;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .reminder-item.urgent, .conta-item.urgent {
            border-left-color: var(--accent-color);
            background-color: #fff5f5;
        }
        .reminder-item.warning, .conta-item.warning {
            border-left-color: var(--warning-color);
            background-color: #fffbf0;
        }
        .reminder-header, .conta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .reminder-title, .conta-title {
            font-weight: 600;
            color: var(--primary-color);
        }
        .reminder-date, .conta-date {
            font-size: 12px;
            color: #666;
        }
        .reminder-actions, .conta-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-agendado { background-color: #3498db; color: white; }
        .status-em-uso { background-color: #f39c12; color: white; }
        .status-liberado { background-color: #2ecc71; color: white; }
        .status-cancelado { background-color: #e74c3c; color: white; }
        .status-pendente { background-color: #95a5a6; color: white; }
        .status-pago { background-color: #2ecc71; color: white; }
        .status-atrasado { background-color: #e74c3c; color: white; }
        .dashboard-alerts {
            margin-bottom: 20px;
        }
        /* Indicador de conexão na tela de login */
        .login-connection-status {
            display: flex;
            align-items: center;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
        }
        .condominio-badge {
            background: var(--secondary-color);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
        }
        .login-connection-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #e74c3c;
            margin-right: 8px;
        }
        .login-connection-dot.connected {
            background-color: #2ecc71;
        }
        .online-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: #2ecc71;
            font-weight: 600;
            margin-left: 12px;
            cursor: pointer;
        }
        .online-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #2ecc71;
            box-shadow: 0 0 6px #2ecc71;
            animation: pulse 2s infinite;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Letreiro de Lembretes -->
    <div id="tickerContainer" class="ticker-container" style="display: none;">
        <div class="ticker-content" id="tickerContent">
            <!-- Conteúdo do letreiro será carregado aqui -->
        </div>
    </div>
    <!-- Página de Login -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h2>Sistema Multi Condomínios</h2>
                <p id="loginStatus">Digite suas credenciais para acessar</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <input type="text" class="form-control" id="username" placeholder="Usuário" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-control" id="password" placeholder="Senha" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="loginBtn">
                    <span id="loginBtnText">Entrar</span>
                    <div class="loading" id="loginLoading" style="display: none;"></div>
                </button>
            </form>
            <div class="login-connection-status">
                <div class="login-connection-dot" id="loginConnectionDot"></div>
                <span id="loginConnectionText">Verificando conexão com o banco de dados...</span>
            </div>
        </div>
    </div>
    <!-- Sistema Principal -->
    <div id="mainSystem" class="container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Multi Condomínios</h3>
                <div id="connectionStatus" class="connection-status" title="Desconectado"></div>
            </div>
            <ul class="sidebar-menu" id="moduleMenu">
                <!-- Os módulos serão carregados dinamicamente aqui -->
            </ul>
        </div>
        <!-- Main Content -->
        <div class="main-content">
            <div class="top-navbar">
                <button class="toggle-btn" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="user-info">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=3498db&color=fff" alt="Usuário" id="userAvatar">
                    <span id="userName">Administrador</span>
                    <!-- SELETOR DE CONDOMÍNIO E BADGE -->
                    <div class="condominio-selector-top" style="margin-left: 15px; display: flex; align-items: center;">
                        <select id="condominioSelectTop" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd;">
                            <option value="">Selecione um condomínio</option>
                        </select>
                        <span id="currentCondominioBadge" class="condominio-badge" style="margin-left: 10px;">
                            Nenhum condomínio selecionado
                        </span>
                    </div>
                    <div class="online-indicator" onclick="showOnlineUsers()">
                        <div class="online-dot"></div>
                        <span id="onlineCount">0</span> online
                    </div>
                    <button class="btn" id="logoutBtn" style="margin-left: 15px;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            <div class="content">
                <div id="moduleContent">
                    <!-- Conteúdo dos módulos será carregado aqui -->
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para Troca de Senha -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Trocar Senha</h3>
                <p>É sua primeira vez aqui! Por favor, defina uma nova senha.</p>
            </div>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label>Nova Senha</label>
                    <input type="password" class="form-control" id="newPassword" required minlength="6">
                    <div id="passwordStrength" class="password-strength"></div>
                </div>
                <div class="form-group">
                    <label>Confirmar Nova Senha</label>
                    <input type="password" class="form-control" id="confirmPassword" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Nova Senha</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para Cadastro de Usuários -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Cadastrar Usuário</h3>
                <button type="button" onclick="closeUserModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="userForm">
                <input type="hidden" id="editingUserId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome Completo *</label>
                        <input type="text" class="form-control" id="userNome" required>
                    </div>
                    <div class="form-group">
                        <label>Usuário *</label>
                        <input type="text" class="form-control" id="userUsuario" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>E-mail</label>
                        <input type="email" class="form-control" id="userEmail">
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="text" class="form-control" id="userTelefone">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Senha <span id="senhaObrigatoria">*</span></label>
                        <input type="password" class="form-control" id="userSenha">
                        <div class="password-info" id="senhaInfo">Deixe em branco para manter a senha atual</div>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Usuário *</label>
                        <select class="form-control" id="userTipo" required>
                            <option value="">Selecione...</option>
                            <option value="sindico">Síndico</option>
                            <option value="subsindico">Subsíndico</option>
                            <option value="zelador">Zelador</option>
                            <option value="portaria">Portaria</option>
                            <option value="prestador">Prestador de Serviço</option>
                            <option value="morador">Morador</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Condomínios Permitidos</label>
                    <div id="condominiosPermitidos" class="permissions-grid">
                        <!-- Condomínios serão carregados aqui -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Módulos Permitidos</label>
                    <div id="permissoesUsuario" class="permissions-grid">
                        <!-- Permissões serão carregadas aqui -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Usuário</button>
                    <button type="button" class="btn" onclick="closeUserModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para Cadastro de Condomínios -->
    <div id="condominioModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="condominioModalTitle">Cadastrar Condomínio</h3>
                <button type="button" onclick="closeCondominioModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="condominioForm">
                <input type="hidden" id="editingCondominioId">
                <div class="form-group">
                    <label>Nome do Condomínio *</label>
                    <input type="text" class="form-control" id="condominioNome" required>
                </div>
                <div class="form-group">
                    <label>Endereço *</label>
                    <input type="text" class="form-control" id="condominioEndereco" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cidade *</label>
                        <input type="text" class="form-control" id="condominioCidade" required>
                    </div>
                    <div class="form-group">
                        <label>Estado *</label>
                        <input type="text" class="form-control" id="condominioEstado" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>CEP</label>
                    <input type="text" class="form-control" id="condominioCEP">
                </div>
                <div class="form-group">
                    <label>Telefone</label>
                    <input type="text" class="form-control" id="condominioTelefone">
                </div>
                <div class="form-group">
                    <label>CNPJ</label>
                    <input type="text" class="form-control" id="condominioCNPJ">
                </div>
                <div class="form-group">
                    <label>Quantidade de Unidades</label>
                    <input type="number" class="form-control" id="condominioUnidades" min="1">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="condominioStatus">
                        <option value="ativo">Ativo</option>
                        <option value="inativo">Inativo</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Condomínio</button>
                    <button type="button" class="btn" onclick="closeCondominioModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para Agendamentos -->
    <div id="agendamentoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="agendamentoModalTitle">Novo Agendamento</h3>
                <button type="button" onclick="closeAgendamentoModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="agendamentoForm">
                <input type="hidden" id="editingAgendamentoId">
                <input type="hidden" id="agendamentoData">
                <div class="form-group">
                    <label>Espaço *</label>
                    <select class="form-control" id="agendamentoEspaco" required>
                        <option value="">Selecione o espaço...</option>
                        <option value="salao-social">1. Salão Social</option>
                        <option value="churrasqueira">2. Churrasqueira Área Gourmet</option>
                        <option value="quiosque">3. Quiosque</option>
                        <option value="pergolado">4. Pergolado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data *</label>
                    <input type="date" class="form-control" id="agendamentoDataInput" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Horário de Início *</label>
                        <input type="time" class="form-control" id="agendamentoHoraInicio" required>
                    </div>
                    <div class="form-group">
                        <label>Horário de Término *</label>
                        <input type="time" class="form-control" id="agendamentoHoraFim" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Morador/Responsável *</label>
                    <input type="text" class="form-control" id="agendamentoResponsavel" required>
                </div>
                <div class="form-group">
                    <label>Unidade/Apartamento *</label>
                    <input type="text" class="form-control" id="agendamentoUnidade" required>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="agendamentoStatus">
                        <option value="agendado">Agendado</option>
                        <option value="em-uso">Em Uso</option>
                        <option value="liberado">Liberado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observações</label>
                    <textarea class="form-control" id="agendamentoObservacoes" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Agendamento</button>
                    <button type="button" class="btn" onclick="closeAgendamentoModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para Contas a Pagar -->
    <div id="contaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="contaModalTitle">Nova Conta a Pagar</h3>
                <button type="button" onclick="closeContaModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="contaForm">
                <input type="hidden" id="editingContaId">
                <div class="form-group">
                    <label>Descrição *</label>
                    <input type="text" class="form-control" id="contaDescricao" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Valor *</label>
                        <input type="number" class="form-control" id="contaValor" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Vencimento *</label>
                        <input type="date" class="form-control" id="contaVencimento" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select class="form-control" id="contaCategoria">
                        <option value="manutencao">Manutenção</option>
                        <option value="limpeza">Limpeza</option>
                        <option value="seguranca">Segurança</option>
                        <option value="administrativo">Administrativo</option>
                        <option value="energia">Energia</option>
                        <option value="agua">Água</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fornecedor</label>
                    <input type="text" class="form-control" id="contaFornecedor">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="contaStatus">
                        <option value="pendente">Pendente</option>
                        <option value="pago">Pago</option>
                        <option value="atrasado">Atrasado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observações</label>
                    <textarea class="form-control" id="contaObservacoes" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Conta</button>
                    <button type="button" class="btn" onclick="closeContaModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para Lembretes -->
    <div id="lembreteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="lembreteModalTitle">Novo Lembrete</h3>
                <button type="button" onclick="closeLembreteModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="lembreteForm">
                <input type="hidden" id="editingLembreteId">
                <div class="form-group">
                    <label>Título *</label>
                    <input type="text" class="form-control" id="lembreteTitulo" required>
                </div>
                <div class="form-group">
                    <label>Descrição</label>
                    <textarea class="form-control" id="lembreteDescricao" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data de Início *</label>
                        <input type="date" class="form-control" id="lembreteDataInicio" required>
                    </div>
                    <div class="form-group">
                        <label>Data de Fim</label>
                        <input type="date" class="form-control" id="lembreteDataFim">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Prioridade</label>
                        <select class="form-control" id="lembretePrioridade">
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Lembrete</button>
                    <button type="button" class="btn" onclick="closeLembreteModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para Cadastro de Moradores -->
    <div id="moradorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="moradorModalTitle">Cadastrar Morador</h3>
                <button type="button" onclick="closeMoradorModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="moradorForm">
                <input type="hidden" id="editingMoradorId">
                <div class="form-group">
                    <label>Morador *</label>
                    <input type="text" class="form-control" id="moradorNome" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Apartamento *</label>
                        <input type="text" class="form-control" id="moradorApto" required>
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="text" class="form-control" id="moradorTelefone">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Garagem</label>
                        <select class="form-control" id="moradorGaragem">
                            <option value="">Selecione...</option>
                            <option value="G1">G1</option>
                            <option value="G2">G2</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vaga</label>
                        <input type="text" class="form-control" id="moradorVaga">
                    </div>
                </div>
                <div class="form-group">
                    <label>Observações</label>
                    <textarea class="form-control" id="moradorObservacoes" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Morador</button>
                    <button type="button" class="btn" onclick="closeMoradorModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para Horas Extras -->
    <div id="horaExtraModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="horaExtraModalTitle">Nova Hora Extra</h3>
                <button type="button" onclick="closeHoraExtraModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="horaExtraForm">
                <input type="hidden" id="editingHoraExtraId">
                <div class="form-group">
                    <label>Funcionário *</label>
                    <input type="text" class="form-control" id="horaExtraFuncionario" required>
                </div>
                <div class="form-group">
                    <label>Matrícula *</label>
                    <input type="text" class="form-control" id="horaExtraMatricula" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data *</label>
                        <input type="date" class="form-control" id="horaExtraData" required>
                    </div>
                    <div class="form-group">
                        <label>Quantidade (horas) *</label>
                        <input type="number" class="form-control" id="horaExtraQuantidade" step="0.5" min="0.5" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Hora Extra</button>
                    <button type="button" class="btn" onclick="closeHoraExtraModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para Limpeza -->
    <div id="limpezaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="limpezaModalTitle">Registro de Limpeza</h3>
                <button type="button" onclick="closeLimpezaModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="limpezaForm">
                <input type="hidden" id="editingLimpezaId">
                <div class="form-group">
                    <label>Responsável pela Limpeza *</label>
                    <input type="text" class="form-control" id="limpezaResponsavel" required>
                </div>
                <div class="form-group">
                    <label>Espaço Limpo *</label>
                    <select class="form-control" id="limpezaEspaco" required>
                        <option value="">Selecione o espaço...</option>
                        <option value="salao-social">Salão Social</option>
                        <option value="churrasqueira">Churrasqueira</option>
                        <option value="quiosque">Quiosque</option>
                        <option value="pergolado">Pergolado</option>
                        <option value="sauna">Sauna</option>
                        <option value="area-comum">Área Comum</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data *</label>
                        <input type="date" class="form-control" id="limpezaData" required>
                    </div>
                    <div class="form-group">
                        <label>Hora Início *</label>
                        <input type="time" class="form-control" id="limpezaHoraInicio" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Hora Fim</label>
                        <input type="time" class="form-control" id="limpezaHoraFim">
                    </div>
                    <div class="form-group">
                        <label>Tempo de Uso (minutos)</label>
                        <input type="number" class="form-control" id="limpezaTempoUso" min="0" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>Observações</label>
                    <textarea class="form-control" id="limpezaObservacoes" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="limpezaStatus">
                        <option value="em-andamento">Em Andamento</option>
                        <option value="concluido">Concluído</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" class="btn btn-success" id="btnConcluirLimpeza" onclick="concluirLimpeza()" style="display: none;">Concluir Limpeza</button>
                    <button type="button" class="btn" onclick="closeLimpezaModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para Sauna -->
    <div id="saunaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="saunaModalTitle">Agendamento de Sauna</h3>
                <button type="button" onclick="closeSaunaModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="saunaForm">
                <input type="hidden" id="editingSaunaId">
                <div class="form-group">
                    <label>Morador *</label>
                    <input type="text" class="form-control" id="saunaMorador" required>
                </div>
                <div class="form-group">
                    <label>Apartamento *</label>
                    <input type="text" class="form-control" id="saunaApto" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data *</label>
                        <input type="date" class="form-control" id="saunaData" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Sauna *</label>
                        <select class="form-control" id="saunaTipo" required>
                            <option value="umida">Sauna Úmida</option>
                            <option value="seca">Sauna Seca</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Hora Início *</label>
                        <input type="time" class="form-control" id="saunaHoraInicio" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Hora Fim</label>
                        <input type="time" class="form-control" id="saunaHoraFim">
                    </div>
                    <div class="form-group">
                        <label>Tempo de Uso (minutos)</label>
                        <input type="number" class="form-control" id="saunaTempoUso" min="0" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="saunaStatus">
                        <option value="agendado">Agendado</option>
                        <option value="em-uso">Em Uso</option>
                        <option value="concluido">Concluído</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observações</label>
                    <textarea class="form-control" id="saunaObservacoes" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" class="btn btn-success" id="btnConcluirSauna" onclick="concluirSauna()" style="display: none;">Concluir Uso</button>
                    <button type="button" class="btn" onclick="closeSaunaModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAhx_I1Wg0RncK_XTTOVjKrRkeD8-wDoMw",
            authDomain: "condominio-amaranthus.firebaseapp.com",
            projectId: "condominio-amaranthus",
            storageBucket: "condominio-amaranthus.firebasestorage.app",
            messagingSenderId: "233912918531",
            appId: "1:233912918531:web:6850381663623ef1282436"
        };
        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // Módulos do sistema
        const modules = [
            { id: 'dashboard', name: 'Dashboard', icon: 'fas fa-tachometer-alt', default: true },
            { id: 'condominios', name: 'Condomínios', icon: 'fas fa-building' },
            { id: 'usuarios', name: 'Usuários', icon: 'fas fa-users' },
            { id: 'horas-extras', name: 'Horas Extras', icon: 'fas fa-clock' },
            { id: 'moradores', name: 'Moradores', icon: 'fas fa-user-friends' },
            { id: 'agendamentos', name: 'Agendamentos', icon: 'fas fa-calendar-alt' },
            { id: 'limpeza', name: 'Limpeza', icon: 'fas fa-broom' },
            { id: 'sauna', name: 'Sauna', icon: 'fas fa-hot-tub' },
            { id: 'contas', name: 'Contas a Pagar', icon: 'fas fa-file-invoice-dollar' },
            { id: 'lembretes', name: 'Lembretes', icon: 'fas fa-bell' },
            { id: 'relatorios', name: 'Relatórios', icon: 'fas fa-chart-bar' },
            { id: 'ocorrencias', name: 'Ocorrências', icon: 'fas fa-exclamation-triangle' },
            { id: 'prestadores', name: 'Prestador de Serviços', icon: 'fas fa-briefcase' },
        ];
        // Estado da aplicação
        let currentUser = null;
        let currentCondominio = null;
        let condominios = [];
        let usuarios = [];
        let horasExtras = [];
        let moradores = [];
        let agendamentos = [];
        let limpezas = [];
        let saunas = [];
        let contas = [];
        let lembretes = [];
        let currentModule = 'dashboard';
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();
        let isFirebaseConnected = false;
        let presenceRef = null;

        // ✅ Nova função: verifica se o usuário pode excluir
        function podeExcluirRegistros() {
            return currentUser && (currentUser.tipo === 'sindico' || currentUser.tipo === 'subsindico');
        }

        // Inicializar a aplicação
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        // Função para inicializar a aplicação
        async function initializeApp() {
            try {
                checkFirebaseConnection();
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    const userDoc = await db.collection('usuarios').doc(currentUser.id).get();
                    if (userDoc.exists) {
                        await loadSystemData();
                        showMainSystem();
                        setupPresence();
                        setupRealtimeListeners();
                        setInterval(updateOnlineCount, 10000);
                        return;
                    }
                }
                showLoginPage();
            } catch (error) {
                console.error('Erro ao inicializar aplicação:', error);
                showLoginPage();
            }
        }
        // Verificar conexão com Firebase
        function checkFirebaseConnection() {
            const connectionDot = document.getElementById('loginConnectionDot');
            const connectionText = document.getElementById('loginConnectionText');
            setTimeout(() => {
                db.collection('test').limit(1).get()
                    .then(() => {
                        isFirebaseConnected = true;
                        connectionDot.classList.add('connected');
                        connectionText.textContent = 'Conectado ao banco de dados';
                    })
                    .catch((error) => {
                        isFirebaseConnected = false;
                        connectionDot.classList.remove('connected');
                        connectionText.textContent = 'Erro na conexão com o banco de dados';
                        console.error('Erro de conexão com Firebase:', error);
                    });
            }, 1000);
        }
        // Mostrar página de login
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainSystem').style.display = 'none';
            document.getElementById('tickerContainer').style.display = 'none';
            document.getElementById('loginStatus').textContent = 'Digite suas credenciais para acessar';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }
        // Mostrar sistema principal
        function showMainSystem() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'flex';
            document.getElementById('tickerContainer').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.nome || currentUser.usuario;
            document.getElementById('currentCondominioBadge').textContent = currentCondominio ? currentCondominio.nome : 'Nenhum condomínio selecionado';
            loadModuleMenu();
            loadModuleContent(currentModule);
            loadTickerContent();
        }
        // ========== FUNÇÕES DE HORAS EXTRAS ==========
        function openHoraExtraModal() {
            document.getElementById('horaExtraModalTitle').textContent = 'Nova Hora Extra';
            document.getElementById('editingHoraExtraId').value = '';
            document.getElementById('horaExtraForm').reset();
            document.getElementById('horaExtraData').value = getCurrentDate();
            document.getElementById('horaExtraModal').style.display = 'flex';
        }
        function closeHoraExtraModal() {
            document.getElementById('horaExtraModal').style.display = 'none';
        }
        function editHoraExtra(id) {
            const horaExtra = horasExtras.find(h => h.id === id);
            if (!horaExtra) return;
            document.getElementById('horaExtraModalTitle').textContent = 'Editar Hora Extra';
            document.getElementById('editingHoraExtraId').value = horaExtra.id;
            document.getElementById('horaExtraFuncionario').value = horaExtra.funcionario;
            document.getElementById('horaExtraMatricula').value = horaExtra.matricula;
            document.getElementById('horaExtraData').value = horaExtra.data;
            document.getElementById('horaExtraQuantidade').value = horaExtra.quantidade;
            document.getElementById('horaExtraModal').style.display = 'flex';
        }
        document.getElementById('horaExtraForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condomínio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingHoraExtraId').value;
            const horaExtraData = {
                funcionario: document.getElementById('horaExtraFuncionario').value,
                matricula: document.getElementById('horaExtraMatricula').value,
                data: document.getElementById('horaExtraData').value,
                quantidade: parseFloat(document.getElementById('horaExtraQuantidade').value),
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('horasExtras').doc(editingId).update(horaExtraData);
                } else {
                    await db.collection('horasExtras').add(horaExtraData);
                }
                await loadSystemData();
                closeHoraExtraModal();
                if (currentModule === 'horas-extras') {
                    loadHorasExtrasContent();
                }
                alert('Hora extra salva com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar hora extra:', error);
                alert('Erro ao salvar hora extra. Tente novamente.');
            }
        });
        async function deleteHoraExtra(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este registro de hora extra?')) return;
            try {
                await db.collection('horasExtras').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'horas-extras') {
                    loadHorasExtrasContent();
                }
                alert('Hora extra excluída com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir hora extra:', error);
                alert('Erro ao excluir hora extra. Tente novamente.');
            }
        }
        function filterHorasExtras() {
            const funcionario = document.getElementById('filtroFuncionario').value.toLowerCase();
            const mes = document.getElementById('filtroMesHoraExtra').value;
            let filteredHorasExtras = horasExtras.filter(h => 
                h.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (funcionario) {
                filteredHorasExtras = filteredHorasExtras.filter(h => 
                    h.funcionario.toLowerCase().includes(funcionario)
                );
            }
            if (mes) {
                filteredHorasExtras = filteredHorasExtras.filter(h => 
                    h.data.startsWith(mes)
                );
            }
            const tbody = document.querySelector('#horasExtrasTable tbody');
            tbody.innerHTML = '';
            if (filteredHorasExtras.length > 0) {
                filteredHorasExtras.forEach(horaExtra => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${horaExtra.funcionario}</td>
                        <td>${horaExtra.matricula}</td>
                        <td>${formatDate(horaExtra.data)}</td>
                        <td>${horaExtra.quantidade}</td>
                        <td>${horaExtra.condominioNome}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editHoraExtra('${horaExtra.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${podeExcluirRegistros() ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteHoraExtra('${horaExtra.id}')">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum registro de hora extra encontrado com os filtros aplicados.</td></tr>';
            }
        }
        // Carregar menu de módulos
        function loadModuleMenu() {
            const moduleMenu = document.getElementById('moduleMenu');
            moduleMenu.innerHTML = '';
            const allowedModules = modules.filter(module => {
                return !currentUser.permissoes || 
                       currentUser.permissoes.includes('*') || 
                       currentUser.permissoes.includes(module.id);
            });
            allowedModules.forEach(module => {
                const menuItem = document.createElement('li');
                menuItem.innerHTML = `
                    <a href="#" class="${module.id === currentModule ? 'active' : ''}" onclick="changeModule('${module.id}')">
                        <i class="${module.icon}"></i>
                        <span>${module.name}</span>
                    </a>
                `;
                moduleMenu.appendChild(menuItem);
            });
        }
        // Carregar conteúdo do módulo
        function loadModuleContent(moduleId) {
            currentModule = moduleId;
            document.querySelectorAll('.sidebar-menu a').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`.sidebar-menu a[onclick="changeModule('${moduleId}')"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
            const moduleContent = document.getElementById('moduleContent');
            switch(moduleId) {
                case 'dashboard':
                    loadDashboardContent();
                    break;
                case 'condominios':
                    loadCondominiosContent();
                    break;
                case 'usuarios':
                    loadUsuariosContent();
                    break;
                case 'moradores':
                    loadMoradoresContent();
                    break;
                case 'agendamentos':
                    loadAgendamentosContent();
                    break;
                case 'limpeza':
                    loadLimpezaContent();
                    break;
                case 'sauna':
                    loadSaunaContent();
                    break;
                case 'contas':
                    loadContasContent();
                    break;
                case 'lembretes':
                    loadLembretesContent();
                    break;
                case 'relatorios':
                    loadRelatoriosContent();
                    break;
                case 'horas-extras':
                    loadHorasExtrasContent();
                    break;
                case 'ocorrencias':
                    loadOcorrenciasContent();
                    break;
                case 'prestadores':
                    loadPrestadoresContent();
                    break;
            }
            setTimeout(() => updateDeleteButtonsState(), 100);
        }
        function changeModule(moduleId) {
            loadModuleContent(moduleId);
        }
        async function loadSystemData() {
            try {
                const condominiosSnapshot = await db.collection('condominios').get();
                condominios = [];
                condominiosSnapshot.forEach(doc => {
                    condominios.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                const usuariosSnapshot = await db.collection('usuarios').get();
                usuarios = [];
                usuariosSnapshot.forEach(doc => {
                    usuarios.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                if (currentCondominio) {
                    const moradoresSnapshot = await db.collection('moradores')
                        .where('condominioId', '==', currentCondominio.id)
                        .get();
                    moradores = [];
                    moradoresSnapshot.forEach(doc => {
                        moradores.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    const horasExtrasSnapshot = await db.collection('horasExtras')
                        .where('condominioId', '==', currentCondominio.id)
                        .get();
                    horasExtras = [];
                    horasExtrasSnapshot.forEach(doc => {
                        horasExtras.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    const limpezasSnapshot = await db.collection('limpezas')
                        .where('condominioId', '==', currentCondominio.id)
                        .get();
                    limpezas = [];
                    limpezasSnapshot.forEach(doc => {
                        limpezas.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    const saunasSnapshot = await db.collection('saunas')
                        .where('condominioId', '==', currentCondominio.id)
                        .get();
                    saunas = [];
                    saunasSnapshot.forEach(doc => {
                        saunas.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    const agendamentosSnapshot = await db.collection('agendamentos')
                        .where('condominioId', '==', currentCondominio.id)
                        .get();
                    agendamentos = [];
                    agendamentosSnapshot.forEach(doc => {
                        agendamentos.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    const contasSnapshot = await db.collection('contas')
                        .where('condominioId', '==', currentCondominio.id)
                        .get();
                    contas = [];
                    contasSnapshot.forEach(doc => {
                        contas.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    const lembretesSnapshot = await db.collection('lembretes')
                        .where('condominioId', '==', currentCondominio.id)
                        .get();
                    lembretes = [];
                    lembretesSnapshot.forEach(doc => {
                        lembretes.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                } else {
                    moradores = [];
                    horasExtras = [];
                    limpezas = [];
                    saunas = [];
                    agendamentos = [];
                    contas = [];
                    lembretes = [];
                }
                await createDouglasUser();
                updateCondominioSelector();
                updateConnectionStatus(true);
            } catch (error) {
                console.error('Erro ao carregar dados do sistema:', error);
                updateConnectionStatus(false);
            }
        }
        function loadTickerContent() {
            const tickerContent = document.getElementById('tickerContent');
            tickerContent.innerHTML = '';
            const hoje = getCurrentDate();
            let lembretesAtivos = [];
            if (currentCondominio) {
                lembretesAtivos = lembretes.filter(l => 
                    l.condominioId === currentCondominio.id &&
                    l.dataInicio <= hoje &&
                    (!l.dataFim || l.dataFim >= hoje)
                );
            } else {
                lembretesAtivos = lembretes.filter(l => 
                    l.dataInicio <= hoje &&
                    (!l.dataFim || l.dataFim >= hoje)
                );
            }
            if (lembretesAtivos.length > 0) {
                lembretesAtivos.forEach(lembrete => {
                    const item = document.createElement('div');
                    item.className = 'ticker-item';
                    let icon = 'fas fa-bell';
                    if (lembrete.prioridade === 'alta') {
                        icon = 'fas fa-exclamation-circle';
                    } else if (lembrete.prioridade === 'media') {
                        icon = 'fas fa-info-circle';
                    }
                    let nomeUsuario = 'Sistema';
                    if (lembrete.criadoPor) {
                        const usuarioCriador = usuarios.find(u => u.id === lembrete.criadoPor);
                        if (usuarioCriador) {
                            nomeUsuario = usuarioCriador.nome || usuarioCriador.usuario || 'Usuário';
                        } else if (typeof lembrete.criadoPor === 'string' && lembrete.criadoPor.length > 10) {
                            nomeUsuario = lembrete.criadoPorNome || 'Usuário';
                        } else {
                            nomeUsuario = lembrete.criadoPor;
                        }
                    }
                    const textoCurto = lembrete.descricao ? 
                        (lembrete.descricao.length > 50 ? lembrete.descricao.substring(0, 50) + '...' : lembrete.descricao) : 
                        'Sem descrição';
                    item.innerHTML = `
                        <i class="${icon}"></i>
                        <strong>${lembrete.titulo}</strong> - ${textoCurto} 
                        <em>(por: ${nomeUsuario})</em>
                    `;
                    tickerContent.appendChild(item);
                });
                document.getElementById('tickerContainer').style.display = 'block';
            } else {
                const item = document.createElement('div');
                item.className = 'ticker-item';
                item.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <strong>Sem lembretes para hoje - ${formatDate(hoje)}</strong>
                `;
                tickerContent.appendChild(item);
                document.getElementById('tickerContainer').style.display = 'block';
            }
            setTimeout(() => {
                const content = document.getElementById('tickerContent');
                content.style.animation = 'none';
                setTimeout(() => {
                    content.style.animation = 'ticker 60s linear infinite';
                }, 10);
            }, 100);
        }
        async function createDouglasUser() {
            try {
                const userQuery = await db.collection('usuarios')
                    .where('usuario', '==', 'Douglas')
                    .limit(1)
                    .get();
                if (userQuery.empty) {
                    console.log('📝 Criando usuário Douglas...');
                    const userData = {
                        usuario: 'Douglas',
                        senha: '0000',
                        nome: 'Douglas Correia',
                        tipo: 'sindico',
                        primeiroLogin: false,
                        email: 'douglas@email.com',
                        telefone: '',
                        ativo: true,
                        condominios: ['*'],
                        permissoes: ['*'],
                        dataCriacao: new Date()
                    };
                    await db.collection('usuarios').add(userData);
                    console.log('✅ Usuário Douglas criado com sucesso!');
                } else {
                    console.log('✅ Usuário Douglas já existe');
                }
            } catch (error) {
                console.error('❌ Erro ao criar usuário Douglas:', error);
            }
        }
        function updateCondominioSelector() {
            const condominioSelectTop = document.getElementById('condominioSelectTop');
            const currentCondominioBadge = document.getElementById('currentCondominioBadge');
            condominioSelectTop.innerHTML = '<option value="">Selecione um condomínio</option>';
            let allowedCondominios = [...condominios];
            if (currentUser.condominios && !currentUser.condominios.includes('*')) {
                allowedCondominios = condominios.filter(condominio => 
                    currentUser.condominios.includes(condominio.id)
                );
            }
            allowedCondominios.forEach(condominio => {
                const option = document.createElement('option');
                option.value = condominio.id;
                option.textContent = condominio.nome;
                condominioSelectTop.appendChild(option);
            });
            if (!currentCondominio && allowedCondominios.length > 0) {
                currentCondominio = allowedCondominios[0];
                condominioSelectTop.value = currentCondominio.id;
                if (currentCondominioBadge) {
                    currentCondominioBadge.textContent = currentCondominio.nome;
                }
            } else if (currentCondominio) {
                condominioSelectTop.value = currentCondominio.id;
                if (currentCondominioBadge) {
                    currentCondominioBadge.textContent = currentCondominio.nome;
                }
            }
        }
        function updateConnectionStatus(connected) {
            const connectionStatus = document.getElementById('connectionStatus');
            if (connected) {
                connectionStatus.classList.add('connected');
                connectionStatus.title = 'Conectado';
            } else {
                connectionStatus.classList.remove('connected');
                connectionStatus.title = 'Desconectado';
            }
        }
        // ========== MÓDULO DASHBOARD ==========
        function loadDashboardContent() {
            const moduleContent = document.getElementById('moduleContent');
            const filteredAgendamentos = currentCondominio ? 
                agendamentos.filter(a => a.condominioId === currentCondominio.id) : [];
            const filteredContas = currentCondominio ? 
                contas.filter(c => c.condominioId === currentCondominio.id) : [];
            const filteredLembretes = currentCondominio ? 
                lembretes.filter(l => l.condominioId === currentCondominio.id) : [];
            const filteredMoradores = currentCondominio ? 
                moradores.filter(m => m.condominioId === currentCondominio.id) : [];
            const filteredLimpezas = currentCondominio ? 
                limpezas.filter(l => l.condominioId === currentCondominio.id) : [];
            const filteredSaunas = currentCondominio ? 
                saunas.filter(s => s.condominioId === currentCondominio.id) : [];
            let totalCondominios;
            if (currentUser.condominios && currentUser.condominios.includes('*')) {
                totalCondominios = condominios.length;
            } else if (currentUser.condominios) {
                totalCondominios = condominios.filter(cond => 
                    currentUser.condominios.includes(cond.id)
                ).length;
            } else {
                totalCondominios = condominios.length;
            }
            const totalUsuarios = usuarios.length;
            const totalMoradores = filteredMoradores.length;
            const totalAgendamentos = filteredAgendamentos.length;
            const totalLimpezas = filteredLimpezas.length;
            const totalSaunas = filteredSaunas.length;
            const agendamentosHoje = filteredAgendamentos.filter(a => {
                const hoje = new Date().toISOString().split('T')[0];
                return a.data === hoje;
            }).length;
            const hoje = new Date();
            const alertaContas = filteredContas.filter(conta => {
                if (conta.status === 'pago') return false;
                const vencimento = new Date(conta.vencimento);
                const diferencaDias = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
                return diferencaDias <= 4 && diferencaDias >= 0;
            });
            const lembretesProximos = filteredLembretes.filter(lembrete => {
                const dataInicio = new Date(lembrete.dataInicio);
                const dataFim = lembrete.dataFim ? new Date(lembrete.dataFim) : dataInicio;
                const diferencaInicio = Math.ceil((dataInicio - hoje) / (1000 * 60 * 60 * 24));
                const diferencaFim = Math.ceil((dataFim - hoje) / (1000 * 60 * 60 * 24));
                return diferencaInicio <= 7 && diferencaFim >= 0;
            });
            let statsHTML = '';
            statsHTML += `
                <div class="stat-card" onclick="changeModule('condominios')">
                    <h3>Condomínios</h3>
                    <div class="value">${totalCondominios}</div>
                </div>
                <div class="stat-card" onclick="changeModule('usuarios')">
                    <h3>Usuários</h3>
                    <div class="value">${totalUsuarios}</div>
                </div>
            `;
            const saunaUmidaEmUso = filteredSaunas.find(s => 
                s.status === 'em-uso' && s.tipo === 'umida'
            );
            const saunaSecaEmUso = filteredSaunas.find(s => 
                s.status === 'em-uso' && s.tipo === 'seca'
            );
            let saunaCardsHTML = '';
            saunaCardsHTML += `
                <div class="stat-card" onclick="changeModule('sauna')">
                    <h3>Sauna Úmida</h3>
                    <div class="value" style="color: ${saunaUmidaEmUso ? '#e74c3c' : '#2ecc71'}; font-size: 16px;">
                        ${saunaUmidaEmUso ? 
                            `${saunaUmidaEmUso.morador}<br><small>Apto: ${saunaUmidaEmUso.apto}</small>` : 
                            'LIVRE'
                        }
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        ${saunaUmidaEmUso ? '🟢 EM USO' : '🟡 DISPONÍVEL'}
                    </div>
                </div>
            `;
            saunaCardsHTML += `
                <div class="stat-card" onclick="changeModule('sauna')">
                    <h3>Sauna Seca</h3>
                    <div class="value" style="color: ${saunaSecaEmUso ? '#e74c3c' : '#2ecc71'}; font-size: 16px;">
                        ${saunaSecaEmUso ? 
                            `${saunaSecaEmUso.morador}<br><small>Apto: ${saunaSecaEmUso.apto}</small>` : 
                            'LIVRE'
                        }
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        ${saunaSecaEmUso ? '🟢 EM USO' : '🟡 DISPONÍVEL'}
                    </div>
                </div>
            `;
            if (currentUser.permissoes && 
                (currentUser.permissoes.includes('*') || currentUser.permissoes.includes('moradores'))) {
                statsHTML += `
                    <div class="stat-card" onclick="changeModule('moradores')">
                        <h3>Moradores</h3>
                        <div class="value">${totalMoradores}</div>
                    </div>
                `;
            }
            if (currentUser.permissoes && 
                (currentUser.permissoes.includes('*') || currentUser.permissoes.includes('agendamentos'))) {
                statsHTML += `
                    <div class="stat-card" onclick="changeModule('agendamentos')">
                        <h3>Agendamentos</h3>
                        <div class="value">${totalAgendamentos}</div>
                    </div>
                    <div class="stat-card" onclick="changeModule('agendamentos')">
                        <h3>Agendamentos Hoje</h3>
                        <div class="value">${agendamentosHoje}</div>
                    </div>
                `;
            }
            if (currentUser.permissoes && 
                (currentUser.permissoes.includes('*') || currentUser.permissoes.includes('limpeza'))) {
                statsHTML += `
                    <div class="stat-card" onclick="changeModule('limpeza')">
                        <h3>Registros de Limpeza</h3>
                        <div class="value">${totalLimpezas}</div>
                    </div>
                `;
            }
            if (currentUser.permissoes && 
                (currentUser.permissoes.includes('*') || currentUser.permissoes.includes('sauna'))) {
                statsHTML += `
                    <div class="stat-card" onclick="changeModule('sauna')">
                        <h3>Agendamentos Sauna</h3>
                        <div class="value">${totalSaunas}</div>
                    </div>
                `;
            }
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Dashboard - ${currentCondominio ? currentCondominio.nome : 'Selecione um condomínio'}</h3>
                        <span>Bem-vindo, ${currentUser.nome || currentUser.usuario}!</span>
                    </div>
                    <div class="card-body">
                        ${!currentCondominio ? `
                            <div class="alert alert-warning">
                                <strong>Atenção!</strong> Selecione um condomínio no menu acima para visualizar os dados específicos.
                            </div>
                        ` : ''}
                        ${(currentUser.permissoes && 
                          (currentUser.permissoes.includes('*') || currentUser.permissoes.includes('contas'))) && 
                          alertaContas.length > 0 ? `
                            <div class="dashboard-alerts">
                                <div class="alert alert-warning">
                                    <h4><i class="fas fa-exclamation-triangle"></i> Contas Próximas do Vencimento</h4>
                                    <p>Você tem ${alertaContas.length} conta(s) que vence(m) em até 4 dias.</p>
                                </div>
                            </div>
                        ` : ''}
                        <div class="stats-container">
                            ${statsHTML}
                        </div>
                        ${(currentUser.permissoes && 
                          (currentUser.permissoes.includes('*') || currentUser.permissoes.includes('sauna'))) ? `
                        <div class="card">
                            <div class="card-header">
                                <h3>Status das Saunas - ${currentCondominio ? currentCondominio.nome : 'Condomínio'}</h3>
                                <button class="btn btn-primary btn-sm" onclick="changeModule('sauna')">
                                    <i class="fas fa-eye"></i> Ver Detalhes
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="stats-container">
                                    ${saunaCardsHTML}
                                </div>
                                ${(saunaUmidaEmUso || saunaSecaEmUso) ? `
                                <div class="alert alert-info" style="margin-top: 15px;">
                                    <i class="fas fa-info-circle"></i> 
                                    Clique no card para gerenciar os agendamentos de sauna
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        ${(currentUser.permissoes && 
                          (currentUser.permissoes.includes('*') || currentUser.permissoes.includes('contas'))) ? `
                        <div class="card">
                            <div class="card-header">
                                <h3>Contas a Pagar - Próximos Vencimentos</h3>
                                <button class="btn btn-primary btn-sm" onclick="changeModule('contas')">
                                    <i class="fas fa-eye"></i> Ver Todas
                                </button>
                            </div>
                            <div class="card-body">
                                ${alertaContas.length > 0 ? 
                                    alertaContas.map(conta => `
                                        <div class="conta-item ${conta.status === 'atrasado' ? 'urgent' : 'warning'}">
                                            <div class="conta-header">
                                                <div class="conta-title">${conta.descricao}</div>
                                                <div class="conta-date">Vence: ${formatDate(conta.vencimento)}</div>
                                            </div>
                                            <div class="conta-details">
                                                <strong>R$ ${conta.valor.toFixed(2)}</strong> - ${conta.fornecedor}
                                            </div>
                                            <div class="conta-actions">
                                                <button class="btn btn-sm btn-success" onclick="marcarContaComoPaga('${conta.id}')">
                                                    <i class="fas fa-check"></i> Marcar como Pago
                                                </button>
                                            </div>
                                        </div>
                                    `).join('') 
                                    : '<p>Não há contas com vencimento próximo.</p>'
                                }
                            </div>
                        </div>
                        ` : ''}
                        ${currentCondominio && 
                         (currentUser.permissoes && 
                          (currentUser.permissoes.includes('*') || currentUser.permissoes.includes('agendamentos'))) ? `
                        <div class="card">
                            <div class="card-header">
                                <h4>Agendamentos Recentes - ${currentCondominio.nome}</h4>
                            </div>
                            <div class="card-body">
                                ${filteredAgendamentos.length > 0 ? `
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Espaço</th>
                                            <th>Solicitante</th>
                                            <th>Data</th>
                                            <th>Horário</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredAgendamentos.slice(0, 5).map(agendamento => `
                                            <tr>
                                                <td>${getEspacoNome(agendamento.espaco)}</td>
                                                <td>${agendamento.responsavel}</td>
                                                <td>${formatDate(agendamento.data)}</td>
                                                <td>${agendamento.horaInicio} - ${agendamento.horaFim}</td>
                                                <td><span class="status-badge status-${agendamento.status}">${formatStatusAgendamento(agendamento.status)}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                ` : '<p>Nenhum agendamento encontrado para este condomínio.</p>'}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        // ========== MÓDULO CONDOMÍNIOS ==========
        function loadCondominiosContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && 
                !currentUser.permissoes.includes('*') && 
                !currentUser.permissoes.includes('condominios')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            let allowedCondominios = [...condominios];
            if (currentUser.condominios && !currentUser.condominios.includes('*')) {
                allowedCondominios = condominios.filter(condominio => 
                    currentUser.condominios.includes(condominio.id)
                );
            }
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Gerenciar Condomínios</h3>
                        ${(!currentUser.permissoes || currentUser.permissoes.includes('*') || currentUser.permissoes.includes('condominios')) ? `
                        <button class="btn btn-primary" onclick="openCondominioModal()">
                            <i class="fas fa-plus"></i> Novo Condomínio
                        </button>
                        ` : ''}
                    </div>
                    <div class="card-body">
                        ${allowedCondominios.length > 0 ? `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Endereço</th>
                                    <th>Cidade/Estado</th>
                                    <th>Unidades</th>
                                    <th>Status</th>
                                    ${(!currentUser.permissoes || currentUser.permissoes.includes('*') || currentUser.permissoes.includes('condominios')) ? `<th>Ações</th>` : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${allowedCondominios.map(condominio => `
                                    <tr>
                                        <td>${condominio.nome}</td>
                                        <td>${condominio.endereco}</td>
                                        <td>${condominio.cidade}/${condominio.estado}</td>
                                        <td>${condominio.unidades || 'N/A'}</td>
                                        <td>
                                            <span class="badge ${condominio.status === 'ativo' ? 'badge-success' : 'badge-danger'}">
                                                ${condominio.status === 'ativo' ? 'Ativo' : 'Inativo'}
                                            </span>
                                        </td>
                                        ${(!currentUser.permissoes || currentUser.permissoes.includes('*') || currentUser.permissoes.includes('condominios')) ? `
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editCondominio('${condominio.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            ${podeExcluirRegistros() ? `
                                            <button class="btn btn-sm btn-danger" onclick="deleteCondominio('${condominio.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>` : ''}
                                        </td>
                                        ` : ''}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ` : '<p>Nenhum condomínio disponível para visualização.</p>'}
                    </div>
                </div>
            `;
        }
        // ========== MÓDULO HORAS EXTRAS ==========
        function loadHorasExtrasContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && 
                !currentUser.permissoes.includes('*') && 
                !currentUser.permissoes.includes('horas-extras')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Selecione um condomínio</strong> para acessar o módulo de horas extras.
                    </div>
                `;
                return;
            }
            const filteredHorasExtras = horasExtras.filter(h => h.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Horas Extras - ${currentCondominio.nome}</h3>
                        <button class="btn btn-primary" onclick="openHoraExtraModal()">
                            <i class="fas fa-plus"></i> Nova Hora Extra
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Filtrar por Funcionário</label>
                                <input type="text" class="form-control" id="filtroFuncionario" onkeyup="filterHorasExtras()" placeholder="Digite o nome do funcionário">
                            </div>
                            <div class="form-group">
                                <label>Filtrar por Data</label>
                                <input type="month" class="form-control" id="filtroMesHoraExtra" onchange="filterHorasExtras()">
                            </div>
                        </div>
                        <table class="table" id="horasExtrasTable">
                            <thead>
                                <tr>
                                    <th>Funcionário</th>
                                    <th>Matrícula</th>
                                    <th>Data</th>
                                    <th>Quantidade (horas)</th>
                                    <th>Condomínio</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredHorasExtras.map(horaExtra => `
                                    <tr>
                                        <td>${horaExtra.funcionario}</td>
                                        <td>${horaExtra.matricula}</td>
                                        <td>${formatDate(horaExtra.data)}</td>
                                        <td>${horaExtra.quantidade}</td>
                                        <td>${horaExtra.condominioNome}</td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editHoraExtra('${horaExtra.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            ${podeExcluirRegistros() ? `
                                            <button class="btn btn-sm btn-danger" onclick="deleteHoraExtra('${horaExtra.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        // ========== MÓDULO USUÁRIOS ==========
        function loadUsuariosContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && 
                !currentUser.permissoes.includes('*') && 
                !currentUser.permissoes.includes('usuarios')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Gerenciar Usuários</h3>
                        <button class="btn btn-primary" onclick="openUserModal()">
                            <i class="fas fa-plus"></i> Novo Usuário
                        </button>
                    </div>
                    <div class="card-body">
                        ${usuarios.length > 0 ? `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Usuário</th>
                                    <th>Tipo</th>
                                    <th>E-mail</th>
                                    <th>Condomínios</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${usuarios.map(usuario => `
                                    <tr>
                                        <td>${usuario.nome}</td>
                                        <td>${usuario.usuario}</td>
                                        <td>${formatUserType(usuario.tipo)}</td>
                                        <td>${usuario.email || 'N/A'}</td>
                                        <td>${usuario.condominios ? usuario.condominios.length : 0}</td>
                                        <td>
                                            <span class="badge ${usuario.status === 'ativo' ? 'badge-success' : 'badge-danger'}">
                                                ${usuario.status === 'ativo' ? 'Ativo' : 'Inativo'}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editUser('${usuario.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            ${podeExcluirRegistros() ? `
                                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${usuario.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ` : '<p>Nenhum usuário cadastrado.</p>'}
                    </div>
                </div>
            `;
        }
        // ========== MÓDULO MORADORES ==========
        function loadMoradoresContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && 
                !currentUser.permissoes.includes('*') && 
                !currentUser.permissoes.includes('moradores')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Selecione um condomínio</strong> para acessar o módulo de moradores.
                    </div>
                `;
                return;
            }
            const filteredMoradores = moradores.filter(m => m.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Moradores - ${currentCondominio.nome}</h3>
                        <button class="btn btn-primary" onclick="openMoradorModal()">
                            <i class="fas fa-plus"></i> Novo Morador
                        </button>
                    </div>
                    <div class="card-body">
                        ${filteredMoradores.length > 0 ? `
                        <table class="table" id="moradoresTable">
                            <thead>
                                <tr>
                                    <th style="cursor: pointer;" onclick="sortMoradores('nome')">
                                        Morador <i class="fas fa-sort"></i>
                                    </th>
                                    <th style="cursor: pointer;" onclick="sortMoradores('apto')">
                                        Apartamento <i class="fas fa-sort"></i>
                                    </th>
                                    <th>Telefone</th>
                                    <th>Garagem</th>
                                    <th>Vaga</th>
                                    <th>Observações</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="moradoresTbody">
                            </tbody>
                        </table>
                        ` : '<p>Nenhum morador cadastrado para este condomínio.</p>'}
                    </div>
                </div>
            `;
            if (filteredMoradores.length > 0) {
                const sortedMoradores = filteredMoradores.sort((a, b) => {
                    const numA = extractNumberFromApto(a.apto);
                    const numB = extractNumberFromApto(b.apto);
                    return numA - numB;
                });
                loadMoradoresTableData(sortedMoradores);
                setTimeout(() => updateSortIcons('apto'), 100);
            }
        }
        // ========== MÓDULO AGENDAMENTOS ==========
        function loadAgendamentosContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && 
                !currentUser.permissoes.includes('*') && 
                !currentUser.permissoes.includes('agendamentos')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Selecione um condomínio</strong> para acessar o módulo de agendamentos.
                    </div>
                `;
                return;
            }
            const filteredAgendamentos = agendamentos.filter(a => a.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="agendamentos-header">
                    <div class="agendamentos-title">Agendamentos - ${currentCondominio.nome}</div>
                    <div class="calendar-controls">
                        <button class="btn btn-primary" onclick="openAgendamentoModal()">
                            <i class="fas fa-plus"></i> Novo Agendamento
                        </button>
                    </div>
                </div>
                <div class="menu-agendamentos">
                    <h3>Filtros de Agendamento</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Espaço</label>
                            <select id="filtroEspaco" class="form-control" onchange="filterAgendamentos()">
                                <option value="">Todos os espaços</option>
                                <option value="salao-social">Salão Social</option>
                                <option value="churrasqueira">Churrasqueira</option>
                                <option value="quiosque">Quiosque</option>
                                <option value="pergolado">Pergolado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="filtroStatus" class="form-control" onchange="filterAgendamentos()">
                                <option value="">Todos os status</option>
                                <option value="agendado">Agendado</option>
                                <option value="em-uso">Em Uso</option>
                                <option value="liberado">Liberado</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" id="filtroData" class="form-control" onchange="filterAgendamentos()">
                        </div>
                    </div>
                </div>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button class="btn" onclick="changeCalendarMonth(-1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="calendar-title" id="calendarTitle">${getMonthName(currentCalendarMonth)} ${currentCalendarYear}</div>
                            <button class="btn" onclick="changeCalendarMonth(1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="calendar-view-options">
                            <button class="btn active" onclick="changeCalendarView('month')">Mês</button>
                            <button class="btn" onclick="changeCalendarView('week')">Semana</button>
                            <button class="btn" onclick="changeCalendarView('day')">Dia</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                    </div>
                    <div class="calendar-legends">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #3498db;"></div>
                            <span>Salão Social</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #e74c3c;"></div>
                            <span>Churrasqueira</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #2ecc71;"></div>
                            <span>Quiosque</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #9b59b6;"></div>
                            <span>Pergolado</span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h4>Lista de Agendamentos - ${currentCondominio.nome}</h4>
                    </div>
                    <div class="card-body">
                        <table class="table" id="agendamentosTable">
                            <thead>
                                <tr>
                                    <th>Espaço</th>
                                    <th>Solicitante</th>
                                    <th>Data</th>
                                    <th>Horário</th>
                                    <th>Unidade</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            generateCalendar(currentCalendarMonth, currentCalendarYear);
            loadAgendamentosList();
        }
        // ========== MÓDULO LIMPEZA ==========
        function loadLimpezaContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && 
                !currentUser.permissoes.includes('*') && 
                !currentUser.permissoes.includes('limpeza')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Selecione um condomínio</strong> para acessar o módulo de limpeza.
                    </div>
                `;
                return;
            }
            const filteredLimpezas = limpezas.filter(l => l.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Registros de Limpeza - ${currentCondominio.nome}</h3>
                        <button class="btn btn-primary" onclick="openLimpezaModal()">
                            <i class="fas fa-plus"></i> Novo Registro
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Filtrar por Espaço</label>
                                <select class="form-control" id="filtroEspacoLimpeza" onchange="filterLimpezas()">
                                    <option value="">Todos os espaços</option>
                                    <option value="salao-social">Salão Social</option>
                                    <option value="churrasqueira">Churrasqueira</option>
                                    <option value="quiosque">Quiosque</option>
                                    <option value="pergolado">Pergolado</option>
                                    <option value="sauna">Sauna</option>
                                    <option value="area-comum">Área Comum</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Filtrar por Status</label>
                                <select class="form-control" id="filtroStatusLimpeza" onchange="filterLimpezas()">
                                    <option value="">Todos</option>
                                    <option value="em-andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Filtrar por Data</label>
                                <input type="date" class="form-control" id="filtroDataLimpeza" onchange="filterLimpezas()">
                            </div>
                        </div>
                        <table class="table" id="limpezasTable">
                            <thead>
                                <tr>
                                    <th>Responsável</th>
                                    <th>Espaço</th>
                                    <th>Data</th>
                                    <th>Horário</th>
                                    <th>Tempo (min)</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredLimpezas.map(limpeza => `
                                    <tr>
                                        <td>${limpeza.responsavel}</td>
                                        <td>${getEspacoNome(limpeza.espaco)}</td>
                                        <td>${formatDate(limpeza.data)}</td>
                                        <td>${limpeza.horaInicio} ${limpeza.horaFim ? ' - ' + limpeza.horaFim : ''}</td>
                                        <td>${limpeza.tempoUso || '-'}</td>
                                        <td>
                                            <span class="badge ${limpeza.status === 'concluido' ? 'badge-success' : 'badge-warning'}">
                                                ${limpeza.status === 'concluido' ? 'Concluído' : 'Em Andamento'}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editLimpeza('${limpeza.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            ${limpeza.status !== 'concluido' ? `
                                            <button class="btn btn-sm btn-success" onclick="concluirLimpeza('${limpeza.id}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            ` : ''}
                                            ${podeExcluirRegistros() ? `
                                            <button class="btn btn-sm btn-danger" onclick="deleteLimpeza('${limpeza.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        // ========== MÓDULO SAUNA ==========
        function loadSaunaContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && 
                !currentUser.permissoes.includes('*') && 
                !currentUser.permissoes.includes('sauna')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Selecione um condomínio</strong> para acessar o módulo de sauna.
                    </div>
                `;
                return;
            }
            const filteredSaunas = saunas.filter(s => s.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Agendamentos de Sauna - ${currentCondominio.nome}</h3>
                        <button class="btn btn-primary" onclick="openSaunaModal()">
                            <i class="fas fa-plus"></i> Novo Agendamento
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Filtrar por Status</label>
                                <select class="form-control" id="filtroStatusSauna" onchange="filterSaunas()">
                                    <option value="">Todos</option>
                                    <option value="agendado">Agendado</option>
                                    <option value="em-uso">Em Uso</option>
                                    <option value="concluido">Concluído</option>
                                    <option value="cancelado">Cancelado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Filtrar por Data</label>
                                <input type="date" class="form-control" id="filtroDataSauna" onchange="filterSaunas()">
                            </div>
                        </div>
                        <table class="table" id="saunasTable">
                            <thead>
                                <tr>
                                    <th>Morador</th>
                                    <th>Apartamento</th>
                                    <th>Tipo</th>
                                    <th>Data</th>
                                    <th>Horário</th>
                                    <th>Tempo (min)</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredSaunas.map(sauna => `
                                    <tr>
                                        <td>${sauna.morador}</td>
                                        <td>${sauna.apto}</td>
                                        <td>${sauna.tipo === 'umida' ? 'Úmida' : 'Seca'}</td>
                                        <td>${formatDate(sauna.data)}</td>
                                        <td>${sauna.horaInicio} ${sauna.horaFim ? ' - ' + sauna.horaFim : ''}</td>
                                        <td>${sauna.tempoUso || '-'}</td>
                                        <td>
                                            <span class="status-badge status-${sauna.status}">
                                                ${formatStatusSauna(sauna.status)}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editSauna('${sauna.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            ${sauna.status === 'em-uso' ? `
                                            <button class="btn btn-sm btn-success" onclick="concluirSauna('${sauna.id}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            ` : ''}
                                            ${sauna.status === 'agendado' ? `
                                            <button class="btn btn-sm btn-warning" onclick="iniciarSauna('${sauna.id}')">
                                                <i class="fas fa-play"></i>
                                            </button>
                                            ` : ''}
                                            ${podeExcluirRegistros() ? `
                                            <button class="btn btn-sm btn-danger" onclick="deleteSauna('${sauna.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        // ========== MÓDULO CONTAS A PAGAR ==========
        function loadContasContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && 
                !currentUser.permissoes.includes('*') && 
                !currentUser.permissoes.includes('contas')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Selecione um condomínio</strong> para acessar o módulo de contas a pagar.
                    </div>
                `;
                return;
            }
            const filteredContas = contas.filter(c => c.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Contas a Pagar - ${currentCondominio.nome}</h3>
                        <button class="btn btn-primary" onclick="openContaModal()">
                            <i class="fas fa-plus"></i> Nova Conta
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Filtrar por Status</label>
                                <select class="form-control" id="filtroStatusConta" onchange="filterContas()">
                                    <option value="">Todos</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="pago">Pago</option>
                                    <option value="atrasado">Atrasado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Filtrar por Categoria</label>
                                <select class="form-control" id="filtroCategoriaConta" onchange="filterContas()">
                                    <option value="">Todas</option>
                                    <option value="manutencao">Manutenção</option>
                                    <option value="limpeza">Limpeza</option>
                                    <option value="seguranca">Segurança</option>
                                    <option value="administrativo">Administrativo</option>
                                    <option value="energia">Energia</option>
                                    <option value="agua">Água</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                        </div>
                        <table class="table" id="contasTable">
                            <thead>
                                <tr>
                                    <th>Descrição</th>
                                    <th>Valor</th>
                                    <th>Vencimento</th>
                                    <th>Categoria</th>
                                    <th>Fornecedor</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredContas.map(conta => `
                                    <tr>
                                        <td>${conta.descricao}</td>
                                        <td>R$ ${conta.valor.toFixed(2)}</td>
                                        <td>${formatDate(conta.vencimento)}</td>
                                        <td>${formatCategoriaConta(conta.categoria)}</td>
                                        <td>${conta.fornecedor || '-'}</td>
                                        <td>
                                            <span class="status-badge status-${conta.status}">
                                                ${formatStatusConta(conta.status)}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editConta('${conta.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-success" onclick="marcarContaComoPaga('${conta.id}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            ${podeExcluirRegistros() ? `
                                            <button class="btn btn-sm btn-danger" onclick="deleteConta('${conta.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        // ========== MÓDULO LEMBRETES ==========
        function loadLembretesContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && 
                !currentUser.permissoes.includes('*') && 
                !currentUser.permissoes.includes('lembretes')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Selecione um condomínio</strong> para acessar o módulo de lembretes.
                    </div>
                `;
                return;
            }
            const filteredLembretes = lembretes.filter(l => l.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Lembretes - ${currentCondominio.nome}</h3>
                        <button class="btn btn-primary" onclick="openLembreteModal()">
                            <i class="fas fa-plus"></i> Novo Lembrete
                        </button>
                    </div>
                    <div class="card-body">
                        ${filteredLembretes.length > 0 ? `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Título</th>
                                    <th>Descrição</th>
                                    <th>Início</th>
                                    <th>Fim</th>
                                    <th>Prioridade</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredLembretes.map(lembrete => `
                                    <tr>
                                        <td>${lembrete.titulo}</td>
                                        <td>${lembrete.descricao || '-'}</td>
                                        <td>${formatDate(lembrete.dataInicio)}</td>
                                        <td>${lembrete.dataFim ? formatDate(lembrete.dataFim) : '—'}</td>
                                        <td>
                                            <span class="badge ${lembrete.prioridade === 'alta' ? 'badge-danger' : lembrete.prioridade === 'media' ? 'badge-warning' : 'badge-info'}">
                                                ${lembrete.prioridade === 'alta' ? 'Alta' : lembrete.prioridade === 'media' ? 'Média' : 'Baixa'}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editLembrete('${lembrete.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            ${podeExcluirRegistros() ? `
                                            <button class="btn btn-sm btn-danger" onclick="deleteLembrete('${lembrete.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ` : '<p>Nenhum lembrete cadastrado para este condomínio.</p>'}
                    </div>
                </div>
            `;
        }
        // ========== MÓDULO RELATÓRIOS ==========
        function loadRelatoriosContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && 
                !currentUser.permissoes.includes('*') && 
                !currentUser.permissoes.includes('relatorios')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const firstDayStr = firstDay.toISOString().split('T')[0];
            const lastDayStr = lastDay.toISOString().split('T')[0];
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Relatórios - ${currentCondominio ? currentCondominio.nome : 'Todos os condomínios'}</h3>
                    </div>
                    <div class="card-body">
                        <div class="report-filters">
                            <h4>Filtros do Relatório</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tipo de Relatório</label>
                                    <select class="form-control" id="reportType">
                                        <option value="agendamentos">Agendamentos</option>
                                        <option value="contas">Contas a Pagar</option>
                                        <option value="usuarios">Usuários</option>
                                        <option value="moradores">Moradores</option>
                                        <option value="limpeza">Limpeza</option>
                                        <option value="sauna">Sauna</option>
                                        <option value="horas-extras">Horas Extras</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Período Inicial</label>
                                    <input type="date" class="form-control" id="reportStartDate" value="${firstDayStr}">
                                </div>
                                <div class="form-group">
                                    <label>Período Final</label>
                                    <input type="date" class="form-control" id="reportEndDate" value="${lastDayStr}">
                                </div>
                            </div>
                            ${currentCondominio ? `
                            <div class="form-group">
                                <label>Condomínio</label>
                                <select class="form-control" id="reportCondominio">
                                    <option value="${currentCondominio.id}">${currentCondominio.nome}</option>
                                </select>
                            </div>
                            ` : ''}
                            <div class="report-actions">
                                <button class="btn btn-primary" onclick="generateReport()">
                                    <i class="fas fa-chart-bar"></i> Gerar Relatório
                                </button>
                                <button class="btn btn-success" onclick="exportReport()">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div class="report-preview" id="reportPreview">
                            <p>Selecione os filtros e clique em "Gerar Relatório"</p>
                        </div>
                    </div>
                </div>
            `;
        }
        // ========== FUNÇÕES AUXILIARES ==========
        function getEspacoNome(espacoId) {
            const espacos = {
                'salao-social': 'Salão Social',
                'churrasqueira': 'Churrasqueira',
                'quiosque': 'Quiosque',
                'pergolado': 'Pergolado',
                'sauna': 'Sauna',
                'area-comum': 'Área Comum'
            };
            return espacos[espacoId] || espacoId;
        }
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }
        function getCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function formatUserType(userType) {
            const types = {
                'sindico': 'Síndico',
                'subsindico': 'Subsíndico',
                'zelador': 'Zelador',
                'portaria': 'Portaria',
                'prestador': 'Prestador de Serviço',
                'morador': 'Morador'
            };
            return types[userType] || userType;
        }
        function formatStatusAgendamento(status) {
            const statusMap = {
                'agendado': 'Agendado',
                'em-uso': 'Em Uso',
                'liberado': 'Liberado',
                'cancelado': 'Cancelado'
            };
            return statusMap[status] || status;
        }
        function formatStatusSauna(status) {
            const statusMap = {
                'agendado': 'Agendado',
                'em-uso': 'Em Uso',
                'concluido': 'Concluído',
                'cancelado': 'Cancelado'
            };
            return statusMap[status] || status;
        }
        function formatCategoriaConta(categoria) {
            const categorias = {
                'manutencao': 'Manutenção',
                'limpeza': 'Limpeza',
                'seguranca': 'Segurança',
                'administrativo': 'Administrativo',
                'energia': 'Energia',
                'agua': 'Água',
                'outros': 'Outros'
            };
            return categorias[categoria] || categoria;
        }
        function formatStatusConta(status) {
            const statusMap = {
                'pendente': 'Pendente',
                'pago': 'Pago',
                'atrasado': 'Atrasado'
            };
            return statusMap[status] || status;
        }
        function getMonthName(month) {
            const months = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return months[month];
        }
        // ========== FUNÇÕES DE CALENDÁRIO ==========
        function generateCalendar(month, year) {
            const calendarGrid = document.getElementById('calendarGrid');
            if (!calendarGrid) return;
            document.getElementById('calendarTitle').textContent = `${getMonthName(month)} ${year}`;
            calendarGrid.innerHTML = '';
            const daysOfWeek = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            daysOfWeek.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const firstDayOfWeek = firstDay.getDay();
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.innerHTML = `<div class="day-number">${prevMonthLastDay - i}</div>`;
                calendarGrid.appendChild(day);
            }
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const day = document.createElement('div');
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const today = new Date();
                const isToday = today.getDate() === i && 
                               today.getMonth() === month && 
                               today.getFullYear() === year;
                day.className = `calendar-day ${isToday ? 'today' : ''}`;
                day.innerHTML = `<div class="day-number">${i}</div>`;
                const dayEvents = agendamentos.filter(a => 
                    a.data === dateStr && 
                    a.condominioId === (currentCondominio ? currentCondominio.id : '')
                );
                dayEvents.forEach(event => {
                    const eventElement = document.createElement('div');
                    eventElement.className = `event-item ${event.espaco}`;
                    eventElement.textContent = `${event.unidade} ${event.horaInicio} a ${event.horaFim}`;
                    eventElement.title = `${getEspacoNome(event.espaco)}: ${event.responsavel} (${event.unidade}) - ${event.horaInicio} a ${event.horaFim}`;
                    eventElement.addEventListener('click', function(e) {
                        e.stopPropagation();
                        showAgendamentoActions(event, eventElement);
                    });
                    day.appendChild(eventElement);
                });
                day.addEventListener('click', function() {
                    openAgendamentoModalForDate(dateStr);
                });
                calendarGrid.appendChild(day);
            }
            const totalCells = 42;
            const daysSoFar = firstDayOfWeek + lastDay.getDate();
            const nextMonthDays = totalCells - daysSoFar;
            for (let i = 1; i <= nextMonthDays; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.innerHTML = `<div class="day-number">${i}</div>`;
                calendarGrid.appendChild(day);
            }
        }
        function changeCalendarMonth(direction) {
            currentCalendarMonth += direction;
            if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            } else if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            }
            generateCalendar(currentCalendarMonth, currentCalendarYear);
        }
        function changeCalendarView(view) {
            document.querySelectorAll('.calendar-view-options .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            alert(`Visualização alterada para: ${view}`);
        }
        function showAgendamentoActions(agendamento, element) {
            const existingModal = document.querySelector('.agendamento-actions-modal');
            if (existingModal) {
                existingModal.remove();
            }
            const modal = document.createElement('div');
            modal.className = 'agendamento-actions-modal';
            modal.innerHTML = `
                <button onclick="editAgendamento('${agendamento.id}')">Editar</button>
                <button onclick="updateAgendamentoStatus('${agendamento.id}', 'liberado')">Marcar como Liberado</button>
                <button onclick="updateAgendamentoStatus('${agendamento.id}', 'cancelado')">Cancelar</button>
            `;
            const rect = element.getBoundingClientRect();
            modal.style.position = 'fixed';
            modal.style.top = `${rect.bottom + window.scrollY}px`;
            modal.style.left = `${rect.left + window.scrollX}px`;
            document.body.appendChild(modal);
            const closeModal = function(e) {
                if (!modal.contains(e.target)) {
                    modal.remove();
                    document.removeEventListener('click', closeModal);
                }
            };
            setTimeout(() => {
                document.addEventListener('click', closeModal);
            }, 100);
        }
        async function updateAgendamentoStatus(agendamentoId, status) {
            try {
                await db.collection('agendamentos').doc(agendamentoId).update({
                    status: status,
                    dataAtualizacao: new Date().toISOString()
                });
                await loadSystemData();
                if (currentModule === 'agendamentos') {
                    loadAgendamentosContent();
                }
                alert(`Agendamento ${status === 'liberado' ? 'marcado como liberado' : 'cancelado'} com sucesso!`);
            } catch (error) {
                console.error('Erro ao atualizar status do agendamento:', error);
                alert('Erro ao atualizar status do agendamento. Tente novamente.');
            }
        }
        function filterAgendamentos() {
            const espaco = document.getElementById('filtroEspaco').value;
            const status = document.getElementById('filtroStatus').value;
            const data = document.getElementById('filtroData').value;
            let filteredAgendamentos = agendamentos.filter(a => 
                a.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (espaco) {
                filteredAgendamentos = filteredAgendamentos.filter(a => a.espaco === espaco);
            }
            if (status) {
                filteredAgendamentos = filteredAgendamentos.filter(a => a.status === status);
            }
            if (data) {
                filteredAgendamentos = filteredAgendamentos.filter(a => a.data === data);
            }
            const tbody = document.querySelector('#agendamentosTable tbody');
            tbody.innerHTML = '';
            if (filteredAgendamentos.length > 0) {
                filteredAgendamentos.forEach(agendamento => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${getEspacoNome(agendamento.espaco)}</td>
                        <td>${agendamento.responsavel}</td>
                        <td>${formatDate(agendamento.data)}</td>
                        <td>${agendamento.horaInicio} - ${agendamento.horaFim}</td>
                        <td>${agendamento.unidade}</td>
                        <td>
                            <span class="status-badge status-${agendamento.status}">
                                ${formatStatusAgendamento(agendamento.status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editAgendamento('${agendamento.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${podeExcluirRegistros() ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteAgendamento('${agendamento.id}')">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum agendamento encontrado com os filtros aplicados.</td></tr>';
            }
        }
        function loadAgendamentosList() {
            filterAgendamentos();
        }
        function filterContas() {
            const status = document.getElementById('filtroStatusConta').value;
            const categoria = document.getElementById('filtroCategoriaConta').value;
            let filteredContas = contas.filter(c => 
                c.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (status) {
                filteredContas = filteredContas.filter(c => c.status === status);
            }
            if (categoria) {
                filteredContas = filteredContas.filter(c => c.categoria === categoria);
            }
            const tbody = document.querySelector('#contasTable tbody');
            tbody.innerHTML = '';
            if (filteredContas.length > 0) {
                filteredContas.forEach(conta => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${conta.descricao}</td>
                        <td>R$ ${conta.valor.toFixed(2)}</td>
                        <td>${formatDate(conta.vencimento)}</td>
                        <td>${formatCategoriaConta(conta.categoria)}</td>
                        <td>${conta.fornecedor || '-'}</td>
                        <td>
                            <span class="status-badge status-${conta.status}">
                                ${formatStatusConta(conta.status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editConta('${conta.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="marcarContaComoPaga('${conta.id}')">
                                <i class="fas fa-check"></i>
                            </button>
                            ${podeExcluirRegistros() ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteConta('${conta.id}')">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma conta encontrada com os filtros aplicados.</td></tr>';
            }
        }
        function filterLimpezas() {
            const espaco = document.getElementById('filtroEspacoLimpeza').value;
            const status = document.getElementById('filtroStatusLimpeza').value;
            const data = document.getElementById('filtroDataLimpeza').value;
            let filteredLimpezas = limpezas.filter(l => 
                l.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (espaco) {
                filteredLimpezas = filteredLimpezas.filter(l => l.espaco === espaco);
            }
            if (status) {
                filteredLimpezas = filteredLimpezas.filter(l => l.status === status);
            }
            if (data) {
                filteredLimpezas = filteredLimpezas.filter(l => l.data === data);
            }
            const tbody = document.querySelector('#limpezasTable tbody');
            tbody.innerHTML = '';
            if (filteredLimpezas.length > 0) {
                filteredLimpezas.forEach(limpeza => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${limpeza.responsavel}</td>
                        <td>${getEspacoNome(limpeza.espaco)}</td>
                        <td>${formatDate(limpeza.data)}</td>
                        <td>${limpeza.horaInicio} ${limpeza.horaFim ? ' - ' + limpeza.horaFim : ''}</td>
                        <td>${limpeza.tempoUso || '-'}</td>
                        <td>
                            <span class="badge ${limpeza.status === 'concluido' ? 'badge-success' : 'badge-warning'}">
                                ${limpeza.status === 'concluido' ? 'Concluído' : 'Em Andamento'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editLimpeza('${limpeza.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${limpeza.status !== 'concluido' ? `
                            <button class="btn btn-sm btn-success" onclick="concluirLimpeza('${limpeza.id}')">
                                <i class="fas fa-check"></i>
                            </button>
                            ` : ''}
                            ${podeExcluirRegistros() ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteLimpeza('${limpeza.id}')">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum registro de limpeza encontrado com os filtros aplicados.</td></tr>';
            }
        }
        function filterSaunas() {
            const status = document.getElementById('filtroStatusSauna').value;
            const data = document.getElementById('filtroDataSauna').value;
            let filteredSaunas = saunas.filter(s => 
                s.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (status) {
                filteredSaunas = filteredSaunas.filter(s => s.status === status);
            }
            if (data) {
                filteredSaunas = filteredSaunas.filter(s => s.data === data);
            }
            const tbody = document.querySelector('#saunasTable tbody');
            tbody.innerHTML = '';
            if (filteredSaunas.length > 0) {
                filteredSaunas.forEach(sauna => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${sauna.morador}</td>
                        <td>${sauna.apto}</td>
                        <td>${formatDate(sauna.data)}</td>
                        <td>${sauna.horaInicio} ${sauna.horaFim ? ' - ' + sauna.horaFim : ''}</td>
                        <td>${sauna.tempoUso || '-'}</td>
                        <td>
                            <span class="status-badge status-${sauna.status}">
                                ${formatStatusSauna(sauna.status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editSauna('${sauna.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${sauna.status === 'em-uso' ? `
                            <button class="btn btn-sm btn-success" onclick="concluirSauna('${sauna.id}')">
                                <i class="fas fa-check"></i>
                            </button>
                            ` : ''}
                            ${sauna.status === 'agendado' ? `
                            <button class="btn btn-sm btn-warning" onclick="iniciarSauna('${sauna.id}')">
                                <i class="fas fa-play"></i>
                            </button>
                            ` : ''}
                            ${podeExcluirRegistros() ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteSauna('${sauna.id}')">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum agendamento de sauna encontrado com os filtros aplicados.</td></tr>';
            }
        }
        // ========== FUNÇÕES DE AGENDAMENTOS ==========
        function openAgendamentoModal() {
            document.getElementById('agendamentoModalTitle').textContent = 'Novo Agendamento';
            document.getElementById('editingAgendamentoId').value = '';
            document.getElementById('agendamentoForm').reset();
            document.getElementById('agendamentoData').value = '';
            document.getElementById('agendamentoDataInput').value = getCurrentDate();
            document.getElementById('agendamentoStatus').value = 'agendado';
            document.getElementById('agendamentoModal').style.display = 'flex';
        }
        function openAgendamentoModalForDate(dateStr) {
            openAgendamentoModal();
            document.getElementById('agendamentoData').value = dateStr;
            document.getElementById('agendamentoDataInput').value = dateStr;
        }
        function closeAgendamentoModal() {
            document.getElementById('agendamentoModal').style.display = 'none';
        }
        document.getElementById('agendamentoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condomínio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingAgendamentoId').value;
            const espaco = document.getElementById('agendamentoEspaco').value;
            const data = document.getElementById('agendamentoDataInput').value;
            const agendamentoExistente = agendamentos.find(a => 
                a.condominioId === currentCondominio.id &&
                a.espaco === espaco && 
                a.data === data && 
                a.id != editingId
            );
            if (agendamentoExistente) {
                alert(`Já existe um agendamento para ${getEspacoNome(espaco)} na data ${formatDate(data)}. Cada espaço só pode ter um agendamento por dia.`);
                return;
            }
            const agendamentoData = {
                espaco: espaco,
                data: data,
                horaInicio: document.getElementById('agendamentoHoraInicio').value,
                horaFim: document.getElementById('agendamentoHoraFim').value,
                responsavel: document.getElementById('agendamentoResponsavel').value,
                unidade: document.getElementById('agendamentoUnidade').value,
                status: document.getElementById('agendamentoStatus').value,
                observacoes: document.getElementById('agendamentoObservacoes').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('agendamentos').doc(editingId).update(agendamentoData);
                } else {
                    await db.collection('agendamentos').add(agendamentoData);
                }
                await loadSystemData();
                closeAgendamentoModal();
                if (currentModule === 'agendamentos') {
                    loadAgendamentosContent();
                }
                alert('Agendamento salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar agendamento:', error);
                alert('Erro ao salvar agendamento. Tente novamente.');
            }
        });
        function editAgendamento(id) {
            const agendamento = agendamentos.find(a => a.id === id);
            if (!agendamento) return;
            document.getElementById('agendamentoModalTitle').textContent = 'Editar Agendamento';
            document.getElementById('editingAgendamentoId').value = agendamento.id;
            document.getElementById('agendamentoEspaco').value = agendamento.espaco;
            document.getElementById('agendamentoDataInput').value = agendamento.data;
            document.getElementById('agendamentoHoraInicio').value = agendamento.horaInicio;
            document.getElementById('agendamentoHoraFim').value = agendamento.horaFim;
            document.getElementById('agendamentoResponsavel').value = agendamento.responsavel;
            document.getElementById('agendamentoUnidade').value = agendamento.unidade;
            document.getElementById('agendamentoStatus').value = agendamento.status;
            document.getElementById('agendamentoObservacoes').value = agendamento.observacoes || '';
            document.getElementById('agendamentoModal').style.display = 'flex';
        }
        async function deleteAgendamento(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este agendamento?')) return;
            try {
                await db.collection('agendamentos').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'agendamentos') {
                    loadAgendamentosContent();
                }
                alert('Agendamento excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir agendamento:', error);
                alert('Erro ao excluir agendamento. Tente novamente.');
            }
        }
        // ========== FUNÇÕES DE CONTAS A PAGAR ==========
        function openContaModal() {
            document.getElementById('contaModalTitle').textContent = 'Nova Conta a Pagar';
            document.getElementById('editingContaId').value = '';
            document.getElementById('contaForm').reset();
            const dataPadrao = new Date();
            dataPadrao.setDate(dataPadrao.getDate() + 30);
            document.getElementById('contaVencimento').value = dataPadrao.toISOString().split('T')[0];
            document.getElementById('contaStatus').value = 'pendente';
            document.getElementById('contaModal').style.display = 'flex';
        }
        function closeContaModal() {
            document.getElementById('contaModal').style.display = 'none';
        }
        document.getElementById('contaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condomínio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingContaId').value;
            const contaData = {
                descricao: document.getElementById('contaDescricao').value,
                valor: parseFloat(document.getElementById('contaValor').value),
                vencimento: document.getElementById('contaVencimento').value,
                categoria: document.getElementById('contaCategoria').value,
                fornecedor: document.getElementById('contaFornecedor').value,
                status: document.getElementById('contaStatus').value,
                observacoes: document.getElementById('contaObservacoes').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('contas').doc(editingId).update(contaData);
                } else {
                    await db.collection('contas').add(contaData);
                }
                await loadSystemData();
                closeContaModal();
                if (currentModule === 'contas') {
                    loadContasContent();
                }
                alert('Conta salva com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar conta:', error);
                alert('Erro ao salvar conta. Tente novamente.');
            }
        });
        function editConta(id) {
            const conta = contas.find(c => c.id === id);
            if (!conta) return;
            document.getElementById('contaModalTitle').textContent = 'Editar Conta a Pagar';
            document.getElementById('editingContaId').value = conta.id;
            document.getElementById('contaDescricao').value = conta.descricao;
            document.getElementById('contaValor').value = conta.valor;
            document.getElementById('contaVencimento').value = conta.vencimento;
            document.getElementById('contaCategoria').value = conta.categoria;
            document.getElementById('contaFornecedor').value = conta.fornecedor || '';
            document.getElementById('contaStatus').value = conta.status;
            document.getElementById('contaObservacoes').value = conta.observacoes || '';
            document.getElementById('contaModal').style.display = 'flex';
        }
        async function deleteConta(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir esta conta?')) return;
            try {
                await db.collection('contas').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'contas') {
                    loadContasContent();
                }
                alert('Conta excluída com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir conta:', error);
                alert('Erro ao excluir conta. Tente novamente.');
            }
        }
        async function marcarContaComoPaga(id) {
            try {
                await db.collection('contas').doc(id).update({
                    status: 'pago',
                    dataAtualizacao: new Date().toISOString()
                });
                await loadSystemData();
                if (currentModule === 'contas') {
                    loadContasContent();
                } else if (currentModule === 'dashboard') {
                    loadDashboardContent();
                }
                alert('Conta marcada como paga com sucesso!');
            } catch (error) {
                console.error('Erro ao marcar conta como paga:', error);
                alert('Erro ao marcar conta como paga. Tente novamente.');
            }
        }
        // ========== FUNÇÕES DE LEMBRETES ==========
        function openLembreteModal() {
            document.getElementById('lembreteModalTitle').textContent = 'Novo Lembrete';
            document.getElementById('editingLembreteId').value = '';
            document.getElementById('lembreteForm').reset();
            document.getElementById('lembreteDataInicio').value = getCurrentDate();
            document.getElementById('lembreteDataFim').value = '';
            document.getElementById('lembretePrioridade').value = 'media';
            document.getElementById('lembreteModal').style.display = 'flex';
        }
        function closeLembreteModal() {
            document.getElementById('lembreteModal').style.display = 'none';
        }
        document.getElementById('lembreteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condomínio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingLembreteId').value;
            const lembreteData = {
                titulo: document.getElementById('lembreteTitulo').value,
                descricao: document.getElementById('lembreteDescricao').value,
                dataInicio: document.getElementById('lembreteDataInicio').value,
                dataFim: document.getElementById('lembreteDataFim').value || null,
                prioridade: document.getElementById('lembretePrioridade').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id,
                criadoPorNome: currentUser.nome || currentUser.usuario,
            };
            try {
                if (editingId) {
                    await db.collection('lembretes').doc(editingId).update(lembreteData);
                } else {
                    await db.collection('lembretes').add(lembreteData);
                }
                await loadSystemData();
                closeLembreteModal();
                if (currentModule === 'dashboard') {
                    loadDashboardContent();
                }
                loadTickerContent();
                alert('Lembrete salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar lembrete:', error);
                alert('Erro ao salvar lembrete. Tente novamente.');
            }
        });
        function editLembrete(id) {
            const lembrete = lembretes.find(l => l.id === id);
            if (!lembrete) return;
            document.getElementById('lembreteModalTitle').textContent = 'Editar Lembrete';
            document.getElementById('editingLembreteId').value = lembrete.id;
            document.getElementById('lembreteTitulo').value = lembrete.titulo;
            document.getElementById('lembreteDescricao').value = lembrete.descricao || '';
            document.getElementById('lembreteDataInicio').value = lembrete.dataInicio;
            document.getElementById('lembreteDataFim').value = lembrete.dataFim || '';
            document.getElementById('lembretePrioridade').value = lembrete.prioridade || 'media';
            document.getElementById('lembreteModal').style.display = 'flex';
        }
        async function deleteLembrete(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este lembrete?')) return;
            try {
                await db.collection('lembretes').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'dashboard') {
                    loadDashboardContent();
                }
                loadTickerContent();
                alert('Lembrete excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir lembrete:', error);
                alert('Erro ao excluir lembrete. Tente novamente.');
            }
        }
        // ========== FUNÇÕES DE LIMPEZA ==========
        function openLimpezaModal() {
            document.getElementById('limpezaModalTitle').textContent = 'Novo Registro de Limpeza';
            document.getElementById('editingLimpezaId').value = '';
            document.getElementById('limpezaForm').reset();
            document.getElementById('limpezaData').value = getCurrentDate();
            const now = new Date();
            document.getElementById('limpezaHoraInicio').value = now.toTimeString().substring(0, 5);
            document.getElementById('limpezaStatus').value = 'em-andamento';
            document.getElementById('btnConcluirLimpeza').style.display = 'none';
            document.getElementById('limpezaModal').style.display = 'flex';
        }
        function closeLimpezaModal() {
            document.getElementById('limpezaModal').style.display = 'none';
        }
        function editLimpeza(id) {
            const limpeza = limpezas.find(l => l.id === id);
            if (!limpeza) return;
            document.getElementById('limpezaModalTitle').textContent = 'Editar Registro de Limpeza';
            document.getElementById('editingLimpezaId').value = limpeza.id;
            document.getElementById('limpezaResponsavel').value = limpeza.responsavel;
            document.getElementById('limpezaEspaco').value = limpeza.espaco;
            document.getElementById('limpezaData').value = limpeza.data;
            document.getElementById('limpezaHoraInicio').value = limpeza.horaInicio;
            document.getElementById('limpezaHoraFim').value = limpeza.horaFim || '';
            document.getElementById('limpezaTempoUso').value = limpeza.tempoUso || '';
            document.getElementById('limpezaObservacoes').value = limpeza.observacoes || '';
            document.getElementById('limpezaStatus').value = limpeza.status;
            if (limpeza.status !== 'concluido') {
                document.getElementById('btnConcluirLimpeza').style.display = 'inline-block';
            } else {
                document.getElementById('btnConcluirLimpeza').style.display = 'none';
            }
            document.getElementById('limpezaModal').style.display = 'flex';
        }
        document.getElementById('limpezaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condomínio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingLimpezaId').value;
            const limpezaData = {
                responsavel: document.getElementById('limpezaResponsavel').value,
                espaco: document.getElementById('limpezaEspaco').value,
                data: document.getElementById('limpezaData').value,
                horaInicio: document.getElementById('limpezaHoraInicio').value,
                horaFim: document.getElementById('limpezaHoraFim').value,
                tempoUso: document.getElementById('limpezaTempoUso').value,
                observacoes: document.getElementById('limpezaObservacoes').value,
                status: document.getElementById('limpezaStatus').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('limpezas').doc(editingId).update(limpezaData);
                } else {
                    await db.collection('limpezas').add(limpezaData);
                }
                await loadSystemData();
                closeLimpezaModal();
                if (currentModule === 'limpeza') {
                    loadLimpezaContent();
                }
                alert('Registro de limpeza salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar registro de limpeza:', error);
                alert('Erro ao salvar registro de limpeza. Tente novamente.');
            }
        });
        async function concluirLimpeza(id = null) {
            let limpezaId = id || document.getElementById('editingLimpezaId').value;
            if (!limpezaId) {
                alert('Nenhum registro de limpeza selecionado!');
                return;
            }
            const horaFim = new Date().toTimeString().substring(0, 5);
            const limpeza = limpezas.find(l => l.id === limpezaId);
            if (!limpeza) {
                alert('Registro de limpeza não encontrado!');
                return;
            }
            const inicio = new Date(`2000-01-01T${limpeza.horaInicio}`);
            const fim = new Date(`2000-01-01T${horaFim}`);
            const tempoUso = Math.round((fim - inicio) / (1000 * 60));
            try {
                await db.collection('limpezas').doc(limpezaId).update({
                    horaFim: horaFim,
                    tempoUso: tempoUso,
                    status: 'concluido',
                    dataAtualizacao: new Date().toISOString()
                });
                await loadSystemData();
                closeLimpezaModal();
                if (currentModule === 'limpeza') {
                    loadLimpezaContent();
                }
                alert('Limpeza concluída com sucesso! Tempo de uso: ' + tempoUso + ' minutos');
            } catch (error) {
                console.error('Erro ao concluir limpeza:', error);
                alert('Erro ao concluir limpeza. Tente novamente.');
            }
        }
        async function deleteLimpeza(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este registro de limpeza?')) return;
            try {
                await db.collection('limpezas').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'limpeza') {
                    loadLimpezaContent();
                }
                alert('Registro de limpeza excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir registro de limpeza:', error);
                alert('Erro ao excluir registro de limpeza. Tente novamente.');
            }
        }
        // ========== FUNÇÕES DE SAUNA ==========
        function openSaunaModal() {
            document.getElementById('saunaModalTitle').textContent = 'Novo Agendamento de Sauna';
            document.getElementById('editingSaunaId').value = '';
            document.getElementById('saunaForm').reset();
            document.getElementById('saunaData').value = getCurrentDate();
            document.getElementById('saunaTipo').value = 'umida';
            document.getElementById('saunaStatus').value = 'agendado';
            document.getElementById('btnConcluirSauna').style.display = 'none';
            document.getElementById('saunaModal').style.display = 'flex';
        }
        function closeSaunaModal() {
            document.getElementById('saunaModal').style.display = 'none';
        }
        function editSauna(id) {
            const sauna = saunas.find(s => s.id === id);
            if (!sauna) return;
            document.getElementById('saunaModalTitle').textContent = 'Editar Agendamento de Sauna';
            document.getElementById('editingSaunaId').value = sauna.id;
            document.getElementById('saunaMorador').value = sauna.morador;
            document.getElementById('saunaApto').value = sauna.apto;
            document.getElementById('saunaTipo').value = sauna.tipo || 'umida';
            document.getElementById('saunaData').value = sauna.data;
            document.getElementById('saunaHoraInicio').value = sauna.horaInicio;
            document.getElementById('saunaHoraFim').value = sauna.horaFim || '';
            document.getElementById('saunaTempoUso').value = sauna.tempoUso || '';
            document.getElementById('saunaObservacoes').value = sauna.observacoes || '';
            document.getElementById('saunaStatus').value = sauna.status;
            if (sauna.status === 'em-uso') {
                document.getElementById('btnConcluirSauna').style.display = 'inline-block';
            } else {
                document.getElementById('btnConcluirSauna').style.display = 'none';
            }
            document.getElementById('saunaModal').style.display = 'flex';
        }
        document.getElementById('saunaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condomínio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingSaunaId').value;
            const saunaData = {
                morador: document.getElementById('saunaMorador').value,
                apto: document.getElementById('saunaApto').value,
                tipo: document.getElementById('saunaTipo').value,
                data: document.getElementById('saunaData').value,
                horaInicio: document.getElementById('saunaHoraInicio').value,
                horaFim: document.getElementById('saunaHoraFim').value,
                tempoUso: document.getElementById('saunaTempoUso').value,
                observacoes: document.getElementById('saunaObservacoes').value,
                status: document.getElementById('saunaStatus').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('saunas').doc(editingId).update(saunaData);
                } else {
                    await db.collection('saunas').add(saunaData);
                }
                await loadSystemData();
                closeSaunaModal();
                if (currentModule === 'sauna') {
                    loadSaunaContent();
                }
                alert('Agendamento de sauna salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar agendamento de sauna:', error);
                alert('Erro ao salvar agendamento de sauna. Tente novamente.');
            }
        });
        async function iniciarSauna(id) {
            try {
                await db.collection('saunas').doc(id).update({
                    status: 'em-uso',
                    dataAtualizacao: new Date().toISOString()
                });
                await loadSystemData();
                if (currentModule === 'sauna') {
                    loadSaunaContent();
                }
                alert('Uso da sauna iniciado!');
            } catch (error) {
                console.error('Erro ao iniciar sauna:', error);
                alert('Erro ao iniciar sauna. Tente novamente.');
            }
        }
        async function concluirSauna(id = null) {
            let saunaId = id || document.getElementById('editingSaunaId').value;
            if (!saunaId) {
                alert('Nenhum agendamento de sauna selecionado!');
                return;
            }
            const horaFim = new Date().toTimeString().substring(0, 5);
            const sauna = saunas.find(s => s.id === saunaId);
            if (!sauna) {
                alert('Agendamento de sauna não encontrado!');
                return;
            }
            const inicio = new Date(`2000-01-01T${sauna.horaInicio}`);
            const fim = new Date(`2000-01-01T${horaFim}`);
            const tempoUso = Math.round((fim - inicio) / (1000 * 60));
            try {
                await db.collection('saunas').doc(saunaId).update({
                    horaFim: horaFim,
                    tempoUso: tempoUso,
                    status: 'concluido',
                    dataAtualizacao: new Date().toISOString()
                });
                await loadSystemData();
                closeSaunaModal();
                if (currentModule === 'sauna') {
                    loadSaunaContent();
                }
                alert('Uso da sauna concluído com sucesso! Tempo de uso: ' + tempoUso + ' minutos');
            } catch (error) {
                console.error('Erro ao concluir sauna:', error);
                alert('Erro ao concluir sauna. Tente novamente.');
            }
        }
        async function deleteSauna(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este agendamento de sauna?')) return;
            try {
                await db.collection('saunas').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'sauna') {
                    loadSaunaContent();
                }
                alert('Agendamento de sauna excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir agendamento de sauna:', error);
                alert('Erro ao excluir agendamento de sauna. Tente novamente.');
            }
        }
        // ========== FUNÇÕES DE USUÁRIOS ==========
        function openUserModal() {
            document.getElementById('userModalTitle').textContent = 'Cadastrar Usuário';
            document.getElementById('editingUserId').value = '';
            document.getElementById('userForm').reset();
            document.getElementById('userSenha').required = true;
            document.getElementById('senhaObrigatoria').style.display = 'inline';
            document.getElementById('senhaInfo').style.display = 'none';
            loadCondominiosForPermissions();
            loadModulesForPermissions();
            document.getElementById('userModal').style.display = 'flex';
        }
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }
        function loadCondominiosForPermissions() {
            const container = document.getElementById('condominiosPermitidos');
            container.innerHTML = '';
            condominios.forEach(condominio => {
                const item = document.createElement('div');
                item.className = 'permission-item';
                item.innerHTML = `
                    <input type="checkbox" id="condominio-${condominio.id}" value="${condominio.id}">
                    <label for="condominio-${condominio.id}">${condominio.nome}</label>
                `;
                container.appendChild(item);
            });
        }
        function loadModulesForPermissions() {
            const container = document.getElementById('permissoesUsuario');
            container.innerHTML = '';
            modules.forEach(module => {
                const item = document.createElement('div');
                item.className = 'permission-item';
                item.innerHTML = `
                    <input type="checkbox" id="module-${module.id}" value="${module.id}">
                    <label for="module-${module.id}">${module.name}</label>
                `;
                container.appendChild(item);
            });
        }
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const editingId = document.getElementById('editingUserId').value;
            const userData = {
                nome: document.getElementById('userNome').value,
                usuario: document.getElementById('userUsuario').value,
                email: document.getElementById('userEmail').value,
                telefone: document.getElementById('userTelefone').value,
                tipo: document.getElementById('userTipo').value,
                status: 'ativo',
                criadoPor: currentUser.id || currentUser.usuario,
                dataAtualizacao: new Date().toISOString()
            };
            const senha = document.getElementById('userSenha').value;
            if (!editingId || senha) {
                userData.senha = senha;
            }
            if (!editingId) {
                userData.dataCriacao = new Date().toISOString();
            }
            const condominiosPermitidos = [];
            document.querySelectorAll('#condominiosPermitidos input:checked').forEach(checkbox => {
                condominiosPermitidos.push(checkbox.value);
            });
            userData.condominios = condominiosPermitidos;
            const modulosPermitidos = [];
            document.querySelectorAll('#permissoesUsuario input:checked').forEach(checkbox => {
                modulosPermitidos.push(checkbox.value);
            });
            userData.permissoes = modulosPermitidos;
            try {
                if (editingId) {
                    await db.collection('usuarios').doc(editingId).update(userData);
                } else {
                    await db.collection('usuarios').add(userData);
                }
                await loadSystemData();
                closeUserModal();
                if (currentModule === 'usuarios') {
                    loadUsuariosContent();
                }
                alert('Usuário salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar usuário:', error);
                alert('Erro ao salvar usuário. Tente novamente.');
            }
        });
        function editUser(id) {
            const usuario = usuarios.find(u => u.id === id);
            if (!usuario) return;
            document.getElementById('userModalTitle').textContent = 'Editar Usuário';
            document.getElementById('editingUserId').value = usuario.id;
            document.getElementById('userNome').value = usuario.nome;
            document.getElementById('userUsuario').value = usuario.usuario;
            document.getElementById('userEmail').value = usuario.email || '';
            document.getElementById('userTelefone').value = usuario.telefone || '';
            document.getElementById('userSenha').value = '';
            document.getElementById('userSenha').required = false;
            document.getElementById('senhaObrigatoria').style.display = 'none';
            document.getElementById('senhaInfo').style.display = 'block';
            loadCondominiosForPermissions();
            if (usuario.condominios) {
                usuario.condominios.forEach(condominioId => {
                    const checkbox = document.getElementById(`condominio-${condominioId}`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            loadModulesForPermissions();
            if (usuario.permissoes) {
                usuario.permissoes.forEach(moduleId => {
                    const checkbox = document.getElementById(`module-${moduleId}`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            document.getElementById('userModal').style.display = 'flex';
        }
        async function deleteUser(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este usuário?')) return;
            try {
                await db.collection('usuarios').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'usuarios') {
                    loadUsuariosContent();
                }
                alert('Usuário excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir usuário:', error);
                alert('Erro ao excluir usuário. Tente novamente.');
            }
        }
        // ========== FUNÇÕES DE CONDOMÍNIOS ==========
        function openCondominioModal() {
            document.getElementById('condominioModalTitle').textContent = 'Cadastrar Condomínio';
            document.getElementById('editingCondominioId').value = '';
            document.getElementById('condominioForm').reset();
            document.getElementById('condominioModal').style.display = 'flex';
        }
        function closeCondominioModal() {
            document.getElementById('condominioModal').style.display = 'none';
        }
        document.getElementById('condominioForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const editingId = document.getElementById('editingCondominioId').value;
            const condominioData = {
                nome: document.getElementById('condominioNome').value,
                endereco: document.getElementById('condominioEndereco').value,
                cidade: document.getElementById('condominioCidade').value,
                estado: document.getElementById('condominioEstado').value,
                cep: document.getElementById('condominioCEP').value,
                telefone: document.getElementById('condominioTelefone').value,
                cnpj: document.getElementById('condominioCNPJ').value,
                unidades: parseInt(document.getElementById('condominioUnidades').value) || 0,
                status: document.getElementById('condominioStatus').value,
                criadoPor: currentUser.id || currentUser.usuario,
                dataAtualizacao: new Date().toISOString()
            };
            if (!editingId) {
                condominioData.dataCriacao = new Date().toISOString();
            }
            try {
                if (editingId) {
                    await db.collection('condominios').doc(editingId).update(condominioData);
                } else {
                    await db.collection('condominios').add(condominioData);
                }
                await loadSystemData();
                closeCondominioModal();
                if (currentModule === 'condominios') {
                    loadCondominiosContent();
                }
                alert('Condomínio salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar condomínio:', error);
                alert('Erro ao salvar condomínio. Tente novamente.');
            }
        });
        function editCondominio(id) {
            const condominio = condominios.find(c => c.id === id);
            if (!condominio) return;
            document.getElementById('condominioModalTitle').textContent = 'Editar Condomínio';
            document.getElementById('editingCondominioId').value = condominio.id;
            document.getElementById('condominioNome').value = condominio.nome;
            document.getElementById('condominioEndereco').value = condominio.endereco;
            document.getElementById('condominioCidade').value = condominio.cidade;
            document.getElementById('condominioEstado').value = condominio.estado;
            document.getElementById('condominioCEP').value = condominio.cep || '';
            document.getElementById('condominioTelefone').value = condominio.telefone || '';
            document.getElementById('condominioCNPJ').value = condominio.cnpj || '';
            document.getElementById('condominioUnidades').value = condominio.unidades || '';
            document.getElementById('condominioStatus').value = condominio.status || 'ativo';
            document.getElementById('condominioModal').style.display = 'flex';
        }
        async function deleteCondominio(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este condomínio?')) return;
            try {
                await db.collection('condominios').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'condominios') {
                    loadCondominiosContent();
                }
                alert('Condomínio excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir condomínio:', error);
                alert('Erro ao excluir condomínio. Tente novamente.');
            }
        }
        // ========== FUNÇÕES PARA MORADORES ==========
        function openMoradorModal() {
            document.getElementById('moradorModalTitle').textContent = 'Cadastrar Morador';
            document.getElementById('editingMoradorId').value = '';
            document.getElementById('moradorForm').reset();
            document.getElementById('moradorModal').style.display = 'flex';
        }
        function closeMoradorModal() {
            document.getElementById('moradorModal').style.display = 'none';
        }
        document.getElementById('moradorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condomínio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingMoradorId').value;
            const moradorData = {
                nome: document.getElementById('moradorNome').value,
                apto: document.getElementById('moradorApto').value,
                telefone: document.getElementById('moradorTelefone').value,
                garagem: document.getElementById('moradorGaragem').value,
                vaga: document.getElementById('moradorVaga').value,
                observacoes: document.getElementById('moradorObservacoes').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('moradores').doc(editingId).update(moradorData);
                } else {
                    await db.collection('moradores').add(moradorData);
                }
                await loadSystemData();
                closeMoradorModal();
                if (currentModule === 'moradores') {
                    loadMoradoresContent();
                }
                alert('Morador salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar morador:', error);
                alert('Erro ao salvar morador. Tente novamente.');
            }
        });
        function editMorador(id) {
            const morador = moradores.find(m => m.id === id);
            if (!morador) return;
            document.getElementById('moradorModalTitle').textContent = 'Editar Morador';
            document.getElementById('editingMoradorId').value = morador.id;
            document.getElementById('moradorNome').value = morador.nome;
            document.getElementById('moradorApto').value = morador.apto;
            document.getElementById('moradorTelefone').value = morador.telefone || '';
            document.getElementById('moradorGaragem').value = morador.garagem || '';
            document.getElementById('moradorVaga').value = morador.vaga || '';
            document.getElementById('moradorObservacoes').value = morador.observacoes || '';
            document.getElementById('moradorModal').style.display = 'flex';
        }
        async function deleteMorador(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este morador?')) return;
            try {
                await db.collection('moradores').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'moradores') {
                    loadMoradoresContent();
                }
                alert('Morador excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir morador:', error);
                alert('Erro ao excluir morador. Tente novamente.');
            }
        }
        // ========== PRESENCE SYSTEM ==========
        function setupPresence() {
            if (!currentUser) return;
            const userPresenceRef = db.collection('presence').doc(currentUser.id);
            presenceRef = userPresenceRef;
            const onClose = () => {
                if (presenceRef) {
                    presenceRef.update({ 
                        online: false,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            };
            userPresenceRef.set({
                userId: currentUser.id,
                nome: currentUser.nome || currentUser.usuario,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                online: true
            }, { merge: true });
            const keepAlive = setInterval(() => {
                if (presenceRef) {
                    presenceRef.update({
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                        online: true
                    });
                }
            }, 30000);
            window.addEventListener('beforeunload', onClose);
            window.addEventListener('pagehide', onClose);
            window.addEventListener('beforeunload', () => {
                clearInterval(keepAlive);
            });
        }
        async function updateOnlineCount() {
            try {
                const cutoff = new Date(Date.now() - 60000);
                const snapshot = await db.collection('presence')
                    .where('lastSeen', '>=', firebase.firestore.Timestamp.fromDate(cutoff))
                    .where('online', '==', true)
                    .get();
                const onlineUsers = [];
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.userId !== currentUser.id) {
                        onlineUsers.push(userData);
                    }
                });
                const count = onlineUsers.length;
                document.getElementById('onlineCount').textContent = count;
                if (count > 0) {
                    const userNames = onlineUsers.map(user => user.nome).join(', ');
                    document.querySelector('.online-indicator').title = `Online: ${userNames}`;
                }
            } catch (error) {
                console.error('Erro ao atualizar contagem online:', error);
                document.getElementById('onlineCount').textContent = '0';
            }
        }
        function showOnlineUsers() {
            const cutoff = new Date(Date.now() - 60000);
            db.collection('presence')
                .where('lastSeen', '>=', firebase.firestore.Timestamp.fromDate(cutoff))
                .where('online', '==', true)
                .get()
                .then(snapshot => {
                    const onlineUsers = [];
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        onlineUsers.push(userData.nome);
                    });
                    if (onlineUsers.length > 0) {
                        alert(`Usuários Online:
${onlineUsers.join('\n')}`);
                    } else {
                        alert('Nenhum outro usuário online no momento.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar usuários online:', error);
                    alert('Erro ao carregar lista de usuários online.');
                });
        }
        // ========== REALTIME LISTENERS ==========
        function setupRealtimeListeners() {
            const globalCollections = ['usuarios', 'condominios'];
            globalCollections.forEach(collection => {
                db.collection(collection).onSnapshot(() => {
                    if (document.getElementById('mainSystem').style.display !== 'none') {
                        loadSystemData().then(() => {
                            if (currentModule) loadModuleContent(currentModule);
                            loadTickerContent();
                        });
                    }
                });
            });
            if (currentCondominio) {
                const condominioCollections = ['moradores', 'horasExtras', 'limpezas', 'saunas', 'agendamentos', 'contas', 'lembretes', 'ocorrencias', 'prestadores'];
                condominioCollections.forEach(collection => {
                    db.collection(collection)
                        .where('condominioId', '==', currentCondominio.id)
                        .onSnapshot(() => {
                            if (document.getElementById('mainSystem').style.display !== 'none') {
                                loadSystemData().then(() => {
                                    if (currentModule) loadModuleContent(currentModule);
                                    loadTickerContent();
                                });
                            }
                        });
                });
            }
            db.collection('presence').onSnapshot(() => {
                updateOnlineCount();
            });
        }
        // ========== FUNÇÕES DE LOGIN ==========
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            document.getElementById('loginBtnText').style.display = 'none';
            document.getElementById('loginLoading').style.display = 'inline-block';
            document.getElementById('loginBtn').disabled = true;
            try {
                const usuariosSnapshot = await db.collection('usuarios').where('usuario', '==', username).get();
                if (usuariosSnapshot.empty) {
                    throw new Error('Usuário não encontrado');
                }
                let userFound = null;
                usuariosSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.senha === password) {
                        userFound = {
                            id: doc.id,
                            ...userData
                        };
                    }
                });
                if (!userFound) {
                    throw new Error('Senha incorreta');
                }
                if (password === 'admin123' || password === '0000') {
                    currentUser = userFound;
                    document.getElementById('changePasswordModal').style.display = 'flex';
                } else {
                    currentUser = userFound;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    await loadSystemData();
                    showMainSystem();
                    setupPresence();
                    setupRealtimeListeners();
                    setInterval(updateOnlineCount, 10000);
                }
            } catch (error) {
                console.error('Erro no login:', error);
                document.getElementById('loginStatus').textContent = error.message || 'Erro ao fazer login';
                document.getElementById('loginStatus').style.color = 'red';
            } finally {
                document.getElementById('loginBtnText').style.display = 'inline';
                document.getElementById('loginLoading').style.display = 'none';
                document.getElementById('loginBtn').disabled = false;
            }
        });
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (newPassword !== confirmPassword) {
                alert('As senhas não coincidem!');
                return;
            }
            if (newPassword.length < 6) {
                alert('A senha deve ter pelo menos 6 caracteres!');
                return;
            }
            try {
                await db.collection('usuarios').doc(currentUser.id).update({
                    senha: newPassword,
                    primeiroLogin: false
                });
                document.getElementById('changePasswordModal').style.display = 'none';
                currentUser.senha = newPassword;
                currentUser.primeiroLogin = false;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                await loadSystemData();
                showMainSystem();
                setupPresence();
                setupRealtimeListeners();
                setInterval(updateOnlineCount, 10000);
                alert('Senha alterada com sucesso!');
            } catch (error) {
                console.error('Erro ao alterar senha:', error);
                alert('Erro ao alterar senha. Tente novamente.');
            }
        });
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('Deseja realmente sair do sistema?')) {
                if (presenceRef) {
                    presenceRef.update({ 
                        online: false,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                localStorage.removeItem('currentUser');
                currentUser = null;
                currentCondominio = null;
                showLoginPage();
            }
        });
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            if (sidebar.style.width === '280px' || sidebar.style.width === '') {
                sidebar.style.width = '70px';
                mainContent.style.marginLeft = '70px';
            } else {
                sidebar.style.width = '280px';
                mainContent.style.marginLeft = '280px';
            }
        });
        async function handleCondominioChange(condominioId) {
            if (!condominioId) {
                currentCondominio = null;
            } else {
                currentCondominio = condominios.find(c => c.id === condominioId);
            }
            const condominioSelectTop = document.getElementById('condominioSelectTop');
            const currentCondominioBadge = document.getElementById('currentCondominioBadge');
            if (condominioSelectTop) condominioSelectTop.value = condominioId || '';
            if (currentCondominioBadge) {
                currentCondominioBadge.textContent = currentCondominio ? currentCondominio.nome : 'Nenhum condomínio selecionado';
            }
            await loadSystemData();
            if (currentModule) {
                loadModuleContent(currentModule);
            }
            loadTickerContent();
        }
        // Evento de mudança no seletor da top bar
        document.getElementById('condominioSelectTop').addEventListener('change', function() {
            handleCondominioChange(this.value);
        });
        // ========== FUNÇÕES DE RELATÓRIOS ==========
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            let reportContent = '';
            switch(reportType) {
                case 'agendamentos':
                    reportContent = generateAgendamentosReport(startDate, endDate);
                    break;
                case 'usuarios':
                    reportContent = generateUsuariosReport();
                    break;
                case 'moradores':
                    reportContent = generateMoradoresReport();
                    break;
                case 'limpeza':
                    reportContent = generateLimpezaReport(startDate, endDate);
                    break;
                case 'horas-extras':
                    reportContent = generateHorasExtrasReport(startDate, endDate);
                    break;
                case 'sauna':
                    reportContent = generateSaunaReport(startDate, endDate);
                    break;
                case 'contas':
                    reportContent = generateContasReport(startDate, endDate);
                    break;
            }
            document.getElementById('reportPreview').innerHTML = reportContent;
        }
        function generateAgendamentosReport(startDate, endDate) {
            let filteredAgendamentos = agendamentos.filter(a => 
                a.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (startDate) {
                filteredAgendamentos = filteredAgendamentos.filter(a => a.data >= startDate);
            }
            if (endDate) {
                filteredAgendamentos = filteredAgendamentos.filter(a => a.data <= endDate);
            }
            let report = `<h4>Relatório de Agendamentos</h4>`;
            report += `<p>Período: ${startDate || 'Início'} a ${endDate || 'Fim'}</p>`;
            report += `<p>Condomínio: ${currentCondominio ? currentCondominio.nome : 'Todos'}</p>`;
            report += `<p>Total de agendamentos: ${filteredAgendamentos.length}</p>`;
            report += `<div class="report-line"><strong>Data | Espaço | Solicitante | Unidade | Horário | Status</strong></div>`;
            filteredAgendamentos.forEach(agendamento => {
                report += `<div class="report-line">`;
                report += `${formatDate(agendamento.data)} | `;
                report += `${getEspacoNome(agendamento.espaco)} | `;
                report += `${agendamento.responsavel} | `;
                report += `${agendamento.unidade} | `;
                report += `${agendamento.horaInicio}-${agendamento.horaFim} | `;
                report += `${formatStatusAgendamento(agendamento.status)}`;
                report += `</div>`;
            });
            return report;
        }
        function generateUsuariosReport() {
            let report = `<h4>Relatório de Usuários</h4>`;
            report += `<p>Total de usuários: ${usuarios.length}</p>`;
            report += `<div class="report-line"><strong>Nome | Usuário | Tipo | E-mail | Status</strong></div>`;
            usuarios.forEach(usuario => {
                report += `<div class="report-line">`;
                report += `${usuario.nome} | `;
                report += `${usuario.usuario} | `;
                report += `${formatUserType(usuario.tipo)} | `;
                report += `${usuario.email || 'N/A'} | `;
                report += `${usuario.status === 'ativo' ? 'Ativo' : 'Inativo'}`;
                report += `</div>`;
            });
            return report;
        }
        function generateMoradoresReport() {
            const filteredMoradores = currentCondominio ? 
                moradores.filter(m => m.condominioId === currentCondominio.id) : 
                moradores;
            let report = `<h4>Relatório de Moradores</h4>`;
            report += `<p>Condomínio: ${currentCondominio ? currentCondominio.nome : 'Todos'}</p>`;
            report += `<p>Total de moradores: ${filteredMoradores.length}</p>`;
            report += `<div class="report-line"><strong>Morador | Apartamento | Telefone | Garagem | Vaga</strong></div>`;
            filteredMoradores.forEach(morador => {
                report += `<div class="report-line">`;
                report += `${morador.nome} | `;
                report += `${morador.apto} | `;
                report += `${morador.telefone || '-'} | `;
                report += `${morador.garagem || '-'} | `;
                report += `${morador.vaga || '-'}`;
                report += `</div>`;
            });
            return report;
        }
        function generateLimpezaReport(startDate, endDate) {
            let filteredLimpezas = limpezas.filter(l => 
                l.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (startDate) {
                filteredLimpezas = filteredLimpezas.filter(l => l.data >= startDate);
            }
            if (endDate) {
                filteredLimpezas = filteredLimpezas.filter(l => l.data <= endDate);
            }
            let report = `<h4>Relatório de Limpeza</h4>`;
            report += `<p>Período: ${startDate || 'Início'} a ${endDate || 'Fim'}</p>`;
            report += `<p>Condomínio: ${currentCondominio ? currentCondominio.nome : 'Todos'}</p>`;
            report += `<p>Total de registros: ${filteredLimpezas.length}</p>`;
            report += `<div class="report-line"><strong>Data | Responsável | Espaço | Horário | Tempo | Status</strong></div>`;
            filteredLimpezas.forEach(limpeza => {
                report += `<div class="report-line">`;
                report += `${formatDate(limpeza.data)} | `;
                report += `${limpeza.responsavel} | `;
                report += `${getEspacoNome(limpeza.espaco)} | `;
                report += `${limpeza.horaInicio} ${limpeza.horaFim ? '-' + limpeza.horaFim : ''} | `;
                report += `${limpeza.tempoUso || '-'} min | `;
                report += `${limpeza.status === 'concluido' ? 'Concluído' : 'Em Andamento'}`;
                report += `</div>`;
            });
            return report;
        }
        function generateHorasExtrasReport(startDate, endDate) {
            let filteredHorasExtras = horasExtras.filter(h => 
                h.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (startDate) {
                filteredHorasExtras = filteredHorasExtras.filter(h => h.data >= startDate);
            }
            if (endDate) {
                filteredHorasExtras = filteredHorasExtras.filter(h => h.data <= endDate);
            }
            const totalHoras = filteredHorasExtras.reduce((sum, h) => sum + h.quantidade, 0);
            let report = `<h4>Relatório de Horas Extras</h4>`;
            report += `<p>Período: ${startDate || 'Início'} a ${endDate || 'Fim'}</p>`;
            report += `<p>Condomínio: ${currentCondominio ? currentCondominio.nome : 'Todos'}</p>`;
            report += `<p>Total de registros: ${filteredHorasExtras.length}</p>`;
            report += `<p>Total de horas: ${totalHoras}</p>`;
            report += `<div class="report-line"><strong>Data | Funcionário | Matrícula | Quantidade (h) | Condomínio</strong></div>`;
            filteredHorasExtras.forEach(horaExtra => {
                report += `<div class="report-line">`;
                report += `${formatDate(horaExtra.data)} | `;
                report += `${horaExtra.funcionario} | `;
                report += `${horaExtra.matricula} | `;
                report += `${horaExtra.quantidade} | `;
                report += `${horaExtra.condominioNome}`;
                report += `</div>`;
            });
            return report;
        }
        function generateSaunaReport(startDate, endDate) {
            let filteredSaunas = saunas.filter(s => 
                s.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (startDate) {
                filteredSaunas = filteredSaunas.filter(s => s.data >= startDate);
            }
            if (endDate) {
                filteredSaunas = filteredSaunas.filter(s => s.data <= endDate);
            }
            let report = `<h4>Relatório de Sauna</h4>`;
            report += `<p>Período: ${startDate || 'Início'} a ${endDate || 'Fim'}</p>`;
            report += `<p>Condomínio: ${currentCondominio ? currentCondominio.nome : 'Todos'}</p>`;
            report += `<p>Total de agendamentos: ${filteredSaunas.length}</p>`;
            report += `<div class="report-line"><strong>Data | Morador | Apartamento | Horário | Tempo | Status</strong></div>`;
            filteredSaunas.forEach(sauna => {
                report += `<div class="report-line">`;
                report += `${formatDate(sauna.data)} | `;
                report += `${sauna.morador} | `;
                report += `${sauna.apto} | `;
                report += `${sauna.horaInicio} ${sauna.horaFim ? '-' + sauna.horaFim : ''} | `;
                report += `${sauna.tempoUso || '-'} min | `;
                report += `${formatStatusSauna(sauna.status)}`;
                report += `</div>`;
            });
            return report;
        }
        function generateContasReport(startDate, endDate) {
            let filteredContas = contas.filter(c => 
                c.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (startDate) {
                filteredContas = filteredContas.filter(c => c.vencimento >= startDate);
            }
            if (endDate) {
                filteredContas = filteredContas.filter(c => c.vencimento <= endDate);
            }
            const total = filteredContas.reduce((sum, conta) => sum + conta.valor, 0);
            let report = `<h4>Relatório de Contas a Pagar</h4>`;
            report += `<p>Período: ${startDate || 'Início'} a ${endDate || 'Fim'}</p>`;
            report += `<p>Condomínio: ${currentCondominio ? currentCondominio.nome : 'Todos'}</p>`;
            report += `<p>Total de contas: ${filteredContas.length}</p>`;
            report += `<p>Valor total: R$ ${total.toFixed(2)}</p>`;
            report += `<div class="report-line"><strong>Vencimento | Descrição | Valor | Categoria | Status</strong></div>`;
            filteredContas.forEach(conta => {
                report += `<div class="report-line">`;
                report += `${formatDate(conta.vencimento)} | `;
                report += `${conta.descricao} | `;
                report += `R$ ${conta.valor.toFixed(2)} | `;
                report += `${formatCategoriaConta(conta.categoria)} | `;
                report += `${formatStatusConta(conta.status)}`;
                report += `</div>`;
            });
            return report;
        }
        function exportReport() {
            const reportPreview = document.getElementById('reportPreview').innerText;
            const blob = new Blob([reportPreview], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'relatorio.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        // ========== FUNÇÕES DE ORDENAÇÃO PARA MORADORES ==========
        let currentMoradoresSort = { field: 'apto', direction: 'asc' };
        function loadMoradoresTableData(moradoresArray) {
            const tbody = document.getElementById('moradoresTbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            moradoresArray.forEach(morador => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${morador.nome}</td>
                    <td>${morador.apto}</td>
                    <td>${morador.telefone || '-'}</td>
                    <td>${morador.garagem || '-'}</td>
                    <td>${morador.vaga || '-'}</td>
                    <td>${morador.observacoes || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editMorador('${morador.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${podeExcluirRegistros() ? `
                        <button class="btn btn-sm btn-danger" onclick="deleteMorador('${morador.id}')">
                            <i class="fas fa-trash"></i>
                        </button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        function sortMoradores(field) {
            if (currentMoradoresSort.field === field) {
                currentMoradoresSort.direction = currentMoradoresSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentMoradoresSort.field = field;
                currentMoradoresSort.direction = 'asc';
            }
            const filteredMoradores = moradores.filter(m => m.condominioId === currentCondominio.id);
            const sortedMoradores = filteredMoradores.sort((a, b) => {
                let valueA = a[field];
                let valueB = b[field];
                if (field === 'apto') {
                    valueA = extractNumberFromApto(valueA);
                    valueB = extractNumberFromApto(valueB);
                }
                if (valueA < valueB) return currentMoradoresSort.direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return currentMoradoresSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            loadMoradoresTableData(sortedMoradores);
            updateSortIcons(field);
        }
        function extractNumberFromApto(apto) {
            if (!apto) return 0;
            const match = apto.toString().match(/\d+/);
            return match ? parseInt(match[0]) : 0;
        }
        function updateSortIcons(activeField) {
            document.querySelectorAll('#moradoresTable th i').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            const activeHeader = document.querySelector(`#moradoresTable th[onclick="sortMoradores('${activeField}')"] i`);
            if (activeHeader) {
                activeHeader.className = currentMoradoresSort.direction === 'asc' 
                    ? 'fas fa-sort-up' 
                    : 'fas fa-sort-down';
            }
        }
        // ========== INICIALIZAÇÃO ==========
        document.getElementById('newPassword')?.addEventListener('input', function() {
            const password = this.value;
            const strengthBar = document.getElementById('passwordStrength');
            let strength = 0;
            if (password.length >= 6) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/\d/)) strength++;
            if (password.match(/[^a-zA-Z\d]/)) strength++;
            strengthBar.className = 'password-strength ';
            if (strength <= 1) strengthBar.className += 'strength-weak';
            else if (strength === 2) strengthBar.className += 'strength-fair';
            else if (strength === 3) strengthBar.className += 'strength-good';
            else if (strength >= 4) strengthBar.className += 'strength-strong';
        });
        // --- CONTROLE DE EXCLUSÃO ATUALIZADO ---
        function updateDeleteButtonsState() {
            const canDelete = podeExcluirRegistros();
            document.querySelectorAll('button.btn-danger, a.btn-danger').forEach(btn => {
                try {
                    btn.disabled = !canDelete;
                    if (!canDelete) {
                        btn.classList.add('disabled');
                        btn.style.opacity = '0.6';
                        btn.style.pointerEvents = 'none';
                    } else {
                        btn.classList.remove('disabled');
                        btn.style.opacity = '';
                        btn.style.pointerEvents = 'auto';
                    }
                } catch (err) {}
            });
        }
        const observer = new MutationObserver(function() {
            updateDeleteButtonsState();
        });
        observer.observe(document.body, { childList: true, subtree: true });

        // --- Módulo: Ocorrências (básico) ---
        async function loadOcorrenciasContent() {
            currentModule = 'ocorrencias';
            document.querySelectorAll('.sidebar-menu a').forEach(item => item.classList.remove('active'));
            const activeItem = document.querySelector(`.sidebar-menu a[onclick="changeModule('ocorrencias')"]`);
            if (activeItem) activeItem.classList.add('active');
            const moduleContent = document.getElementById('moduleContent');
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <span>Ocorrências</span>
                        <div>
                            <button class="btn btn-primary" onclick="openOcorrenciaModal()">Nova Ocorrência</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table" id="ocorrenciasTable">
                            <thead><tr><th>Morador</th><th>Apto</th><th>Data/Hora</th><th>Descrição</th><th>Status</th><th>Ações</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <!-- Modal Ocorrência -->
                <div id="ocorrenciaModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Ocorrência</h3>
                            <button type="button" onclick="closeOcorrenciaModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
                        </div>
                        <form id="ocorrenciaForm">
                            <input type="hidden" id="editingOcorrenciaId" />
                            <div class="form-group"><label>Morador</label><input type="text" id="ocorrenciaMorador" class="form-control" required></div>
                            <div class="form-group"><label>Apartamento</label><input type="text" id="ocorrenciaApto" class="form-control" required></div>
                            <div class="form-group"><label>Descrição</label><textarea id="ocorrenciaDescricao" class="form-control" rows="3"></textarea></div>
                            <div class="form-group"><label>Status</label>
                                <select id="ocorrenciaStatus" class="form-control">
                                    <option value="aberta">Aberta</option>
                                    <option value="andamento">Em andamento</option>
                                    <option value="resolvida">Resolvida</option>
                                </select>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Salvar</button>
                                <button type="button" class="btn" onclick="closeOcorrenciaModal()">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            const tbody = document.querySelector('#ocorrenciasTable tbody');
            tbody.innerHTML = '<tr><td colspan="6">Carregando...</td></tr>';
            try {
                const snapshot = await db.collection('ocorrencias').get();
                const docs = [];
                snapshot.forEach(doc => docs.push({id: doc.id, ...doc.data()}));
                tbody.innerHTML = '';
                docs.forEach(doc => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${doc.morador || ''}</td>
                        <td>${doc.apto || ''}</td>
                        <td>${doc.dataHora ? new Date(doc.dataHora.seconds ? doc.dataHora.toDate() : doc.dataHora).toLocaleString() : ''}</td>
                        <td>${(doc.descricao||'').substring(0,120)}</td>
                        <td>${doc.status || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editOcorrencia('${doc.id}')"><i class="fas fa-edit"></i></button>
                            ${podeExcluirRegistros() ? `
                            <button class="btn btn-sm btn-danger" onclick="safeDeleteOcorrencia('${doc.id}')"><i class="fas fa-trash"></i></button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="6">Erro ao carregar ocorrências.</td></tr>';
                console.error(err);
            }
        }
        function openOcorrenciaModal() {
            document.getElementById('ocorrenciaModal').style.display = 'flex';
            document.getElementById('editingOcorrenciaId').value = '';
            document.getElementById('ocorrenciaMorador').value = '';
            document.getElementById('ocorrenciaApto').value = '';
            document.getElementById('ocorrenciaDescricao').value = '';
            document.getElementById('ocorrenciaStatus').value = 'aberta';
        }
        function closeOcorrenciaModal() { document.getElementById('ocorrenciaModal').style.display = 'none'; }
        document.addEventListener('submit', async function(e) {
            if (e.target && e.target.id === 'ocorrenciaForm') {
                e.preventDefault();
                const id = document.getElementById('editingOcorrenciaId').value;
                const doc = {
                    morador: document.getElementById('ocorrenciaMorador').value,
                    apto: document.getElementById('ocorrenciaApto').value,
                    descricao: document.getElementById('ocorrenciaDescricao').value,
                    status: document.getElementById('ocorrenciaStatus').value,
                    dataHora: new Date()
                };
                try {
                    if (id) {
                        await db.collection('ocorrencias').doc(id).update(doc);
                    } else {
                        await db.collection('ocorrencias').add(doc);
                    }
                    closeOcorrenciaModal();
                    await loadOcorrenciasContent();
                } catch (err) {
                    alert('Erro ao salvar ocorrência: ' + err.message);
                }
            }
            if (e.target && e.target.id === 'prestadorForm') {
                e.preventDefault();
                const id = document.getElementById('editingPrestadorId').value;
                const doc = {
                    nome: document.getElementById('prestadorNome').value,
                    data: document.getElementById('prestadorData').value,
                    entrada: document.getElementById('prestadorEntrada').value,
                    saida: document.getElementById('prestadorSaida').value,
                    observacoes: document.getElementById('prestadorObservacoes').value,
                    status: document.getElementById('prestadorStatus').value,
                    dataAtualizacao: new Date()
                };
                try {
                    if (id) {
                        await db.collection('prestadores').doc(id).update(doc);
                    } else {
                        await db.collection('prestadores').add(doc);
                    }
                    closePrestadorModal();
                    await loadPrestadoresContent();
                } catch (err) {
                    alert('Erro ao salvar prestador: ' + (err.message || err));
                }
            }
        });
        function editOcorrencia(id) {
            db.collection('ocorrencias').doc(id).get().then(doc => {
                if (!doc.exists) return alert('Registro não encontrado');
                const data = doc.data();
                document.getElementById('editingOcorrenciaId').value = id;
                document.getElementById('ocorrenciaMorador').value = data.morador || '';
                document.getElementById('ocorrenciaApto').value = data.apto || '';
                document.getElementById('ocorrenciaDescricao').value = data.descricao || '';
                document.getElementById('ocorrenciaStatus').value = data.status || 'aberta';
                document.getElementById('ocorrenciaModal').style.display = 'flex';
            });
        }
        async function safeDeleteOcorrencia(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Confirma exclusão?')) return;
            await db.collection('ocorrencias').doc(id).delete();
            await loadOcorrenciasContent();
        }
        // --- Módulo: Prestadores de Serviço (básico) ---
        async function loadPrestadoresContent() {
            currentModule = 'prestadores';
            document.querySelectorAll('.sidebar-menu a').forEach(item => item.classList.remove('active'));
            const activeItem = document.querySelector(`.sidebar-menu a[onclick="changeModule('prestadores')"]`);
            if (activeItem) activeItem.classList.add('active');
            const moduleContent = document.getElementById('moduleContent');
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <span>Prestadores de Serviço</span>
                        <div>
                            <button class="btn btn-primary" onclick="openPrestadorModal()">Novo Prestador</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table" id="prestadoresTable">
                            <thead><tr><th>Nome</th><th>Data</th><th>Entrada</th><th>Saída</th><th>Observações</th><th>Status</th><th>Ações</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <!-- Modal Prestador -->
                <div id="prestadorModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Prestador de Serviço</h3>
                            <button type="button" onclick="closePrestadorModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
                        </div>
                        <form id="prestadorForm">
                            <input type="hidden" id="editingPrestadorId" />
                            <div class="form-group"><label>Nome</label><input type="text" id="prestadorNome" class="form-control" required></div>
                            <div class="form-group"><label>Data</label><input type="date" id="prestadorData" class="form-control" required readonly></div>
                            <div class="form-row"><div class="form-group"><label>Entrada</label><input type="time" id="prestadorEntrada" class="form-control"></div>
                            <div class="form-group"><label>Saída</label><input type="time" id="prestadorSaida" class="form-control"></div></div>
                            <div class="form-group"><label>Observações</label><textarea id="prestadorObservacoes" class="form-control" rows="3"></textarea></div>
                            <div class="form-group"><label>Status</label>
                                <select id="prestadorStatus" class="form-control">
                                    <option value="adiado">Adiado</option>
                                    <option value="concluido">Concluído</option>
                                    <option value="andamento">Em andamento</option>
                                </select>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Salvar</button>
                                <button type="button" class="btn" onclick="closePrestadorModal()">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            const tbody = document.querySelector('#prestadoresTable tbody');
            tbody.innerHTML = '<tr><td colspan="7">Carregando...</td></tr>';
            try {
                const snapshot = await db.collection('prestadores').get();
                const docs = [];
                snapshot.forEach(doc => docs.push({id: doc.id, ...doc.data()}));
                tbody.innerHTML = '';
                docs.forEach(doc => {
                    const tr = document.createElement('tr');
                    const dataStr = doc.data ? (doc.data.seconds ? new Date(doc.data.toDate()).toLocaleDateString() : new Date(doc.data).toLocaleDateString()) : '';
                    tr.innerHTML = `
                        <td>${doc.nome || ''}</td>
                        <td>${dataStr}</td>
                        <td>${doc.entrada || ''}</td>
                        <td>${doc.saida || ''}</td>
                        <td>${(doc.observacoes||'').substring(0,120)}</td>
                        <td>${doc.status || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editPrestador('${doc.id}')"><i class="fas fa-edit"></i></button>
                            ${podeExcluirRegistros() ? `
                            <button class="btn btn-sm btn-danger" onclick="safeDeletePrestador('${doc.id}')"><i class="fas fa-trash"></i></button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="7">Erro ao carregar prestadores.</td></tr>';
                console.error(err);
            }
        }
        function openPrestadorModal() {
            document.getElementById('prestadorModal').style.display = 'flex';
            document.getElementById('editingPrestadorId').value = '';
            document.getElementById('prestadorNome').value = '';
            const hoje = new Date();
            const yyyy = hoje.getFullYear();
            const mm = String(hoje.getMonth()+1).padStart(2,'0');
            const dd = String(hoje.getDate()).padStart(2,'0');
            document.getElementById('prestadorData').value = `${yyyy}-${mm}-${dd}`;
            document.getElementById('prestadorEntrada').value = '';
            document.getElementById('prestadorSaida').value = '';
            document.getElementById('prestadorObservacoes').value = '';
            document.getElementById('prestadorStatus').value = 'andamento';
        }
        function closePrestadorModal() { document.getElementById('prestadorModal').style.display = 'none'; }
        function editPrestador(id) {
            db.collection('prestadores').doc(id).get().then(doc => {
                if (!doc.exists) return alert('Registro não encontrado');
                const data = doc.data();
                document.getElementById('editingPrestadorId').value = id;
                document.getElementById('prestadorNome').value = data.nome || '';
                if (data.data) {
                    const d = data.data.seconds ? data.data.toDate() : new Date(data.data);
                    const yyyy = d.getFullYear(), mm = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
                    document.getElementById('prestadorData').value = `${yyyy}-${mm}-${dd}`;
                } else {
                    const hoje = new Date(); document.getElementById('prestadorData').value = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}-${String(hoje.getDate()).padStart(2,'0')}`;
                }
                document.getElementById('prestadorEntrada').value = data.entrada || '';
                document.getElementById('prestadorSaida').value = data.saida || '';
                document.getElementById('prestadorObservacoes').value = data.observacoes || '';
                document.getElementById('prestadorStatus').value = data.status || 'andamento';
                document.getElementById('prestadorModal').style.display = 'flex';
            });
        }
        async function safeDeletePrestador(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Confirma exclusão?')) return;
            await db.collection('prestadores').doc(id).delete();
            await loadPrestadoresContent();
        }
        const originalLoadModuleContent = loadModuleContent;
        loadModuleContent = function(moduleId) {
            originalLoadModuleContent.apply(this, arguments);
            setTimeout(()=> updateDeleteButtonsState(), 100);
        };
    </script>
</body>
</html>
