<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Multi Condom√≠nios</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #5dade2;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            display: flex;
            min-height: 100vh;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-agendado { background-color: #3498db; color: white; }
        .status-em-uso { background-color: #f39c12; color: white; }
        .status-liberado { background-color: #2ecc71; color: white; }
        .status-concluido { background-color: #2ecc71; color: white; }
        .status-cancelado { background-color: #e74c3c; color: white; }
        .status-pendente { background-color: #95a5a6; color: white; }
        .status-pago { background-color: #2ecc71; color: white; }
        .status-atrasado { background-color: #e74c3c; color: white; }
        .ticker-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #000000;
            color: white;
            padding: 8px 0;
            z-index: 2000;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .ticker-content {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
            animation: ticker 17.65s linear infinite;
        }
        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        .ticker-item {
            display: inline-block;
            margin-right: 40px;
            font-size: 14px;
        }
        .ticker-item i {
            margin-right: 5px;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .sidebar {
            width: 280px;
            background-color: var(--primary-color);
            color: white;
            transition: all 0.3s;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 3000;
        }
        .sidebar-header {
            padding: 20px;
            background-color: var(--dark-color);
            text-align: center;
            position: relative;
            border-bottom: 2px solid var(--secondary-color);
        }
        .condominio-selector {
            margin-top: 15px;
        }
        .condominio-selector select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: white;
        }
        .connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #e74c3c;
        }
        .connection-status.connected {
            background-color: #2ecc71;
        }
        .sidebar-menu {
            padding: 0;
            list-style: none;
        }
        .sidebar-menu li {
            position: relative;
        }
        .sidebar-menu a {
            display: block;
            padding: 15px 20px;
            color: var(--light-color);
            text-decoration: none;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s;
        }
        .sidebar-menu a:hover {
            background-color: var(--dark-color);
            padding-left: 25px;
        }
        .sidebar-menu a.active {
            background-color: var(--secondary-color);
        }
        .sidebar-menu a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .main-content {
            flex: 1;
            margin-left: 280px;
            transition: all 0.3s;
            margin-top: 40px;
        }
        .top-navbar {
            background-color: white;
            padding: 15px 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .toggle-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--dark-color);
        }
        .user-info {
            display: flex;
            align-items: center;
        }
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .content {
            padding: 30px;
        }
        .card {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .card-header {
            padding: 15px 20px;
            background-color: var(--light-color);
            border-bottom: 1px solid #eee;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body {
            padding: 20px;
        }
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--primary-color);
        }
        .login-box {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 400px;
            padding: 30px;
            position: relative;
        }
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .btn-primary { background-color: var(--secondary-color); color: white; }
        .btn-primary:hover { background-color: #3498db; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--accent-color); color: white; }
        .btn-info { background-color: var(--info-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 14px; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .table th {
            background-color: var(--light-color);
            font-weight: 600;
        }
        .table tr:hover { background-color: #f9f9f9; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 4000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 5px;
            width: 600px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-footer {
            margin-top: 20px;
            text-align: right;
        }
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .permission-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .permission-item input {
            margin-right: 8px;
        }
        @media (max-width: 768px) {
            .sidebar { width: 70px; text-align: center; }
            .sidebar-header h3, .sidebar-menu a span, .condominio-selector { display: none; }
            .sidebar-menu a i { margin-right: 0; font-size: 20px; }
            .main-content { margin-left: 70px; }
            .ticker-container { font-size: 12px; }
        }
        .module-content { display: none; }
        .module-content.active { display: block; }
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            flex: 1;
            min-width: 200px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-card h3 { font-size: 14px; color: #777; margin-bottom: 10px; }
        .stat-card .value { font-size: 24px; font-weight: bold; color: var(--primary-color); }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-row .form-group { flex: 1; }
        .action-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .password-strength {
            height: 5px;
            margin-top: 5px;
            border-radius: 2px;
            transition: all 0.3s;
        }
        .strength-weak { background-color: #e74c3c; width: 25%; }
        .strength-fair { background-color: #f39c12; width: 50%; }
        .strength-good { background-color: #3498db; width: 75%; }
        .strength-strong { background-color: #2ecc71; width: 100%; }
        .login-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 14px;
            border-left: 4px solid var(--secondary-color);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .condominio-badge {
            background: var(--secondary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
        .alert {
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .alert-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .alert-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success { background-color: var(--success-color); color: white; }
        .badge-warning { background-color: var(--warning-color); color: white; }
        .badge-danger { background-color: var(--accent-color); color: white; }
        .badge-info { background-color: var(--secondary-color); color: white; }
        .calendar-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .calendar-title {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 0 20px;
        }
        .calendar-view-options {
            display: flex;
            gap: 5px;
        }
        .calendar-view-options .btn {
            padding: 8px 15px;
            font-size: 14px;
            background: #f8f9fa;
            border: 1px solid #ddd;
        }
        .calendar-view-options .btn.active {
            background: var(--secondary-color);
            color: white;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e0e0e0;
            border: 1px solid #e0e0e0;
        }
        .calendar-day-header {
            background-color: #f8f9fa;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #e0e0e0;
            font-size: 14px;
        }
        .calendar-day {
            background-color: white;
            padding: 10px 8px;
            min-height: 120px;
            border: 1px solid #e0e0e0;
            position: relative;
            font-size: 14px;
            cursor: pointer;
        }
        .calendar-day.other-month {
            background-color: #f8f9fa;
            color: #999;
        }
        .calendar-day.today {
            background-color: #e3f2fd;
        }
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 16px;
            color: #333;
        }
        .event-item {
            background-color: #e74c3c;
            color: white;
            padding: 2px 6px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 11px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            border-left: 3px solid #c0392b;
            cursor: pointer;
        }
        .event-item.salao-social { background-color: #3498db; border-left-color: #2980b9; }
        .event-item.churrasqueira { background-color: #e74c3c; border-left-color: #c0392b; }
        .event-item.quiosque { background-color: #2ecc71; border-left-color: #27ae60; }
        .event-item.pergolado { background-color: #9b59b6; border-left-color: #8e44ad; }
        .espacos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .espaco-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid var(--secondary-color);
            cursor: pointer;
            transition: all 0.3s;
        }
        .espaco-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .espaco-card.selected {
            border-left-color: var(--success-color);
            background-color: #f8fff9;
        }
        .espaco-card h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 16px;
        }
        .espaco-card p {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .report-filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .report-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .report-preview {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-height: 500px;
            overflow-y: auto;
        }
        .report-line {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-family: 'Courier New', monospace;
        }
        .char-counter {
            font-size: 0.8em;
            color: #666;
            text-align: right;
            margin-top: 5px;
        }
        .terms-box {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
        }
        .calendar-legends {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        .menu-agendamentos {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .menu-agendamentos h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 18px;
        }
        .menu-agendamentos select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 14px;
        }
        .agendamentos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        .agendamentos-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
        .calendar-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .calendar-controls .btn {
            padding: 8px 15px;
            font-size: 14px;
        }
        .current-space {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary-color);
        }
        .current-space h4 {
            margin: 0;
            color: var(--primary-color);
            font-size: 16px;
        }
        .agendamento-actions-modal {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            padding: 10px;
            min-width: 150px;
        }
        .agendamento-actions-modal button {
            display: block;
            width: 100%;
            margin-bottom: 5px;
            text-align: left;
            padding: 8px 12px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 3px;
        }
        .agendamento-actions-modal button:hover {
            background: #f5f5f5;
        }
        .password-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .alert-success {
            background-color: #d1edff;
            border: 1px solid #b3d9ff;
            color: #004085;
        }
        .reminder-item, .conta-item {
            padding: 12px 15px;
            border-left: 4px solid var(--secondary-color);
            background: white;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .reminder-item.urgent, .conta-item.urgent {
            border-left-color: var(--accent-color);
            background-color: #fff5f5;
        }
        .reminder-item.warning, .conta-item.warning {
            border-left-color: var(--warning-color);
            background-color: #fffbf0;
        }
        .reminder-header, .conta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .reminder-title, .conta-title {
            font-weight: 600;
            color: var(--primary-color);
        }
        .reminder-date, .conta-date {
            font-size: 12px;
            color: #666;
        }
        .reminder-actions, .conta-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        .login-connection-status {
            display: flex;
            align-items: center;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
        }
        .login-connection-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #e74c3c;
            margin-right: 8px;
        }
        .login-connection-dot.connected {
            background-color: #2ecc71;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Letreiro de Lembretes -->
    <div id="tickerContainer" class="ticker-container" style="display: none;">
        <div class="ticker-content" id="tickerContent"></div>
    </div>

    <!-- P√°gina de Login -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h2>Sistema Multi Condom√≠nios</h2>
                <p id="loginStatus">Digite suas credenciais para acessar</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <input type="text" class="form-control" id="username" placeholder="Usu√°rio" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-control" id="password" placeholder="Senha" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="loginBtn">
                    <span id="loginBtnText">Entrar</span>
                    <div class="loading" id="loginLoading" style="display: none;"></div>
                </button>
            </form>
            <div class="login-connection-status">
                <div class="login-connection-dot" id="loginConnectionDot"></div>
                <span id="loginConnectionText">Verificando conex√£o com o banco de dados...</span>
            </div>
        </div>
    </div>

    <!-- Sistema Principal -->
    <div id="mainSystem" class="container" style="display: none;">
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Multi Condom√≠nios</h3>
                <div class="condominio-selector">
                    <select id="condominioSelect">
                        <option value="">Selecione um condom√≠nio</option>
                    </select>
                </div>
                <div id="connectionStatus" class="connection-status" title="Desconectado"></div>
            </div>
            <ul class="sidebar-menu" id="moduleMenu"></ul>
        </div>
        <div class="main-content">
            <div class="top-navbar">
                <button class="toggle-btn" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="user-info">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=3498db&color=fff" alt="Usu√°rio" id="userAvatar">
                    <span id="userName">Administrador</span>
                    <span class="condominio-badge" id="currentCondominioBadge"></span>
                    <div class="online-indicator" style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: #2ecc71; font-weight: 600; margin-left: 12px; cursor: pointer;" onclick="showOnlineUsers()">
                        <div class="online-dot" style="width: 10px; height: 10px; border-radius: 50%; background-color: #2ecc71; box-shadow: 0 0 6px #2ecc71; animation: pulse 2s infinite;"></div>
                        <span id="onlineCount">0</span> online
                    </div>
                    <button class="btn" id="logoutBtn" style="margin-left: 15px;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            <div class="content">
                <div id="moduleContent"></div>
            </div>
        </div>
    </div>

    <!-- Modal Troca de Senha -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Trocar Senha</h3>
                <p>√â sua primeira vez aqui! Por favor, defina uma nova senha.</p>
            </div>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label>Nova Senha</label>
                    <input type="password" class="form-control" id="newPassword" required minlength="6">
                    <div id="passwordStrength" class="password-strength"></div>
                </div>
                <div class="form-group">
                    <label>Confirmar Nova Senha</label>
                    <input type="password" class="form-control" id="confirmPassword" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Nova Senha</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Usu√°rios -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Cadastrar Usu√°rio</h3>
                <button type="button" onclick="closeUserModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="userForm">
                <input type="hidden" id="editingUserId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome Completo *</label>
                        <input type="text" class="form-control" id="userNome" required>
                    </div>
                    <div class="form-group">
                        <label>Usu√°rio *</label>
                        <input type="text" class="form-control" id="userUsuario" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>E-mail</label>
                        <input type="email" class="form-control" id="userEmail">
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="text" class="form-control" id="userTelefone">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Senha <span id="senhaObrigatoria">*</span></label>
                        <input type="password" class="form-control" id="userSenha">
                        <div class="password-info" id="senhaInfo">Deixe em branco para manter a senha atual</div>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Usu√°rio *</label>
                        <select class="form-control" id="userTipo" required>
                            <option value="">Selecione...</option>
                            <option value="sindico">S√≠ndico</option>
                            <option value="subsindico">Subs√≠ndico</option>
                            <option value="zelador">Zelador</option>
                            <option value="portaria">Portaria</option>
                            <option value="prestador">Prestador de Servi√ßo</option>
                            <option value="morador">Morador</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Condom√≠nios Permitidos</label>
                    <div id="condominiosPermitidos" class="permissions-grid"></div>
                </div>
                <div class="form-group">
                    <label>M√≥dulos Permitidos</label>
                    <div id="permissoesUsuario" class="permissions-grid"></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Usu√°rio</button>
                    <button type="button" class="btn" onclick="closeUserModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Condom√≠nios -->
    <div id="condominioModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="condominioModalTitle">Cadastrar Condom√≠nio</h3>
                <button type="button" onclick="closeCondominioModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="condominioForm">
                <input type="hidden" id="editingCondominioId">
                <div class="form-group">
                    <label>Nome do Condom√≠nio *</label>
                    <input type="text" class="form-control" id="condominioNome" required>
                </div>
                <div class="form-group">
                    <label>Endere√ßo *</label>
                    <input type="text" class="form-control" id="condominioEndereco" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cidade *</label>
                        <input type="text" class="form-control" id="condominioCidade" required>
                    </div>
                    <div class="form-group">
                        <label>Estado *</label>
                        <input type="text" class="form-control" id="condominioEstado" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>CEP</label>
                    <input type="text" class="form-control" id="condominioCEP">
                </div>
                <div class="form-group">
                    <label>Telefone</label>
                    <input type="text" class="form-control" id="condominioTelefone">
                </div>
                <div class="form-group">
                    <label>CNPJ</label>
                    <input type="text" class="form-control" id="condominioCNPJ">
                </div>
                <div class="form-group">
                    <label>Quantidade de Unidades</label>
                    <input type="number" class="form-control" id="condominioUnidades" min="1">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="condominioStatus">
                        <option value="ativo">Ativo</option>
                        <option value="inativo">Inativo</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Condom√≠nio</button>
                    <button type="button" class="btn" onclick="closeCondominioModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Agendamentos -->
    <div id="agendamentoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="agendamentoModalTitle">Novo Agendamento</h3>
                <button type="button" onclick="closeAgendamentoModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="agendamentoForm">
                <input type="hidden" id="editingAgendamentoId">
                <input type="hidden" id="agendamentoData">
                <div class="form-group">
                    <label>Espa√ßo *</label>
                    <select class="form-control" id="agendamentoEspaco" required>
                        <option value="">Selecione o espa√ßo...</option>
                        <option value="salao-social">1. Sal√£o Social</option>
                        <option value="churrasqueira">2. Churrasqueira √Årea Gourmet</option>
                        <option value="quiosque">3. Quiosque</option>
                        <option value="pergolado">4. Pergolado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data *</label>
                    <input type="date" class="form-control" id="agendamentoDataInput" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Hor√°rio de In√≠cio *</label>
                        <input type="time" class="form-control" id="agendamentoHoraInicio" required>
                    </div>
                    <div class="form-group">
                        <label>Hor√°rio de T√©rmino *</label>
                        <input type="time" class="form-control" id="agendamentoHoraFim" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Morador/Respons√°vel *</label>
                    <input type="text" class="form-control" id="agendamentoResponsavel" required>
                </div>
                <div class="form-group">
                    <label>Unidade/Apartamento *</label>
                    <input type="text" class="form-control" id="agendamentoUnidade" required>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="agendamentoStatus">
                        <option value="agendado">Agendado</option>
                        <option value="em-uso">Em Uso</option>
                        <option value="liberado">Liberado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observa√ß√µes</label>
                    <textarea class="form-control" id="agendamentoObservacoes" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Agendamento</button>
                    <button type="button" class="btn" onclick="closeAgendamentoModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Contas -->
    <div id="contaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="contaModalTitle">Nova Conta a Pagar</h3>
                <button type="button" onclick="closeContaModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="contaForm">
                <input type="hidden" id="editingContaId">
                <div class="form-group">
                    <label>Descri√ß√£o *</label>
                    <input type="text" class="form-control" id="contaDescricao" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Valor *</label>
                        <input type="number" class="form-control" id="contaValor" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Vencimento *</label>
                        <input type="date" class="form-control" id="contaVencimento" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select class="form-control" id="contaCategoria">
                        <option value="manutencao">Manuten√ß√£o</option>
                        <option value="limpeza">Limpeza</option>
                        <option value="seguranca">Seguran√ßa</option>
                        <option value="administrativo">Administrativo</option>
                        <option value="energia">Energia</option>
                        <option value="agua">√Ågua</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fornecedor</label>
                    <input type="text" class="form-control" id="contaFornecedor">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="contaStatus">
                        <option value="pendente">Pendente</option>
                        <option value="pago">Pago</option>
                        <option value="atrasado">Atrasado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observa√ß√µes</label>
                    <textarea class="form-control" id="contaObservacoes" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Conta</button>
                    <button type="button" class="btn" onclick="closeContaModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Lembretes (CORRIGIDO COM dataInicio e dataFim) -->
    <div id="lembreteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="lembreteModalTitle">Novo Lembrete</h3>
                <button type="button" onclick="closeLembreteModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="lembreteForm">
                <input type="hidden" id="editingLembreteId">
                <div class="form-group">
                    <label>T√≠tulo *</label>
                    <input type="text" class="form-control" id="lembreteTitulo" required>
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <textarea class="form-control" id="lembreteDescricao" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data de In√≠cio *</label>
                        <input type="date" class="form-control" id="lembreteDataInicio" required>
                    </div>
                    <div class="form-group">
                        <label>Data de Fim *</label>
                        <input type="date" class="form-control" id="lembreteDataFim" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Prioridade</label>
                        <select class="form-control" id="lembretePrioridade">
                            <option value="baixa">Baixa</option>
                            <option value="media">M√©dia</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Lembrete</button>
                    <button type="button" class="btn" onclick="closeLembreteModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Moradores -->
    <div id="moradorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="moradorModalTitle">Cadastrar Morador</h3>
                <button type="button" onclick="closeMoradorModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="moradorForm">
                <input type="hidden" id="editingMoradorId">
                <div class="form-group">
                    <label>Morador *</label>
                    <input type="text" class="form-control" id="moradorNome" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Apartamento *</label>
                        <input type="text" class="form-control" id="moradorApto" required>
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="text" class="form-control" id="moradorTelefone">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Garagem</label>
                        <select class="form-control" id="moradorGaragem">
                            <option value="">Selecione...</option>
                            <option value="G1">G1</option>
                            <option value="G2">G2</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vaga</label>
                        <input type="text" class="form-control" id="moradorVaga">
                    </div>
                </div>
                <div class="form-group">
                    <label>Observa√ß√µes</label>
                    <textarea class="form-control" id="moradorObservacoes" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Morador</button>
                    <button type="button" class="btn" onclick="closeMoradorModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Limpeza -->
    <div id="limpezaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="limpezaModalTitle">Registro de Limpeza</h3>
                <button type="button" onclick="closeLimpezaModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="limpezaForm">
                <input type="hidden" id="editingLimpezaId">
                <div class="form-group">
                    <label>Respons√°vel pela Limpeza *</label>
                    <input type="text" class="form-control" id="limpezaResponsavel" required>
                </div>
                <div class="form-group">
                    <label>Espa√ßo Limpo *</label>
                    <select class="form-control" id="limpezaEspaco" required>
                        <option value="">Selecione o espa√ßo...</option>
                        <option value="salao-social">Sal√£o Social</option>
                        <option value="churrasqueira">Churrasqueira</option>
                        <option value="quiosque">Quiosque</option>
                        <option value="pergolado">Pergolado</option>
                        <option value="sauna">Sauna</option>
                        <option value="area-comum">√Årea Comum</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data *</label>
                        <input type="date" class="form-control" id="limpezaData" required>
                    </div>
                    <div class="form-group">
                        <label>Hora In√≠cio *</label>
                        <input type="time" class="form-control" id="limpezaHoraInicio" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Hora Fim</label>
                        <input type="time" class="form-control" id="limpezaHoraFim">
                    </div>
                    <div class="form-group">
                        <label>Tempo de Uso (minutos)</label>
                        <input type="number" class="form-control" id="limpezaTempoUso" min="0" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>Observa√ß√µes</label>
                    <textarea class="form-control" id="limpezaObservacoes" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="limpezaStatus">
                        <option value="em-andamento">Em Andamento</option>
                        <option value="concluido">Conclu√≠do</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" class="btn btn-success" id="btnConcluirLimpeza" onclick="concluirLimpeza()" style="display: none;">Concluir Limpeza</button>
                    <button type="button" class="btn" onclick="closeLimpezaModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Sauna -->
    <div id="saunaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="saunaModalTitle">Agendamento de Sauna</h3>
                <button type="button" onclick="closeSaunaModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="saunaForm">
                <input type="hidden" id="editingSaunaId">
                <div class="form-group">
                    <label>Morador *</label>
                    <input type="text" class="form-control" id="saunaMorador" required>
                </div>
                <div class="form-group">
                    <label>Apartamento *</label>
                    <input type="text" class="form-control" id="saunaApto" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data *</label>
                        <input type="date" class="form-control" id="saunaData" required>
                    </div>
                    <div class="form-group">
                        <label>Hora In√≠cio *</label>
                        <input type="time" class="form-control" id="saunaHoraInicio" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Hora Fim</label>
                        <input type="time" class="form-control" id="saunaHoraFim">
                    </div>
                    <div class="form-group">
                        <label>Tempo de Uso (minutos)</label>
                        <input type="number" class="form-control" id="saunaTempoUso" min="0" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="saunaStatus">
                        <option value="agendado">Agendado</option>
                        <option value="em-uso">Em Uso</option>
                        <option value="concluido">Conclu√≠do</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observa√ß√µes</label>
                    <textarea class="form-control" id="saunaObservacoes" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" class="btn btn-success" id="btnConcluirSauna" onclick="concluirSauna()" style="display: none;">Concluir Uso</button>
                    <button type="button" class="btn" onclick="closeSaunaModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAhx_I1Wg0RncK_XTTOVjKrRkeD8-wDoMw",
            authDomain: "condominio-amaranthus.firebaseapp.com",
            projectId: "condominio-amaranthus",
            storageBucket: "condominio-amaranthus.firebasestorage.app",
            messagingSenderId: "233912918531",
            appId: "1:233912918531:web:6850381663623ef1282436"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const modules = [
            { id: 'dashboard', name: 'Dashboard', icon: 'fas fa-tachometer-alt', default: true },
            { id: 'condominios', name: 'Condom√≠nios', icon: 'fas fa-building' },
            { id: 'usuarios', name: 'Usu√°rios', icon: 'fas fa-users' },
            { id: 'moradores', name: 'Moradores', icon: 'fas fa-user-friends' },
            { id: 'agendamentos', name: 'Agendamentos', icon: 'fas fa-calendar-alt' },
            { id: 'limpeza', name: 'Limpeza', icon: 'fas fa-broom' },
            { id: 'sauna', name: 'Sauna', icon: 'fas fa-hot-tub' },
            { id: 'contas', name: 'Contas a Pagar', icon: 'fas fa-file-invoice-dollar' },
            { id: 'lembretes', name: 'Lembretes', icon: 'fas fa-bell' },
            { id: 'relatorios', name: 'Relat√≥rios', icon: 'fas fa-chart-bar' }
        ];

        let currentUser = null;
        let currentCondominio = null;
        let condominios = [];
        let usuarios = [];
        let moradores = [];
        let agendamentos = [];
        let limpezas = [];
        let saunas = [];
        let contas = [];
        let lembretes = [];
        let currentModule = 'dashboard';
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();
        let isFirebaseConnected = false;
        let presenceRef = null;

        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            try {
                checkFirebaseConnection();
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    const userDoc = await db.collection('usuarios').doc(currentUser.id).get();
                    if (userDoc.exists) {
                        await loadSystemData();
                        showMainSystem();
                        setupPresence();
                        setupRealtimeListeners();
                        setInterval(updateOnlineCount, 10000);
                        return;
                    }
                }
                showLoginPage();
            } catch (error) {
                console.error('Erro ao inicializar aplica√ß√£o:', error);
                showLoginPage();
            }
        }

        function showOnlineUsers() {
            const cutoff = new Date(Date.now() - 60000);
            db.collection('presence')
                .where('lastSeen', '>=', cutoff)
                .where('online', '==', true)
                .get()
                .then(snapshot => {
                    const onlineUsers = [];
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.userId !== currentUser.id) {
                            onlineUsers.push(userData.nome);
                        }
                    });
                    if (onlineUsers.length > 0) {
                        alert(`Usu√°rios Online:\n${onlineUsers.join('\n')}`);
                    } else {
                        alert('Nenhum outro usu√°rio online no momento.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar usu√°rios online:', error);
                    alert('Erro ao carregar lista de usu√°rios online.');
                });
        }

        function checkFirebaseConnection() {
            const connectionDot = document.getElementById('loginConnectionDot');
            const connectionText = document.getElementById('loginConnectionText');
            setTimeout(() => {
                db.collection('test').limit(1).get()
                    .then(() => {
                        isFirebaseConnected = true;
                        connectionDot.classList.add('connected');
                        connectionText.textContent = 'Conectado ao banco de dados';
                    })
                    .catch((error) => {
                        isFirebaseConnected = false;
                        connectionDot.classList.remove('connected');
                        connectionText.textContent = 'Erro na conex√£o com o banco de dados';
                        console.error('Erro de conex√£o com Firebase:', error);
                    });
            }, 1000);
        }

        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainSystem').style.display = 'none';
            document.getElementById('tickerContainer').style.display = 'none';
            document.getElementById('loginStatus').textContent = 'Digite suas credenciais para acessar';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function showMainSystem() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'flex';
            document.getElementById('tickerContainer').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.nome || currentUser.usuario;
            document.getElementById('currentCondominioBadge').textContent = currentCondominio ? currentCondominio.nome : 'Nenhum condom√≠nio selecionado';
            loadModuleMenu();
            loadModuleContent(currentModule);
            loadTickerContent();
        }

        function loadModuleMenu() {
            const moduleMenu = document.getElementById('moduleMenu');
            moduleMenu.innerHTML = '';
            const allowedModules = modules.filter(module => {
                return !currentUser.permissoes || 
                       currentUser.permissoes.includes('*') || 
                       currentUser.permissoes.includes(module.id);
            });
            allowedModules.forEach(module => {
                const menuItem = document.createElement('li');
                menuItem.innerHTML = `
                    <a href="#" class="${module.id === currentModule ? 'active' : ''}" onclick="changeModule('${module.id}')">
                        <i class="${module.icon}"></i>
                        <span>${module.name}</span>
                    </a>
                `;
                moduleMenu.appendChild(menuItem);
            });
        }

        function loadModuleContent(moduleId) {
            currentModule = moduleId;
            document.querySelectorAll('.sidebar-menu a').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`.sidebar-menu a[onclick="changeModule('${moduleId}')"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
            const moduleContent = document.getElementById('moduleContent');
            switch(moduleId) {
                case 'dashboard': loadDashboardContent(); break;
                case 'condominios': loadCondominiosContent(); break;
                case 'usuarios': loadUsuariosContent(); break;
                case 'moradores': loadMoradoresContent(); break;
                case 'agendamentos': loadAgendamentosContent(); break;
                case 'limpeza': loadLimpezaContent(); break;
                case 'sauna': loadSaunaContent(); break;
                case 'contas': loadContasContent(); break;
                case 'lembretes': loadLembretesContent(); break;
                case 'relatorios': loadRelatoriosContent(); break;
            }
        }

        function changeModule(moduleId) {
            loadModuleContent(moduleId);
        }

        async function loadSystemData() {
            try {
                const condominiosSnapshot = await db.collection('condominios').get();
                condominios = [];
                condominiosSnapshot.forEach(doc => {
                    condominios.push({ id: doc.id, ...doc.data() });
                });

                const usuariosSnapshot = await db.collection('usuarios').get();
                usuarios = [];
                usuariosSnapshot.forEach(doc => {
                    usuarios.push({ id: doc.id, ...doc.data() });
                });

                const moradoresSnapshot = await db.collection('moradores').get();
                moradores = [];
                moradoresSnapshot.forEach(doc => {
                    moradores.push({ id: doc.id, ...doc.data() });
                });

                const limpezasSnapshot = await db.collection('limpezas').get();
                limpezas = [];
                limpezasSnapshot.forEach(doc => {
                    limpezas.push({ id: doc.id, ...doc.data() });
                });

                const saunasSnapshot = await db.collection('saunas').get();
                saunas = [];
                saunasSnapshot.forEach(doc => {
                    saunas.push({ id: doc.id, ...doc.data() });
                });

                const agendamentosSnapshot = await db.collection('agendamentos').get();
                agendamentos = [];
                agendamentosSnapshot.forEach(doc => {
                    agendamentos.push({ id: doc.id, ...doc.data() });
                });

                const contasSnapshot = await db.collection('contas').get();
                contas = [];
                contasSnapshot.forEach(doc => {
                    contas.push({ id: doc.id, ...doc.data() });
                });

                const lembretesSnapshot = await db.collection('lembretes').get();
                lembretes = [];
                lembretesSnapshot.forEach(doc => {
                    lembretes.push({ id: doc.id, ...doc.data() });
                });

                await createDouglasUser();
                updateCondominioSelector();
                updateConnectionStatus(true);
            } catch (error) {
                console.error('Erro ao carregar dados do sistema:', error);
                updateConnectionStatus(false);
            }
        }

        // ‚úÖ CORRE√á√ÉO 2: LEMBRETES COM DATA DE IN√çCIO E FIM NO LETREIRO
        function loadTickerContent() {
            const tickerContent = document.getElementById('tickerContent');
            tickerContent.innerHTML = '';
            const hoje = getCurrentDate();

            let lembretesVisiveis = [];
            if (currentCondominio) {
                lembretesVisiveis = lembretes.filter(l =>
                    l.condominioId === currentCondominio.id &&
                    l.dataInicio <= hoje &&
                    l.dataFim >= hoje
                );
            } else {
                lembretesVisiveis = lembretes.filter(l =>
                    l.dataInicio <= hoje &&
                    l.dataFim >= hoje
                );
            }

            if (lembretesVisiveis.length > 0) {
                lembretesVisiveis.forEach(lembrete => {
                    const item = document.createElement('div');
                    item.className = 'ticker-item';
                    let icon = 'fas fa-bell';
                    if (lembrete.prioridade === 'alta') icon = 'fas fa-exclamation-circle';
                    else if (lembrete.prioridade === 'media') icon = 'fas fa-info-circle';

                    let nomeUsuario = 'Sistema';
                    if (lembrete.criadoPor) {
                        const usuarioCriador = usuarios.find(u => u.id === lembrete.criadoPor);
                        if (usuarioCriador) {
                            nomeUsuario = usuarioCriador.nome || usuarioCriador.usuario || 'Usu√°rio';
                        } else {
                            nomeUsuario = lembrete.criadoPorNome || 'Usu√°rio';
                        }
                    }

                    const textoCurto = lembrete.descricao ?
                        (lembrete.descricao.length > 50 ? lembrete.descricao.substring(0, 50) + '...' : lembrete.descricao) :
                        'Sem descri√ß√£o';

                    item.innerHTML = `
                        <i class="${icon}"></i>
                        <strong>${lembrete.titulo}</strong> - ${textoCurto} 
                        <em>(por: ${nomeUsuario})</em>
                    `;
                    tickerContent.appendChild(item);
                });
                document.getElementById('tickerContainer').style.display = 'block';
            } else {
                const item = document.createElement('div');
                item.className = 'ticker-item';
                item.innerHTML = `<i class="fas fa-check-circle"></i><strong>Sem lembretes para hoje - ${formatDate(hoje)}</strong>`;
                tickerContent.appendChild(item);
                document.getElementById('tickerContainer').style.display = 'block';
            }

            setTimeout(() => {
                const content = document.getElementById('tickerContent');
                content.style.animation = 'none';
                setTimeout(() => {
                    content.style.animation = 'ticker 17.65s linear infinite';
                }, 10);
            }, 100);
        }

        async function createDouglasUser() {
            try {
                const userQuery = await db.collection('usuarios')
                    .where('usuario', '==', 'Douglas')
                    .limit(1)
                    .get();
                if (userQuery.empty) {
                    const userData = {
                        usuario: 'Douglas',
                        senha: '0000',
                        nome: 'Douglas Correia',
                        tipo: 'sindico',
                        primeiroLogin: false,
                        email: 'douglas@email.com',
                        telefone: '',
                        ativo: true,
                        condominios: ['*'],
                        permissoes: ['*'],
                        dataCriacao: new Date()
                    };
                    await db.collection('usuarios').add(userData);
                }
            } catch (error) {
                console.error('Erro ao criar usu√°rio Douglas:', error);
            }
        }

        function updateCondominioSelector() {
            const condominioSelect = document.getElementById('condominioSelect');
            condominioSelect.innerHTML = '<option value="">Selecione um condom√≠nio</option>';
            let allowedCondominios = [...condominios];
            if (currentUser.condominios && !currentUser.condominios.includes('*')) {
                allowedCondominios = condominios.filter(condominio =>
                    currentUser.condominios.includes(condominio.id)
                );
            }
            allowedCondominios.forEach(condominio => {
                const option = document.createElement('option');
                option.value = condominio.id;
                option.textContent = condominio.nome;
                condominioSelect.appendChild(option);
            });
            if (!currentCondominio && allowedCondominios.length > 0) {
                currentCondominio = allowedCondominios[0];
                condominioSelect.value = currentCondominio.id;
                document.getElementById('currentCondominioBadge').textContent = currentCondominio.nome;
            }
        }

        function updateConnectionStatus(connected) {
            const connectionStatus = document.getElementById('connectionStatus');
            if (connected) {
                connectionStatus.classList.add('connected');
                connectionStatus.title = 'Conectado';
            } else {
                connectionStatus.classList.remove('connected');
                connectionStatus.title = 'Desconectado';
            }
        }

        // ========== DASHBOARD ==========
        function loadDashboardContent() {
            const moduleContent = document.getElementById('moduleContent');
            const filteredAgendamentos = currentCondominio ? agendamentos.filter(a => a.condominioId === currentCondominio.id) : [];
            const filteredContas = currentCondominio ? contas.filter(c => c.condominioId === currentCondominio.id) : [];
            const filteredLembretes = currentCondominio ? lembretes.filter(l => l.condominioId === currentCondominio.id) : [];
            const filteredMoradores = currentCondominio ? moradores.filter(m => m.condominioId === currentCondominio.id) : [];

            let totalCondominios;
            if (currentUser.condominios && currentUser.condominios.includes('*')) {
                totalCondominios = condominios.length;
            } else if (currentUser.condominios) {
                totalCondominios = condominios.filter(cond => currentUser.condominios.includes(cond.id)).length;
            } else {
                totalCondominios = condominios.length;
            }
            const totalUsuarios = usuarios.length;
            const totalMoradores = filteredMoradores.length;
            const totalAgendamentos = filteredAgendamentos.length;
            const agendamentosHoje = filteredAgendamentos.filter(a => a.data === getCurrentDate()).length;

            const hoje = new Date();
            const alertaContas = filteredContas.filter(conta => {
                if (conta.status === 'pago') return false;
                const vencimento = new Date(conta.vencimento);
                const diferencaDias = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
                return diferencaDias <= 4 && diferencaDias >= 0;
            });

            const lembretesProximos = filteredLembretes.filter(lembrete => {
                const dataLembrete = new Date(lembrete.dataInicio);
                const diferencaDias = Math.ceil((dataLembrete - hoje) / (1000 * 60 * 60 * 24));
                return diferencaDias <= 7 && diferencaDias >= 0;
            });

            let statsHTML = `
                <div class="stat-card" onclick="changeModule('condominios')">
                    <h3>Condom√≠nios</h3>
                    <div class="value">${totalCondominios}</div>
                </div>
                <div class="stat-card" onclick="changeModule('usuarios')">
                    <h3>Usu√°rios</h3>
                    <div class="value">${totalUsuarios}</div>
                </div>
            `;

            if (currentUser.permissoes && (currentUser.permissoes.includes('*') || currentUser.permissoes.includes('moradores'))) {
                statsHTML += `
                    <div class="stat-card" onclick="changeModule('moradores')">
                        <h3>Moradores</h3>
                        <div class="value">${totalMoradores}</div>
                    </div>
                `;
            }
            if (currentUser.permissoes && (currentUser.permissoes.includes('*') || currentUser.permissoes.includes('agendamentos'))) {
                statsHTML += `
                    <div class="stat-card" onclick="changeModule('agendamentos')">
                        <h3>Agendamentos</h3>
                        <div class="value">${totalAgendamentos}</div>
                    </div>
                    <div class="stat-card" onclick="changeModule('agendamentos')">
                        <h3>Agendamentos Hoje</h3>
                        <div class="value">${agendamentosHoje}</div>
                    </div>
                `;
            }

            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Dashboard - ${currentCondominio ? currentCondominio.nome : 'Selecione um condom√≠nio'}</h3>
                        <span>Bem-vindo, ${currentUser.nome || currentUser.usuario}!</span>
                    </div>
                    <div class="card-body">
                        ${!currentCondominio ? `
                            <div class="alert alert-warning">
                                <strong>Aten√ß√£o!</strong> Selecione um condom√≠nio no menu acima para visualizar os dados espec√≠ficos.
                            </div>
                        ` : ''}
                        ${(currentUser.permissoes && (currentUser.permissoes.includes('*') || currentUser.permissoes.includes('contas'))) && alertaContas.length > 0 ? `
                            <div class="dashboard-alerts">
                                <div class="alert alert-warning">
                                    <h4><i class="fas fa-exclamation-triangle"></i> Contas Pr√≥ximas do Vencimento</h4>
                                    <p>Voc√™ tem ${alertaContas.length} conta(s) que vence(m) em at√© 4 dias.</p>
                                </div>
                            </div>
                        ` : ''}
                        <div class="stats-container">
                            ${statsHTML}
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3>Lembretes</h3>
                                <button class="btn btn-primary btn-sm" onclick="openLembreteModal()">
                                    <i class="fas fa-plus"></i> Novo Lembrete
                                </button>
                            </div>
                            <div class="card-body">
                                ${lembretesProximos.length > 0 ? 
                                    lembretesProximos.map(lembrete => `
                                        <div class="reminder-item ${lembrete.prioridade === 'alta' ? 'urgent' : lembrete.prioridade === 'media' ? 'warning' : ''}">
                                            <div class="reminder-header">
                                                <div class="reminder-title">${lembrete.titulo}</div>
                                                <div class="reminder-date">${formatDate(lembrete.dataInicio)} - ${formatDate(lembrete.dataFim)}</div>
                                            </div>
                                            <div class="reminder-desc">${lembrete.descricao}</div>
                                            <div class="reminder-actions">
                                                <button class="btn btn-sm btn-danger" onclick="deleteLembrete('${lembrete.id}')">
                                                    <i class="fas fa-trash"></i> Excluir
                                                </button>
                                            </div>
                                        </div>
                                    `).join('') 
                                    : '<p>N√£o h√° lembretes para os pr√≥ximos dias.</p>'
                                }
                            </div>
                        </div>
                        ${(currentUser.permissoes && (currentUser.permissoes.includes('*') || currentUser.permissoes.includes('contas'))) ? `
                        <div class="card">
                            <div class="card-header">
                                <h3>Contas a Pagar - Pr√≥ximos Vencimentos</h3>
                                <button class="btn btn-primary btn-sm" onclick="changeModule('contas')">
                                    <i class="fas fa-eye"></i> Ver Todas
                                </button>
                            </div>
                            <div class="card-body">
                                ${alertaContas.length > 0 ? 
                                    alertaContas.map(conta => `
                                        <div class="conta-item ${conta.status === 'atrasado' ? 'urgent' : 'warning'}">
                                            <div class="conta-header">
                                                <div class="conta-title">${conta.descricao}</div>
                                                <div class="conta-date">Vence: ${formatDate(conta.vencimento)}</div>
                                            </div>
                                            <div class="conta-details">
                                                <strong>R$ ${conta.valor.toFixed(2)}</strong> - ${conta.fornecedor}
                                            </div>
                                            <div class="conta-actions">
                                                <button class="btn btn-sm btn-success" onclick="marcarContaComoPaga('${conta.id}')">
                                                    <i class="fas fa-check"></i> Marcar como Pago
                                                </button>
                                            </div>
                                        </div>
                                    `).join('') 
                                    : '<p>N√£o h√° contas com vencimento pr√≥ximo.</p>'
                                }
                            </div>
                        </div>
                        ` : ''}
                        ${currentCondominio && (currentUser.permissoes && (currentUser.permissoes.includes('*') || currentUser.permissoes.includes('agendamentos'))) ? `
                        <div class="card">
                            <div class="card-header">
                                <h4>Agendamentos Recentes - ${currentCondominio.nome}</h4>
                            </div>
                            <div class="card-body">
                                ${filteredAgendamentos.length > 0 ? `
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Espa√ßo</th>
                                            <th>Solicitante</th>
                                            <th>Data</th>
                                            <th>Hor√°rio</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredAgendamentos.slice(0, 5).map(agendamento => `
                                            <tr>
                                                <td>${getEspacoNome(agendamento.espaco)}</td>
                                                <td>${agendamento.responsavel}</td>
                                                <td>${formatDate(agendamento.data)}</td>
                                                <td>${agendamento.horaInicio} - ${agendamento.horaFim}</td>
                                                <td><span class="status-badge status-${agendamento.status}">${formatStatusAgendamento(agendamento.status)}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                ` : '<p>Nenhum agendamento encontrado para este condom√≠nio.</p>'}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ========== M√ìDULOS B√ÅSICOS ==========
        function loadCondominiosContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && !currentUser.permissoes.includes('*') && !currentUser.permissoes.includes('condominios')) {
                moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Acesso negado!</strong> Voc√™ n√£o tem permiss√£o para acessar este m√≥dulo.</div>`;
                return;
            }
            let allowedCondominios = [...condominios];
            if (currentUser.condominios && !currentUser.condominios.includes('*')) {
                allowedCondominios = condominios.filter(condominio => currentUser.condominios.includes(condominio.id));
            }
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Gerenciar Condom√≠nios</h3>
                        ${(!currentUser.permissoes || currentUser.permissoes.includes('*') || currentUser.permissoes.includes('condominios')) ? `
                        <button class="btn btn-primary" onclick="openCondominioModal()">
                            <i class="fas fa-plus"></i> Novo Condom√≠nio
                        </button>
                        ` : ''}
                    </div>
                    <div class="card-body">
                        ${allowedCondominios.length > 0 ? `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Endere√ßo</th>
                                    <th>Cidade/Estado</th>
                                    <th>Unidades</th>
                                    <th>Status</th>
                                    ${(!currentUser.permissoes || currentUser.permissoes.includes('*') || currentUser.permissoes.includes('condominios')) ? `<th>A√ß√µes</th>` : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${allowedCondominios.map(condominio => `
                                    <tr>
                                        <td>${condominio.nome}</td>
                                        <td>${condominio.endereco}</td>
                                        <td>${condominio.cidade}/${condominio.estado}</td>
                                        <td>${condominio.unidades || 'N/A'}</td>
                                        <td>
                                            <span class="badge ${condominio.status === 'ativo' ? 'badge-success' : 'badge-danger'}">
                                                ${condominio.status === 'ativo' ? 'Ativo' : 'Inativo'}
                                            </span>
                                        </td>
                                        ${(!currentUser.permissoes || currentUser.permissoes.includes('*') || currentUser.permissoes.includes('condominios')) ? `
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editCondominio('${condominio.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteCondominio('${condominio.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                        ` : ''}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ` : '<p>Nenhum condom√≠nio dispon√≠vel para visualiza√ß√£o.</p>'}
                    </div>
                </div>
            `;
        }

        function loadUsuariosContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && !currentUser.permissoes.includes('*') && !currentUser.permissoes.includes('usuarios')) {
                moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Acesso negado!</strong> Voc√™ n√£o tem permiss√£o para acessar este m√≥dulo.</div>`;
                return;
            }
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Gerenciar Usu√°rios</h3>
                        <button class="btn btn-primary" onclick="openUserModal()">
                            <i class="fas fa-plus"></i> Novo Usu√°rio
                        </button>
                    </div>
                    <div class="card-body">
                        ${usuarios.length > 0 ? `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Usu√°rio</th>
                                    <th>Tipo</th>
                                    <th>E-mail</th>
                                    <th>Condom√≠nios</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${usuarios.map(usuario => `
                                    <tr>
                                        <td>${usuario.nome}</td>
                                        <td>${usuario.usuario}</td>
                                        <td>${formatUserType(usuario.tipo)}</td>
                                        <td>${usuario.email || 'N/A'}</td>
                                        <td>${usuario.condominios ? usuario.condominios.length : 0}</td>
                                        <td>
                                            <span class="badge ${usuario.status === 'ativo' ? 'badge-success' : 'badge-danger'}">
                                                ${usuario.status === 'ativo' ? 'Ativo' : 'Inativo'}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editUser('${usuario.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${usuario.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ` : '<p>Nenhum usu√°rio cadastrado.</p>'}
                    </div>
                </div>
            `;
        }

        function loadMoradoresContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && !currentUser.permissoes.includes('*') && !currentUser.permissoes.includes('moradores')) {
                moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Acesso negado!</strong> Voc√™ n√£o tem permiss√£o para acessar este m√≥dulo.</div>`;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Selecione um condom√≠nio</strong> para acessar o m√≥dulo de moradores.</div>`;
                return;
            }
            const filteredMoradores = moradores.filter(m => m.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Moradores - ${currentCondominio.nome}</h3>
                        <button class="btn btn-primary" onclick="openMoradorModal()">
                            <i class="fas fa-plus"></i> Novo Morador
                        </button>
                    </div>
                    <div class="card-body">
                        ${filteredMoradores.length > 0 ? `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Morador</th>
                                    <th>Apartamento</th>
                                    <th>Telefone</th>
                                    <th>Garagem</th>
                                    <th>Vaga</th>
                                    <th>Observa√ß√µes</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredMoradores.map(morador => `
                                    <tr>
                                        <td>${morador.nome}</td>
                                        <td>${morador.apto}</td>
                                        <td>${morador.telefone || '-'}</td>
                                        <td>${morador.garagem || '-'}</td>
                                        <td>${morador.vaga || '-'}</td>
                                        <td>${morador.observacoes || '-'}</td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editMorador('${morador.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteMorador('${morador.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ` : '<p>Nenhum morador cadastrado para este condom√≠nio.</p>'}
                    </div>
                </div>
            `;
        }

        // ‚úÖ CORRE√á√ÉO 2: M√ìDULO LEMBRETES COM dataInicio e dataFim
        function loadLembretesContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && !currentUser.permissoes.includes('*') && !currentUser.permissoes.includes('lembretes')) {
                moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Acesso negado!</strong> Voc√™ n√£o tem permiss√£o para acessar este m√≥dulo.</div>`;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Selecione um condom√≠nio</strong> para acessar o m√≥dulo de lembretes.</div>`;
                return;
            }
            const filteredLembretes = lembretes.filter(l => l.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Lembretes - ${currentCondominio.nome}</h3>
                        <button class="btn btn-primary" onclick="openLembreteModal()">
                            <i class="fas fa-plus"></i> Novo Lembrete
                        </button>
                    </div>
                    <div class="card-body">
                        ${filteredLembretes.length > 0 ? `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>T√≠tulo</th>
                                    <th>Descri√ß√£o</th>
                                    <th>In√≠cio</th>
                                    <th>Fim</th>
                                    <th>Prioridade</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredLembretes.map(lembrete => `
                                    <tr>
                                        <td>${lembrete.titulo}</td>
                                        <td>${lembrete.descricao || '-'}</td>
                                        <td>${formatDate(lembrete.dataInicio)}</td>
                                        <td>${formatDate(lembrete.dataFim)}</td>
                                        <td>
                                            <span class="badge ${lembrete.prioridade === 'alta' ? 'badge-danger' : lembrete.prioridade === 'media' ? 'badge-warning' : 'badge-info'}">
                                                ${lembrete.prioridade === 'alta' ? 'Alta' : lembrete.prioridade === 'media' ? 'M√©dia' : 'Baixa'}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editLembrete('${lembrete.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteLembrete('${lembrete.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ` : '<p>Nenhum lembrete cadastrado para este condom√≠nio.</p>'}
                    </div>
                </div>
            `;
        }

        function loadLimpezaContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && !currentUser.permissoes.includes('*') && !currentUser.permissoes.includes('limpeza')) {
                moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Acesso negado!</strong> Voc√™ n√£o tem permiss√£o para acessar este m√≥dulo.</div>`;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Selecione um condom√≠nio</strong> para acessar o m√≥dulo de limpeza.</div>`;
                return;
            }
            const filteredLimpezas = limpezas.filter(l => l.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Registros de Limpeza - ${currentCondominio.nome}</h3>
                        <button class="btn btn-primary" onclick="openLimpezaModal()">
                            <i class="fas fa-plus"></i> Novo Registro
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Filtrar por Espa√ßo</label>
                                <select class="form-control" id="filtroEspacoLimpeza" onchange="filterLimpezas()">
                                    <option value="">Todos os espa√ßos</option>
                                    <option value="salao-social">Sal√£o Social</option>
                                    <option value="churrasqueira">Churrasqueira</option>
                                    <option value="quiosque">Quiosque</option>
                                    <option value="pergolado">Pergolado</option>
                                    <option value="sauna">Sauna</option>
                                    <option value="area-comum">√Årea Comum</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Filtrar por Status</label>
                                <select class="form-control" id="filtroStatusLimpeza" onchange="filterLimpezas()">
                                    <option value="">Todos</option>
                                    <option value="em-andamento">Em Andamento</option>
                                    <option value="concluido">Conclu√≠do</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Filtrar por Data</label>
                                <input type="date" class="form-control" id="filtroDataLimpeza" onchange="filterLimpezas()">
                            </div>
                        </div>
                        <table class="table" id="limpezasTable">
                            <thead>
                                <tr>
                                    <th>Respons√°vel</th>
                                    <th>Espa√ßo</th>
                                    <th>Data</th>
                                    <th>Hor√°rio</th>
                                    <th>Tempo (min)</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredLimpezas.map(limpeza => `
                                    <tr>
                                        <td>${limpeza.responsavel}</td>
                                        <td>${getEspacoNome(limpeza.espaco)}</td>
                                        <td>${formatDate(limpeza.data)}</td>
                                        <td>${limpeza.horaInicio} ${limpeza.horaFim ? ' - ' + limpeza.horaFim : ''}</td>
                                        <td>${limpeza.tempoUso || '-'}</td>
                                        <td>
                                            <span class="badge ${limpeza.status === 'concluido' ? 'badge-success' : 'badge-warning'}">
                                                ${limpeza.status === 'concluido' ? 'Conclu√≠do' : 'Em Andamento'}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editLimpeza('${limpeza.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            ${limpeza.status !== 'concluido' ? `
                                            <button class="btn btn-sm btn-success" onclick="concluirLimpeza('${limpeza.id}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            ` : ''}
                                            <button class="btn btn-sm btn-danger" onclick="deleteLimpeza('${limpeza.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function loadSaunaContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && !currentUser.permissoes.includes('*') && !currentUser.permissoes.includes('sauna')) {
                moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Acesso negado!</strong> Voc√™ n√£o tem permiss√£o para acessar este m√≥dulo.</div>`;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Selecione um condom√≠nio</strong> para acessar o m√≥dulo de sauna.</div>`;
                return;
            }
            const filteredSaunas = saunas.filter(s => s.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Agendamentos de Sauna - ${currentCondominio.nome}</h3>
                        <button class="btn btn-primary" onclick="openSaunaModal()">
                            <i class="fas fa-plus"></i> Novo Agendamento
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Filtrar por Status</label>
                                <select class="form-control" id="filtroStatusSauna" onchange="filterSaunas()">
                                    <option value="">Todos</option>
                                    <option value="agendado">Agendado</option>
                                    <option value="em-uso">Em Uso</option>
                                    <option value="concluido">Conclu√≠do</option>
                                    <option value="cancelado">Cancelado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Filtrar por Data</label>
                                <input type="date" class="form-control" id="filtroDataSauna" onchange="filterSaunas()">
                            </div>
                        </div>
                        <table class="table" id="saunasTable">
                            <thead>
                                <tr>
                                    <th>Morador</th>
                                    <th>Apartamento</th>
                                    <th>Data</th>
                                    <th>Hor√°rio</th>
                                    <th>Tempo (min)</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredSaunas.map(sauna => `
                                    <tr>
                                        <td>${sauna.morador}</td>
                                        <td>${sauna.apto}</td>
                                        <td>${formatDate(sauna.data)}</td>
                                        <td>${sauna.horaInicio} ${sauna.horaFim ? ' - ' + sauna.horaFim : ''}</td>
                                        <td>${sauna.tempoUso || '-'}</td>
                                        <td>
                                            <span class="status-badge status-${sauna.status}">
                                                ${formatStatusSauna(sauna.status)}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editSauna('${sauna.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            ${sauna.status === 'em-uso' ? `
                                            <button class="btn btn-sm btn-success" onclick="concluirSauna('${sauna.id}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            ` : ''}
                                            ${sauna.status === 'agendado' ? `
                                            <button class="btn btn-sm btn-warning" onclick="iniciarSauna('${sauna.id}')">
                                                <i class="fas fa-play"></i>
                                            </button>
                                            ` : ''}
                                            <button class="btn btn-sm btn-danger" onclick="deleteSauna('${sauna.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function loadAgendamentosContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && !currentUser.permissoes.includes('*') && !currentUser.permissoes.includes('agendamentos')) {
                moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Acesso negado!</strong> Voc√™ n√£o tem permiss√£o para acessar este m√≥dulo.</div>`;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Selecione um condom√≠nio</strong> para acessar o m√≥dulo de agendamentos.</div>`;
                return;
            }
            const filteredAgendamentos = agendamentos.filter(a => a.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="agendamentos-header">
                    <div class="agendamentos-title">Agendamentos - ${currentCondominio.nome}</div>
                    <div class="calendar-controls">
                        <button class="btn btn-primary" onclick="openAgendamentoModal()">
                            <i class="fas fa-plus"></i> Novo Agendamento
                        </button>
                    </div>
                </div>
                <div class="menu-agendamentos">
                    <h3>Filtros de Agendamento</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Espa√ßo</label>
                            <select id="filtroEspaco" class="form-control" onchange="filterAgendamentos()">
                                <option value="">Todos os espa√ßos</option>
                                <option value="salao-social">Sal√£o Social</option>
                                <option value="churrasqueira">Churrasqueira</option>
                                <option value="quiosque">Quiosque</option>
                                <option value="pergolado">Pergolado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="filtroStatus" class="form-control" onchange="filterAgendamentos()">
                                <option value="">Todos os status</option>
                                <option value="agendado">Agendado</option>
                                <option value="em-uso">Em Uso</option>
                                <option value="liberado">Liberado</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" id="filtroData" class="form-control" onchange="filterAgendamentos()">
                        </div>
                    </div>
                </div>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button class="btn" onclick="changeCalendarMonth(-1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="calendar-title" id="calendarTitle">${getMonthName(currentCalendarMonth)} ${currentCalendarYear}</div>
                            <button class="btn" onclick="changeCalendarMonth(1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="calendar-view-options">
                            <button class="btn active" onclick="changeCalendarView('month')">M√™s</button>
                            <button class="btn" onclick="changeCalendarView('week')">Semana</button>
                            <button class="btn" onclick="changeCalendarView('day')">Dia</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                    <div class="calendar-legends">
                        <div class="legend-item"><div class="legend-color" style="background-color: #3498db;"></div><span>Sal√£o Social</span></div>
                        <div class="legend-item"><div class="legend-color" style="background-color: #e74c3c;"></div><span>Churrasqueira</span></div>
                        <div class="legend-item"><div class="legend-color" style="background-color: #2ecc71;"></div><span>Quiosque</span></div>
                        <div class="legend-item"><div class="legend-color" style="background-color: #9b59b6;"></div><span>Pergolado</span></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h4>Lista de Agendamentos - ${currentCondominio.nome}</h4>
                    </div>
                    <div class="card-body">
                        <table class="table" id="agendamentosTable">
                            <thead>
                                <tr>
                                    <th>Espa√ßo</th>
                                    <th>Solicitante</th>
                                    <th>Data</th>
                                    <th>Hor√°rio</th>
                                    <th>Unidade</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            `;
            generateCalendar(currentCalendarMonth, currentCalendarYear);
            loadAgendamentosList();
        }

        function loadContasContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && !currentUser.permissoes.includes('*') && !currentUser.permissoes.includes('contas')) {
                moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Acesso negado!</strong> Voc√™ n√£o tem permiss√£o para acessar este m√≥dulo.</div>`;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Selecione um condom√≠nio</strong> para acessar o m√≥dulo de contas a pagar.</div>`;
                return;
            }
            const filteredContas = contas.filter(c => c.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Contas a Pagar - ${currentCondominio.nome}</h3>
                        <button class="btn btn-primary" onclick="openContaModal()">
                            <i class="fas fa-plus"></i> Nova Conta
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Filtrar por Status</label>
                                <select class="form-control" id="filtroStatusConta" onchange="filterContas()">
                                    <option value="">Todos</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="pago">Pago</option>
                                    <option value="atrasado">Atrasado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Filtrar por Categoria</label>
                                <select class="form-control" id="filtroCategoriaConta" onchange="filterContas()">
                                    <option value="">Todas</option>
                                    <option value="manutencao">Manuten√ß√£o</option>
                                    <option value="limpeza">Limpeza</option>
                                    <option value="seguranca">Seguran√ßa</option>
                                    <option value="administrativo">Administrativo</option>
                                    <option value="energia">Energia</option>
                                    <option value="agua">√Ågua</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                        </div>
                        <table class="table" id="contasTable">
                            <thead>
                                <tr>
                                    <th>Descri√ß√£o</th>
                                    <th>Valor</th>
                                    <th>Vencimento</th>
                                    <th>Categoria</th>
                                    <th>Fornecedor</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredContas.map(conta => `
                                    <tr>
                                        <td>${conta.descricao}</td>
                                        <td>R$ ${conta.valor.toFixed(2)}</td>
                                        <td>${formatDate(conta.vencimento)}</td>
                                        <td>${formatCategoriaConta(conta.categoria)}</td>
                                        <td>${conta.fornecedor || '-'}</td>
                                        <td>
                                            <span class="status-badge status-${conta.status}">
                                                ${formatStatusConta(conta.status)}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editConta('${conta.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-success" onclick="marcarContaComoPaga('${conta.id}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteConta('${conta.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function loadRelatoriosContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes && !currentUser.permissoes.includes('*') && !currentUser.permissoes.includes('relatorios')) {
                moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Acesso negado!</strong> Voc√™ n√£o tem permiss√£o para acessar este m√≥dulo.</div>`;
                return;
            }
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const firstDayStr = firstDay.toISOString().split('T')[0];
            const lastDayStr = lastDay.toISOString().split('T')[0];
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Relat√≥rios - ${currentCondominio ? currentCondominio.nome : 'Todos os condom√≠nios'}</h3>
                    </div>
                    <div class="card-body">
                        <div class="report-filters">
                            <h4>Filtros do Relat√≥rio</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tipo de Relat√≥rio</label>
                                    <select class="form-control" id="reportType">
                                        <option value="agendamentos">Agendamentos</option>
                                        <option value="contas">Contas a Pagar</option>
                                        <option value="usuarios">Usu√°rios</option>
                                        <option value="moradores">Moradores</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Per√≠odo Inicial</label>
                                    <input type="date" class="form-control" id="reportStartDate" value="${firstDayStr}">
                                </div>
                                <div class="form-group">
                                    <label>Per√≠odo Final</label>
                                    <input type="date" class="form-control" id="reportEndDate" value="${lastDayStr}">
                                </div>
                            </div>
                            ${currentCondominio ? `
                            <div class="form-group">
                                <label>Condom√≠nio</label>
                                <select class="form-control" id="reportCondominio">
                                    <option value="${currentCondominio.id}">${currentCondominio.nome}</option>
                                </select>
                            </div>
                            ` : ''}
                            <div class="report-actions">
                                <button class="btn btn-primary" onclick="generateReport()">
                                    <i class="fas fa-chart-bar"></i> Gerar Relat√≥rio
                                </button>
                                <button class="btn btn-success" onclick="exportReport()">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div class="report-preview" id="reportPreview">
                            <p>Selecione os filtros e clique em "Gerar Relat√≥rio"</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // ========== FUN√á√ïES AUXILIARES ==========
        function getEspacoNome(espacoId) {
            const espacos = {
                'salao-social': 'Sal√£o Social',
                'churrasqueira': 'Churrasqueira',
                'quiosque': 'Quiosque',
                'pergolado': 'Pergolado',
                'sauna': 'Sauna',
                'area-comum': '√Årea Comum'
            };
            return espacos[espacoId] || espacoId;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }

        function getCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatUserType(userType) {
            const types = {
                'sindico': 'S√≠ndico',
                'subsindico': 'Subs√≠ndico',
                'zelador': 'Zelador',
                'portaria': 'Portaria',
                'prestador': 'Prestador de Servi√ßo',
                'morador': 'Morador'
            };
            return types[userType] || userType;
        }

        function formatStatusAgendamento(status) {
            const statusMap = {
                'agendado': 'Agendado',
                'em-uso': 'Em Uso',
                'liberado': 'Liberado',
                'cancelado': 'Cancelado'
            };
            return statusMap[status] || status;
        }

        function formatCategoriaConta(categoria) {
            const categorias = {
                'manutencao': 'Manuten√ß√£o',
                'limpeza': 'Limpeza',
                'seguranca': 'Seguran√ßa',
                'administrativo': 'Administrativo',
                'energia': 'Energia',
                'agua': '√Ågua',
                'outros': 'Outros'
            };
            return categorias[categoria] || categoria;
        }

        function formatStatusConta(status) {
            const statusMap = {
                'pendente': 'Pendente',
                'pago': 'Pago',
                'atrasado': 'Atrasado'
            };
            return statusMap[status] || status;
        }

        function formatStatusSauna(status) {
            const statusMap = {
                'agendado': 'Agendado',
                'em-uso': 'Em Uso',
                'concluido': 'Conclu√≠do',
                'cancelado': 'Cancelado'
            };
            return statusMap[status] || status;
        }

        function getMonthName(month) {
            const months = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return months[month];
        }

        // ========== CALEND√ÅRIO ==========
        function generateCalendar(month, year) {
            const calendarGrid = document.getElementById('calendarGrid');
            if (!calendarGrid) return;
            document.getElementById('calendarTitle').textContent = `${getMonthName(month)} ${year}`;
            calendarGrid.innerHTML = '';
            const daysOfWeek = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            daysOfWeek.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const firstDayOfWeek = firstDay.getDay();
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.innerHTML = `<div class="day-number">${prevMonthLastDay - i}</div>`;
                calendarGrid.appendChild(day);
            }
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const day = document.createElement('div');
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const today = new Date();
                const isToday = today.getDate() === i && today.getMonth() === month && today.getFullYear() === year;
                day.className = `calendar-day ${isToday ? 'today' : ''}`;
                day.innerHTML = `<div class="day-number">${i}</div>`;
                const dayEvents = agendamentos.filter(a =>
                    a.data === dateStr && a.condominioId === (currentCondominio ? currentCondominio.id : '')
                );
                dayEvents.forEach(event => {
                    const eventElement = document.createElement('div');
                    eventElement.className = `event-item ${event.espaco}`;
                    eventElement.textContent = `${event.unidade} ${event.horaInicio} a ${event.horaFim}`;
                    eventElement.title = `${getEspacoNome(event.espaco)}: ${event.responsavel} (${event.unidade}) - ${event.horaInicio} a ${event.horaFim}`;
                    eventElement.addEventListener('click', function(e) {
                        e.stopPropagation();
                        showAgendamentoActions(event, eventElement);
                    });
                    day.appendChild(eventElement);
                });
                day.addEventListener('click', function() {
                    openAgendamentoModalForDate(dateStr);
                });
                calendarGrid.appendChild(day);
            }
            const totalCells = 42;
            const daysSoFar = firstDayOfWeek + lastDay.getDate();
            const nextMonthDays = totalCells - daysSoFar;
            for (let i = 1; i <= nextMonthDays; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.innerHTML = `<div class="day-number">${i}</div>`;
                calendarGrid.appendChild(day);
            }
        }

        function changeCalendarMonth(direction) {
            currentCalendarMonth += direction;
            if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            } else if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            }
            generateCalendar(currentCalendarMonth, currentCalendarYear);
        }

        function changeCalendarView(view) {
            document.querySelectorAll('.calendar-view-options .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            alert(`Visualiza√ß√£o alterada para: ${view}`);
        }

        function showAgendamentoActions(agendamento, element) {
            const existingModal = document.querySelector('.agendamento-actions-modal');
            if (existingModal) existingModal.remove();
            const modal = document.createElement('div');
            modal.className = 'agendamento-actions-modal';
            modal.innerHTML = `
                <button onclick="editAgendamento('${agendamento.id}')">Editar</button>
                <button onclick="updateAgendamentoStatus('${agendamento.id}', 'liberado')">Marcar como Liberado</button>
                <button onclick="updateAgendamentoStatus('${agendamento.id}', 'cancelado')">Cancelar</button>
            `;
            const rect = element.getBoundingClientRect();
            modal.style.position = 'fixed';
            modal.style.top = `${rect.bottom + window.scrollY}px`;
            modal.style.left = `${rect.left + window.scrollX}px`;
            document.body.appendChild(modal);
            const closeModal = function(e) {
                if (!modal.contains(e.target)) {
                    modal.remove();
                    document.removeEventListener('click', closeModal);
                }
            };
            setTimeout(() => {
                document.addEventListener('click', closeModal);
            }, 100);
        }

        async function updateAgendamentoStatus(agendamentoId, status) {
            try {
                await db.collection('agendamentos').doc(agendamentoId).update({
                    status: status,
                    dataAtualizacao: new Date().toISOString()
                });
                await loadSystemData();
                if (currentModule === 'agendamentos') loadAgendamentosContent();
                alert(`Agendamento ${status === 'liberado' ? 'marcado como liberado' : 'cancelado'} com sucesso!`);
            } catch (error) {
                console.error('Erro ao atualizar status do agendamento:', error);
                alert('Erro ao atualizar status do agendamento. Tente novamente.');
            }
        }

        function filterAgendamentos() {
            const espaco = document.getElementById('filtroEspaco').value;
            const status = document.getElementById('filtroStatus').value;
            const data = document.getElementById('filtroData').value;
            let filteredAgendamentos = agendamentos.filter(a => a.condominioId === (currentCondominio ? currentCondominio.id : ''));
            if (espaco) filteredAgendamentos = filteredAgendamentos.filter(a => a.espaco === espaco);
            if (status) filteredAgendamentos = filteredAgendamentos.filter(a => a.status === status);
            if (data) filteredAgendamentos = filteredAgendamentos.filter(a => a.data === data);
            const tbody = document.querySelector('#agendamentosTable tbody');
            tbody.innerHTML = '';
            if (filteredAgendamentos.length > 0) {
                filteredAgendamentos.forEach(agendamento => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${getEspacoNome(agendamento.espaco)}</td>
                        <td>${agendamento.responsavel}</td>
                        <td>${formatDate(agendamento.data)}</td>
                        <td>${agendamento.horaInicio} - ${agendamento.horaFim}</td>
                        <td>${agendamento.unidade}</td>
                        <td>
                            <span class="status-badge status-${agendamento.status}">
                                ${formatStatusAgendamento(agendamento.status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editAgendamento('${agendamento.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteAgendamento('${agendamento.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum agendamento encontrado com os filtros aplicados.</td></tr>';
            }
        }

        function loadAgendamentosList() {
            filterAgendamentos();
        }

        function filterContas() {
            const status = document.getElementById('filtroStatusConta').value;
            const categoria = document.getElementById('filtroCategoriaConta').value;
            let filteredContas = contas.filter(c => c.condominioId === (currentCondominio ? currentCondominio.id : ''));
            if (status) filteredContas = filteredContas.filter(c => c.status === status);
            if (categoria) filteredContas = filteredContas.filter(c => c.categoria === categoria);
            const tbody = document.querySelector('#contasTable tbody');
            tbody.innerHTML = '';
            if (filteredContas.length > 0) {
                filteredContas.forEach(conta => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${conta.descricao}</td>
                        <td>R$ ${conta.valor.toFixed(2)}</td>
                        <td>${formatDate(conta.vencimento)}</td>
                        <td>${formatCategoriaConta(conta.categoria)}</td>
                        <td>${conta.fornecedor || '-'}</td>
                        <td>
                            <span class="status-badge status-${conta.status}">
                                ${formatStatusConta(conta.status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editConta('${conta.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="marcarContaComoPaga('${conta.id}')">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteConta('${conta.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma conta encontrada com os filtros aplicados.</td></tr>';
            }
        }

        // ========== AGENDAMENTOS ==========
        function openAgendamentoModal() {
            document.getElementById('agendamentoModalTitle').textContent = 'Novo Agendamento';
            document.getElementById('editingAgendamentoId').value = '';
            document.getElementById('agendamentoForm').reset();
            document.getElementById('agendamentoData').value = '';
            document.getElementById('agendamentoDataInput').value = getCurrentDate();
            document.getElementById('agendamentoStatus').value = 'agendado';
            document.getElementById('agendamentoModal').style.display = 'flex';
        }

        function openAgendamentoModalForDate(dateStr) {
            openAgendamentoModal();
            document.getElementById('agendamentoData').value = dateStr;
            document.getElementById('agendamentoDataInput').value = dateStr;
        }

        function closeAgendamentoModal() {
            document.getElementById('agendamentoModal').style.display = 'none';
        }

        document.getElementById('agendamentoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condom√≠nio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingAgendamentoId').value;
            const espaco = document.getElementById('agendamentoEspaco').value;
            const data = document.getElementById('agendamentoDataInput').value;
            const agendamentoExistente = agendamentos.find(a =>
                a.condominioId === currentCondominio.id &&
                a.espaco === espaco &&
                a.data === data &&
                a.id != editingId
            );
            if (agendamentoExistente) {
                alert(`J√° existe um agendamento para ${getEspacoNome(espaco)} na data ${formatDate(data)}. Cada espa√ßo s√≥ pode ter um agendamento por dia.`);
                return;
            }
            const agendamentoData = {
                espaco: espaco,
                data: data,
                horaInicio: document.getElementById('agendamentoHoraInicio').value,
                horaFim: document.getElementById('agendamentoHoraFim').value,
                responsavel: document.getElementById('agendamentoResponsavel').value,
                unidade: document.getElementById('agendamentoUnidade').value,
                status: document.getElementById('agendamentoStatus').value,
                observacoes: document.getElementById('agendamentoObservacoes').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('agendamentos').doc(editingId).update(agendamentoData);
                } else {
                    await db.collection('agendamentos').add(agendamentoData);
                }
                await loadSystemData();
                closeAgendamentoModal();
                if (currentModule === 'agendamentos') loadAgendamentosContent();
                alert('Agendamento salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar agendamento:', error);
                alert('Erro ao salvar agendamento. Tente novamente.');
            }
        });

        function editAgendamento(id) {
            const agendamento = agendamentos.find(a => a.id === id);
            if (!agendamento) return;
            document.getElementById('agendamentoModalTitle').textContent = 'Editar Agendamento';
            document.getElementById('editingAgendamentoId').value = agendamento.id;
            document.getElementById('agendamentoEspaco').value = agendamento.espaco;
            document.getElementById('agendamentoDataInput').value = agendamento.data;
            document.getElementById('agendamentoHoraInicio').value = agendamento.horaInicio;
            document.getElementById('agendamentoHoraFim').value = agendamento.horaFim;
            document.getElementById('agendamentoResponsavel').value = agendamento.responsavel;
            document.getElementById('agendamentoUnidade').value = agendamento.unidade;
            document.getElementById('agendamentoStatus').value = agendamento.status;
            document.getElementById('agendamentoObservacoes').value = agendamento.observacoes || '';
            document.getElementById('agendamentoModal').style.display = 'flex';
        }

        async function deleteAgendamento(id) {
            if (!confirm('Tem certeza que deseja excluir este agendamento?')) return;
            try {
                await db.collection('agendamentos').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'agendamentos') loadAgendamentosContent();
                alert('Agendamento exclu√≠do com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir agendamento:', error);
                alert('Erro ao excluir agendamento. Tente novamente.');
            }
        }

        // ========== CONTAS ==========
        function openContaModal() {
            document.getElementById('contaModalTitle').textContent = 'Nova Conta a Pagar';
            document.getElementById('editingContaId').value = '';
            document.getElementById('contaForm').reset();
            const dataPadrao = new Date();
            dataPadrao.setDate(dataPadrao.getDate() + 30);
            document.getElementById('contaVencimento').value = dataPadrao.toISOString().split('T')[0];
            document.getElementById('contaStatus').value = 'pendente';
            document.getElementById('contaModal').style.display = 'flex';
        }

        function closeContaModal() {
            document.getElementById('contaModal').style.display = 'none';
        }

        document.getElementById('contaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condom√≠nio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingContaId').value;
            const contaData = {
                descricao: document.getElementById('contaDescricao').value,
                valor: parseFloat(document.getElementById('contaValor').value),
                vencimento: document.getElementById('contaVencimento').value,
                categoria: document.getElementById('contaCategoria').value,
                fornecedor: document.getElementById('contaFornecedor').value,
                status: document.getElementById('contaStatus').value,
                observacoes: document.getElementById('contaObservacoes').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('contas').doc(editingId).update(contaData);
                } else {
                    await db.collection('contas').add(contaData);
                }
                await loadSystemData();
                closeContaModal();
                if (currentModule === 'contas') loadContasContent();
                alert('Conta salva com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar conta:', error);
                alert('Erro ao salvar conta. Tente novamente.');
            }
        });

        function editConta(id) {
            const conta = contas.find(c => c.id === id);
            if (!conta) return;
            document.getElementById('contaModalTitle').textContent = 'Editar Conta a Pagar';
            document.getElementById('editingContaId').value = conta.id;
            document.getElementById('contaDescricao').value = conta.descricao;
            document.getElementById('contaValor').value = conta.valor;
            document.getElementById('contaVencimento').value = conta.vencimento;
            document.getElementById('contaCategoria').value = conta.categoria;
            document.getElementById('contaFornecedor').value = conta.fornecedor || '';
            document.getElementById('contaStatus').value = conta.status;
            document.getElementById('contaObservacoes').value = conta.observacoes || '';
            document.getElementById('contaModal').style.display = 'flex';
        }

        async function deleteConta(id) {
            if (!confirm('Tem certeza que deseja excluir esta conta?')) return;
            try {
                await db.collection('contas').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'contas') loadContasContent();
                alert('Conta exclu√≠da com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir conta:', error);
                alert('Erro ao excluir conta. Tente novamente.');
            }
        }

        async function marcarContaComoPaga(id) {
            try {
                await db.collection('contas').doc(id).update({
                    status: 'pago',
                    dataAtualizacao: new Date().toISOString()
                });
                await loadSystemData();
                if (currentModule === 'contas') loadContasContent();
                else if (currentModule === 'dashboard') loadDashboardContent();
                alert('Conta marcada como paga com sucesso!');
            } catch (error) {
                console.error('Erro ao marcar conta como paga:', error);
                alert('Erro ao marcar conta como paga. Tente novamente.');
            }
        }

        // ========== LEMBRETES ==========
        function openLembreteModal() {
            document.getElementById('lembreteModalTitle').textContent = 'Novo Lembrete';
            document.getElementById('editingLembreteId').value = '';
            document.getElementById('lembreteForm').reset();
            const hoje = getCurrentDate();
            document.getElementById('lembreteDataInicio').value = hoje;
            document.getElementById('lembreteDataFim').value = hoje;
            document.getElementById('lembretePrioridade').value = 'media';
            document.getElementById('lembreteModal').style.display = 'flex';
        }

        function closeLembreteModal() {
            document.getElementById('lembreteModal').style.display = 'none';
        }

        document.getElementById('lembreteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condom√≠nio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingLembreteId').value;
            const lembreteData = {
                titulo: document.getElementById('lembreteTitulo').value,
                descricao: document.getElementById('lembreteDescricao').value,
                dataInicio: document.getElementById('lembreteDataInicio').value,
                dataFim: document.getElementById('lembreteDataFim').value,
                prioridade: document.getElementById('lembretePrioridade').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id,
                criadoPorNome: currentUser.nome || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('lembretes').doc(editingId).update(lembreteData);
                } else {
                    await db.collection('lembretes').add(lembreteData);
                }
                await loadSystemData();
                closeLembreteModal();
                if (currentModule === 'dashboard') loadDashboardContent();
                alert('Lembrete salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar lembrete:', error);
                alert('Erro ao salvar lembrete. Tente novamente.');
            }
        });

        function editLembrete(id) {
            const lembrete = lembretes.find(l => l.id === id);
            if (!lembrete) return;
            document.getElementById('lembreteModalTitle').textContent = 'Editar Lembrete';
            document.getElementById('editingLembreteId').value = lembrete.id;
            document.getElementById('lembreteTitulo').value = lembrete.titulo;
            document.getElementById('lembreteDescricao').value = lembrete.descricao || '';
            document.getElementById('lembreteDataInicio').value = lembrete.dataInicio;
            document.getElementById('lembreteDataFim').value = lembrete.dataFim;
            document.getElementById('lembretePrioridade').value = lembrete.prioridade || 'media';
            document.getElementById('lembreteModal').style.display = 'flex';
        }

        async function deleteLembrete(id) {
            if (!confirm('Tem certeza que deseja excluir este lembrete?')) return;
            try {
                await db.collection('lembretes').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'dashboard') loadDashboardContent();
                loadTickerContent();
                alert('Lembrete exclu√≠do com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir lembrete:', error);
                alert('Erro ao excluir lembrete. Tente novamente.');
            }
        }

        // ========== USU√ÅRIOS ==========
        function openUserModal() {
            document.getElementById('userModalTitle').textContent = 'Cadastrar Usu√°rio';
            document.getElementById('editingUserId').value = '';
            document.getElementById('userForm').reset();
            document.getElementById('userSenha').required = true;
            document.getElementById('senhaObrigatoria').style.display = 'inline';
            document.getElementById('senhaInfo').style.display = 'none';
            loadCondominiosForPermissions();
            loadModulesForPermissions();
            document.getElementById('userModal').style.display = 'flex';
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        function loadCondominiosForPermissions() {
            const container = document.getElementById('condominiosPermitidos');
            container.innerHTML = '';
            condominios.forEach(condominio => {
                const item = document.createElement('div');
                item.className = 'permission-item';
                item.innerHTML = `
                    <input type="checkbox" id="condominio-${condominio.id}" value="${condominio.id}">
                    <label for="condominio-${condominio.id}">${condominio.nome}</label>
                `;
                container.appendChild(item);
            });
        }

        // ‚úÖ CORRE√á√ÉO 3: PERMISS√ïES N√ÉO MARCAM TUDO AO EDITAR
        function loadModulesForPermissions() {
            const container = document.getElementById('permissoesUsuario');
            container.innerHTML = '';
            modules.forEach(module => {
                const item = document.createElement('div');
                item.className = 'permission-item';
                item.innerHTML = `
                    <input type="checkbox" id="module-${module.id}" value="${module.id}">
                    <label for="module-${module.id}">${module.name}</label>
                `;
                container.appendChild(item);
            });
        }

        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const editingId = document.getElementById('editingUserId').value;
            const userData = {
                nome: document.getElementById('userNome').value,
                usuario: document.getElementById('userUsuario').value,
                email: document.getElementById('userEmail').value,
                telefone: document.getElementById('userTelefone').value,
                tipo: document.getElementById('userTipo').value,
                status: 'ativo',
                criadoPor: currentUser.id || currentUser.usuario,
                dataAtualizacao: new Date().toISOString()
            };
            const senha = document.getElementById('userSenha').value;
            if (!editingId || senha) {
                userData.senha = senha;
            }
            if (!editingId) {
                userData.dataCriacao = new Date().toISOString();
            }
            const condominiosPermitidos = [];
            document.querySelectorAll('#condominiosPermitidos input:checked').forEach(checkbox => {
                condominiosPermitidos.push(checkbox.value);
            });
            userData.condominios = condominiosPermitidos;
            const modulosPermitidos = [];
            document.querySelectorAll('#permissoesUsuario input:checked').forEach(checkbox => {
                modulosPermitidos.push(checkbox.value);
            });
            userData.permissoes = modulosPermitidos;
            try {
                if (editingId) {
                    await db.collection('usuarios').doc(editingId).update(userData);
                } else {
                    await db.collection('usuarios').add(userData);
                }
                await loadSystemData();
                closeUserModal();
                if (currentModule === 'usuarios') loadUsuariosContent();
                alert('Usu√°rio salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar usu√°rio:', error);
                alert('Erro ao salvar usu√°rio. Tente novamente.');
            }
        });

        function editUser(id) {
            const usuario = usuarios.find(u => u.id === id);
            if (!usuario) return;
            document.getElementById('userModalTitle').textContent = 'Editar Usu√°rio';
            document.getElementById('editingUserId').value = usuario.id;
            document.getElementById('userNome').value = usuario.nome;
            document.getElementById('userUsuario').value = usuario.usuario;
            document.getElementById('userEmail').value = usuario.email || '';
            document.getElementById('userTelefone').value = usuario.telefone || '';
            document.getElementById('userSenha').value = '';
            document.getElementById('userTipo').value = usuario.tipo;
            document.getElementById('userSenha').required = false;
            document.getElementById('senhaObrigatoria').style.display = 'none';
            document.getElementById('senhaInfo').style.display = 'block';
            loadCondominiosForPermissions();
            loadModulesForPermissions();
            if (usuario.condominios) {
                usuario.condominios.forEach(condominioId => {
                    const checkbox = document.getElementById(`condominio-${condominioId}`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            if (usuario.permissoes) {
                usuario.permissoes.forEach(moduleId => {
                    const checkbox = document.getElementById(`module-${moduleId}`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            document.getElementById('userModal').style.display = 'flex';
        }

        async function deleteUser(id) {
            if (!confirm('Tem certeza que deseja excluir este usu√°rio?')) return;
            try {
                await db.collection('usuarios').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'usuarios') loadUsuariosContent();
                alert('Usu√°rio exclu√≠do com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir usu√°rio:', error);
                alert('Erro ao excluir usu√°rio. Tente novamente.');
            }
        }

        // ========== CONDOM√çNIOS ==========
        function openCondominioModal() {
            document.getElementById('condominioModalTitle').textContent = 'Cadastrar Condom√≠nio';
            document.getElementById('editingCondominioId').value = '';
            document.getElementById('condominioForm').reset();
            document.getElementById('condominioModal').style.display = 'flex';
        }

        function closeCondominioModal() {
            document.getElementById('condominioModal').style.display = 'none';
        }

        document.getElementById('condominioForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const editingId = document.getElementById('editingCondominioId').value;
            const condominioData = {
                nome: document.getElementById('condominioNome').value,
                endereco: document.getElementById('condominioEndereco').value,
                cidade: document.getElementById('condominioCidade').value,
                estado: document.getElementById('condominioEstado').value,
                cep: document.getElementById('condominioCEP').value,
                telefone: document.getElementById('condominioTelefone').value,
                cnpj: document.getElementById('condominioCNPJ').value,
                unidades: parseInt(document.getElementById('condominioUnidades').value) || 0,
                status: document.getElementById('condominioStatus').value,
                criadoPor: currentUser.id || currentUser.usuario,
                dataAtualizacao: new Date().toISOString()
            };
            if (!editingId) {
                condominioData.dataCriacao = new Date().toISOString();
            }
            try {
                if (editingId) {
                    await db.collection('condominios').doc(editingId).update(condominioData);
                } else {
                    await db.collection('condominios').add(condominioData);
                }
                await loadSystemData();
                closeCondominioModal();
                if (currentModule === 'condominios') loadCondominiosContent();
                alert('Condom√≠nio salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar condom√≠nio:', error);
                alert('Erro ao salvar condom√≠nio. Tente novamente.');
            }
        });

        function editCondominio(id) {
            const condominio = condominios.find(c => c.id === id);
            if (!condominio) return;
            document.getElementById('condominioModalTitle').textContent = 'Editar Condom√≠nio';
            document.getElementById('editingCondominioId').value = condominio.id;
            document.getElementById('condominioNome').value = condominio.nome;
            document.getElementById('condominioEndereco').value = condominio.endereco;
            document.getElementById('condominioCidade').value = condominio.cidade;
            document.getElementById('condominioEstado').value = condominio.estado;
            document.getElementById('condominioCEP').value = condominio.cep || '';
            document.getElementById('condominioTelefone').value = condominio.telefone || '';
            document.getElementById('condominioCNPJ').value = condominio.cnpj || '';
            document.getElementById('condominioUnidades').value = condominio.unidades || '';
            document.getElementById('condominioStatus').value = condominio.status || 'ativo';
            document.getElementById('condominioModal').style.display = 'flex';
        }

        async function deleteCondominio(id) {
            if (!confirm('Tem certeza que deseja excluir este condom√≠nio?')) return;
            try {
                await db.collection('condominios').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'condominios') loadCondominiosContent();
                alert('Condom√≠nio exclu√≠do com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir condom√≠nio:', error);
                alert('Erro ao excluir condom√≠nio. Tente novamente.');
            }
        }

        // ========== MORADORES ==========
        function openMoradorModal(moradorId = null) {
            const modal = document.getElementById('moradorModal');
            const title = document.getElementById('moradorModalTitle');
            if (moradorId) {
                const morador = moradores.find(m => m.id === moradorId);
                if (morador) {
                    title.textContent = 'Editar Morador';
                    document.getElementById('editingMoradorId').value = morador.id;
                    document.getElementById('moradorNome').value = morador.nome;
                    document.getElementById('moradorApto').value = morador.apto;
                    document.getElementById('moradorTelefone').value = morador.telefone || '';
                    document.getElementById('moradorGaragem').value = morador.garagem || '';
                    document.getElementById('moradorVaga').value = morador.vaga || '';
                    document.getElementById('moradorObservacoes').value = morador.observacoes || '';
                }
            } else {
                title.textContent = 'Cadastrar Morador';
                document.getElementById('moradorForm').reset();
                document.getElementById('editingMoradorId').value = '';
            }
            modal.style.display = 'flex';
        }

        function closeMoradorModal() {
            document.getElementById('moradorModal').style.display = 'none';
        }

        document.getElementById('moradorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condom√≠nio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingMoradorId').value;
            const moradorData = {
                nome: document.getElementById('moradorNome').value,
                apto: document.getElementById('moradorApto').value,
                telefone: document.getElementById('moradorTelefone').value,
                garagem: document.getElementById('moradorGaragem').value,
                vaga: document.getElementById('moradorVaga').value,
                observacoes: document.getElementById('moradorObservacoes').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('moradores').doc(editingId).update(moradorData);
                } else {
                    await db.collection('moradores').add(moradorData);
                }
                await loadSystemData();
                closeMoradorModal();
                if (currentModule === 'moradores') loadMoradoresContent();
                alert('Morador salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar morador:', error);
                alert('Erro ao salvar morador. Tente novamente.');
            }
        });

        function editMorador(id) {
            openMoradorModal(id);
        }

        async function deleteMorador(id) {
            if (!confirm('Tem certeza que deseja excluir este morador?')) return;
            try {
                await db.collection('moradores').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'moradores') loadMoradoresContent();
                alert('Morador exclu√≠do com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir morador:', error);
                alert('Erro ao excluir morador. Tente novamente.');
            }
        }

        // ========== LOGIN ==========
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            document.getElementById('loginBtnText').style.display = 'none';
            document.getElementById('loginLoading').style.display = 'inline-block';
            document.getElementById('loginBtn').disabled = true;
            try {
                const usuariosSnapshot = await db.collection('usuarios').where('usuario', '==', username).get();
                if (usuariosSnapshot.empty) throw new Error('Usu√°rio n√£o encontrado');
                let userFound = null;
                usuariosSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.senha === password) userFound = { id: doc.id, ...userData };
                });
                if (!userFound) throw new Error('Senha incorreta');
                currentUser = userFound;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                if (password === 'admin123' || password === '0000') {
                    document.getElementById('changePasswordModal').style.display = 'flex';
                } else {
                    await loadSystemData();
                    showMainSystem();
                    setupPresence();
                    setupRealtimeListeners();
                    setInterval(updateOnlineCount, 10000);
                }
            } catch (error) {
                document.getElementById('loginStatus').textContent = error.message || 'Erro ao fazer login';
                document.getElementById('loginStatus').style.color = 'red';
            } finally {
                document.getElementById('loginBtnText').style.display = 'inline';
                document.getElementById('loginLoading').style.display = 'none';
                document.getElementById('loginBtn').disabled = false;
            }
        });

        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (newPassword !== confirmPassword) {
                alert('As senhas n√£o coincidem!');
                return;
            }
            if (newPassword.length < 6) {
                alert('A senha deve ter pelo menos 6 caracteres!');
                return;
            }
            try {
                await db.collection('usuarios').doc(currentUser.id).update({
                    senha: newPassword,
                    primeiroLogin: false
                });
                document.getElementById('changePasswordModal').style.display = 'none';
                currentUser.senha = newPassword;
                currentUser.primeiroLogin = false;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                await loadSystemData();
                showMainSystem();
                setupPresence();
                setupRealtimeListeners();
                setInterval(updateOnlineCount, 10000);
                alert('Senha alterada com sucesso!');
            } catch (error) {
                console.error('Erro ao alterar senha:', error);
                alert('Erro ao alterar senha. Tente novamente.');
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('Deseja realmente sair do sistema?')) {
                if (presenceRef) {
                    presenceRef.update({
                        online: false,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                localStorage.removeItem('currentUser');
                currentUser = null;
                currentCondominio = null;
                showLoginPage();
            }
        });

        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            if (sidebar.style.width === '280px' || sidebar.style.width === '') {
                sidebar.style.width = '70px';
                mainContent.style.marginLeft = '70px';
            } else {
                sidebar.style.width = '280px';
                mainContent.style.marginLeft = '280px';
            }
        });

        document.getElementById('condominioSelect').addEventListener('change', function() {
            const condominioId = this.value;
            currentCondominio = condominios.find(c => c.id === condominioId);
            document.getElementById('currentCondominioBadge').textContent = currentCondominio ? currentCondominio.nome : 'Nenhum condom√≠nio selecionado';
            loadModuleContent(currentModule);
            loadTickerContent();
        });

        // ========== RELAT√ìRIOS ==========
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            let reportContent = '';
            switch(reportType) {
                case 'agendamentos': reportContent = generateAgendamentosReport(startDate, endDate); break;
                case 'usuarios': reportContent = generateUsuariosReport(); break;
                case 'moradores': reportContent = generateMoradoresReport(); break;
                case 'contas': reportContent = generateContasReport(startDate, endDate); break;
            }
            document.getElementById('reportPreview').innerHTML = reportContent;
        }

        function generateAgendamentosReport(startDate, endDate) {
            let filteredAgendamentos = agendamentos.filter(a => a.condominioId === (currentCondominio ? currentCondominio.id : ''));
            if (startDate) filteredAgendamentos = filteredAgendamentos.filter(a => a.data >= startDate);
            if (endDate) filteredAgendamentos = filteredAgendamentos.filter(a => a.data <= endDate);
            let report = `<h4>Relat√≥rio de Agendamentos</h4>`;
            report += `<p>Per√≠odo: ${startDate || 'In√≠cio'} a ${endDate || 'Fim'}</p>`;
            report += `<p>Condom√≠nio: ${currentCondominio ? currentCondominio.nome : 'Todos'}</p>`;
            report += `<p>Total de agendamentos: ${filteredAgendamentos.length}</p>`;
            report += `<div class="report-line"><strong>Data | Espa√ßo | Solicitante | Unidade | Hor√°rio | Status</strong></div>`;
            filteredAgendamentos.forEach(agendamento => {
                report += `<div class="report-line">`;
                report += `${formatDate(agendamento.data)} | `;
                report += `${getEspacoNome(agendamento.espaco)} | `;
                report += `${agendamento.responsavel} | `;
                report += `${agendamento.unidade} | `;
                report += `${agendamento.horaInicio}-${agendamento.horaFim} | `;
                report += `${formatStatusAgendamento(agendamento.status)}`;
                report += `</div>`;
            });
            return report;
        }

        function generateUsuariosReport() {
            let report = `<h4>Relat√≥rio de Usu√°rios</h4>`;
            report += `<p>Total de usu√°rios: ${usuarios.length}</p>`;
            report += `<div class="report-line"><strong>Nome | Usu√°rio | Tipo | E-mail | Status</strong></div>`;
            usuarios.forEach(usuario => {
                report += `<div class="report-line">`;
                report += `${usuario.nome} | `;
                report += `${usuario.usuario} | `;
                report += `${formatUserType(usuario.tipo)} | `;
                report += `${usuario.email || 'N/A'} | `;
                report += `${usuario.status === 'ativo' ? 'Ativo' : 'Inativo'}`;
                report += `</div>`;
            });
            return report;
        }

        function generateMoradoresReport() {
            const filteredMoradores = currentCondominio ?
                moradores.filter(m => m.condominioId === currentCondominio.id) :
                moradores;
            let report = `<h4>Relat√≥rio de Moradores</h4>`;
            report += `<p>Condom√≠nio: ${currentCondominio ? currentCondominio.nome : 'Todos'}</p>`;
            report += `<p>Total de moradores: ${filteredMoradores.length}</p>`;
            report += `<div class="report-line"><strong>Morador | Apartamento | Telefone | Garagem | Vaga</strong></div>`;
            filteredMoradores.forEach(morador => {
                report += `<div class="report-line">`;
                report += `${morador.nome} | `;
                report += `${morador.apto} | `;
                report += `${morador.telefone || '-'} | `;
                report += `${morador.garagem || '-'} | `;
                report += `${morador.vaga || '-'}`;
                report += `</div>`;
            });
            return report;
        }

        function generateContasReport(startDate, endDate) {
            let filteredContas = contas.filter(c => c.condominioId === (currentCondominio ? currentCondominio.id : ''));
            if (startDate) filteredContas = filteredContas.filter(c => c.vencimento >= startDate);
            if (endDate) filteredContas = filteredContas.filter(c => c.vencimento <= endDate);
            const total = filteredContas.reduce((sum, conta) => sum + conta.valor, 0);
            let report = `<h4>Relat√≥rio de Contas a Pagar</h4>`;
            report += `<p>Per√≠odo: ${startDate || 'In√≠cio'} a ${endDate || 'Fim'}</p>`;
            report += `<p>Condom√≠nio: ${currentCondominio ? currentCondominio.nome : 'Todos'}</p>`;
            report += `<p>Total de contas: ${filteredContas.length}</p>`;
            report += `<p>Valor total: R$ ${total.toFixed(2)}</p>`;
            report += `<div class="report-line"><strong>Vencimento | Descri√ß√£o | Valor | Categoria | Status</strong></div>`;
            filteredContas.forEach(conta => {
                report += `<div class="report-line">`;
                report += `${formatDate(conta.vencimento)} | `;
                report += `${conta.descricao} | `;
                report += `R$ ${conta.valor.toFixed(2)} | `;
                report += `${formatCategoriaConta(conta.categoria)} | `;
                report += `${formatStatusConta(conta.status)}`;
                report += `</div>`;
            });
            return report;
        }

        function exportReport() {
            const reportPreview = document.getElementById('reportPreview').innerText;
            const blob = new Blob([reportPreview], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'relatorio.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ========== PRESENCE SYSTEM ==========
        function setupPresence() {
            if (!currentUser) return;
            const userPresenceRef = db.collection('presence').doc(currentUser.id);
            presenceRef = userPresenceRef;
            const onClose = () => {
                if (presenceRef) {
                    presenceRef.update({
                        online: false,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            };
            userPresenceRef.set({
                userId: currentUser.id,
                nome: currentUser.nome || currentUser.usuario,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                online: true
            }, { merge: true });
            const keepAlive = setInterval(() => {
                if (presenceRef) {
                    presenceRef.update({
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                        online: true
                    });
                }
            }, 30000);
            window.addEventListener('beforeunload', onClose);
            window.addEventListener('pagehide', onClose);
            window.addEventListener('beforeunload', () => {
                clearInterval(keepAlive);
            });
        }

        // ‚úÖ CORRE√á√ÉO 1: CONTADOR DE USU√ÅRIOS ONLINE FUNCIONANDO
        async function updateOnlineCount() {
            try {
                const cutoff = new Date(Date.now() - 60000);
                const snapshot = await db.collection('presence')
                    .where('lastSeen', '>=', cutoff)
                    .where('online', '==', true)
                    .get();
                const onlineUsers = [];
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.userId !== currentUser.id) {
                        onlineUsers.push(userData);
                    }
                });
                document.getElementById('onlineCount').textContent = onlineUsers.length;
                if (onlineUsers.length > 0) {
                    const userNames = onlineUsers.map(user => user.nome).join(', ');
                    document.querySelector('.online-indicator').title = `Online: ${userNames}`;
                }
            } catch (error) {
                console.error('Erro ao atualizar contagem online:', error);
                document.getElementById('onlineCount').textContent = '0';
            }
        }

        function setupRealtimeListeners() {
            const collections = ['agendamentos', 'contas', 'lembretes', 'moradores', 'usuarios', 'condominios', 'limpezas', 'saunas'];
            collections.forEach(collection => {
                db.collection(collection).onSnapshot(() => {
                    if (document.getElementById('mainSystem').style.display !== 'none') {
                        loadSystemData().then(() => {
                            if (currentModule) loadModuleContent(currentModule);
                            loadTickerContent();
                        });
                    }
                });
            });
            db.collection('presence').onSnapshot(() => {
                updateOnlineCount();
            });
        }

        document.getElementById('newPassword')?.addEventListener('input', function() {
            const password = this.value;
            const strengthBar = document.getElementById('passwordStrength');
            let strength = 0;
            if (password.length >= 6) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/\d/)) strength++;
            if (password.match(/[^a-zA-Z\d]/)) strength++;
            strengthBar.className = 'password-strength ';
            if (strength <= 1) strengthBar.className += 'strength-weak';
            else if (strength === 2) strengthBar.className += 'strength-fair';
            else if (strength === 3) strengthBar.className += 'strength-good';
            else if (strength >= 4) strengthBar.className += 'strength-strong';
        });

        // Fun√ß√µes para Limpeza
        function openLimpezaModal() {
            document.getElementById('limpezaModalTitle').textContent = 'Novo Registro de Limpeza';
            document.getElementById('editingLimpezaId').value = '';
            document.getElementById('limpezaForm').reset();
            document.getElementById('limpezaData').value = getCurrentDate();
            const now = new Date();
            document.getElementById('limpezaHoraInicio').value = now.toTimeString().substring(0, 5);
            document.getElementById('limpezaStatus').value = 'em-andamento';
            document.getElementById('btnConcluirLimpeza').style.display = 'none';
            document.getElementById('limpezaModal').style.display = 'flex';
        }

        function closeLimpezaModal() {
            document.getElementById('limpezaModal').style.display = 'none';
        }

        function editLimpeza(id) {
            const limpeza = limpezas.find(l => l.id === id);
            if (!limpeza) return;
            document.getElementById('limpezaModalTitle').textContent = 'Editar Registro de Limpeza';
            document.getElementById('editingLimpezaId').value = limpeza.id;
            document.getElementById('limpezaResponsavel').value = limpeza.responsavel;
            document.getElementById('limpezaEspaco').value = limpeza.espaco;
            document.getElementById('limpezaData').value = limpeza.data;
            document.getElementById('limpezaHoraInicio').value = limpeza.horaInicio;
            document.getElementById('limpezaHoraFim').value = limpeza.horaFim || '';
            document.getElementById('limpezaTempoUso').value = limpeza.tempoUso || '';
            document.getElementById('limpezaObservacoes').value = limpeza.observacoes || '';
            document.getElementById('limpezaStatus').value = limpeza.status;
            if (limpeza.status !== 'concluido') {
                document.getElementById('btnConcluirLimpeza').style.display = 'inline-block';
            } else {
                document.getElementById('btnConcluirLimpeza').style.display = 'none';
            }
            document.getElementById('limpezaModal').style.display = 'flex';
        }

        document.getElementById('limpezaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condom√≠nio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingLimpezaId').value;
            const limpezaData = {
                responsavel: document.getElementById('limpezaResponsavel').value,
                espaco: document.getElementById('limpezaEspaco').value,
                data: document.getElementById('limpezaData').value,
                horaInicio: document.getElementById('limpezaHoraInicio').value,
                horaFim: document.getElementById('limpezaHoraFim').value,
                tempoUso: document.getElementById('limpezaTempoUso').value,
                observacoes: document.getElementById('limpezaObservacoes').value,
                status: document.getElementById('limpezaStatus').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('limpezas').doc(editingId).update(limpezaData);
                } else {
                    await db.collection('limpezas').add(limpezaData);
                }
                await loadSystemData();
                closeLimpezaModal();
                if (currentModule === 'limpeza') loadLimpezaContent();
                alert('Registro de limpeza salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar registro de limpeza:', error);
                alert('Erro ao salvar registro de limpeza. Tente novamente.');
            }
        });

        async function concluirLimpeza(id = null) {
            let limpezaId = id || document.getElementById('editingLimpezaId').value;
            if (!limpezaId) {
                alert('Nenhum registro de limpeza selecionado!');
                return;
            }
            const horaFim = new Date().toTimeString().substring(0, 5);
            const limpeza = limpezas.find(l => l.id === limpezaId);
            if (!limpeza) {
                alert('Registro de limpeza n√£o encontrado!');
                return;
            }
            const inicio = new Date(`2000-01-01T${limpeza.horaInicio}`);
            const fim = new Date(`2000-01-01T${horaFim}`);
            const tempoUso = Math.round((fim - inicio) / (1000 * 60));
            try {
                await db.collection('limpezas').doc(limpezaId).update({
                    horaFim: horaFim,
                    tempoUso: tempoUso,
                    status: 'concluido',
                    dataAtualizacao: new Date().toISOString()
                });
                await loadSystemData();
                closeLimpezaModal();
                if (currentModule === 'limpeza') loadLimpezaContent();
                alert('Limpeza conclu√≠da com sucesso! Tempo de uso: ' + tempoUso + ' minutos');
            } catch (error) {
                console.error('Erro ao concluir limpeza:', error);
                alert('Erro ao concluir limpeza. Tente novamente.');
            }
        }

        async function deleteLimpeza(id) {
            if (!confirm('Tem certeza que deseja excluir este registro de limpeza?')) return;
            try {
                await db.collection('limpezas').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'limpeza') loadLimpezaContent();
                alert('Registro de limpeza exclu√≠do com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir registro de limpeza:', error);
                alert('Erro ao excluir registro de limpeza. Tente novamente.');
            }
        }

        function filterLimpezas() {
            const espaco = document.getElementById('filtroEspacoLimpeza').value;
            const status = document.getElementById('filtroStatusLimpeza').value;
            const data = document.getElementById('filtroDataLimpeza').value;
            let filteredLimpezas = limpezas.filter(l => l.condominioId === (currentCondominio ? currentCondominio.id : ''));
            if (espaco) filteredLimpezas = filteredLimpezas.filter(l => l.espaco === espaco);
            if (status) filteredLimpezas = filteredLimpezas.filter(l => l.status === status);
            if (data) filteredLimpezas = filteredLimpezas.filter(l => l.data === data);
            const tbody = document.querySelector('#limpezasTable tbody');
            tbody.innerHTML = '';
            if (filteredLimpezas.length > 0) {
                filteredLimpezas.forEach(limpeza => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${limpeza.responsavel}</td>
                        <td>${getEspacoNome(limpeza.espaco)}</td>
                        <td>${formatDate(limpeza.data)}</td>
                        <td>${limpeza.horaInicio} ${limpeza.horaFim ? ' - ' + limpeza.horaFim : ''}</td>
                        <td>${limpeza.tempoUso || '-'}</td>
                        <td>
                            <span class="badge ${limpeza.status === 'concluido' ? 'badge-success' : 'badge-warning'}">
                                ${limpeza.status === 'concluido' ? 'Conclu√≠do' : 'Em Andamento'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editLimpeza('${limpeza.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${limpeza.status !== 'concluido' ? `
                            <button class="btn btn-sm btn-success" onclick="concluirLimpeza('${limpeza.id}')">
                                <i class="fas fa-check"></i>
                            </button>
                            ` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteLimpeza('${limpeza.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum registro de limpeza encontrado com os filtros aplicados.</td></tr>';
            }
        }

        // Fun√ß√µes para Sauna
        function openSaunaModal() {
            document.getElementById('saunaModalTitle').textContent = 'Novo Agendamento de Sauna';
            document.getElementById('editingSaunaId').value = '';
            document.getElementById('saunaForm').reset();
            document.getElementById('saunaData').value = getCurrentDate();
            document.getElementById('saunaStatus').value = 'agendado';
            document.getElementById('btnConcluirSauna').style.display = 'none';
            document.getElementById('saunaModal').style.display = 'flex';
        }

        function closeSaunaModal() {
            document.getElementById('saunaModal').style.display = 'none';
        }

        function editSauna(id) {
            const sauna = saunas.find(s => s.id === id);
            if (!sauna) return;
            document.getElementById('saunaModalTitle').textContent = 'Editar Agendamento de Sauna';
            document.getElementById('editingSaunaId').value = sauna.id;
            document.getElementById('saunaMorador').value = sauna.morador;
            document.getElementById('saunaApto').value = sauna.apto;
            document.getElementById('saunaData').value = sauna.data;
            document.getElementById('saunaHoraInicio').value = sauna.horaInicio;
            document.getElementById('saunaHoraFim').value = sauna.horaFim || '';
            document.getElementById('saunaTempoUso').value = sauna.tempoUso || '';
            document.getElementById('saunaObservacoes').value = sauna.observacoes || '';
            document.getElementById('saunaStatus').value = sauna.status;
            if (sauna.status === 'em-uso') {
                document.getElementById('btnConcluirSauna').style.display = 'inline-block';
            } else {
                document.getElementById('btnConcluirSauna').style.display = 'none';
            }
            document.getElementById('saunaModal').style.display = 'flex';
        }

        document.getElementById('saunaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condom√≠nio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingSaunaId').value;
            const saunaData = {
                morador: document.getElementById('saunaMorador').value,
                apto: document.getElementById('saunaApto').value,
                data: document.getElementById('saunaData').value,
                horaInicio: document.getElementById('saunaHoraInicio').value,
                horaFim: document.getElementById('saunaHoraFim').value,
                tempoUso: document.getElementById('saunaTempoUso').value,
                observacoes: document.getElementById('saunaObservacoes').value,
                status: document.getElementById('saunaStatus').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('saunas').doc(editingId).update(saunaData);
                } else {
                    await db.collection('saunas').add(saunaData);
                }
                await loadSystemData();
                closeSaunaModal();
                if (currentModule === 'sauna') loadSaunaContent();
                alert('Agendamento de sauna salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar agendamento de sauna:', error);
                alert('Erro ao salvar agendamento de sauna. Tente novamente.');
            }
        });

        async function iniciarSauna(id) {
            try {
                await db.collection('saunas').doc(id).update({
                    status: 'em-uso',
                    dataAtualizacao: new Date().toISOString()
                });
                await loadSystemData();
                if (currentModule === 'sauna') loadSaunaContent();
                alert('Uso da sauna iniciado!');
            } catch (error) {
                console.error('Erro ao iniciar sauna:', error);
                alert('Erro ao iniciar sauna. Tente novamente.');
            }
        }

        async function concluirSauna(id = null) {
            let saunaId = id || document.getElementById('editingSaunaId').value;
            if (!saunaId) {
                alert('Nenhum agendamento de sauna selecionado!');
                return;
            }
            const horaFim = new Date().toTimeString().substring(0, 5);
            const sauna = saunas.find(s => s.id === saunaId);
            if (!sauna) {
                alert('Agendamento de sauna n√£o encontrado!');
                return;
            }
            const inicio = new Date(`2000-01-01T${sauna.horaInicio}`);
            const fim = new Date(`2000-01-01T${horaFim}`);
            const tempoUso = Math.round((fim - inicio) / (1000 * 60));
            try {
                await db.collection('saunas').doc(saunaId).update({
                    horaFim: horaFim,
                    tempoUso: tempoUso,
                    status: 'concluido',
                    dataAtualizacao: new Date().toISOString()
                });
                await loadSystemData();
                closeSaunaModal();
                if (currentModule === 'sauna') loadSaunaContent();
                alert('Uso da sauna conclu√≠do com sucesso! Tempo de uso: ' + tempoUso + ' minutos');
            } catch (error) {
                console.error('Erro ao concluir sauna:', error);
                alert('Erro ao concluir sauna. Tente novamente.');
            }
        }

        async function deleteSauna(id) {
            if (!confirm('Tem certeza que deseja excluir este agendamento de sauna?')) return;
            try {
                await db.collection('saunas').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'sauna') loadSaunaContent();
                alert('Agendamento de sauna exclu√≠do com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir agendamento de sauna:', error);
                alert('Erro ao excluir agendamento de sauna. Tente novamente.');
            }
        }

        function filterSaunas() {
            const status = document.getElementById('filtroStatusSauna').value;
            const data = document.getElementById('filtroDataSauna').value;
            let filteredSaunas = saunas.filter(s => s.condominioId === (currentCondominio ? currentCondominio.id : ''));
            if (status) filteredSaunas = filteredSaunas.filter(s => s.status === status);
            if (data) filteredSaunas = filteredSaunas.filter(s => s.data === data);
            const tbody = document.querySelector('#saunasTable tbody');
            tbody.innerHTML = '';
            if (filteredSaunas.length > 0) {
                filteredSaunas.forEach(sauna => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${sauna.morador}</td>
                        <td>${sauna.apto}</td>
                        <td>${formatDate(sauna.data)}</td>
                        <td>${sauna.horaInicio} ${sauna.horaFim ? ' - ' + sauna.horaFim : ''}</td>
                        <td>${sauna.tempoUso || '-'}</td>
                        <td>
                            <span class="status-badge status-${sauna.status}">
                                ${formatStatusSauna(sauna.status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editSauna('${sauna.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${sauna.status === 'em-uso' ? `
                            <button class="btn btn-sm btn-success" onclick="concluirSauna('${sauna.id}')">
                                <i class="fas fa-check"></i>
                            </button>
                            ` : ''}
                            ${sauna.status === 'agendado' ? `
                            <button class="btn btn-sm btn-warning" onclick="iniciarSauna('${sauna.id}')">
                                <i class="fas fa-play"></i>
                            </button>
                            ` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteSauna('${sauna.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum agendamento de sauna encontrado com os filtros aplicados.</td></tr>';
            }
        }
    </script>
</body>
</html>
