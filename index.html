<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Multi Condomínios</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #5dade2;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            display: flex;
            min-height: 100vh;
        }
/* NOVOS CARDS MODERNOS */
.stat-card-modern {
    flex: 1;
    min-width: 200px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    border: none;
    color: white;
    position: relative;
    overflow: hidden;
}
.stat-card-modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: rgba(255,255,255,0.3);
}
.stat-card-modern:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 12px 30px rgba(0,0,0,0.25);
}
.stat-card-header {
    margin-bottom: 15px;
}
.stat-card-modern h3 {
    font-size: 1em;
    margin: 0;
    font-weight: 600;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
.stat-card-content {
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.stat-value {
    font-size: 2.2em;
    font-weight: bold;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    line-height: 1;
}
.stat-label {
    font-size: 0.85em;
    opacity: 0.9;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}
/* Efeito de brilho suave */
.stat-card-modern::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent,
        rgba(255,255,255,0.1),
        transparent
    );
    transform: rotate(45deg);
    transition: all 0.5s ease;
    opacity: 0;
}
.stat-card-modern:hover::after {
    opacity: 1;
    animation: shine 1.5s ease-in-out;
}
@keyframes shine {
    0% { transform: rotate(45deg) translateX(-100%); }
    100% { transform: rotate(45deg) translateX(100%); }
}
.stats-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 30px;
}
         /* ANIMAÇÃO DE ONDAS PARA PISCINA LIGADA */
@keyframes piscina-ondas {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}
.stat-card-piscina.ligada {
    background: linear-gradient(135deg, #1e88e5 0%, #0d47a1 100%);
    position: relative;
    overflow: hidden;
}
.stat-card-piscina.ligada::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: 
    radial-gradient(circle at 20% 30%, rgba(255,255,255,0.5) 0%, transparent 40%),
    radial-gradient(circle at 80% 70%, rgba(255,255,255,0.4) 0%, transparent 50%);
    animation: piscina-ondas 2s ease-in-out infinite;
    pointer-events: none;
}
.stat-card-piscina.ligada i {
    color: white;
    text-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
        /* Estilos para os novos módulos */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-agendado {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .status-em-uso {
            background-color: #fff3e0;
            color: #f57c00;
        }
        .status-concluido {
            background-color: #e8f5e8;
            color: #388e3c;
        }
        .status-cancelado {
            background-color: #ffebee;
            color: #d32f2f;
        }
        /* Letreiro de Lembretes */
        .ticker-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #000000;
            color: white;
            padding: 8px 0;
            z-index: 2000;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .ticker-content {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
            animation: ticker 60s linear infinite;
        }
        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        .ticker-item {
            display: inline-block;
            margin-right: 40px;
            font-size: 14px;
        }
        .ticker-item i {
            margin-right: 5px;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
       /* Sidebar Moderna Compacta */
.sidebar {
    width: 70px;
    background-color: var(--primary-color);
    color: white;
    transition: all 0.3s ease;
    position: fixed;
    height: 100vh;
    overflow-y: auto;
    z-index: 3000;
    box-shadow: 2px 0 10px rgba(0,0,0,0.15);
}

.sidebar-header {
    padding: 15px;
    background-color: var(--dark-color);
    text-align: center;
    position: relative;
    border-bottom: 2px solid var(--secondary-color);
}

.sidebar-header h3 {
    font-size: 14px;
    opacity: 0;
    transition: opacity 0.2s;
}

.sidebar.expanded .sidebar-header h3 {
    opacity: 1;
}

.connection-status {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #e74c3c;
    transition: background-color 0.3s;
}

.connection-status.connected {
    background-color: #2ecc71;
}

.sidebar-menu {
    padding: 10px 0;
    list-style: none;
    margin-top: 10px;
}

.sidebar-menu li {
    margin-bottom: 5px;
    position: relative;
}

.sidebar-menu a {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 14px 0;
    color: var(--light-color);
    text-decoration: none;
    transition: all 0.3s;
    position: relative;
    border-radius: 6px;
    margin: 0 6px;
}

.sidebar-menu a:hover,
.sidebar-menu a.active {
    background-color: rgba(255,255,255,0.1);
}

.sidebar-menu a i {
    font-size: 20px;
    width: 24px;
    text-align: center;
}

/* Tooltip ao passar o mouse */
.sidebar-menu a::after {
    content: attr(data-name);
    position: absolute;
    left: 70px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.85);
    color: white;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 14px;
    white-space: nowrap;
    z-index: 100;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

.sidebar-menu a:hover::after {
    opacity: 1;
}

/* Modo expandido */
.sidebar.expanded {
    width: 260px;
}

.sidebar.expanded .sidebar-menu a {
    justify-content: flex-start;
    padding-left: 24px;
}

.sidebar.expanded .sidebar-menu a span {
    margin-left: 12px;
    font-size: 15px;
    display: inline;
}

.sidebar-menu a span {
    display: none;
    white-space: nowrap;
}

/* Botão de expandir/encolher no header */
.sidebar-header .toggle-icon {
    position: absolute;
    right: 12px;
    cursor: pointer;
    font-size: 18px;
    color: rgba(255,255,255,0.7);
    transition: transform 0.3s;
}

.sidebar.expanded .sidebar-header .toggle-icon {
    transform: rotate(180deg);
}

/* Responsivo: em telas < 768px, mantém compacto */
@media (max-width: 768px) {
    .sidebar.expanded {
        width: 260px;
    }
    .main-content.expanded {
    margin-left: 260px;
}
}
        /* Main Content */
        .main-content {
    flex: 1;
    margin-left: 70px;
    transition: margin-left 0.3s ease;
    margin-top: 40px;
}
        .top-navbar {
            background-color: white;
            padding: 15px 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .toggle-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--dark-color);
        }
        .user-info {
            display: flex;
            align-items: center;
        }
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .content {
            padding: 30px;
        }
        .card {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .card-header {
            padding: 15px 20px;
            background-color: var(--light-color);
            border-bottom: 1px solid #eee;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body {
            padding: 20px;
        }
        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--primary-color);
        }
        .login-box {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 400px;
            padding: 30px;
            position: relative;
        }
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: #3498db;
        }
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        .btn-danger {
            background-color: var(--accent-color);
            color: white;
        }
        .btn-info {
            background-color: var(--info-color);
            color: white;
        }
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        .btn-sm {
            padding: 5px 10px;
            font-size: 14px;
        }
        /* Table Styles */
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .table th {
            background-color: var(--light-color);
            font-weight: 600;
        }
        .table tr:hover {
            background-color: #f9f9f9;
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 4000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 5px;
            width: 600px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-footer {
            margin-top: 20px;
            text-align: right;
        }
        /* Checkbox Grid */
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .permission-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .permission-item input {
            margin-right: 8px;
        }
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                text-align: center;
            }
            .sidebar-header h3, .sidebar-menu a span {
                display: none;
            }
            .sidebar-menu a i {
                margin-right: 0;
                font-size: 20px;
            }
            .main-content {
                margin-left: 70px;
            }
            .ticker-container {
                font-size: 12px;
            }
        }
        /* Module-specific styles */
        .module-content {
            display: none;
        }
        .module-content.active {
            display: block;
        }
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            flex: 1;
            min-width: 200px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-card h3 {
            font-size: 14px;
            color: #777;
            margin-bottom: 10px;
        }
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .password-strength {
            height: 5px;
            margin-top: 5px;
            border-radius: 2px;
            transition: all 0.3s;
        }
        .strength-weak { background-color: #e74c3c; width: 25%; }
        .strength-fair { background-color: #f39c12; width: 50%; }
        .strength-good { background-color: #3498db; width: 75%; }
        .strength-strong { background-color: #2ecc71; width: 100%; }
        .login-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 14px;
            border-left: 4px solid var(--secondary-color);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .condominio-badge {
            background: var(--secondary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
        .alert {
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .alert-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .alert-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
         .alert-info { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
.alert-warning { background-color: #fff8e1; border-left: 4px solid #ffc107; }
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success {
            background-color: var(--success-color);
            color: white;
        }
        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }
        .badge-danger {
            background-color: var(--accent-color);
            color: white;
        }
        .badge-info {
            background-color: var(--secondary-color);
            color: white;
        }
        /* Calendário */
        .calendar-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .calendar-title {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 0 20px;
        }
        .calendar-view-options {
            display: flex;
            gap: 5px;
        }
        .calendar-view-options .btn {
            padding: 8px 15px;
            font-size: 14px;
            background: #f8f9fa;
            border: 1px solid #ddd;
        }
        .calendar-view-options .btn.active {
            background: var(--secondary-color);
            color: white;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e0e0e0;
            border: 1px solid #e0e0e0;
        }
        .calendar-day-header {
            background-color: #f8f9fa;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #e0e0e0;
            font-size: 14px;
        }
        .calendar-day {
            background-color: white;
            padding: 10px 8px;
            min-height: 120px;
            border: 1px solid #e0e0e0;
            position: relative;
            font-size: 14px;
            cursor: pointer;
        }
        .calendar-day.other-month {
            background-color: #f8f9fa;
            color: #999;
        }
        .calendar-day.today {
            background-color: #e3f2fd;
        }
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 16px;
            color: #333;
        }
        .event-item {
            background-color: #e74c3c;
            color: white;
            padding: 2px 6px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 11px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            border-left: 3px solid #c0392b;
            cursor: pointer;
        }
        .event-item.salao-social {
            background-color: #3498db;
            border-left-color: #2980b9;
        }
        .event-item.churrasqueira {
            background-color: #e74c3c;
            border-left-color: #c0392b;
        }
        .event-item.quiosque {
            background-color: #2ecc71;
            border-left-color: #27ae60;
        }
        .event-item.pergolado {
            background-color: #9b59b6;
            border-left-color: #8e44ad;
        }
        /* Espaços para agendamento */
        .espacos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .espaco-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid var(--secondary-color);
            cursor: pointer;
            transition: all 0.3s;
        }
        .espaco-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .espaco-card.selected {
            border-left-color: var(--success-color);
            background-color: #f8fff9;
        }
        .espaco-card h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 16px;
        }
        .espaco-card p {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        /* Relatórios */
        .report-filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .report-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .report-preview {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-height: 500px;
            overflow-y: auto;
        }
        .report-line {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-family: 'Courier New', monospace;
        }
        .char-counter {
            font-size: 0.8em;
            color: #666;
            text-align: right;
            margin-top: 5px;
        }
        .terms-box {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
        }
        .calendar-legends {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        /* Menu lateral específico */
        .menu-agendamentos {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .menu-agendamentos h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 18px;
        }
        .menu-agendamentos select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 14px;
        }
        /* Layout fiel à imagem */
        .agendamentos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        .agendamentos-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
        .calendar-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .calendar-controls .btn {
            padding: 8px 15px;
            font-size: 14px;
        }
        .current-space {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary-color);
        }
        .current-space h4 {
            margin: 0;
            color: var(--primary-color);
            font-size: 16px;
        }
        /* Modal de ações para agendamento */
        .agendamento-actions-modal {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            padding: 10px;
            min-width: 150px;
        }
        .agendamento-actions-modal button {
            display: block;
            width: 100%;
            margin-bottom: 5px;
            text-align: left;
            padding: 8px 12px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 3px;
        }
        .agendamento-actions-modal button:hover {
            background: #f5f5f5;
        }
        .password-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        /* Novos estilos para Contas a Pagar e Lembretes */
        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .alert-success {
            background-color: #d1edff;
            border: 1px solid #b3d9ff;
            color: #004085;
        }
        .reminder-item, .conta-item, .compra-item {
            padding: 12px 15px;
            border-left: 4px solid var(--secondary-color);
            background: white;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .reminder-item.urgent, .conta-item.urgent, .compra-item.urgent {
            border-left-color: var(--accent-color);
            background-color: #fff5f5;
        }
        .reminder-item.warning, .conta-item.warning, .compra-item.warning {
            border-left-color: var(--warning-color);
            background-color: #fffbf0;
        }
        .reminder-header, .conta-header, .compra-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .reminder-title, .conta-title, .compra-title {
            font-weight: 600;
            color: var(--primary-color);
        }
        .reminder-date, .conta-date, .compra-date {
            font-size: 12px;
            color: #666;
        }
        .reminder-actions, .conta-actions, .compra-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-agendado { background-color: #3498db; color: white; }
        .status-em-uso { background-color: #f39c12; color: white; }
        .status-liberado { background-color: #2ecc71; color: white; }
        .status-cancelado { background-color: #e74c3c; color: white; }
        .status-pendente { background-color: #95a5a6; color: white; }
        .status-pago { background-color: #2ecc71; color: white; }
        .status-atrasado { background-color: #e74c3c; color: white; }
        .status-em-andamento { background-color: #f39c12; color: white; }
        .status-concluido { background-color: #2ecc71; color: white; }
        .status-adaptado { background-color: #9b59b6; color: white; }
        .dashboard-alerts {
            margin-bottom: 20px;
        }
        /* Indicador de conexão na tela de login */
        .login-connection-status {
            display: flex;
            align-items: center;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
        }
        .condominio-badge {
            background: var(--secondary-color);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
        }
        .login-connection-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #e74c3c;
            margin-right: 8px;
        }
        .login-connection-dot.connected {
            background-color: #2ecc71;
        }
        .online-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: #2ecc71;
            font-weight: 600;
            margin-left: 12px;
            cursor: pointer;
        }
        .online-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #2ecc71;
            box-shadow: 0 0 6px #2ecc71;
            animation: pulse 2s infinite;
        }
        /* Estilo para o modal de compras */
        .compras-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .compras-item:last-child {
            border-bottom: none;
        }
        .compras-item .item-info {
            flex: 1;
        }
        .compras-item .item-actions {
            display: flex;
            gap: 5px;
        }
        .compras-item .item-actions button {
            padding: 3px 6px;
            font-size: 12px;
        }
        .add-item-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        .add-item-btn:hover {
            background-color: #27ae60;
        }
        .item-total {
            font-weight: bold;
            margin-top: 5px;
        }
        .compra-itens-lista {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        .compra-itens-lista .compras-item {
            padding: 6px 0;
        }
         @media print {
    body * {
        visibility: hidden;
    }
    #printArea, #printArea * {
        visibility: visible;
    }
    #printArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 20px;
        box-sizing: border-box;
    }
    .no-print {
        display: none !important;
    }
}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- JSZip (necessário para criar .docx) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js">
</script>
<!-- FileSaver (para download do arquivo) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js">
</script>
<script>
  // Garantir compatibilidade: alguns bundles só expõem via .default
  if (typeof htmlDocx === 'undefined' && typeof htmlDocxJs !== 'undefined') {
    window.htmlDocx = htmlDocxJs;
  }
  if (typeof htmlDocx === 'undefined' && typeof window.default !== 'undefined') {
    window.htmlDocx = window.default;
  }
</script>
</head>
<!-- ✅ jsPDF correta — compatível com UMD e expõe jsPDF globalmente -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.js">
</script>
<script>
  // Garante compatibilidade com UMD bundle
  if (typeof window.jsPDF === 'undefined' && window.jspdf && window.jspdf.jsPDF) {
    window.jsPDF = window.jspdf.jsPDF;
  }
 // ✅ Garante que `jsPDF` esteja disponível globalmente, de forma confiável
  if (typeof jsPDF === 'undefined') {
    if (typeof window.jspdf !== 'undefined') {
      window.jsPDF = window.jspdf.jsPDF;
    } else if (typeof window.default !== 'undefined') {
      window.jsPDF = window.default;
    }
  }
</script>
<body>
    <!-- Letreiro de Lembretes -->
    <div id="tickerContainer" class="ticker-container" style="display: none;">
        <div class="ticker-content" id="tickerContent">
            <!-- Conteúdo do letreiro será carregado aqui -->
        </div>
    </div>
    <!-- Página de Login -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h2>Sistema Multi Condomínios</h2>
                <p id="loginStatus">Digite suas credenciais para acessar</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <input type="text" class="form-control" id="username" placeholder="Usuário" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-control" id="password" placeholder="Senha" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="loginBtn">
                    <span id="loginBtnText">Entrar</span>
                    <div class="loading" id="loginLoading" style="display: none;"></div>
                </button>
            </form>
            <div class="login-connection-status">
                <div class="login-connection-dot" id="loginConnectionDot"></div>
                <span id="loginConnectionText">Verificando conexão com o banco de dados...</span>
            </div>
        </div>
    </div>
    <!-- Sistema Principal -->
    <div id="mainSystem" class="container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
    <div class="sidebar-header">
    <div id="connectionStatus" class="connection-status" title="Desconectado"></div>
</div>
    <ul class="sidebar-menu" id="moduleMenu">
        <!-- Os módulos serão carregados dinamicamente aqui -->
    </ul>
</div>
        <!-- Main Content -->
        <div class="main-content">
            <div class="top-navbar">
                <button class="toggle-btn" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="user-info">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=3498db&color=fff" alt="Usuário" id="userAvatar">
                    <span id="userName">Administrador</span>
                    <!-- SELETOR DE CONDOMÍNIO E BADGE -->
                    <div class="condominio-selector-top" style="margin-left: 15px; display: flex; align-items: center;">
                        <select id="condominioSelectTop" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd;">
                            <option value="" disabled selected hidden>Selecione um condomínio</option>
                        </select>
                        <span id="currentCondominioBadge" class="condominio-badge" style="margin-left: 10px;">
                            Nenhum condomínio selecionado
                        </span>
                    </div>
                    <div class="online-indicator" onclick="showOnlineUsers()">
                        <div class="online-dot"></div>
                        <span id="onlineCount">0</span> online
                    </div>
                    <button class="btn" id="logoutBtn" style="margin-left: 15px;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            <div class="content">
                <div id="moduleContent">
                    <!-- Conteúdo dos módulos será carregado aqui -->
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para Troca de Senha -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Trocar Senha</h3>
                <p>É sua primeira vez aqui! Por favor, defina uma nova senha.</p>
            </div>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label>Nova Senha</label>
                    <input type="password" class="form-control" id="newPassword" required minlength="6">
                    <div id="passwordStrength" class="password-strength"></div>
                </div>
                <div class="form-group">
                    <label>Confirmar Nova Senha</label>
                    <input type="password" class="form-control" id="confirmPassword" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Nova Senha</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para Cadastro de Usuários -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Cadastrar Usuário</h3>
                <button type="button" onclick="closeUserModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="userForm">
                <input type="hidden" id="editingUserId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome Completo *</label>
                        <input type="text" class="form-control" id="userNome" required>
                    </div>
                    <div class="form-group">
                        <label>Usuário *</label>
                        <input type="text" class="form-control" id="userUsuario" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>E-mail</label>
                        <input type="email" class="form-control" id="userEmail">
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="text" class="form-control" id="userTelefone">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Senha <span id="senhaObrigatoria">*</span></label>
                        <input type="password" class="form-control" id="userSenha">
                        <div class="password-info" id="senhaInfo">Deixe em branco para manter a senha atual</div>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Usuário *</label>
                        <select class="form-control" id="userTipo" required>
                            <option value="">Selecione...</option>
                            <option value="sindico">Síndico</option>
                            <option value="subsindico">Subsíndico</option>
                            <option value="zelador">Zelador</option>
                            <option value="portaria">Portaria</option>
                            <option value="prestador">Prestador de Serviço</option>
                            <option value="morador">Morador</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Condomínios Permitidos</label>
                    <div id="condominiosPermitidos" class="permissions-grid">
                        <!-- Condomínios serão carregados aqui -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Módulos Permitidos</label>
                    <div id="permissoesUsuario" class="permissions-grid">
                        <!-- Permissões serão carregadas aqui -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Usuário</button>
                    <button type="button" class="btn" onclick="closeUserModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para Cadastro de Condomínios -->
    <div id="condominioModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="condominioModalTitle">Cadastrar Condomínio</h3>
                <button type="button" onclick="closeCondominioModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="condominioForm">
                <input type="hidden" id="editingCondominioId">
                <div class="form-group">
                    <label>Nome do Condomínio *</label>
                    <input type="text" class="form-control" id="condominioNome" required>
                </div>
                <div class="form-group">
                    <label>Endereço *</label>
                    <input type="text" class="form-control" id="condominioEndereco" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cidade *</label>
                        <input type="text" class="form-control" id="condominioCidade" required>
                    </div>
                    <div class="form-group">
                        <label>Estado *</label>
                        <input type="text" class="form-control" id="condominioEstado" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>CEP</label>
                    <input type="text" class="form-control" id="condominioCEP">
                </div>
                <div class="form-group">
                    <label>Telefone</label>
                    <input type="text" class="form-control" id="condominioTelefone">
                </div>
                <div class="form-group">
                    <label>CNPJ</label>
                    <input type="text" class="form-control" id="condominioCNPJ">
                </div>
                <div class="form-group">
                    <label>Quantidade de Unidades</label>
                    <input type="number" class="form-control" id="condominioUnidades" min="1">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="condominioStatus">
                        <option value="ativo">Ativo</option>
                        <option value="inativo">Inativo</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Condomínio</button>
                    <button type="button" class="btn" onclick="closeCondominioModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para Agendamentos -->
    <div id="agendamentoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="agendamentoModalTitle">Novo Agendamento</h3>
                <button type="button" onclick="closeAgendamentoModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="agendamentoForm">
                <input type="hidden" id="editingAgendamentoId">
                <input type="hidden" id="agendamentoData">
                <div class="form-group">
                    <label>Espaço *</label>
                    <select class="form-control" id="agendamentoEspaco" required>
                        <option value="">Selecione o espaço...</option>
                        <option value="salao-social">1. Salão Social</option>
                        <option value="churrasqueira">2. Churrasqueira Área Gourmet</option>
                        <option value="quiosque">3. Quiosque</option>
                        <option value="pergolado">4. Pergolado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data *</label>
                    <input type="date" class="form-control" id="agendamentoDataInput" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Horário de Início *</label>
                        <input type="time" class="form-control" id="agendamentoHoraInicio" required>
                    </div>
                    <div class="form-group">
                        <label>Horário de Término *</label>
                        <input type="time" class="form-control" id="agendamentoHoraFim" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Morador/Responsável *</label>
                    <input type="text" class="form-control" id="agendamentoResponsavel" required>
                </div>
                <div class="form-group">
                    <label>Unidade/Apartamento *</label>
                    <input type="text" class="form-control" id="agendamentoUnidade" required>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="agendamentoStatus">
                        <option value="agendado">Agendado</option>
                        <option value="em-uso">Em Uso</option>
                        <option value="liberado">Liberado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observações</label>
                    <textarea class="form-control" id="agendamentoObservacoes" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Agendamento</button>
                    <button type="button" class="btn" onclick="closeAgendamentoModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para Contas a Pagar -->
    <div id="contaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="contaModalTitle">Nova Conta a Pagar</h3>
                <button type="button" onclick="closeContaModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="contaForm">
                <input type="hidden" id="editingContaId">
                <div class="form-group">
                    <label>Descrição *</label>
                    <input type="text" class="form-control" id="contaDescricao" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Valor *</label>
                        <input type="number" class="form-control" id="contaValor" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Vencimento *</label>
                        <input type="date" class="form-control" id="contaVencimento" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select class="form-control" id="contaCategoria">
                        <option value="manutencao">Manutenção</option>
                        <option value="limpeza">Limpeza</option>
                        <option value="seguranca">Segurança</option>
                        <option value="administrativo">Administrativo</option>
                        <option value="energia">Energia</option>
                        <option value="agua">Água</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fornecedor</label>
                    <input type="text" class="form-control" id="contaFornecedor">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="contaStatus">
                        <option value="pendente">Pendente</option>
                        <option value="pago">Pago</option>
                        <option value="atrasado">Atrasado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observações</label>
                    <textarea class="form-control" id="contaObservacoes" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Conta</button>
                    <button type="button" class="btn" onclick="closeContaModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para Lembretes -->
    <div id="lembreteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="lembreteModalTitle">Novo Lembrete</h3>
                <button type="button" onclick="closeLembreteModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="lembreteForm">
                <input type="hidden" id="editingLembreteId">
                <div class="form-group">
                    <label>Título *</label>
                    <input type="text" class="form-control" id="lembreteTitulo" required>
                </div>
                <div class="form-group">
                    <label>Descrição</label>
                    <textarea class="form-control" id="lembreteDescricao" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data de Início *</label>
                        <input type="date" class="form-control" id="lembreteDataInicio" required>
                    </div>
                    <div class="form-group">
                        <label>Data de Fim</label>
                        <input type="date" class="form-control" id="lembreteDataFim">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Prioridade</label>
                        <select class="form-control" id="lembretePrioridade">
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Lembrete</button>
                    <button type="button" class="btn" onclick="closeLembreteModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para Cadastro de Moradores -->
    <div id="moradorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="moradorModalTitle">Cadastrar Morador</h3>
                <button type="button" onclick="closeMoradorModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="moradorForm">
                <input type="hidden" id="editingMoradorId">
                <div class="form-group">
                    <label>Morador *</label>
                    <input type="text" class="form-control" id="moradorNome" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Apartamento *</label>
                        <input type="text" class="form-control" id="moradorApto" required>
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="text" class="form-control" id="moradorTelefone">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Garagem</label>
                        <select class="form-control" id="moradorGaragem">
                            <option value="">Selecione...</option>
                            <option value="G1">G1</option>
                            <option value="G2">G2</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vaga</label>
                        <input type="text" class="form-control" id="moradorVaga">
                    </div>
                </div>
                 <div class="form-group">
    <label>Placa do Veículo</label>
    <input type="text" class="form-control" id="moradorPlaca" maxlength="8" placeholder="ex: ABC1234">
    <small class="text-muted">Formato: ABC1234 ou ABC-1234</small>
</div>
                <div class="form-group">
                    <label>Observações</label>
                    <textarea class="form-control" id="moradorObservacoes" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar Morador</button>
                    <button type="button" class="btn" onclick="closeMoradorModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="horaExtraModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="horaExtraModalTitle">Nova Hora Extra</h3>
            <button type="button" onclick="closeHoraExtraModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        <form id="horaExtraForm">
            <input type="hidden" id="editingHoraExtraId">
            <div class="form-group">
                <label>Funcionário *</label>
                <input type="text" class="form-control" id="horaExtraFuncionario" required>
            </div>
            <div class="form-group">
                <label>Matrícula *</label>
                <input type="text" class="form-control" id="horaExtraMatricula" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Data *</label>
                    <input type="date" class="form-control" id="horaExtraData" required>
                </div>
                <div class="form-group">
                    <label>Regime de Trabalho *</label>
                    <select class="form-control" id="horaExtraRegime" required onchange="atualizarHorariosRegime()">
                        <option value="">Selecione o regime...</option>
                        <option value="12-36">12/36 (7h às 19h)</option>
                        <option value="8h">8h (8h às 17:48h)</option>
                        <option value="personalizado">Personalizado</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <div class="permission-item">
                    <input type="checkbox" id="trabalhoFolga" onchange="calcularHorasExtras()">
                    <label for="trabalhoFolga" style="font-weight: bold; color: #e74c3c;">
                        <i class="fas fa-calendar-day"></i> Trabalho em Dia de Folga (100% horas extras)
                    </label>
                </div>
                <small class="text-muted">Quando marcado, todo o período trabalhado é considerado hora extra</small>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Entrada Real *</label>
                    <input type="time" class="form-control" id="horaExtraEntrada" required onchange="calcularHorasExtras()">
                </div>
                <div class="form-group">
                    <label>Saída Intervalo</label>
                    <input type="time" class="form-control" id="horaExtraSaidaIntervalo" onchange="calcularHorasExtras()">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Volta Intervalo</label>
                    <input type="time" class="form-control" id="horaExtraVoltaIntervalo" onchange="calcularHorasExtras()">
                </div>
                <div class="form-group">
                    <label>Saída Real *</label>
                    <input type="time" class="form-control" id="horaExtraSaida" required onchange="calcularHorasExtras()">
                </div>
            </div>
            <div class="form-group">
                <label>Horas Extras Calculadas</label>
                <input type="text" class="form-control" id="horaExtraCalculada" readonly style="background-color: #f8f9fa; font-weight: bold; font-size: 16px;">
                <small class="text-muted" id="detalhesCalculo"></small>
            </div>
            <div class="form-group">
                <label>Observações</label>
                <textarea class="form-control" id="horaExtraObservacoes" rows="2"></textarea>
            </div>
            <input type="hidden" id="horaExtraQuantidade">
            <div class="modal-footer">
                <button type="button" class="btn btn-info" onclick="calcularHorasExtras()">
                    <i class="fas fa-calculator"></i> Recalcular
                </button>
                <button type="submit" class="btn btn-primary">Salvar Hora Extra</button>
                <button type="button" class="btn btn-secondary" onclick="closeHoraExtraModal()">Cancelar</button>
            </div>
        </form>
    </div>
</div>
    <!-- Modal para Limpeza -->
    <div id="limpezaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="limpezaModalTitle">Registro de Limpeza</h3>
                <button type="button" onclick="closeLimpezaModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="limpezaForm">
                <input type="hidden" id="editingLimpezaId">
                <div class="form-group">
                    <label>Responsável pela Limpeza *</label>
                    <input type="text" class="form-control" id="limpezaResponsavel" required>
                </div>
                <div class="form-group">
                    <label>Espaço Limpo *</label>
                    <select class="form-control" id="limpezaEspaco" required>
                        <option value="">Selecione o espaço...</option>
                        <option value="salao-social">Salão Social</option>
                        <option value="churrasqueira">Churrasqueira</option>
                        <option value="quiosque">Quiosque</option>
                        <option value="pergolado">Pergolado</option>
                        <option value="sauna">Sauna</option>
                        <option value="area-comum">Área Comum</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data *</label>
                        <input type="date" class="form-control" id="limpezaData" required>
                    </div>
                    <div class="form-group">
                        <label>Hora Início *</label>
                        <input type="time" class="form-control" id="limpezaHoraInicio" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Hora Fim</label>
                        <input type="time" class="form-control" id="limpezaHoraFim">
                    </div>
                    <div class="form-group">
                        <label>Tempo de Uso (minutos)</label>
                        <input type="number" class="form-control" id="limpezaTempoUso" min="0" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>Observações</label>
                    <textarea class="form-control" id="limpezaObservacoes" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="limpezaStatus">
                        <option value="em-andamento">Em Andamento</option>
                        <option value="concluido">Concluído</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" class="btn btn-success" id="btnConcluirLimpeza" onclick="concluirLimpeza()" style="display: none;">Concluir Limpeza</button>
                    <button type="button" class="btn" onclick="closeLimpezaModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal para Sauna -->
    <div id="saunaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="saunaModalTitle">Agendamento de Sauna</h3>
                <button type="button" onclick="closeSaunaModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="saunaForm">
                <input type="hidden" id="editingSaunaId">
                <div class="form-group">
                    <label>Morador *</label>
                    <input type="text" class="form-control" id="saunaMorador" required>
                </div>
                <div class="form-group">
                    <label>Apartamento *</label>
                    <input type="text" class="form-control" id="saunaApto" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data *</label>
                        <input type="date" class="form-control" id="saunaData" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Sauna *</label>
                        <select class="form-control" id="saunaTipo" required>
                            <option value="umida">Sauna Úmida</option>
                            <option value="seca">Sauna Seca</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Hora Início *</label>
                        <input type="time" class="form-control" id="saunaHoraInicio" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Hora Fim</label>
                        <input type="time" class="form-control" id="saunaHoraFim">
                    </div>
                    <div class="form-group">
                        <label>Tempo de Uso (minutos)</label>
                        <input type="number" class="form-control" id="saunaTempoUso" min="0" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="saunaStatus">
                        <option value="agendado">Agendado</option>
                        <option value="em-uso">Em Uso</option>
                        <option value="concluido">Concluído</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observações</label>
                    <textarea class="form-control" id="saunaObservacoes" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" class="btn btn-success" id="btnConcluirSauna" onclick="concluirSauna()" style="display: none;">Concluir Uso</button>
                    <button type="button" class="btn" onclick="closeSaunaModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
     <!-- Modal para Confraternização -->
<div id="confraternizacaoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="confraternizacaoModalTitle">Nova Inscrição - Confraternização</h3>
            <button type="button" onclick="closeConfraternizacaoModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        <form id="confraternizacaoForm">
            <input type="hidden" id="editingConfraternizacaoId">
            <div class="form-group">
                <label>Morador *</label>
                <select class="form-control" id="confraternizacaoMorador" required onchange="preencherAptoAutomatico()">
                    <option value="">Selecione...</option>
                    <!-- Moradores serão carregados aqui -->
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Apartamento</label>
                    <input type="text" class="form-control" id="confraternizacaoApto" readonly>
                </div>
                <div class="form-group">
                    <label>Adultos (R$80)</label>
                    <input type="number" class="form-control" id="confraternizacaoAdultos" min="0" value="0" onchange="calcularTotalConfraternizacao()">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Crianças 7 a 12 anos (R$40)</label>
                    <input type="number" class="form-control" id="confraternizacaoCriancas7a12" min="0" value="0" onchange="calcularTotalConfraternizacao()">
                </div>
                <div class="form-group">
                    <label>Crianças até 6 anos (Grátis)</label>
                    <input type="number" class="form-control" id="confraternizacaoCriancasMenor6" min="0" value="0" onchange="calcularTotalConfraternizacao()">
                </div>
            </div>
            <div class="form-group">
                <label>Total</label>
                <input type="text" class="form-control" id="confraternizacaoTotal" readonly style="font-weight: bold; font-size: 1.2em;">
            </div>
            <div class="form-group">
                <label>Status</label>
                <select class="form-control" id="confraternizacaoStatus" required>
                    <option value="pendente">Pendente</option>
                    <option value="pago">Pago</option>
                    <option value="cancelado">Cancelado</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Salvar</button>
                <button type="button" class="btn" onclick="closeConfraternizacaoModal()">Cancelar</button>
            </div>
        </form>
    </div>
</div>
    <!-- Modal para Compras -->
    <div id="compraModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="compraModalTitle">Nova Compra</h3>
                <button type="button" onclick="closeCompraModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <form id="compraForm">
    <input type="hidden" id="editingCompraId">
    <div class="form-group">
        <label>Fornecedor *</label>
        <input type="text" class="form-control" id="compraFornecedor" required>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label>Data da Fatura *</label>
            <input type="date" class="form-control" id="compraDataFatura" required>
        </div>
        <div class="form-group">
            <label>Vencimento *</label>
            <input type="date" class="form-control" id="compraVencimento" required>
        </div>
    </div>
    <div class="form-group">
        <label>Descrição Geral</label>
        <textarea class="form-control" id="compraDescricaoGeral" rows="2"></textarea>
    </div>
    <div class="form-group">
        <label>Observações</label>
        <textarea class="form-control" id="compraObservacoes" rows="3"></textarea>
    </div>
    <div class="form-group">
        <label>Itens da Compra</label>
        <div class="form-row">
            <input type="text" class="form-control" id="novoItemNome" placeholder="Nome do Item">
            <input type="number" class="form-control" id="novoItemQuantidade" placeholder="Qtd" style="width: 80px;">
            <input type="number" class="form-control" id="novoItemValor" placeholder="Valor Unitário" step="0.01" style="width: 120px;">
        </div>
        <button type="button" class="add-item-btn" onclick="adicionarItemCompra()">+ Adicionar Item</button>
    </div>
    <div class="form-group">
        <div class="compra-itens-lista" id="compraItensLista">
            <!-- Itens serão adicionados aqui -->
        </div>
        <div class="item-total" id="compraTotalDisplay">Total: R$ 0.00</div>
    </div>
    <div class="form-group">
        <label>Status</label>
        <select class="form-control" id="compraStatus">
            <option value="pendente">Pendente</option>
            <option value="recebido">Recebido</option>
            <option value="pago">Pago</option>
            <option value="cancelado">Cancelado</option>
        </select>
    </div>
    <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Salvar Compra</button>
        <button type="button" class="btn" onclick="closeCompraModal()">Cancelar</button>
    </div>
</form>
        </div>
    </div>
     <!-- Modal para Vales -->
<div id="valeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="valeModalTitle">Solicitar Vale</h3>
            <button type="button" onclick="closeValeModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        <form id="valeForm">
            <input type="hidden" id="editingValeId">
            <div class="form-group">
                <label>Valor *</label>
                <input type="number" class="form-control" id="valeValor" step="0.01" min="0.01" required>
            </div>
            <div class="form-group">
                <label>Motivo</label>
                <textarea class="form-control" id="valeMotivo" rows="3" placeholder="Ex: emergência, transporte, alimentação..."></textarea>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select class="form-control" id="valeStatus" disabled>
                    <option value="pendente">Pendente</option>
                </select>
                <small class="text-muted">Só o síndico pode alterar o status.</small>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Enviar Solicitação</button>
                <button type="button" class="btn" onclick="closeValeModal()">Cancelar</button>
            </div>
        </form>
    </div>
</div>
     <!-- Modal para Agendamentos Concluídos -->
<div id="agendamentosConcluidosModal" class="modal">
    <div class="modal-content" style="max-width: 90%; width: 90%;">
        <div class="modal-header">
            <h3>Agendamentos Concluídos e Cancelados - Últimos 18 Meses</h3>
            <button type="button" onclick="closeAgendamentosConcluidosModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        <div class="card-body">
            <div class="form-row">
    <div class="form-group">
        <label>Espaço</label>
        <select id="filtroConcluidosEspaco" class="form-control" onchange="filterAgendamentosConcluidos()">
            <option value="">Todos</option>
            <option value="salao-social">Salão Social</option>
            <option value="churrasqueira">Churrasqueira</option>
            <option value="quiosque">Quiosque</option>
            <option value="pergolado">Pergolado</option>
        </select>
    </div>
    <div class="form-group">
        <label>De</label>
        <input type="date" id="filtroConcluidosDataIni" class="form-control" onchange="filterAgendamentosConcluidos()">
    </div>
    <div class="form-group">
        <label>Até</label>
        <input type="date" id="filtroConcluidosDataFim" class="form-control" onchange="filterAgendamentosConcluidos()">
    </div>
    <div class="form-group">
        <label>Nome</label>
        <input type="text" id="filtroConcluidosNome" class="form-control" placeholder="Ex: João" onkeyup="filterAgendamentosConcluidos()">
    </div>
    <div class="form-group">
        <label>Apto</label>
        <input type="text" id="filtroConcluidosApto" class="form-control" placeholder="Ex: 101" onkeyup="filterAgendamentosConcluidos()">
    </div>
</div>
<div class="form-row">
    <div class="form-group">
        <button class="btn btn-success" onclick="exportarAgendamentosConcluidosPDF()">
            <i class="fas fa-file-pdf"></i> Exportar PDF
        </button>
    </div>
</div>
            
            <table class="table">
                <thead>
                    <tr>
                        <th>Espaço</th>
                        <th>Solicitante</th>
                        <th>Data</th>
                        <th>Horário</th>
                        <th>Unidade</th>
                        <th>Status</th>
                        <th>Ações</th> 
                    </tr>
                </thead>
                <tbody id="agendamentosConcluidosTbody">
                    <!-- Os agendamentos serão carregados aqui -->
                </tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeAgendamentosConcluidosModal()">Fechar</button>
        </div>
    </div>
</div>
<!-- Modal Detalhado do Agendamento -->
<div id="detalhesAgendamentoModal" class="modal">
    <div class="modal-content" style="max-width: 600px; width: 95%;">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-check"></i> Detalhes do Agendamento</h3>
            <button type="button" onclick="closeDetalhesAgendamentoModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        <div class="card" style="margin-top: 15px;">
            <div class="card-body">
                <div class="form-group">
                    <label><strong>Espaço:</strong></label>
                    <p id="detalheEspaco" class="form-control-plaintext"></p>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label><strong>Solicitante:</strong></label>
                        <p id="detalheResponsavel" class="form-control-plaintext"></p>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label><strong>Unidade:</strong></label>
                        <p id="detalheUnidade" class="form-control-plaintext"></p>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><strong>Data:</strong></label>
                        <p id="detalheData" class="form-control-plaintext"></p>
                    </div>
                    <div class="form-group">
                        <label><strong>Horário:</strong></label>
                        <p id="detalheHorario" class="form-control-plaintext"></p>
                    </div>
                </div>
                <div class="form-group">
                    <label><strong>Status:</strong></label>
                    <p><span id="detalheStatus" class="status-badge"></span></p>
                </div>
                <div class="form-group">
                    <label><strong>Observações:</strong></label>
                    <p id="detalheObservacoes" class="form-control-plaintext" style="white-space: pre-wrap;"></p>
                </div>
                <div class="form-group">
                    <label><strong>Criado por:</strong></label>
                    <p id="detalheCriadoPor" class="form-control-plaintext"></p>
                </div>
                <div class="form-group">
                    <label><strong>Data de Criação:</strong></label>
                    <p id="detalheCriadoEm" class="form-control-plaintext"></p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDetalhesAgendamentoModal()">
                <i class="fas fa-times"></i> Fechar
            </button>
        </div>
    </div>
</div>
      <!-- Modal Detalhado do Agendamento -->
<div id="detalhesAgendamentoModal" class="modal">
    <div class="modal-content" style="max-width: 600px; width: 95%;">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-check"></i> Detalhes do Agendamento</h3>
            <button type="button" onclick="closeDetalhesAgendamentoModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        <div class="card" style="margin-top: 15px;">
            <div class="card-body">
                <div class="form-group">
                    <label><strong>Espaço:</strong></label>
                    <p id="detalheEspaco" class="form-control-plaintext"></p>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label><strong>Solicitante:</strong></label>
                        <p id="detalheResponsavel" class="form-control-plaintext"></p>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label><strong>Unidade:</strong></label>
                        <p id="detalheUnidade" class="form-control-plaintext"></p>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><strong>Data:</strong></label>
                        <p id="detalheData" class="form-control-plaintext"></p>
                    </div>
                    <div class="form-group">
                        <label><strong>Horário:</strong></label>
                        <p id="detalheHorario" class="form-control-plaintext"></p>
                    </div>
                </div>
                <div class="form-group">
                    <label><strong>Status:</strong></label>
                    <p><span id="detalheStatus" class="status-badge"></span></p>
                </div>
                <div class="form-group">
                    <label><strong>Observações:</strong></label>
                    <p id="detalheObservacoes" class="form-control-plaintext" style="white-space: pre-wrap;"></p>
                </div>
                <div class="form-group">
                    <label><strong>Criado por:</strong></label>
                    <p id="detalheCriadoPor" class="form-control-plaintext"></p>
                </div>
                <div class="form-group">
                    <label><strong>Data de Criação:</strong></label>
                    <p id="detalheCriadoEm" class="form-control-plaintext"></p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDetalhesAgendamentoModal()">
                <i class="fas fa-times"></i> Fechar
            </button>
        </div>
    </div>
</div>
     <!-- Modal para Palavras-chave Mercado Livre -->
<div id="palavraChaveModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="palavraChaveModalTitle">Nova Palavra-chave</h3>
            <button type="button" onclick="closePalavraChaveModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        <form id="palavraChaveForm">
            <input type="hidden" id="editingPalavraChaveId">
            <div class="form-group">
                <label>Morador *</label>
                <select class="form-control" id="palavraChaveMorador" required>
                    <option value="">Selecione...</option>
                    <!-- Moradores serão carregados dinamicamente -->
                </select>
            </div>
            <div class="form-group">
                <label>Palavras-chave *</label>
                <textarea class="form-control" id="palavraChaveTexto" rows="4" placeholder="Digite as palavras separadas por vírgula"></textarea>
                <small class="char-counter">Palavras: <span id="palavraChaveCount">0</span></small>
            </div>
            <div class="form-group">
                <label>Observações</label>
                <textarea class="form-control" id="palavraChaveObservacoes" rows="2"></textarea>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Salvar</button>
                <button type="button" class="btn" onclick="closePalavraChaveModal()">Cancelar</button>
            </div>
        </form>
    </div>
</div>
     <!-- Modal para Tarefas -->
<div id="tarefaModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="tarefaModalTitle">Nova Tarefa</h3>
            <button type="button" onclick="closeTarefaModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        <form id="tarefaForm">
            <input type="hidden" id="editingTarefaId">
            <div class="form-group">
                <label>Título *</label>
                <input type="text" class="form-control" id="tarefaTitulo" placeholder="Ex: Varrer corredor" required>
            </div>
            <div class="form-group">
                <label>Descrição</label>
                <textarea class="form-control" id="tarefaDescricao" rows="3" placeholder="Detalhes opcionais..."></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Tipo *</label>
                    <select class="form-control" id="tarefaTipo" required onchange="toggleDiasSemana()">
                        <option value="unica">Única</option>
                        <option value="recorrente">Recorrente (dias da semana)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data</label>
                    <input type="date" class="form-control" id="tarefaDataUnica">
                </div>
            </div>
            <div class="form-group" id="diasSemanaContainer" style="display: none;">
                <label>Dias da Semana</label><br>
                <label class="permission-item"><input type="checkbox" name="diaSemana" value="dom"> Domingo</label>
                <label class="permission-item"><input type="checkbox" name="diaSemana" value="seg"> Segunda</label>
                <label class="permission-item"><input type="checkbox" name="diaSemana" value="ter"> Terça</label>
                <label class="permission-item"><input type="checkbox" name="diaSemana" value="qua"> Quarta</label>
                <label class="permission-item"><input type="checkbox" name="diaSemana" value="qui"> Quinta</label>
                <label class="permission-item"><input type="checkbox" name="diaSemana" value="sex"> Sexta</label>
                <label class="permission-item"><input type="checkbox" name="diaSemana" value="sab"> Sábado</label>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Salvar Tarefa</button>
                <button type="button" class="btn" onclick="closeTarefaModal()">Cancelar</button>
            </div>
        </form>
    </div>
</div>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js">
</script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAhx_I1Wg0RncK_XTTOVjKrRkeD8-wDoMw",
            authDomain: "condominio-amaranthus.firebaseapp.com",
            projectId: "condominio-amaranthus",
            storageBucket: "condominio-amaranthus.firebasestorage.app",
            messagingSenderId: "233912918531",
            appId: "1:233912918531:web:6850381663623ef1282436"
        };
        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // Módulos do sistema
        const modules = [
            { id: 'dashboard', name: 'Dashboard', icon: 'fas fa-tachometer-alt', default: true },
            { id: 'confraternizacao', name: 'Confraternização', icon: 'fas fa-glass-cheers' },                       
            { id: 'ocorrencias', name: 'Ocorrências', icon: 'fas fa-exclamation-triangle' },
            { id: 'palavras-chave', name: 'Palavras-chave ML', icon: 'fas fa-tags' },
            { id: 'vales', name: 'Vales', icon: 'fas fa-money-bill-wave' },
            { id: 'prestadores', name: 'Prestador de Serviços', icon: 'fas fa-briefcase' },
            { id: 'agendamentos', name: 'Agendamentos', icon: 'fas fa-calendar-alt' },
            { id: 'limpeza', name: 'Limpeza', icon: 'fas fa-broom' },
            { id: 'sauna', name: 'Sauna', icon: 'fas fa-hot-tub' },
            { id: 'horas-extras', name: 'Horas Extras', icon: 'fas fa-clock' },            
            { id: 'compras', name: 'Compras', icon: 'fas fa-shopping-cart' }, // <-- Novo Módulo
            { id: 'contas', name: 'Contas a Pagar', icon: 'fas fa-file-invoice-dollar' },
            { id: 'lembretes', name: 'Lembretes', icon: 'fas fa-bell' },
            { id: 'condominios', name: 'Condomínios', icon: 'fas fa-building' },
            { id: 'relatorios', name: 'Relatórios', icon: 'fas fa-chart-bar' },
            { id: 'usuarios', name: 'Usuários', icon: 'fas fa-users' },
            { id: 'moradores', name: 'Moradores', icon: 'fas fa-user-friends' },
            { id: 'tarefas', name: 'Tarefas', icon: 'fas fa-tasks' },
        ];
        // Estado da aplicação
        let currentUser = null;
        let currentCondominio = null;
        let condominios = [];
        let vales = [];
        let usuarios = [];
        let horasExtras = [];
        let moradores = [];
        let agendamentos = [];
        let limpezas = [];
        let palavrasChave = [];
        let saunas = [];
        let contas = [];
        let lembretes = [];
        let compras = []; // <-- Novo Array
        let currentModule = 'dashboard';
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();
        let isFirebaseConnected = false;
        let presenceRef = null;

        // ✅ Nova função: verifica se o usuário pode excluir
        function podeExcluirRegistros() {
            return currentUser && (currentUser.tipo === 'sindico' || currentUser.tipo === 'subsindico');
        }
        // Inicializar a aplicação
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        // Função para inicializar a aplicação
        async function initializeApp() {
            try {
                checkFirebaseConnection();
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    const userDoc = await db.collection('usuarios').doc(currentUser.id).get();
                    if (userDoc.exists) {
                        await loadSystemData();
                        showMainSystem();
                        setupPresence();
                        setupRealtimeListeners();
                        // ✅ INICIAR VERIFICAÇÃO AUTOMÁTICA DE STATUS
                setInterval(updateOnlineCount, 10000);
               setInterval(atualizarStatusAutomatico, 30000); // ← 30.000 ms = 30s
atualizarStatusAutomatico(); // ← executa imediatamente ao carregar
                        setInterval(updateOnlineCount, 10000);
                        return;
                    }
                }
                showLoginPage();
            } catch (error) {
                console.error('Erro ao inicializar aplicação:', error);
                showLoginPage();
            }
        }
           // ========== CONTROLE DE PISCINA E AQUECEDOR ==========
async function togglePiscina() {
    if (!currentCondominio) {
        alert('Selecione um condomínio primeiro.');
        return;
    }
    try {
        const novoStatus = !currentCondominio.statusPiscina;
        await db.collection('condominios').doc(currentCondominio.id).update({
            statusPiscina: novoStatus,
            dataAtualizacao: new Date().toISOString()
        });
        currentCondominio.statusPiscina = novoStatus;
        loadDashboardContent(); // Atualiza só a dashboard
        alert(`Piscina ${novoStatus ? 'ligada' : 'desligada'} com sucesso!`);
    } catch (err) {
        console.error('Erro ao atualizar piscina:', err);
        alert('Erro ao atualizar status da piscina.');
    }
}

async function toggleAquecedor() {
    if (!currentCondominio) {
        alert('Selecione um condomínio primeiro.');
        return;
    }
    try {
        const novoStatus = !currentCondominio.statusAquecedor;
        await db.collection('condominios').doc(currentCondominio.id).update({
            statusAquecedor: novoStatus,
            dataAtualizacao: new Date().toISOString()
        });
        currentCondominio.statusAquecedor = novoStatus;
        loadDashboardContent();
        alert(`Aquecedor ${novoStatus ? 'ligado' : 'desligado'} com sucesso!`);
    } catch (err) {
        console.error('Erro ao atualizar aquecedor:', err);
        alert('Erro ao atualizar status do aquecedor.');
    }
}
// ========== FUNÇÕES DE CÁLCULO DE HORAS EXTRAS ==========
function atualizarHorariosRegime() {
    const regime = document.getElementById('horaExtraRegime').value;
    const hoje = document.getElementById('horaExtraData').value || getCurrentDate();
    switch(regime) {
        case '12-36':
            document.getElementById('horaExtraEntrada').value = '07:00';
            document.getElementById('horaExtraSaidaIntervalo').value = '12:00';
            document.getElementById('horaExtraVoltaIntervalo').value = '13:00';
            document.getElementById('horaExtraSaida').value = '19:00';
            break;
        case '8h':
            document.getElementById('horaExtraEntrada').value = '08:00';
            document.getElementById('horaExtraSaidaIntervalo').value = '12:00';
            document.getElementById('horaExtraVoltaIntervalo').value = '13:00';
            document.getElementById('horaExtraSaida').value = '17:48';
            break;
        case 'personalizado':
            // Limpa os campos para preenchimento manual
            document.getElementById('horaExtraEntrada').value = '';
            document.getElementById('horaExtraSaidaIntervalo').value = '';
            document.getElementById('horaExtraVoltaIntervalo').value = '';
            document.getElementById('horaExtraSaida').value = '';
            break;
    }
    calcularHorasExtras();
}
function calcularHorasExtras() {
    const regime = document.getElementById('horaExtraRegime').value;
    const entradaReal = document.getElementById('horaExtraEntrada').value;
    const saidaIntervalo = document.getElementById('horaExtraSaidaIntervalo').value;
    const voltaIntervalo = document.getElementById('horaExtraVoltaIntervalo').value;
    const saidaReal = document.getElementById('horaExtraSaida').value;
    const trabalhoFolga = document.getElementById('trabalhoFolga').checked;
    if (!entradaReal || !saidaReal || !regime) {
        document.getElementById('horaExtraCalculada').value = 'Preencha todos os campos';
        return;
    }
// ========== FUNÇÃO DE CÁLCULO DETALHADO DE HORAS EXTRAS ==========
function calcularHorasExtrasDetalhado(entradaReal, saidaReal, saidaIntervaloReal, voltaIntervaloReal,
                                     entradaContratual, saidaContratual, saidaIntervaloContratual, voltaIntervaloContratual) {
    function toMinutes(timeStr) {
        if (!timeStr) return 0;
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
    }
    function toHours(minutos) {
        return minutos / 60;
    }
    const entReal = toMinutes(entradaReal);
    const saiReal = toMinutes(saidaReal);
    const saiIntReal = toMinutes(saidaIntervaloReal);
    const voltIntReal = toMinutes(voltaIntervaloReal);
    const entContr = toMinutes(entradaContratual);
    const saiContr = toMinutes(saidaContratual);
    const saiIntContr = toMinutes(saidaIntervaloContratual);
    const voltIntContr = toMinutes(voltaIntervaloContratual);
    let horasExtras = {
        antesExpediente: 0,
        intervaloSuprimido: 0,
        aposExpediente: 0,
        total: 0
    };
    // REGIME 12/36 (7h-19h)
    if (saidaContratual === '19:00') {
        // 1. Horas extras antes do expediente
        if (entReal < entContr) {
            horasExtras.antesExpediente = toHours(entContr - entReal);
        }
        // 2. Horas extras no intervalo
        if (saiIntReal && voltIntReal) {
            const intervaloReal = voltIntReal - saiIntReal;
            const intervaloContratual = 60; // 1 hora de almoço
            if (intervaloReal < intervaloContratual) {
                horasExtras.intervaloSuprimido = toHours(intervaloContratual - intervaloReal);
            }
        }
        // 3. Horas extras após o expediente
        if (saiReal > saiContr) {
            horasExtras.aposExpediente = toHours(saiReal - saiContr);
        }
    }
    // REGIME 8h (8h-17:48)
    else if (saidaContratual === '17:48') {
        // No regime de 8h, a jornada contratual é das 8h às 17:48
        // Isso inclui 8h de trabalho + 48min de horas extras habituais
        // 1. Horas extras antes das 8h
        if (entReal < toMinutes('08:00')) {
            horasExtras.antesExpediente = toHours(toMinutes('08:00') - entReal);
        }
        // 2. Horas extras no intervalo de almoço
        if (saiIntReal && voltIntReal) {
            const intervaloReal = voltIntReal - saiIntReal;
            const intervaloContratual = 60; // 1 hora de almoço
            if (intervaloReal < intervaloContratual) {
                horasExtras.intervaloSuprimido = toHours(intervaloContratual - intervaloReal);
            }
        }
        // 3. Horas extras APÓS as 17:48 (apenas o que passar disso é hora extra)
        if (saiReal > toMinutes('17:48')) {
            horasExtras.aposExpediente = toHours(saiReal - toMinutes('17:48'));
        }
        // IMPORTANTE: O período das 17:00 às 17:48 já está incluído na jornada normal
        // do regime de 8h, portanto NÃO conta como hora extra
    }
    // REGIME PERSONALIZADO
    else {
        // Cálculo genérico para regime personalizado
        if (entReal < entContr) {
            horasExtras.antesExpediente = toHours(entContr - entReal);
        }
        if (saiIntReal && voltIntReal) {
            const intervaloReal = voltIntReal - saiIntReal;
            const intervaloContratual = 60;
            if (intervaloReal < intervaloContratual) {
                horasExtras.intervaloSuprimido = toHours(intervaloContratual - intervaloReal);
            }
        }
        if (saiReal > saiContr) {
            horasExtras.aposExpediente = toHours(saiReal - saiContr);
        }
    }
    horasExtras.total = horasExtras.antesExpediente + horasExtras.intervaloSuprimido + horasExtras.aposExpediente;
    return horasExtras;
}
    // TRABALHO NA FOLGA - cálculo simplificado (todo período é extra)
    if (trabalhoFolga) {
        const horasTrabalhadas = calcularDiferencaHoras(entradaReal, saidaReal);
        // Subtrair intervalo se informado
        let intervalo = 0;
        if (saidaIntervalo && voltaIntervalo) {
            intervalo = calcularDiferencaHoras(saidaIntervalo, voltaIntervalo);
        }
        const horasExtrasTotal = horasTrabalhadas - intervalo;
        document.getElementById('horaExtraCalculada').value = `${horasExtrasTotal.toFixed(2)} horas (100% extra - Folga)`;
        document.getElementById('horaExtraQuantidade').value = horasExtrasTotal;
        document.getElementById('detalhesCalculo').textContent = `Trabalho em folga: ${horasTrabalhadas.toFixed(2)}h trabalhadas - ${intervalo.toFixed(2)}h intervalo`;
        return;
    }
    // CÁLCULO NORMAL (dia de trabalho)
    let entradaContratual, saidaContratual, saidaIntervaloContratual, voltaIntervaloContratual;
    switch(regime) {
        case '12-36':
            entradaContratual = '07:00';
            saidaContratual = '19:00';
            saidaIntervaloContratual = '12:00';
            voltaIntervaloContratual = '13:00';
            break;
        case '8h':
            entradaContratual = '08:00';
            saidaContratual = '17:48'; // 8h48min de trabalho (8h + 48min)
            saidaIntervaloContratual = '12:00';
            voltaIntervaloContratual = '13:00';
            break;
        case 'personalizado':
            entradaContratual = '08:00';
            saidaContratual = '17:00';
            saidaIntervaloContratual = '12:00';
            voltaIntervaloContratual = '13:00';
            break;
    }
    const horasExtras = calcularHorasExtrasDetalhado(
        entradaReal, saidaReal, saidaIntervalo, voltaIntervalo,
        entradaContratual, saidaContratual, saidaIntervaloContratual, voltaIntervaloContratual
    );
    document.getElementById('horaExtraCalculada').value = `${horasExtras.total.toFixed(2)} horas`;
    document.getElementById('horaExtraQuantidade').value = horasExtras.total;
    let detalhes = [];
    if (horasExtras.antesExpediente > 0) detalhes.push(`Antes: ${horasExtras.antesExpediente.toFixed(2)}h`);
    if (horasExtras.intervaloSuprimido > 0) detalhes.push(`Intervalo: ${horasExtras.intervaloSuprimido.toFixed(2)}h`);
    if (horasExtras.aposExpediente > 0) detalhes.push(`Após: ${horasExtras.aposExpediente.toFixed(2)}h`);
    document.getElementById('detalhesCalculo').textContent = detalhes.join(' | ');
}
// Função auxiliar para calcular diferença entre horários
function calcularDiferencaHoras(horario1, horario2) {
    const [h1, m1] = horario1.split(':').map(Number);
    const [h2, m2] = horario2.split(':').map(Number);
    const totalMinutos1 = h1 * 60 + m1;
    const totalMinutos2 = h2 * 60 + m2;
    // Se o horário2 for menor que horário1, assumir que é do dia seguinte
    const diferencaMinutos = totalMinutos2 >= totalMinutos1
        ? totalMinutos2 - totalMinutos1
        : (1440 - totalMinutos1) + totalMinutos2; // 1440 = minutos em 24h
    return diferencaMinutos / 60;
}
        // Verificar conexão com Firebase
        function checkFirebaseConnection() {
            const connectionDot = document.getElementById('loginConnectionDot');
            const connectionText = document.getElementById('loginConnectionText');
            setTimeout(() => {
                db.collection('test').limit(1).get()
                    .then(() => {
                        isFirebaseConnected = true;
                        connectionDot.classList.add('connected');
                        connectionText.textContent = 'Conectado ao banco de dados';
                    })
                    .catch((error) => {
                        isFirebaseConnected = false;
                        connectionDot.classList.remove('connected');
                        connectionText.textContent = 'Erro na conexão com o banco de dados';
                        console.error('Erro de conexão com Firebase:', error);
                    });
            }, 1000);
        }
        // Mostrar página de login
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainSystem').style.display = 'none';
            document.getElementById('tickerContainer').style.display = 'none';
            document.getElementById('loginStatus').textContent = 'Digite suas credenciais para acessar';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }
        // Mostrar sistema principal
        function showMainSystem() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'flex';
            document.getElementById('tickerContainer').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.nome || currentUser.usuario;
            document.getElementById('currentCondominioBadge').textContent = currentCondominio ? currentCondominio.nome : 'Nenhum condomínio selecionado';
            loadModuleMenu();
            loadModuleContent(currentModule);
            loadTickerContent();
        }
      // Inicia o menu recolhido por padrão
document.querySelector('.sidebar').style.width = '70px';
document.querySelector('.main-content').style.marginLeft = '70px';
document.querySelectorAll('.sidebar-menu a span').forEach(el => el.style.display = 'none');
document.querySelectorAll('.sidebar-menu a i').forEach(el => el.style.marginRight = '0');
        // ========== FUNÇÕES DE HORAS EXTRAS ==========
    function openHoraExtraModal() {
    document.getElementById('horaExtraModalTitle').textContent = 'Nova Hora Extra';
    document.getElementById('editingHoraExtraId').value = '';
    document.getElementById('horaExtraForm').reset();
    document.getElementById('horaExtraData').value = getCurrentDate();
    // Reset dos campos
    document.getElementById('horaExtraEntrada').value = '';
    document.getElementById('horaExtraSaidaIntervalo').value = '';
    document.getElementById('horaExtraVoltaIntervalo').value = '';
    document.getElementById('horaExtraSaida').value = '';
    document.getElementById('horaExtraCalculada').value = '';
    document.getElementById('trabalhoFolga').checked = false;
    document.getElementById('horaExtraModal').style.display = 'flex';
}
        function editHoraExtra(id) {
    const horaExtra = horasExtras.find(h => h.id === id);
    if (!horaExtra) return;
    document.getElementById('horaExtraModalTitle').textContent = 'Editar Hora Extra';
    document.getElementById('editingHoraExtraId').value = horaExtra.id;
    document.getElementById('horaExtraFuncionario').value = horaExtra.funcionario;
    document.getElementById('horaExtraMatricula').value = horaExtra.matricula;
    document.getElementById('horaExtraData').value = horaExtra.data;
    document.getElementById('horaExtraRegime').value = horaExtra.regime || '12-36';
    document.getElementById('horaExtraEntrada').value = horaExtra.entradaReal || '';
    document.getElementById('horaExtraSaidaIntervalo').value = horaExtra.saidaIntervalo || '';
    document.getElementById('horaExtraVoltaIntervalo').value = horaExtra.voltaIntervalo || '';
    document.getElementById('horaExtraSaida').value = horaExtra.saidaReal || '';
    document.getElementById('horaExtraObservacoes').value = horaExtra.observacoes || '';
    // Recalcular horas extras para exibir
    setTimeout(() => {
        calcularHorasExtras();
    }, 100);
    document.getElementById('horaExtraModal').style.display = 'flex';
}
        document.getElementById('horaExtraForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    if (!currentCondominio) {
        alert('Selecione um condomínio primeiro!');
        return;
    }
    const editingId = document.getElementById('editingHoraExtraId').value;
    const horaExtraData = {
        funcionario: document.getElementById('horaExtraFuncionario').value,
        matricula: document.getElementById('horaExtraMatricula').value,
        data: document.getElementById('horaExtraData').value,
        regime: document.getElementById('horaExtraRegime').value,
        entradaReal: document.getElementById('horaExtraEntrada').value,
        saidaIntervalo: document.getElementById('horaExtraSaidaIntervalo').value,
        voltaIntervalo: document.getElementById('horaExtraVoltaIntervalo').value,
        saidaReal: document.getElementById('horaExtraSaida').value,
        quantidade: parseFloat(document.getElementById('horaExtraQuantidade').value) || 0,
        observacoes: document.getElementById('horaExtraObservacoes').value,
        condominioId: currentCondominio.id,
        condominioNome: currentCondominio.nome,
        criadoPor: currentUser.id || currentUser.usuario,
        criadoEm: new Date().toISOString()
    };
    try {
        if (editingId) {
            await db.collection('horasExtras').doc(editingId).update(horaExtraData);
        } else {
            await db.collection('horasExtras').add(horaExtraData);
        }
        await loadSystemData();
        closeHoraExtraModal();
        if (currentModule === 'horas-extras') {
            loadHorasExtrasContent();
        }
        alert('Hora extra salva com sucesso!');
    } catch (error) {
        console.error('Erro ao salvar hora extra:', error);
        alert('Erro ao salvar hora extra. Tente novamente.');
    }
});
function closeHoraExtraModal() {
    document.getElementById('horaExtraModal').style.display = 'none';
}
        async function deleteHoraExtra(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este registro de hora extra?')) return;
            try {
                await db.collection('horasExtras').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'horas-extras') {
                    loadHorasExtrasContent();
                }
                alert('Hora extra excluída com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir hora extra:', error);
                alert('Erro ao excluir hora extra. Tente novamente.');
            }
        }
        function filterHorasExtras() {
            const funcionario = document.getElementById('filtroFuncionario').value.toLowerCase();
            const mes = document.getElementById('filtroMesHoraExtra').value;
            let filteredHorasExtras = horasExtras.filter(h =>
                h.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (funcionario) {
                filteredHorasExtras = filteredHorasExtras.filter(h =>
                    h.funcionario.toLowerCase().includes(funcionario)
                );
            }
            if (mes) {
                filteredHorasExtras = filteredHorasExtras.filter(h =>
                    h.data.startsWith(mes)
                );
            }
            const tbody = document.querySelector('#horasExtrasTable tbody');
            tbody.innerHTML = '';
            if (filteredHorasExtras.length > 0) {
                filteredHorasExtras.forEach(horaExtra => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${horaExtra.funcionario}</td>
                        <td>${horaExtra.matricula}</td>
                        <td>${formatDate(horaExtra.data)}</td>
                        <td>${horaExtra.quantidade}</td>
                        <td>${horaExtra.condominioNome}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editHoraExtra('${horaExtra.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${podeExcluirRegistros() ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteHoraExtra('${horaExtra.id}')">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum registro de hora extra encontrado com os filtros aplicados.</td></tr>';
            }
        }

        // ========== FUNÇÕES DO NOVO MÓDULO COMPRAS ==========

        function openCompraModal() {
            document.getElementById('compraModalTitle').textContent = 'Nova Compra';
            document.getElementById('editingCompraId').value = '';
            document.getElementById('compraForm').reset();
            document.getElementById('compraItensLista').innerHTML = '';
            document.getElementById('compraTotalDisplay').textContent = 'Total: R$ 0.00';
            document.getElementById('compraDataFatura').value = getCurrentDate();
            document.getElementById('compraStatus').value = 'pendente';
            document.getElementById('compraModal').style.display = 'flex';
        }

        function closeCompraModal() {
            document.getElementById('compraModal').style.display = 'none';
        }

       function editCompra(id) {
    const compra = compras.find(c => c.id === id);
    if (!compra) return;

    document.getElementById('compraModalTitle').textContent = 'Editar Compra';
    document.getElementById('editingCompraId').value = compra.id;

    document.getElementById('compraFornecedor').value = compra.fornecedor;
    document.getElementById('compraDataFatura').value = compra.dataFatura;
    document.getElementById('compraVencimento').value = compra.vencimento || '';
    document.getElementById('compraDescricaoGeral').value = compra.descricaoGeral || '';
    document.getElementById('compraObservacoes').value = compra.observacoes || '';
    document.getElementById('compraStatus').value = compra.status;

    // Carregar itens
    document.getElementById('compraItensLista').innerHTML = '';
    compra.itens.forEach((item, index) => {
        adicionarItemNaLista(item.nome, item.quantidade, item.valorUnitario, index);
    });
    atualizarTotalCompra();
    document.getElementById('compraModal').style.display = 'flex';
}

        function adicionarItemCompra() {
            const nome = document.getElementById('novoItemNome').value.trim();
            const qtd = parseFloat(document.getElementById('novoItemQuantidade').value);
            const valor = parseFloat(document.getElementById('novoItemValor').value);

            if (!nome || isNaN(qtd) || isNaN(valor) || qtd <= 0 || valor <= 0) {
                alert('Preencha corretamente os campos do item.');
                return;
            }

            const index = Date.now(); // Usar timestamp como ID temporário para o item
            adicionarItemNaLista(nome, qtd, valor, index);

            // Limpar campos
            document.getElementById('novoItemNome').value = '';
            document.getElementById('novoItemQuantidade').value = '';
            document.getElementById('novoItemValor').value = '';
            atualizarTotalCompra();
        }

        function adicionarItemNaLista(nome, qtd, valor, index) {
            const lista = document.getElementById('compraItensLista');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'compras-item';
            itemDiv.id = `item-${index}`;
            itemDiv.innerHTML = `
                <div class="item-info">
                    <span class="item-nome">${nome}</span> - <span class="item-qtd">${qtd}</span> x R$ <span class="item-valor">${valor.toFixed(2)}</span>
                </div>
                <div class="item-actions">
                    <button type="button" class="btn btn-sm btn-danger" onclick="removerItemCompra(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            lista.appendChild(itemDiv);
        }

        function removerItemCompra(index) {
            const item = document.getElementById(`item-${index}`);
            if (item) {
                item.remove();
                atualizarTotalCompra();
            }
        }

        function atualizarTotalCompra() {
            let total = 0;
            const itens = document.getElementById('compraItensLista').children;
            for (let i = 0; i < itens.length; i++) {
                const itemDiv = itens[i];
                const qtdText = itemDiv.querySelector('.item-qtd').textContent;
                const valorText = itemDiv.querySelector('.item-valor').textContent;
                const qtd = parseFloat(qtdText);
                const valor = parseFloat(valorText);
                total += qtd * valor;
            }
            document.getElementById('compraTotalDisplay').textContent = `Total: R$ ${total.toFixed(2)}`;
        }

        function getItensCompraFromDOM() {
            const itens = [];
            const itensDivs = document.getElementById('compraItensLista').children;
            for (let i = 0; i < itensDivs.length; i++) {
                const itemDiv = itensDivs[i];
                const nome = itemDiv.querySelector('.item-nome').textContent;
                const qtd = parseFloat(itemDiv.querySelector('.item-qtd').textContent);
                const valor = parseFloat(itemDiv.querySelector('.item-valor').textContent);
                itens.push({ nome, quantidade: qtd, valorUnitario: valor });
            }
            return itens;
        }

        document.getElementById('compraForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    if (!currentCondominio) {
        alert('Selecione um condomínio primeiro!');
        return;
    }
    const itens = getItensCompraFromDOM();
    const editingId = document.getElementById('editingCompraId').value;
    const fornecedor = document.getElementById('compraFornecedor').value.trim();
    const dataFatura = document.getElementById('compraDataFatura').value;
    const vencimento = document.getElementById('compraVencimento').value;
    const descricaoGeral = document.getElementById('compraDescricaoGeral').value;
    const observacoes = document.getElementById('compraObservacoes').value;
    const status = document.getElementById('compraStatus').value;
    const valorTotal = itens.reduce((sum, item) => sum + (item.quantidade * item.valorUnitario), 0);

    if (!fornecedor || !dataFatura || !vencimento) {
        alert('Preencha todos os campos obrigatórios.');
        return;
    }

    const compraData = {
        fornecedor,
        dataFatura,
        vencimento,
        descricaoGeral: descricaoGeral || '',
        observacoes: observacoes || '',
        itens,
        valorTotal,
        status,
        condominioId: currentCondominio.id,
        condominioNome: currentCondominio.nome,
        criadoPor: currentUser.id || currentUser.usuario,
        criadoEm: new Date().toISOString()
    };

    try {
        if (editingId) {
            await db.collection('compras').doc(editingId).update(compraData);
        } else {
            await db.collection('compras').add(compraData);
        }
        await loadSystemData();
        closeCompraModal();
        if (currentModule === 'compras') {
            loadComprasContent();
        }
        alert('Compra salva com sucesso!');
    } catch (error) {
        console.error('Erro ao salvar compra:', error);
        alert('Erro ao salvar compra. Tente novamente.');
    }
});

        async function deleteCompra(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir esta compra?')) return;
            try {
                await db.collection('compras').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'compras') {
                    loadComprasContent();
                }
                alert('Compra excluída com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir compra:', error);
                alert('Erro ao excluir compra. Tente novamente.');
            }
        }

        function filterCompras() {
    const fornecedor = (document.getElementById('filtroFornecedorCompra')?.value || '').toLowerCase();
    const status = document.getElementById('filtroStatusCompra')?.value || '';
    const filtroVencimento = document.getElementById('filtroVencimentoCompra')?.value || '';

    let filtered = compras.filter(c => c.condominioId === currentCondominio.id);

    if (fornecedor) {
        filtered = filtered.filter(c => c.fornecedor.toLowerCase().includes(fornecedor));
    }
    if (status) {
        filtered = filtered.filter(c => c.status === status);
    }

    const hoje = new Date();
    if (filtroVencimento === 'proximos-7') {
        filtered = filtered.filter(c => {
            const venc = new Date(c.vencimento);
            const diff = Math.ceil((venc - hoje) / (1000 * 60 * 60 * 24));
            return diff >= 0 && diff <= 7;
        });
    } else if (filtroVencimento === 'atrasados') {
        filtered = filtered.filter(c => {
            const venc = new Date(c.vencimento);
            return venc < hoje;
        });
    }

    const tbody = document.querySelector('#comprasTableBody');
    if (!tbody) return;

    tbody.innerHTML = filtered.length > 0 ? filtered.map(compra => {
        const total = compra.valorTotal || compra.itens.reduce((s, i) => s + i.quantidade * i.valorUnitario, 0);
        return `
            <tr>
                <td>${compra.fornecedor}</td>
                <td>${formatDate(compra.dataFatura)}</td>
                <td>${formatDate(compra.vencimento)}</td>
                <td>R$ ${total.toFixed(2).replace('.', ',')}</td>
                <td><span class="status-badge status-${compra.status}">${formatStatusCompra(compra.status)}</span></td>
                <td>${(compra.observacoes || '').substring(0, 50)}${compra.observacoes && compra.observacoes.length > 50 ? '...' : ''}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="editCompra('${compra.id}')"><i class="fas fa-edit"></i></button>
                    ${podeExcluirRegistros() ? 
                        `<button class="btn btn-sm btn-danger" onclick="deleteCompra('${compra.id}')"><i class="fas fa-trash"></i></button>` : ''}
                </td>
            </tr>
        `;
    }).join('') : '<tr><td colspan="7" class="text-center">Nenhuma compra encontrada com os filtros aplicados.</td></tr>';
}

        function formatStatusCompra(status) {
    const statusMap = {
        'pendente': 'Pendente',
        'recebido': 'Recebido',
        'pago': 'Pago',
        'cancelado': 'Cancelado'
    };
    return statusMap[status] || status;
}

        // Carregar menu de módulos
        function loadModuleMenu() {
    const moduleMenu = document.getElementById('moduleMenu');
    moduleMenu.innerHTML = '';
    const allowedModules = modules.filter(module => {
        return !currentUser.permissoes ||
               currentUser.permissoes.includes('*') ||
               currentUser.permissoes.includes(module.id);
    });
    allowedModules.forEach(module => {
        const menuItem = document.createElement('li');
        menuItem.innerHTML = `
            <a href="#" 
               class="${module.id === currentModule ? 'active' : ''}" 
               onclick="changeModule('${module.id}'); return false;"
               data-name="${module.name}">
                <i class="${module.icon}"></i>
                <span>${module.name}</span>
            </a>
        `;
        moduleMenu.appendChild(menuItem);
    });
}
        // Carregar conteúdo do módulo
        function loadModuleContent(moduleId) {
    currentModule = moduleId;
    document.querySelectorAll('.sidebar-menu a').forEach(item => {
        item.classList.remove('active');
    });
    const activeItem = document.querySelector(`.sidebar-menu a[onclick="changeModule('${moduleId}')"]`);
    if (activeItem) {
        activeItem.classList.add('active');
    }
    const moduleContent = document.getElementById('moduleContent');
    switch(moduleId) {
        case 'dashboard':
            loadDashboardContent();
            break;
        case 'condominios':
            loadCondominiosContent();
            break;
                case 'tarefas':
            loadTarefasContent();
            break;
        case 'usuarios':
            loadUsuariosContent();
            break;
        case 'moradores':
            loadMoradoresContent();
            break;
        case 'agendamentos':
            loadAgendamentosContent();
            break;
        case 'limpeza':
            loadLimpezaContent();
            break;
        case 'sauna':
            loadSaunaContent();
            break;
        case 'palavras-chave':
    loadPalavrasChaveContent();
    break;
        case 'contas':
            loadContasContent();
            break;
        case 'lembretes':
            loadLembretesContent();
            break;
        case 'relatorios':
            loadRelatoriosContent();
            break;
        case 'horas-extras':
            loadHorasExtrasContent();
            break;
        case 'ocorrencias':
            loadOcorrenciasContent();
            break;
        case 'prestadores':
            loadPrestadoresContent();
            break;
        case 'compras':
            loadComprasContent();
            break;
        case 'confraternizacao':
            loadConfraternizacaoContent();
            break;
        case 'vales':  // ← ESSE CASO É O QUE FALTAVA!
            loadValesContent();
            break;
        default:
            moduleContent.innerHTML = `<div class="alert alert-warning">Módulo não encontrado: ${moduleId}</div>`;
    }
    setTimeout(() => updateDeleteButtonsState(), 100);
}
        function changeModule(moduleId) {
            loadModuleContent(moduleId);
        }
        function atualizarCardsPalavrasChave() {
    if (!currentCondominio) return;
    const cards = document.querySelectorAll('.card');
    let targetCard = null;
    for (let card of cards) {
        const h3 = card.querySelector('.card-header h3');
        if (h3 && h3.textContent.includes('Palavras-chave Mercado Livre')) {
            targetCard = card;
            break;
        }
    }
    if (!targetCard) return;
    const container = targetCard.querySelector('.stats-container');
    if (!container) return;
    const pcs = palavrasChave.filter(pc => pc.condominioId === currentCondominio.id);
    const btnVerTodas = targetCard.querySelector('button[onclick*="palavras-chave"]');
    if (pcs.length === 0) {
        container.innerHTML = `
            <div class="mercado-livre-card" onclick="openPalavraChaveModal()" style="background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%);">
                <div class="mercado-livre-header">
                    <i class="fas fa-plus-circle" style="font-size: 2em; margin-bottom: 8px; color: #2c3e50;"></i>
                    <h3>Adicionar Primeira</h3>
                </div>
                <div class="mercado-livre-content">
                    <div style="text-align: center; color: #2c3e50; font-size: 0.9em;">
                        Clique para cadastrar sua primeira palavra-chave
                    </div>
                </div>
            </div>
        `;
        if (btnVerTodas) btnVerTodas.style.display = 'none';
        return;
    }
    const htmlCards = pcs.slice(0, 3).map(pc => `
        <div class="mercado-livre-card" onclick="editPalavraChave('${pc.id}')">
            <div class="mercado-livre-header">
                <i class="fas fa-tags" style="font-size: 1.5em; margin-bottom: 8px; color: #2c3e50;"></i>
                <h3>Palavras-chave</h3>
            </div>
            <div class="mercado-livre-content">
                <div class="morador-info">${pc.moradorNome}</div>
                <div class="apto-info">Apto: ${pc.moradorApto}</div>
                ${pc.palavrasChave.slice(0, 2).map(p => `<div class="palavra-chave-item">${p}</div>`).join('')}
                ${pc.palavrasChave.length > 2 ? `<div class="palavra-chave-item">+${pc.palavrasChave.length - 2} mais...</div>` : ''}
            </div>
        </div>
    `).join('');
    container.innerHTML = htmlCards;
    if (btnVerTodas) {
        btnVerTodas.style.display = pcs.length > 3 ? 'inline-block' : 'none';
        btnVerTodas.textContent = `Ver todas (${pcs.length})`;
    }
}
        async function loadSystemData() {
            try {
                const condominiosSnapshot = await db.collection('condominios').get();
                condominios = [];
                condominiosSnapshot.forEach(doc => {
                    condominios.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                const usuariosSnapshot = await db.collection('usuarios').get();
                usuarios = [];
                usuariosSnapshot.forEach(doc => {
                    usuarios.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                if (currentCondominio) {
                    const moradoresSnapshot = await db.collection('moradores')
                        .where('condominioId', '==', currentCondominio.id)
                        .get();
                    moradores = [];
                    moradoresSnapshot.forEach(doc => {
                        moradores.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                     // Carregar Vales
const valesSnapshot = await db.collection('vales')
    .where('condominioId', '==', currentCondominio.id)
    .get();
vales = [];
valesSnapshot.forEach(doc => {
    vales.push({
        id: doc.id,
        ...doc.data()
    });
});
                    // Adicione esta linha na função loadSystemData() para carregar as palavras-chave:
// Dentro da função loadSystemData(), adicione:
const palavrasChaveSnapshot = await db.collection('palavrasChave')
    .where('condominioId', '==', currentCondominio.id)
    .get();
palavrasChave = [];
palavrasChaveSnapshot.forEach(doc => {
    palavrasChave.push({
        id: doc.id,
        ...doc.data()
    });
});
                    const horasExtrasSnapshot = await db.collection('horasExtras')
                        .where('condominioId', '==', currentCondominio.id)
                        .get();
                    horasExtras = [];
                    horasExtrasSnapshot.forEach(doc => {
                        horasExtras.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    const limpezasSnapshot = await db.collection('limpezas')
                        .where('condominioId', '==', currentCondominio.id)
                        .get();
                    limpezas = [];
                    limpezasSnapshot.forEach(doc => {
                        limpezas.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    const saunasSnapshot = await db.collection('saunas')
                        .where('condominioId', '==', currentCondominio.id)
                        .get();
                    saunas = [];
                    saunasSnapshot.forEach(doc => {
                        saunas.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    const agendamentosSnapshot = await db.collection('agendamentos')
                        .where('condominioId', '==', currentCondominio.id)
                        .get();
                    agendamentos = [];
                    agendamentosSnapshot.forEach(doc => {
                        agendamentos.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    const contasSnapshot = await db.collection('contas')
                        .where('condominioId', '==', currentCondominio.id)
                        .get();
                    contas = [];
                    contasSnapshot.forEach(doc => {
                        contas.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    const lembretesSnapshot = await db.collection('lembretes')
                        .where('condominioId', '==', currentCondominio.id)
                        .get();
                    lembretes = [];
                    lembretesSnapshot.forEach(doc => {
                        lembretes.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    // Carregar Compras
                    const comprasSnapshot = await db.collection('compras')
                        .where('condominioId', '==', currentCondominio.id)
                        .get();
                    compras = [];
                    comprasSnapshot.forEach(doc => {
                        compras.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                } else {
                    moradores = [];
                    horasExtras = [];
                    vales = []; // <-- Adicione esta linha
                    limpezas = [];
                    saunas = [];
                    agendamentos = [];
                    contas = [];
                    lembretes = [];
                    compras = []; // <-- Limpar Compras
                }
                        // Carregar Tarefas
        await loadTarefas();
                
                updateCondominioSelector();
                updateConnectionStatus(true);
            } catch (error) {
                console.error('Erro ao carregar dados do sistema:', error);
                updateConnectionStatus(false);
            }
        }
        function loadPalavrasChaveContent() {
    const moduleContent = document.getElementById('moduleContent');
    if (!currentCondominio) {
        moduleContent.innerHTML = `<div class="alert alert-warning">Selecione um condomínio primeiro.</div>`;
        return;
    }

    const condominioId = currentCondominio.id;
    const pcs = palavrasChave.filter(pc => pc.condominioId === condominioId);

    moduleContent.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h3>Palavras-chave Mercado Livre — ${currentCondominio.nome}</h3>
                <button class="btn btn-primary" onclick="openPalavraChaveModal()">
                    <i class="fas fa-plus"></i> Nova Palavra-chave
                </button>
            </div>
            <div class="card-body">
                ${pcs.length > 0 ? `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Morador</th>
                            <th>Apto</th>
                            <th>Palavras-chave</th>
                            <th>Observações</th>
                            <th>Data</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pcs.map(pc => `
                            <tr>
                                <td>${pc.moradorNome}</td>
                                <td>${pc.moradorApto}</td>
                                <td>
                                    ${pc.palavrasChave.map(p => 
                                        `<span class="badge badge-info" style="margin:2px">${p}</span>`
                                    ).join('')}
                                </td>
                                <td>${pc.observacoes || '—'}</td>
                                <td>${new Date(pc.criadoEm).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="editPalavraChave('${pc.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ${podeExcluirRegistros() ? `
                                    <button class="btn btn-sm btn-danger" onclick="deletePalavraChave('${pc.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ` : `
                <div class="alert alert-info">
                    <h5>Nenhuma palavra-chave cadastrada</h5>
                    <p>Clique abaixo para cadastrar palavras-chave do Mercado Livre por morador.</p>
                    <button class="btn btn-primary" onclick="openPalavraChaveModal()">
                        <i class="fas fa-plus"></i> Cadastrar Primeira Palavra-chave
                    </button>
                </div>
                `}
            </div>
        </div>
    `;
}
        function loadTickerContent() {
            const tickerContent = document.getElementById('tickerContent');
            tickerContent.innerHTML = '';
            const hoje = getCurrentDate();
            let lembretesAtivos = [];
            if (currentCondominio) {
                lembretesAtivos = lembretes.filter(l =>
                    l.condominioId === currentCondominio.id &&
                    l.dataInicio <= hoje &&
                    (!l.dataFim || l.dataFim >= hoje)
                );
            } else {
                lembretesAtivos = lembretes.filter(l =>
                    l.dataInicio <= hoje &&
                    (!l.dataFim || l.dataFim >= hoje)
                );
            }
            if (lembretesAtivos.length > 0) {
                lembretesAtivos.forEach(lembrete => {
                    const item = document.createElement('div');
                    item.className = 'ticker-item';
                    let icon = 'fas fa-bell';
                    if (lembrete.prioridade === 'alta') {
                        icon = 'fas fa-exclamation-circle';
                    } else if (lembrete.prioridade === 'media') {
                        icon = 'fas fa-info-circle';
                    }
                    let nomeUsuario = 'Sistema';
                    if (lembrete.criadoPor) {
                        const usuarioCriador = usuarios.find(u => u.id === lembrete.criadoPor);
                        if (usuarioCriador) {
                            nomeUsuario = usuarioCriador.nome || usuarioCriador.usuario || 'Usuário';
                        } else if (typeof lembrete.criadoPor === 'string' && lembrete.criadoPor.length > 10) {
                            nomeUsuario = lembrete.criadoPorNome || 'Usuário';
                        } else {
                            nomeUsuario = lembrete.criadoPor;
                        }
                    }
                    const textoCurto = lembrete.descricao ?
                        (lembrete.descricao.length > 50 ? lembrete.descricao.substring(0, 50) + '...' : lembrete.descricao) :
                        'Sem descrição';
                    item.innerHTML = `
                        <i class="${icon}"></i>
                        <strong>${lembrete.titulo}</strong> - ${textoCurto}
                        <em>(por: ${nomeUsuario})</em>
                    `;
                    tickerContent.appendChild(item);
                });
                document.getElementById('tickerContainer').style.display = 'block';
            } else {
                const item = document.createElement('div');
                item.className = 'ticker-item';
                item.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <strong>Sem lembretes para hoje - ${formatDate(hoje)}</strong>
                `;
                tickerContent.appendChild(item);
                document.getElementById('tickerContainer').style.display = 'block';
            }
            setTimeout(() => {
                const content = document.getElementById('tickerContent');
                content.style.animation = 'none';
                setTimeout(() => {
                    content.style.animation = 'ticker 60s linear infinite';
                }, 10);
            }, 100);
        }
                
        function updateCondominioSelector() {
            const condominioSelectTop = document.getElementById('condominioSelectTop');
            const currentCondominioBadge = document.getElementById('currentCondominioBadge');
            condominioSelectTop.innerHTML = '<option value="" disabled selected hidden>Selecione um condomínio</option>';
            let allowedCondominios = [...condominios];
            if (currentUser.condominios && !currentUser.condominios.includes('*')) {
                allowedCondominios = condominios.filter(condominio =>
                    currentUser.condominios.includes(condominio.id)
                );
            }
            allowedCondominios.forEach(condominio => {
                const option = document.createElement('option');
                option.value = condominio.id;
                option.textContent = condominio.nome;
                condominioSelectTop.appendChild(option);
            });
            if (!currentCondominio && allowedCondominios.length > 0) {
                currentCondominio = allowedCondominios[0];
                condominioSelectTop.value = currentCondominio.id;
                if (currentCondominioBadge) {
                    currentCondominioBadge.textContent = currentCondominio.nome;
                }
            } else if (currentCondominio) {
                condominioSelectTop.value = currentCondominio.id;
                if (currentCondominioBadge) {
                    currentCondominioBadge.textContent = currentCondominio.nome;
                }
            }
        }
        function updateConnectionStatus(connected) {
            const connectionStatus = document.getElementById('connectionStatus');
            if (connected) {
                connectionStatus.classList.add('connected');
                connectionStatus.title = 'Conectado';
            } else {
                connectionStatus.classList.remove('connected');
                connectionStatus.title = 'Desconectado';
            }
        }
        // ========== MÓDULO COMPRAS ==========
        function loadComprasContent() {
    const moduleContent = document.getElementById('moduleContent');
    if (currentUser.permissoes && !currentUser.permissoes.includes('*') && !currentUser.permissoes.includes('compras')) {
        moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.</div>`;
        return;
    }
    if (!currentCondominio) {
        moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Selecione um condomínio</strong> para acessar o módulo de compras.</div>`;
        return;
    }

    const filteredCompras = compras.filter(c => c.condominioId === currentCondominio.id);

    moduleContent.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h3>Compras - ${currentCondominio.nome}</h3>
                <button class="btn btn-primary" onclick="openCompraModal()">
                    <i class="fas fa-plus"></i> Nova Compra
                </button>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Filtrar por Fornecedor</label>
                        <input type="text" class="form-control" id="filtroFornecedorCompra" onkeyup="filterCompras()" placeholder="Digite o nome do fornecedor">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select class="form-control" id="filtroStatusCompra" onchange="filterCompras()">
                            <option value="">Todos</option>
                            <option value="pendente">Pendente</option>
                            <option value="recebido">Recebido</option>
                            <option value="pago">Pago</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vencimento</label>
                        <select class="form-control" id="filtroVencimentoCompra" onchange="filterCompras()">
                            <option value="">Qualquer data</option>
                            <option value="proximos-7">Próximos 7 dias</option>
                            <option value="atrasados">Vencidos</option>
                        </select>
                    </div>
                </div>
                <table class="table" id="comprasTable">
                    <thead>
                        <tr>
                            <th>Fornecedor</th>
                            <th>Data Fatura</th>
                            <th>Vencimento</th>
                            <th>Valor Total</th>
                            <th>Status</th>
                            <th>Observações</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="comprasTableBody">
                        ${filteredCompras.length > 0 ? filteredCompras.map(compra => {
                            const total = compra.valorTotal || compra.itens.reduce((s, i) => s + i.quantidade * i.valorUnitario, 0);
                            return `
                                <tr>
                                    <td>${compra.fornecedor}</td>
                                    <td>${formatDate(compra.dataFatura)}</td>
                                    <td>${formatDate(compra.vencimento)}</td>
                                    <td>R$ ${total.toFixed(2).replace('.', ',')}</td>
                                    <td><span class="status-badge status-${compra.status}">${formatStatusCompra(compra.status)}</span></td>
                                    <td>${(compra.observacoes || '').substring(0, 50)}${compra.observacoes && compra.observacoes.length > 50 ? '...' : ''}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info" onclick="editCompra('${compra.id}')"><i class="fas fa-edit"></i></button>
                                        ${podeExcluirRegistros() ? 
                                            `<button class="btn btn-sm btn-danger" onclick="deleteCompra('${compra.id}')"><i class="fas fa-trash"></i></button>` : ''}
                                    </td>
                                </tr>
                            `;
                        }).join('') : '<tr><td colspan="7" class="text-center">Nenhuma compra encontrada.</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}        function openValeModal() {
    document.getElementById('valeModalTitle').textContent = currentUser.tipo === 'sindico' || currentUser.tipo === 'subsindico' 
        ? 'Novo Vale (Admin)' : 'Solicitar Vale';
    document.getElementById('editingValeId').value = '';
    document.getElementById('valeForm').reset();
    document.getElementById('valeStatus').value = 'pendente';
    document.getElementById('valeStatus').disabled = !(currentUser.tipo === 'sindico' || currentUser.tipo === 'subsindico');
    document.getElementById('valeModal').style.display = 'flex';
}

function closeValeModal() {
    document.getElementById('valeModal').style.display = 'none';
}
document.getElementById('valeForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    if (!currentCondominio) {
        alert('Selecione um condomínio primeiro!');
        return;
    }

    const editingId = document.getElementById('editingValeId').value;
    const valor = parseFloat(document.getElementById('valeValor').value);
    const motivo = document.getElementById('valeMotivo').value.trim();
    const status = document.getElementById('valeStatus').value;

    if (isNaN(valor) || valor <= 0) {
        alert('Valor inválido.');
        return;
    }

    const valeData = {
        solicitanteId: currentUser.id,
        solicitanteNome: currentUser.nome || currentUser.usuario,
        solicitanteTipo: currentUser.tipo,
        valor: valor,
        motivo: motivo,
        status: status,
        condominioId: currentCondominio.id,
        condominioNome: currentCondominio.nome,
        dataCriacao: new Date().toISOString()
    };

    // Se for edição por síndico, preserva o solicitante original
    if (editingId) {
        const valeExistente = vales.find(v => v.id === editingId);
        if (valeExistente) {
            valeData.solicitanteId = valeExistente.solicitanteId;
            valeData.solicitanteNome = valeExistente.solicitanteNome;
            valeData.solicitanteTipo = valeExistente.solicitanteTipo;
        }
    }

    try {
        if (editingId) {
            await db.collection('vales').doc(editingId).update(valeData);
        } else {
            await db.collection('vales').add(valeData);
        }
        await loadSystemData();
        closeValeModal();
        if (currentModule === 'vales') {
            loadValesContent();
        }
        alert(editingId ? 'Vale atualizado com sucesso!' : 'Solicitação enviada com sucesso!');
    } catch (error) {
        console.error('Erro ao salvar vale:', error);
        alert('Erro ao salvar vale. Tente novamente.');
    }
});
function editVale(id) {
    if (!podeExcluirRegistros()) { // usa sua função existente (síndico/subsíndico)
        alert('Somente síndico ou subsíndico podem editar vales.');
        return;
    }
    const vale = vales.find(v => v.id === id);
    if (!vale) return;

    document.getElementById('valeModalTitle').textContent = 'Editar Vale';
    document.getElementById('editingValeId').value = vale.id;
    document.getElementById('valeValor').value = vale.valor;
    document.getElementById('valeMotivo').value = vale.motivo || '';
    document.getElementById('valeStatus').value = vale.status;
    document.getElementById('valeStatus').disabled = false;
    document.getElementById('valeModal').style.display = 'flex';
}
async function deleteVale(id) {
    if (!podeExcluirRegistros()) {
        alert('Somente síndico ou subsíndico podem excluir registros.');
        return;
    }
    if (!confirm('Tem certeza que deseja excluir este vale?')) return;
    try {
        await db.collection('vales').doc(id).delete();
        await loadSystemData();
        if (currentModule === 'vales') {
            loadValesContent();
        }
        alert('Vale excluído com sucesso!');
    } catch (error) {
        console.error('Erro ao excluir vale:', error);
        alert('Erro ao excluir vale. Tente novamente.');
    }
}
async function marcarValeComoPago(id) {
    if (!podeExcluirRegistros()) {
        alert('Somente síndico ou subsíndico podem marcar como pago.');
        return;
    }
    try {
        await db.collection('vales').doc(id).update({
            status: 'pago',
            dataPagamento: new Date().toISOString()
        });
        await loadSystemData();
        if (currentModule === 'vales') {
            loadValesContent();
        }
        alert('Vale marcado como pago com sucesso!');
    } catch (error) {
        console.error('Erro ao marcar como pago:', error);
        alert('Erro ao atualizar status do vale.');
    }
}
function formatStatusVale(status) {
    const map = {
        'pendente': 'Pendente',
        'aprovado': 'Aprovado',
        'rejeitado': 'Rejeitado',
        'pago': 'Pago'
    };
    return map[status] || status;
}
     function loadValesContent() {
    const moduleContent = document.getElementById('moduleContent');
    
    // Verifica permissão
    if (currentUser.permissoes &&
        !currentUser.permissoes.includes('*') &&
        !currentUser.permissoes.includes('vales')) {
        moduleContent.innerHTML = `
            <div class="alert alert-warning">
                <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
            </div>
        `;
        return;
    }

    if (!currentCondominio) {
        moduleContent.innerHTML = `
            <div class="alert alert-warning">
                <strong>Selecione um condomínio</strong> para acessar o módulo de Vales.
            </div>
        `;
        return;
    }

    // Filtra vales: síndico/sub vê todos; outros só os próprios
    let filteredVales = vales.filter(v => v.condominioId === currentCondominio.id);
    if (currentUser.tipo !== 'sindico' && currentUser.tipo !== 'subsindico') {
        filteredVales = filteredVales.filter(v => v.solicitanteId === currentUser.id);
    }

    // Estatísticas
    const total = filteredVales.length;
    const pendentes = filteredVales.filter(v => v.status === 'pendente').length;
    const pagos = filteredVales.filter(v => v.status === 'pago').length;
    const valorTotal = filteredVales.reduce((sum, v) => sum + v.valor, 0);
    const valorPago = filteredVales.filter(v => v.status === 'pago').reduce((sum, v) => sum + v.valor, 0);

    moduleContent.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h3>Vales - ${currentCondominio.nome}</h3>
                <div>
                    ${currentUser.tipo !== 'sindico' && currentUser.tipo !== 'subsindico' 
                        ? `<button class="btn btn-primary" onclick="openValeModal()">
                            <i class="fas fa-plus"></i> Solicitar Vale
                          </button>`
                        : `<button class="btn btn-primary" onclick="openValeModal()">
                            <i class="fas fa-plus"></i> Novo Vale (Admin)
                          </button>`
                    }
                </div>
            </div>
            <div class="card-body">
                <!-- Estatísticas -->
                <div class="stats-container">
                    <div class="stat-card-modern">
                        <div class="stat-card-header"><h3>Total de Vales</h3></div>
                        <div class="stat-card-content">
                            <div class="stat-value">${total}</div>
                            <div class="stat-label">Solicitações</div>
                        </div>
                    </div>
                    <div class="stat-card-modern" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                        <div class="stat-card-header"><h3>Pendentes</h3></div>
                        <div class="stat-card-content">
                            <div class="stat-value">${pendentes}</div>
                            <div class="stat-label">Aguardando análise</div>
                        </div>
                    </div>
                    <div class="stat-card-modern" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);">
                        <div class="stat-card-header"><h3>Pagos</h3></div>
                        <div class="stat-card-content">
                            <div class="stat-value">${pagos}</div>
                            <div class="stat-label">Vales liberados</div>
                        </div>
                    </div>
                    <div class="stat-card-modern" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                        <div class="stat-card-header"><h3>Valor Total</h3></div>
                        <div class="stat-card-content">
                            <div class="stat-value">R$ ${valorTotal.toFixed(2).replace('.', ',')}</div>
                            <div class="stat-label">Solicitado</div>
                        </div>
                    </div>
                </div>

                <!-- Tabela -->
                <table class="table" id="valesTable">
                    <thead>
                        <tr>
                            <th>Solicitante</th>
                            <th>Valor</th>
                            <th>Motivo</th>
                            <th>Data</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredVales.length > 0 
                            ? filteredVales.map(vale => `
                                <tr>
                                    <td>
                                        ${vale.solicitanteNome} 
                                        ${currentUser.tipo === 'sindico' || currentUser.tipo === 'subsindico' 
                                            ? `<br><small>${formatUserType(vale.solicitanteTipo)}</small>` 
                                            : ''}
                                    </td>
                                    <td>R$ ${vale.valor.toFixed(2).replace('.', ',')}</td>
                                    <td>${vale.motivo || '—'}</td>
                                    <td>${new Date(vale.dataCriacao).toLocaleDateString('pt-BR')}</td>
                                    <td>
                                        <span class="status-badge status-${vale.status}">
                                            ${formatStatusVale(vale.status)}
                                        </span>
                                    </td>
                                    <td>
                                        ${currentUser.tipo === 'sindico' || currentUser.tipo === 'subsindico' 
                                            ? `
                                                <button class="btn btn-sm btn-info" onclick="editVale('${vale.id}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                ${vale.status !== 'pago' ? `
                                                <button class="btn btn-sm btn-success" onclick="marcarValeComoPago('${vale.id}')">
                                                    <i class="fas fa-money-bill"></i> Pagar
                                                </button>` : ''}
                                                <button class="btn btn-sm btn-danger" onclick="deleteVale('${vale.id}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            `
                                            : `
                                                ${vale.status === 'pendente' 
                                                    ? `<span class="badge badge-warning">Aguardando aprovação</span>`
                                                    : `<span class="badge badge-success">Concluído</span>`
                                                }
                                            `
                                        }
                                    </td>
                                </tr>
                            `).join('')
                            : `<tr><td colspan="6" class="text-center">Nenhum vale encontrado.</td></tr>`
                        }
                    </tbody>
                </table>
            </div>
        </div>
    `;
}  
        
    // ========== MÓDULO DASHBOARD (REVISADO E MODERNIZADO) ==========
function loadDashboardContent() {
    const moduleContent = document.getElementById('moduleContent');
    
    // Dados filtrados por condomínio
    const filteredAgendamentos = currentCondominio ? agendamentos.filter(a => a.condominioId === currentCondominio.id) : [];
    const filteredContas = currentCondominio ? contas.filter(c => c.condominioId === currentCondominio.id) : [];
    const filteredCompras = currentCondominio ? compras.filter(c => c.condominioId === currentCondominio.id) : [];
    const filteredMoradores = currentCondominio ? moradores.filter(m => m.condominioId === currentCondominio.id) : [];
    const filteredSaunas = currentCondominio ? saunas.filter(s => s.condominioId === currentCondominio.id) : [];
    const filteredPalavras = currentCondominio ? palavrasChave.filter(p => p.condominioId === currentCondominio.id) : [];
    const filteredTarefas = currentCondominio ? tarefas.filter(t => t.condominioId === currentCondominio.id) : [];

    // ⏰ Hoje e cálculos
    const hoje = new Date();
    const hojeStr = hoje.toISOString().split('T')[0]; // "2025-12-18"
    const hojeSemana = hoje.getDay(); // 0 = dom, 1 = seg ... 6 = sab
    const diasMap = { dom:0, seg:1, ter:2, qua:3, qui:4, sex:5, sab:6 };

    // ✅ Tarefas de HOJE (filtradas e com status de conclusão)
    const tarefasHoje = filteredTarefas.filter(t => {
        if (t.tipo === 'unica') return t.dataUnica === hojeStr;
        if (t.tipo === 'recorrente') return t.diasSemana.some(d => diasMap[d] === hojeSemana);
        return false;
    }).map(t => ({
        ...t,
        jaConcluiuHoje: t.historicoConclusao?.some(h => h.dataReal === hojeStr) || false
    }));

    // ⚠️ Alertas de contas/compras (vencidas ou ≤ 3 dias)
    const alertaContas = filteredContas.filter(c => {
        if (c.status === 'pago') return false;
        const venc = new Date(c.vencimento);
        const diff = Math.ceil((venc - hoje) / (1000 * 60 * 60 * 24));
        return diff <= 3;
    });
    const alertaCompras = filteredCompras.filter(c => {
        if (!c.vencimento || c.status === 'pago') return false;
        const venc = new Date(c.vencimento);
        const diff = Math.ceil((venc - hoje) / (1000 * 60 * 60 * 24));
        return diff <= 3;
    });
    const totalAlertas = alertaContas.length + alertaCompras.length;

    // 🔴 Status dos espaços
    const espacos = [
    { id: 'salao-social', nome: 'Salão Social', icon: 'fas fa-warehouse', cor: '#3498db' },
    { id: 'churrasqueira', nome: 'Churrasqueira', icon: 'fas fa-fire', cor: '#e74c3c' },
    { id: 'quiosque', nome: 'Quiosque', icon: 'fas fa-tree', cor: '#2ecc71' },
    { id: 'pergolado', nome: 'Pergolado', icon: 'fas fa-umbrella', cor: '#9b59b6' }
].map(espaco => {

    // Busca todos os agendamentos ativos (não só de hoje)
    const ags = filteredAgendamentos
        .filter(a =>
            a.espaco === espaco.id &&
            a.status !== 'liberado' &&
            a.status !== 'cancelado'
        )
        .sort((a, b) => {
            const dataA = new Date(a.data + 'T' + a.horaInicio + '-03:00');
            const dataB = new Date(b.data + 'T' + b.horaInicio + '-03:00');
            return dataA - dataB;
        });

    const agora = new Date();
    const hojeStr = agora.toLocaleDateString('sv-SE'); // ex: "2025-12-19"

    // Encontra o PRÓXIMO agendamento futuro
    const proximoFuturo = ags.find(a => {
        const dataHora = new Date(a.data + 'T' + a.horaInicio + '-03:00');
        return dataHora > agora;
    });

    // Verifica se há uso HOJE (para status dinâmico)
    let status = { label: 'Livre', cor: '#27ae60', icone: '🟢' };
    let agendamentoAtivo = null;

    for (const ag of ags) {
        if (ag.data !== hojeStr) continue; // só verifica agendamentos de hoje

        const [hIniH, hIniM] = ag.horaInicio.split(':').map(Number);
        const [hFimH, hFimM] = ag.horaFim.split(':').map(Number);

        const dataLocal = new Date(ag.data + 'T00:00:00-03:00');
        const inicio = new Date(dataLocal);
        inicio.setHours(hIniH, hIniM, 0, 0);
        const fim = new Date(dataLocal);
        fim.setHours(hFimH, hFimM, 0, 0);

        if (agora >= inicio && agora <= fim) {
            status = { label: 'Em uso', cor: '#e74c3c', icone: '🔴' };
            agendamentoAtivo = ag;
            break;
        } else if (agora >= new Date(inicio.getTime() - 60 * 60 * 1000) && agora < inicio) {
            status = { label: 'Preparando', cor: '#f39c12', icone: '🟡' };
            agendamentoAtivo = ag;
            break;
        }
    }

    // Monta o texto que vai aparecer no card
    let detalhes = '';
    if (agendamentoAtivo) {
        detalhes = `${agendamentoAtivo.responsavel} — ${agendamentoAtivo.unidade} — ${agendamentoAtivo.horaInicio}`;
    } else if (proximoFuturo) {
        const data = new Date(proximoFuturo.data + 'T00:00-03:00');
        const dataStr = data.toLocaleDateString('pt-BR'); // ex: "19/12/2025"
        detalhes = `Próximo: ${proximoFuturo.responsavel} — ${proximoFuturo.unidade} — ${dataStr} às ${proximoFuturo.horaInicio}`;
    }

    return {
        ...espaco,
        status,
        agendamentoAtivo,
        totalAgendado: ags.length,
        detalhes // ← esse é o novo campo com o texto
    };
});

    // ♨ Saunas
    const saunaUmida = filteredSaunas.find(s => s.tipo === 'umida' && s.status === 'em-uso');
    const saunaSeca = filteredSaunas.find(s => s.tipo === 'seca' && s.status === 'em-uso');

    // 📊 Estatísticas
    const stats = [
        { label: 'Moradores', valor: filteredMoradores.length, cor: '#9b59b6', icone: 'fas fa-users' },
        { label: 'Agendamentos', valor: filteredAgendamentos.length, cor: '#3498db', icone: 'fas fa-calendar-check' },
        { label: 'Contas em aberto', valor: alertaContas.length, cor: '#e74c3c', icone: 'fas fa-file-invoice-dollar' },
        { label: 'Tarefas do dia', valor: tarefasHoje.length, cor: '#2ecc71', icone: 'fas fa-tasks' }
    ];

    // ✅ Monta HTML
    moduleContent.innerHTML = `
        <div class="dashboard-container">
            <!-- Cabeçalho -->
            <div class="dashboard-header">
                <div>
                    <h1>Dashboard</h1>
                    <p>Bem-vindo, <strong>${currentUser.nome || currentUser.usuario}</strong> • ${currentCondominio ? currentCondominio.nome : 'Selecione um condomínio'}</p>
                </div>
                ${currentCondominio ? `
                <div class="quick-actions">
                    <button class="btn btn-sm btn-primary" onclick="openTarefaModal()">
                        <i class="fas fa-plus"></i> Nova Tarefa
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="changeModule('tarefas')">
                        <i class="fas fa-tasks"></i> Todas as Tarefas
                    </button>
                </div>
                ` : ''}
            </div>

            ${!currentCondominio ? `
                <div class="alert alert-warning dashboard-alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Atenção!</strong> Selecione um condomínio no menu superior para visualizar os dados.
                </div>
            ` : ''}

            <!-- ⚠️ ALERTAS -->
            ${totalAlertas > 0 ? `
            <section class="dashboard-section">
                <div class="section-header">
                    <h2><i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> Alertas Urgentes</h2>
                </div>
                <div class="alert-grid">
                    ${alertaContas.map(c => `
                        <div class="alert-card alert-conta ${new Date(c.vencimento) < hoje ? 'vencida' : ''}">
                            <div class="alert-icon" style="background: #e74c3c20; color: #e74c3c;">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                            <div class="alert-content">
                                <div class="alert-title">${c.descricao}</div>
                                <div class="alert-meta">
                                    <span>Vencimento: <strong>${formatDate(c.vencimento)}</strong></span>
                                    <span>R$ ${c.valor.toFixed(2)}</span>
                                </div>
                                <div class="alert-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${Math.min(100, Math.max(0, 100 - (new Date(c.vencimento) - hoje) / (24*60*60*1000) * 20))}%"></div>
                                    </div>
                                    <span class="days-left">${new Date(c.vencimento) < hoje ? 'VENCIDO' : `${Math.ceil((new Date(c.vencimento) - hoje) / (24*60*60*1000))} dias`}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    ${alertaCompras.map(c => `
                        <div class="alert-card alert-compra ${new Date(c.vencimento) < hoje ? 'vencida' : ''}">
                            <div class="alert-icon" style="background: #3498db20; color: #3498db;">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="alert-content">
                                <div class="alert-title">Compra: ${c.fornecedor}</div>
                                <div class="alert-meta">
                                    <span>${c.vencimento ? `Vencimento: ${formatDate(c.vencimento)}` : 'Sem data'}</span>
                                    <span>R$ ${(c.valorTotal || c.itens.reduce((s,i)=>s+i.quantidade*i.valorUnitario,0)).toFixed(2)}</span>
                                </div>
                                <div class="alert-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${c.vencimento ? Math.min(100, Math.max(0, 100 - (new Date(c.vencimento) - hoje) / (24*60*60*1000) * 20)) : 0}%"></div>
                                    </div>
                                    <span class="days-left">${c.vencimento && new Date(c.vencimento) < hoje ? 'VENCIDO' : c.vencimento ? `${Math.ceil((new Date(c.vencimento) - hoje) / (24*60*60*1000))} dias` : 'Sem data'}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="section-footer">
                    <button class="btn btn-sm btn-danger" onclick="changeModule('contas')">
                        <i class="fas fa-file-invoice-dollar"></i> Gerenciar Contas
                    </button>
                    <button class="btn btn-sm btn-info" onclick="changeModule('compras')">
                        <i class="fas fa-shopping-cart"></i> Gerenciar Compras
                    </button>
                </div>
            </section>
            ` : ''}

          <!-- ✅ TAREFAS DO DIA -->
<section class="dashboard-section">
    <div class="section-header">
        <h2><i class="fas fa-tasks" style="color: #2ecc71;"></i> Tarefas de Hoje</h2>
        <span class="badge">${tarefasHoje.length} tarefa${tarefasHoje.length !== 1 ? 's' : ''}</span>
    </div>
    <div class="tasks-grid">
        ${tarefasHoje.length > 0 ? tarefasHoje.map(t => `
            <div class="task-card ${t.jaConcluiuHoje ? 'completed' : ''}">
                <div class="task-header">
                    <h4>${t.titulo}</h4>
                    <div class="task-type-badge ${t.tipo === 'recorrente' ? 'recorrente' : 'unica'}">
                        ${t.tipo === 'recorrente' ? '🔁' : '📅'}
                    </div>
                </div>
                ${t.descricao ? `<p class="task-desc">${t.descricao}</p>` : ''}
                <div class="task-actions">
                    ${t.jaConcluiuHoje ? `
                    <span class="task-status-completed">
                        <i class="fas fa-check-circle"></i> Concluída hoje
                    </span>
                    ` : `
                    <button class="btn btn-success btn-sm" onclick="concluirTarefa('${t.id}')">
                        <i class="fas fa-check"></i> Concluir
                    </button>
                    `}
                    <div class="task-edit-group">
                        <button class="btn btn-outline-secondary btn-sm" onclick="editTarefa('${t.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${podeExcluirRegistros() ? `
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteTarefa('${t.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `).join('') : `
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-check-circle"></i></div>
                <h4>Nenhuma tarefa pendente</h4>
                <p>Todas as tarefas foram concluídas ou não há nenhuma cadastrada para hoje.</p>
                <button class="btn btn-primary" onclick="openTarefaModal()">
                    <i class="fas fa-plus"></i> Criar Tarefa
                </button>
            </div>
        `}
    </div>
</section>
 

<!-- 🎯 STATUS DOS ESPAÇOS -->
<section class="dashboard-section">
    <div class="section-header">
        <h2><i class="fas fa-map-marker-alt" style="color: #3498db;"></i> Espaços Comuns</h2>
    </div>
    <div class="spaces-grid">
        ${espacos.map(e => `
            <div class="space-card" 
                 onclick="changeModule('agendamentos')" 
                 style="--space-color: ${e.status.cor}">
                <div class="space-icon">
                    <i class="${e.icon}"></i>
                </div>
                <div class="space-info">
                    <div class="space-name">${e.nome}</div>
                    <div class="space-status">
                        <span class="status-dot" style="background: ${e.status.cor};"></span>
                        <span class="status-label">${e.status.icone} ${e.status.label}</span>
                    </div>
                </div>
                ${e.detalhes ? `
                <div class="space-user">
                    <div><strong>${(e.detalhes.split('—')[0] || '').trim() || '—'}</strong></div>
                    <div class="space-time">
                        ${(e.detalhes.split('—').slice(1).join('—') || '').trim()}
                    </div>
                </div>
                ` : `
                <div class="space-user">
                    <div class="space-time" style="color: #95a5a6; font-style: italic;">
                        Nenhum agendamento
                    </div>
                </div>
                `}
            </div>
        `).join('')}
    </div>
    <div class="section-footer">
        <button class="btn btn-sm btn-primary" onclick="changeModule('agendamentos')">
            <i class="fas fa-calendar-check"></i> Gerenciar Agendamentos
        </button>
    </div>
</section>

<!-- ♨ SAUNAS -->
${(currentUser.permissoes?.includes('*') || currentUser.permissoes?.includes('sauna')) ? `
<section class="dashboard-section">
    <div class="section-header">
        <h2><i class="fas fa-hot-tub" style="color: #e74c3c;"></i> Saunas</h2>
    </div>
    <div class="saunas-grid">
        <div class="sauna-card ${saunaUmida ? 'in-use' : 'available'}" onclick="changeModule('sauna')">
            <div class="sauna-icon"><i class="fas fa-tint"></i></div>
            <div class="sauna-info">
                <div class="sauna-name">Sauna Úmida</div>
                <div class="sauna-status">
                    <span class="status-dot" style="background: ${saunaUmida ? '#e74c3c' : '#27ae60'};"></span>
                    <span>${saunaUmida ? '🔴 Em uso' : '🟢 Disponível'}</span>
                </div>
            </div>
            ${saunaUmida ? `
            <div class="sauna-user">
                <div><strong>${saunaUmida.morador || '—'}</strong></div>
                <div class="sauna-time">${saunaUmida.horaInicio || ''}</div>
            </div>
            ` : ''}
        </div>
        <div class="sauna-card ${saunaSeca ? 'in-use' : 'available'}" onclick="changeModule('sauna')">
            <div class="sauna-icon"><i class="fas fa-fire"></i></div>
            <div class="sauna-info">
                <div class="sauna-name">Sauna Seca</div>
                <div class="sauna-status">
                    <span class="status-dot" style="background: ${saunaSeca ? '#e74c3c' : '#27ae60'};"></span>
                    <span>${saunaSeca ? '🔴 Em uso' : '🟢 Disponível'}</span>
                </div>
            </div>
            ${saunaSeca ? `
            <div class="sauna-user">
                <div><strong>${saunaSeca.morador || '—'}</strong></div>
                <div class="sauna-time">${saunaSeca.horaInicio || ''}</div>
            </div>
            ` : ''}
        </div>
    </div>
</section>
` : ''}
            <!-- 🏊 PISCINA + AQUECEDOR -->
            ${currentCondominio ? `
            <section class="dashboard-section">
                <div class="section-header">
                    <h2><i class="fas fa-swimmer" style="color: #3498db;"></i> Piscina & Aquecedor</h2>
                </div>
                <div class="pool-grid">
                    <div class="pool-card ${currentCondominio.statusPiscina ? 'on' : 'off'}" onclick="togglePiscina()">
                        <div class="pool-icon"><i class="fas fa-swimmer"></i></div>
                        <div class="pool-info">
                            <div class="pool-name">Piscina</div>
                            <div class="pool-status">
                                <span class="status-dot" style="background: ${currentCondominio.statusPiscina ? '#2ecc71' : '#e74c3c'};"></span>
                                <span>${currentCondominio.statusPiscina ? '🟢 Ligada' : '🔴 Desligada'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="pool-card ${currentCondominio.statusAquecedor ? 'on' : 'off'}" onclick="toggleAquecedor()">
                        <div class="pool-icon"><i class="fas fa-fire"></i></div>
                        <div class="pool-info">
                            <div class="pool-name">Aquecedor</div>
                            <div class="pool-status">
                                <span class="status-dot" style="background: ${currentCondominio.statusAquecedor ? '#e67e22' : '#95a5a6'};"></span>
                                <span>${currentCondominio.statusAquecedor ? '🔥 Ligado' : '❄️ Desligado'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            ` : ''}

            <!-- 🏷️ PALAVRAS-CHAVE -->
            ${currentCondominio ? `
            <section class="dashboard-section">
                <div class="section-header">
                    <h2><i class="fas fa-tags" style="color: #f39c12;"></i> Palavras-chave (Mercado Livre)</h2>
                    <span class="badge">${filteredPalavras.length}</span>
                </div>
                <div class="tags-grid">
                    ${filteredPalavras.slice(0, 4).map(p => `
                        <div class="tag-card" onclick="editPalavraChave('${p.id}')">
                            <div class="tag-header">
                                <div class="tag-morador">${p.moradorNome} • Apto ${p.moradorApto}</div>
                            </div>
                            <div class="tag-words">
                                ${p.palavrasChave.slice(0, 2).map(w => `<span>${w}</span>`).join('')}
                                ${p.palavrasChave.length > 2 ? `<span>+${p.palavrasChave.length - 2}</span>` : ''}
                            </div>
                        </div>
                    `).join('')}
                    ${filteredPalavras.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-icon"><i class="fas fa-tags"></i></div>
                            <p>Nenhuma palavra-chave cadastrada</p>
                            <button class="btn btn-outline-primary" onclick="openPalavraChaveModal()">
                                <i class="fas fa-plus"></i> Adicionar
                            </button>
                        </div>
                    ` : ''}
                </div>
                ${filteredPalavras.length > 4 ? `
                <div class="section-footer">
                    <button class="btn btn-sm btn-primary" onclick="changeModule('palavras-chave')">
                        Ver todas (${filteredPalavras.length})
                    </button>
                </div>
                ` : ''}
            </section>
            ` : ''}

            <!-- 📊 ESTATÍSTICAS -->
            <section class="dashboard-section">
                <div class="section-header">
                    <h2><i class="fas fa-chart-bar" style="color: #9b59b6;"></i> Visão Geral</h2>
                </div>
                <div class="stats-grid">
                    ${stats.map(s => `
                        <div class="stat-card" style="--stat-color: ${s.cor}">
                            <div class="stat-icon"><i class="${s.icone}"></i></div>
                            <div class="stat-value">${s.valor}</div>
                            <div class="stat-label">${s.label}</div>
                        </div>
                    `).join('')}
                </div>
            </section>
        </div>

        <!-- CSS INLINE MODERNO -->
        <style>
        .dashboard-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .dashboard-header h1 {
            margin: 0;
            font-weight: 700;
            color: #2c3e50;
        }
        .dashboard-header p {
            margin: 4px 0 0;
            color: #7f8c8d;
            font-size: 1rem;
        }
        .quick-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .dashboard-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 24px;
            overflow: hidden;
        }
        .section-header {
            padding: 20px 24px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }
        .section-header h2 {
            margin: 0;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.3rem;
        }
        .badge {
            background: #3498db;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .section-footer {
            padding: 16px 24px;
            background: #f8f9fa;
            text-align: right;
            border-top: 1px solid #eee;
        }

        /* ⚠️ ALERTAS */
        .alert-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        .alert-card {
            display: flex;
            gap: 16px;
            padding: 16px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #3498db;
            transition: all 0.2s;
        }
        .alert-card.alert-conta { border-left-color: #e74c3c; }
        .alert-card.alert-compra { border-left-color: #3498db; }
        .alert-card.vencida {
            border-left-color: #e74c3c !important;
            background: #fff5f5;
        }
        .alert-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
        }
        .alert-content { flex: 1; }
        .alert-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #2c3e50;
        }
        .alert-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 12px;
        }
        .alert-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .progress-bar {
            flex: 1;
            height: 6px;
            background: #ecf0f1;
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            border-radius: 3px;
            transition: width 0.5s;
        }
        .alert-card.alert-conta .progress-fill { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .alert-card.vencida .progress-fill { background: #e74c3c; }
        .days-left {
            font-weight: 600;
            font-size: 0.85rem;
            color: #e74c3c;
        }

        /* ✅ TAREFAS */
        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        .task-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.06);
            border-left: 4px solid #2ecc71;
            transition: all 0.3s;
        }
        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .task-card.completed {
            opacity: 0.85;
            border-left-color: #95a5a6;
            background: #f8f9fa;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .task-header h4 {
            margin: 0;
            color: #2c3e50;
            font-weight: 600;
        }
        .task-type-badge {
            background: #ecf0f1;
            color: #7f8c8d;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .task-type-badge.recorrente { background: #e3f2fd; color: #1976d2; }
        .task-type-badge.unica { background: #fff3e0; color: #e65100; }
        .task-desc {
            color: #7f8c8d;
            font-size: 0.95rem;
            margin: 0 0 16px;
            line-height: 1.5;
        }
        .task-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-status-completed {
            color: #27ae60;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .task-edit-group {
            display: flex;
            gap: 6px;
        }

        /* 🎯 ESPAÇOS */
        .spaces-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        .space-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border-top: 4px solid var(--space-color);
        }
        .space-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        .space-icon {
            font-size: 2rem;
            margin-bottom: 12px;
            color: var(--space-color);
        }
        .space-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: #2c3e50;
        }
        .space-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .space-user {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #eee;
            font-size: 0.85rem;
            color: #2c3e50;
        }
        .space-time {
            color: #7f8c8d;
            font-size: 0.8rem;
        }

        /* ♨ SAUNAS */
        .saunas-grid, .pool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        .sauna-card, .pool-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        .sauna-card.in-use, .pool-card.on {
            border-left: 4px solid #e74c3c;
        }
        .sauna-card.available, .pool-card.off {
            border-left: 4px solid #27ae60;
        }
        .sauna-card:hover, .pool-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        .sauna-icon, .pool-icon {
            font-size: 2rem;
            margin-bottom: 12px;
        }
        .sauna-name, .pool-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: #2c3e50;
        }
        .sauna-status, .pool-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        .sauna-user {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #eee;
            font-size: 0.85rem;
            color: #2c3e50;
        }

        /* 🏷️ TAGS */
        .tags-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        .tag-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 4px solid #f39c12;
        }
        .tag-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .tag-header {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .tag-words {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .tag-words span {
            background: #fef9e7;
            color: #b7950b;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* 📊 STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border-top: 4px solid var(--stat-color);
        }
        .stat-icon {
            font-size: 2rem;
            color: var(--stat-color);
            margin-bottom: 12px;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 0.95rem;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            color: #bdc3c7;
        }
        .empty-state h4 {
            color: #2c3e50;
            margin: 0 0 12px;
        }

        /* RESPONSIVO */
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                align-items: stretch;
            }
            .quick-actions {
                justify-content: center;
            }
            .alert-grid, .tasks-grid, .spaces-grid, .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        </style>
    `;

    // ✅ Garante atualização das tarefas (se mudar condomínio, etc.)
    atualizarTarefasDashboard();
}
        // ========== MÓDULO USUÁRIOS ==========
        function loadUsuariosContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes &&
                !currentUser.permissoes.includes('*') &&
                !currentUser.permissoes.includes('usuarios')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Gerenciar Usuários</h3>
                        <button class="btn btn-primary" onclick="openUserModal()">
                            <i class="fas fa-plus"></i> Novo Usuário
                        </button>
                    </div>
                    <div class="card-body">
                        ${usuarios.length > 0 ? `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Usuário</th>
                                    <th>Tipo</th>
                                    <th>E-mail</th>
                                    <th>Condomínios</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${usuarios.map(usuario => `
                                    <tr>
                                        <td>${usuario.nome}</td>
                                        <td>${usuario.usuario}</td>
                                        <td>${formatUserType(usuario.tipo)}</td>
                                        <td>${usuario.email || 'N/A'}</td>
                                        <td>${usuario.condominios ? usuario.condominios.length : 0}</td>
                                        <td>
                                            <span class="badge ${usuario.status === 'ativo' ? 'badge-success' : 'badge-danger'}">
                                                ${usuario.status === 'ativo' ? 'Ativo' : 'Inativo'}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editUser('${usuario.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            ${podeExcluirRegistros() ? `
                                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${usuario.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ` : '<p>Nenhum usuário cadastrado.</p>'}
                    </div>
                </div>
            `;
        }
        // ========== MÓDULO MORADORES ==========
        function loadMoradoresContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes &&
                !currentUser.permissoes.includes('*') &&
                !currentUser.permissoes.includes('moradores')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Selecione um condomínio</strong> para acessar o módulo de moradores.
                    </div>
                `;
                return;
            }
            const filteredMoradores = moradores.filter(m => m.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Moradores - ${currentCondominio.nome}</h3>
                        <button class="btn btn-primary" onclick="openMoradorModal()">
                            <i class="fas fa-plus"></i> Novo Morador
                        </button>
                    </div>
                    <div class="card-body">
                        ${filteredMoradores.length > 0 ? `
                        <table class="table" id="moradoresTable">
                            <thead>
                                <tr>
                                    <th style="cursor: pointer;" onclick="sortMoradores('nome')">
                                        Morador <i class="fas fa-sort"></i>
                                    </th>
                                    <th style="cursor: pointer;" onclick="sortMoradores('apto')">
                                        Apartamento <i class="fas fa-sort"></i>
                                    </th>
                                    <th>Telefone</th>
                                    <th>Garagem</th>
                                    <th>Vaga</th>
                                    <th>Placa</th>  
                                    <th>Observações</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="moradoresTbody">
                            </tbody>
                        </table>
                        ` : '<p>Nenhum morador cadastrado para este condomínio.</p>'}
                    </div>
                </div>
            `;
            if (filteredMoradores.length > 0) {
                const sortedMoradores = filteredMoradores.sort((a, b) => {
                    const numA = extractNumberFromApto(a.apto);
                    const numB = extractNumberFromApto(b.apto);
                    return numA - numB;
                });
                loadMoradoresTableData(sortedMoradores);
                setTimeout(() => updateSortIcons('apto'), 100);
            }
        }
        // ========== MÓDULO AGENDAMENTOS ==========
        function loadAgendamentosContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes &&
                !currentUser.permissoes.includes('*') &&
                !currentUser.permissoes.includes('agendamentos')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Selecione um condomínio</strong> para acessar o módulo de agendamentos.
                    </div>
                `;
                return;
            }
            const filteredAgendamentos = agendamentos.filter(a => a.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="agendamentos-header">
                    <div class="agendamentos-title">Agendamentos - ${currentCondominio.nome}</div>
                    <div class="calendar-controls">
                        <button class="btn btn-primary" onclick="openAgendamentoModal()">
                            <i class="fas fa-plus"></i> Novo Agendamento
                        <button class="btn btn-outline-info" onclick="openAgendamentosConcluidosModal()">
            <i class="fas fa-history"></i> Ver Concluídos (18 meses)
                        </button>
                    </div>
                </div>
                <div class="menu-agendamentos">
                    <h3>Filtros de Agendamento</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Espaço</label>
                            <select id="filtroEspaco" class="form-control" onchange="filterAgendamentos()">
                                <option value="">Todos os espaços</option>
                                <option value="salao-social">Salão Social</option>
                                <option value="churrasqueira">Churrasqueira</option>
                                <option value="quiosque">Quiosque</option>
                                <option value="pergolado">Pergolado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="filtroStatus" class="form-control" onchange="filterAgendamentos()">
                                <option value="">Todos os status</option>
                                <option value="agendado">Agendado</option>
                                <option value="em-uso">Em Uso</option>
                                <option value="liberado">Liberado</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" id="filtroData" class="form-control" onchange="filterAgendamentos()">
                        </div>
                    </div>
                </div>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button class="btn" onclick="changeCalendarMonth(-1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="calendar-title" id="calendarTitle">${getMonthName(currentCalendarMonth)} ${currentCalendarYear}</div>
                            <button class="btn" onclick="changeCalendarMonth(1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="calendar-view-options">
                            <button class="btn active" onclick="changeCalendarView('month')">Mês</button>
                            <button class="btn" onclick="changeCalendarView('week')">Semana</button>
                            <button class="btn" onclick="changeCalendarView('day')">Dia</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                    </div>
                    <div class="calendar-legends">
    <div class="legend-item">
        <div class="legend-color" style="background-color: #e3f2fd; border: 1px solid #2196f3;"></div>
        <span>Com agendamento</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #ffebee; border: 1px solid #f44336;"></div>
        <span>Feriado Nacional</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #fff3e0; border: 1px solid #ff9800;"></div>
        <span>Feriado Jaraguá do Sul</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #ffffff; border: 1px solid #e0e0e0;"></div>
        <span>Dia normal</span>
    </div>
</div>
                <div class="card">
                    <div class="card-header">
                        <h4>Lista de Agendamentos - ${currentCondominio.nome}</h4>
                    </div>
                    <div class="card-body">
                        <table class="table" id="agendamentosTable">
                            <thead>
                                <tr>
                                    <th>Espaço</th>
                                    <th>Solicitante</th>
                                    <th>Data</th>
                                    <th>Horário</th>
                                    <th>Unidade</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            generateCalendar(currentCalendarMonth, currentCalendarYear);
            loadAgendamentosList();
        }
        // ========== FUNÇÕES PARA AGENDAMENTOS CONCLUÍDOS ==========

function openAgendamentosConcluidosModal() {
    document.getElementById('agendamentosConcluidosModal').style.display = 'flex';
    loadAgendamentosConcluidos();
}

function closeAgendamentosConcluidosModal() {
    document.getElementById('agendamentosConcluidosModal').style.display = 'none';
}

function loadAgendamentosConcluidos() {
    const tbody = document.getElementById('agendamentosConcluidosTbody');
    if (!tbody) return;

    const dataLimite = new Date();
    dataLimite.setMonth(dataLimite.getMonth() - 18);

    const agendamentosConcluidos = agendamentos.filter(a => 
        a.condominioId === currentCondominio.id &&
        (a.status === 'liberado' || a.status === 'concluido' || a.status === 'cancelado') &&
        new Date(a.data) >= dataLimite
    ).sort((a, b) => new Date(b.data) - new Date(a.data));

    if (agendamentosConcluidos.length > 0) {
        tbody.innerHTML = agendamentosConcluidos.map(a => `
            <tr>
                <td>${getEspacoNome(a.espaco)}</td>
                <td>${a.responsavel}</td>
                <td>${formatDate(a.data)}</td>
                <td>${a.horaInicio} - ${a.horaFim}</td>
                <td>${a.unidade}</td>
                <td><span class="status-badge status-${a.status}">${formatStatusAgendamento(a.status)}</span></td>
                <td>
    <button class="btn btn-sm btn-info" onclick="verDetalhesAgendamento('${a.id}')">
        <i class="fas fa-eye"></i> Ver
    </button>
    ${podeExcluirRegistros() ? `
    <button class="btn btn-sm btn-warning" onclick="editAgendamento('${a.id}')">
        <i class="fas fa-edit"></i> Editar
    </button>` : ''}
</td>
            </tr>
        `).join('');
    } else {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum agendamento encontrado nos últimos 18 meses.</td></tr>';
    }
}

function filterAgendamentosConcluidos() {
    const tbody = document.getElementById('agendamentosConcluidosTbody');
    if (!tbody) return;

    const dataLimite = new Date();
    dataLimite.setMonth(dataLimite.getMonth() - 18);

    let filtered = agendamentos.filter(a =>
        a.condominioId === currentCondominio.id &&
        (a.status === 'liberado' || a.status === 'concluido' || a.status === 'cancelado') &&
        new Date(a.data) >= dataLimite
    );

    const espaco = document.getElementById('filtroConcluidosEspaco')?.value || '';
    const dataIni = document.getElementById('filtroConcluidosDataIni')?.value || '';
    const dataFim = document.getElementById('filtroConcluidosDataFim')?.value || '';
    const nome = (document.getElementById('filtroConcluidosNome')?.value || '').toLowerCase();
    const apto = (document.getElementById('filtroConcluidosApto')?.value || '').toLowerCase();

    if (espaco) filtered = filtered.filter(a => a.espaco === espaco);
    if (dataIni) filtered = filtered.filter(a => a.data >= dataIni);
    if (dataFim) filtered = filtered.filter(a => a.data <= dataFim);
    if (nome) filtered = filtered.filter(a => a.responsavel.toLowerCase().includes(nome));
    if (apto) filtered = filtered.filter(a => a.unidade.toLowerCase().includes(apto));

    filtered.sort((a, b) => new Date(b.data) - new Date(a.data));

    if (filtered.length > 0) {
        tbody.innerHTML = filtered.map(a => `
            <tr>
                <td>${getEspacoNome(a.espaco)}</td>
                <td>${a.responsavel}</td>
                <td>${formatDate(a.data)}</td>
                <td>${a.horaInicio} - ${a.horaFim}</td>
                <td>${a.unidade}</td>
                <td><span class="status-badge status-${a.status}">${formatStatusAgendamento(a.status)}</span></td>
                <td>
    <button class="btn btn-sm btn-info" onclick="verDetalhesAgendamento('${a.id}')">
        <i class="fas fa-eye"></i> Ver
    </button>
    ${podeExcluirRegistros() ? `
    <button class="btn btn-sm btn-warning" onclick="editAgendamento('${a.id}')">
        <i class="fas fa-edit"></i> Editar
    </button>` : ''}
</td>
            </tr>
        `).join('');
    } else {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum agendamento encontrado com os filtros aplicados.</td></tr>';
    }
}// ========== MÓDULO LIMPEZA ==========
        function loadLimpezaContent() {
    const moduleContent = document.getElementById('moduleContent');
    if (currentUser.permissoes &&
        !currentUser.permissoes.includes('*') &&
        !currentUser.permissoes.includes('limpeza')) {
        moduleContent.innerHTML = `
            <div class="alert alert-warning">
                <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
            </div>
        `;
        return;
    }
    if (!currentCondominio) {
        moduleContent.innerHTML = `
            <div class="alert alert-warning">
                <strong>Selecione um condomínio</strong> para acessar o módulo de limpeza.
            </div>
        `;
        return;
    }

    // ✅ Filtra apenas limpezas do condomínio atual
    const filteredLimpezas = limpezas.filter(l => l.condominioId === currentCondominio.id);

    // ✅ Data atual (para filtrar mês atual)
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();

    // ✅ Limpezas do mês atual
    const limpezasMesAtual = filteredLimpezas.filter(l => {
        const dataLimpeza = new Date(l.data);
        return dataLimpeza.getMonth() === mesAtual && dataLimpeza.getFullYear() === anoAtual;
    });

    // ✅ Ordena: mais recente primeiro
    limpezasMesAtual.sort((a, b) => new Date(b.data + 'T' + (b.horaInicio || '00:00')) - new Date(a.data + 'T' + (a.horaInicio || '00:00')));

    moduleContent.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h3>Registros de Limpeza - ${currentCondominio.nome}</h3>
                <div>
                    <button class="btn btn-primary" onclick="openLimpezaModal()">
                        <i class="fas fa-plus"></i> Novo Registro
                    </button>
                    <button class="btn btn-outline-info" style="margin-left: 8px;" onclick="openLimpezasConcluidasModal()">
                        <i class="fas fa-history"></i> Ver últimos 18 meses
                    </button>
                    <button class="btn btn-success" style="margin-left: 8px;" onclick="exportarLimpezasPDF()">
                        <i class="fas fa-file-pdf"></i> Exportar PDF (mês atual)
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Filtros -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Filtrar por Espaço</label>
                        <select class="form-control" id="filtroEspacoLimpeza" onchange="filterLimpezas()">
                            <option value="">Todos os espaços</option>
                            <option value="salao-social">Salão Social</option>
                            <option value="churrasqueira">Churrasqueira</option>
                            <option value="quiosque">Quiosque</option>
                            <option value="pergolado">Pergolado</option>
                            <option value="sauna">Sauna</option>
                            <option value="area-comum">Área Comum</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Filtrar por Data</label>
                        <input type="date" class="form-control" id="filtroDataLimpeza" onchange="filterLimpezas()">
                    </div>
                </div>

                <h5 style="margin: 15px 0;">Limpezas do mês atual (${getMonthName(mesAtual)} ${anoAtual})</h5>
                <table class="table" id="limpezasTable">
                    <thead>
                        <tr>
                            <th>Responsável</th>
                            <th>Espaço</th>
                            <th>Data</th>
                            <th>Horário</th>
                            <th>Tempo (min)</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${limpezasMesAtual.length > 0 
                            ? limpezasMesAtual.map(limpeza => `
                                <tr>
                                    <td>${limpeza.responsavel}</td>
                                    <td>${getEspacoNome(limpeza.espaco)}</td>
                                    <td>${formatDate(limpeza.data)}</td>
                                    <td>${limpeza.horaInicio} ${limpeza.horaFim ? ' - ' + limpeza.horaFim : ''}</td>
                                    <td>${limpeza.tempoUso || '-'}</td>
                                    <td>
                                        <span class="badge ${limpeza.status === 'concluido' ? 'badge-success' : 'badge-warning'}">
                                            ${limpeza.status === 'concluido' ? 'Concluído' : 'Em Andamento'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-info" onclick="editLimpeza('${limpeza.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        ${limpeza.status !== 'concluido' ? `
                                        <button class="btn btn-sm btn-success" onclick="concluirLimpeza('${limpeza.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        ` : ''}
                                        ${podeExcluirRegistros() ? `
                                        <button class="btn btn-sm btn-danger" onclick="deleteLimpeza('${limpeza.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>` : ''}
                                    </td>
                                </tr>
                            `).join('')
                            : '<tr><td colspan="7" class="text-center">Nenhuma limpeza registrada neste mês.</td></tr>'
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal para ver últimos 18 meses -->
        <div id="limpezasConcluidasModal" class="modal">
            <div class="modal-content" style="max-width: 95%; max-height: 90vh;">
                <div class="modal-header">
                    <h3>Limpezas dos Últimos 18 Meses - ${currentCondominio.nome}</h3>
                    <button type="button" onclick="closeLimpezasConcluidasModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Espaço</label>
                            <select id="filtroConcluidosEspacoLimpeza" class="form-control" onchange="filterLimpezasConcluidas()">
                                <option value="">Todos</option>
                                <option value="salao-social">Salão Social</option>
                                <option value="churrasqueira">Churrasqueira</option>
                                <option value="quiosque">Quiosque</option>
                                <option value="pergolado">Pergolado</option>
                                <option value="sauna">Sauna</option>
                                <option value="area-comum">Área Comum</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>De</label>
                            <input type="date" id="filtroConcluidosDataIniLimpeza" class="form-control" onchange="filterLimpezasConcluidas()">
                        </div>
                        <div class="form-group">
                            <label>Até</label>
                            <input type="date" id="filtroConcluidosDataFimLimpeza" class="form-control" onchange="filterLimpezasConcluidas()">
                        </div>
                        <div class="form-group">
                            <label>Responsável</label>
                            <input type="text" id="filtroConcluidosResponsavel" class="form-control" placeholder="Ex: João" onkeyup="filterLimpezasConcluidas()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <button class="btn btn-success" onclick="exportarLimpezasConcluidasPDF()">
                                <i class="fas fa-file-pdf"></i> Exportar PDF Completo
                            </button>
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Responsável</th>
                                <th>Espaço</th>
                                <th>Data</th>
                                <th>Horário</th>
                                <th>Tempo</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="limpezasConcluidasTbody">
                            <!-- Carregado por JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeLimpezasConcluidasModal()">Fechar</button>
                </div>
            </div>
        </div>
    `;

    // ✅ Carrega os últimos 18 meses no modal (só quando necessário)
    setTimeout(() => {
        loadLimpezasConcluidas();
    }, 300);
}
           // ✅ Abre o modal de limpezas concluídas (18 meses)
function openLimpezasConcluidasModal() {
    document.getElementById('limpezasConcluidasModal').style.display = 'flex';
    loadLimpezasConcluidas();
}

function closeLimpezasConcluidasModal() {
    document.getElementById('limpezasConcluidasModal').style.display = 'none';
}

// ✅ Carrega todas as limpezas dos últimos 18 meses
function loadLimpezasConcluidas() {
    const tbody = document.getElementById('limpezasConcluidasTbody');
    if (!tbody) return;

    const dataLimite = new Date();
    dataLimite.setMonth(dataLimite.getMonth() - 18);

    const limpezas18Meses = limpezas.filter(l =>
        l.condominioId === currentCondominio.id &&
        new Date(l.data) >= dataLimite
    ).sort((a, b) => new Date(b.data + 'T' + (b.horaInicio || '00:00')) - new Date(a.data + 'T' + (a.horaInicio || '00:00')));

    if (limpezas18Meses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma limpeza encontrada nos últimos 18 meses.</td></tr>';
        return;
    }

    tbody.innerHTML = limpezas18Meses.map(l => `
        <tr>
            <td>${l.responsavel}</td>
            <td>${getEspacoNome(l.espaco)}</td>
            <td>${formatDate(l.data)}</td>
            <td>${l.horaInicio} ${l.horaFim ? ' - ' + l.horaFim : ''}</td>
            <td>${l.tempoUso || '-'}</td>
            <td>
                <span class="badge ${l.status === 'concluido' ? 'badge-success' : 'badge-warning'}">
                    ${l.status === 'concluido' ? 'Concluído' : 'Em Andamento'}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-info" onclick="editLimpeza('${l.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                ${podeExcluirRegistros() ? `
                <button class="btn btn-sm btn-danger" onclick="deleteLimpeza('${l.id}')">
                    <i class="fas fa-trash"></i>
                </button>` : ''}
            </td>
        </tr>
    `).join('');
}

// ✅ Filtro dinâmico dentro do modal (18 meses)
function filterLimpezasConcluidas() {
    const tbody = document.getElementById('limpezasConcluidasTbody');
    if (!tbody) return;

    const dataLimite = new Date();
    dataLimite.setMonth(dataLimite.getMonth() - 18);

    let filtered = limpezas.filter(l =>
        l.condominioId === currentCondominio.id &&
        new Date(l.data) >= dataLimite
    );

    const espaco = document.getElementById('filtroConcluidosEspacoLimpeza')?.value || '';
    const dataIni = document.getElementById('filtroConcluidosDataIniLimpeza')?.value || '';
    const dataFim = document.getElementById('filtroConcluidosDataFimLimpeza')?.value || '';
    const responsavel = (document.getElementById('filtroConcluidosResponsavel')?.value || '').toLowerCase();

    if (espaco) filtered = filtered.filter(l => l.espaco === espaco);
    if (dataIni) filtered = filtered.filter(l => l.data >= dataIni);
    if (dataFim) filtered = filtered.filter(l => l.data <= dataFim);
    if (responsavel) filtered = filtered.filter(l => l.responsavel.toLowerCase().includes(responsavel));

    filtered.sort((a, b) => new Date(b.data + 'T' + (b.horaInicio || '00:00')) - new Date(a.data + 'T' + (a.horaInicio || '00:00')));

    tbody.innerHTML = filtered.length > 0 ? filtered.map(l => `
        <tr>
            <td>${l.responsavel}</td>
            <td>${getEspacoNome(l.espaco)}</td>
            <td>${formatDate(l.data)}</td>
            <td>${l.horaInicio} ${l.horaFim ? ' - ' + l.horaFim : ''}</td>
            <td>${l.tempoUso || '-'}</td>
            <td>
                <span class="badge ${l.status === 'concluido' ? 'badge-success' : 'badge-warning'}">
                    ${l.status === 'concluido' ? 'Concluído' : 'Em Andamento'}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-info" onclick="editLimpeza('${l.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                ${podeExcluirRegistros() ? `
                <button class="btn btn-sm btn-danger" onclick="deleteLimpeza('${l.id}')">
                    <i class="fas fa-trash"></i>
                </button>` : ''}
            </td>
        </tr>
    `).join('') : '<tr><td colspan="7" class="text-center">Nenhum registro encontrado com os filtros.</td></tr>';
}

// ✅ Exportar PDF — mês atual
function exportarLimpezasPDF() {
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    const mesNome = getMonthName(mesAtual);

    const limpezasMes = limpezas
        .filter(l => l.condominioId === currentCondominio.id)
        .filter(l => {
            const d = new Date(l.data);
            return d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
        })
        .sort((a, b) => new Date(b.data + 'T' + (b.horaInicio || '00:00')) - new Date(a.data + 'T' + (a.horaInicio || '00:00')));

    if (limpezasMes.length === 0) {
        alert('⚠️ Nenhuma limpeza registrada neste mês.');
        return;
    }

    const total = limpezasMes.length;
    const concluidas = limpezasMes.filter(l => l.status === 'concluido').length;

    let html = `
    <div id="printArea">
        <style>
            @media print { @page { size: A4; margin: 10mm; } body { -webkit-print-color-adjust: exact; } }
            body { font-family: Arial, sans-serif; }
            .header { text-align: center; border-bottom: 3px solid #2c3e50; padding-bottom: 15px; margin-bottom: 20px; }
            .title { font-size: 22px; font-weight: bold; color: #2c3e50; margin: 0; }
            .subtitle { font-size: 14px; color: #666; margin: 5px 0; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th { background-color: #2c3e50; color: white; padding: 10px; text-align: left; }
            td { padding: 8px 10px; border-bottom: 1px solid #eee; }
            tr:nth-child(even) { background-color: #f9f9f9; }
            .badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
            .badge-success { background-color: #27ae60; color: white; }
            .badge-warning { background-color: #f39c12; color: white; }
        </style>
        <div class="header">
            <h1 class="title">Relatório de Limpeza — ${mesNome} ${anoAtual}</h1>
            <p class="subtitle">Condomínio: <strong>${currentCondominio.nome}</strong></p>
            <p class="subtitle">Total: <strong>${total}</strong> registros | Concluídas: <strong>${concluidas}</strong></p>
            <p class="subtitle">Gerado por: ${currentUser.nome || currentUser.usuario} em ${new Date().toLocaleDateString('pt-BR')}</p>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Espaço</th>
                    <th>Responsável</th>
                    <th>Horário</th>
                    <th>Tempo (min)</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                ${limpezasMes.map(l => `
                <tr>
                    <td>${formatDate(l.data)}</td>
                    <td>${getEspacoNome(l.espaco)}</td>
                    <td>${l.responsavel}</td>
                    <td>${l.horaInicio} ${l.horaFim ? '–' + l.horaFim : ''}</td>
                    <td>${l.tempoUso || '—'}</td>
                    <td><span class="badge badge-${l.status === 'concluido' ? 'success' : 'warning'}">
                        ${l.status === 'concluido' ? 'Concluído' : 'Em Andamento'}
                    </span></td>
                </tr>
                `).join('')}
            </tbody>
        </table>
        <div class="footer" style="margin-top:30px; padding-top:15px; border-top:1px solid #ccc; text-align:right; font-size:12px; color:#777;">
            Sistema Multi Condomínios — Confidencial
        </div>
    </div>
    `;

    const win = window.open('', '_blank', 'width=800,height=600');
    win.document.write(html);
    win.document.close();
    win.onload = () => {
        win.focus();
        win.print();
        setTimeout(() => win.close(), 2000);
    };
}

// ✅ Exportar PDF — últimos 18 meses (completo)
function exportarLimpezasConcluidasPDF() {
    const dataLimite = new Date();
    dataLimite.setMonth(dataLimite.getMonth() - 18);

    let registros = limpezas.filter(l =>
        l.condominioId === currentCondominio.id &&
        new Date(l.data) >= dataLimite
    );

    // Aplicar filtros atuais (se houver)
    const espaco = document.getElementById('filtroConcluidosEspacoLimpeza')?.value || '';
    const dataIni = document.getElementById('filtroConcluidosDataIniLimpeza')?.value || '';
    const dataFim = document.getElementById('filtroConcluidosDataFimLimpeza')?.value || '';
    const responsavel = (document.getElementById('filtroConcluidosResponsavel')?.value || '').toLowerCase();

    if (espaco) registros = registros.filter(l => l.espaco === espaco);
    if (dataIni) registros = registros.filter(l => l.data >= dataIni);
    if (dataFim) registros = registros.filter(l => l.data <= dataFim);
    if (responsavel) registros = registros.filter(l => l.responsavel.toLowerCase().includes(responsavel));

    registros.sort((a, b) => new Date(b.data + 'T' + (b.horaInicio || '00:00')) - new Date(a.data + 'T' + (a.horaInicio || '00:00')));

    if (registros.length === 0) {
        alert('⚠️ Nenhuma limpeza para exportar.');
        return;
    }

    const periodo = `${formatDate(dataLimite.toISOString().split('T')[0])} a ${new Date().toLocaleDateString('pt-BR')}`;

    let html = `
    <div id="printArea">
        <style>
            @media print { @page { size: A4; margin: 10mm; } body { -webkit-print-color-adjust: exact; } }
            body { font-family: Arial, sans-serif; }
            .header { text-align: center; border-bottom: 3px solid #2c3e50; padding-bottom: 15px; margin-bottom: 20px; }
            .title { font-size: 22px; font-weight: bold; color: #2c3e50; margin: 0; }
            .subtitle { font-size: 14px; color: #666; margin: 5px 0; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th { background-color: #2c3e50; color: white; padding: 10px; text-align: left; }
            td { padding: 8px 10px; border-bottom: 1px solid #eee; }
            tr:nth-child(even) { background-color: #f9f9f9; }
            .badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
            .badge-success { background-color: #27ae60; color: white; }
            .badge-warning { background-color: #f39c12; color: white; }
        </style>
        <div class="header">
            <h1 class="title">Relatório de Limpeza — Últimos 18 Meses</h1>
            <p class="subtitle">Condomínio: <strong>${currentCondominio.nome}</strong></p>
            <p class="subtitle">Período: <strong>${periodo}</strong> | Total: <strong>${registros.length}</strong> registros</p>
            <p class="subtitle">Gerado por: ${currentUser.nome || currentUser.usuario} em ${new Date().toLocaleDateString('pt-BR')}</p>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Espaço</th>
                    <th>Responsável</th>
                    <th>Horário</th>
                    <th>Tempo (min)</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                ${registros.map(l => `
                <tr>
                    <td>${formatDate(l.data)}</td>
                    <td>${getEspacoNome(l.espaco)}</td>
                    <td>${l.responsavel}</td>
                    <td>${l.horaInicio} ${l.horaFim ? '–' + l.horaFim : ''}</td>
                    <td>${l.tempoUso || '—'}</td>
                    <td><span class="badge badge-${l.status === 'concluido' ? 'success' : 'warning'}">
                        ${l.status === 'concluido' ? 'Concluído' : 'Em Andamento'}
                    </span></td>
                </tr>
                `).join('')}
            </tbody>
        </table>
        <div class="footer" style="margin-top:30px; padding-top:15px; border-top:1px solid #ccc; text-align:right; font-size:12px; color:#777;">
            Sistema Multi Condomínios — Confidencial
        </div>
    </div>
    `;

    const win = window.open('', '_blank', 'width=800,height=600');
    win.document.write(html);
    win.document.close();
    win.onload = () => {
        win.focus();
        win.print();
        setTimeout(() => win.close(), 2000);
    };
}

        // ========== MÓDULO SAUNA ==========
        function loadSaunaContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes &&
                !currentUser.permissoes.includes('*') &&
                !currentUser.permissoes.includes('sauna')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Selecione um condomínio</strong> para acessar o módulo de sauna.
                    </div>
                `;
                return;
            }
            const filteredSaunas = saunas.filter(s => s.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Agendamentos de Sauna - ${currentCondominio.nome}</h3>
                        <button class="btn btn-primary" onclick="openSaunaModal()">
                            <i class="fas fa-plus"></i> Novo Agendamento
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Filtrar por Status</label>
                                <select class="form-control" id="filtroStatusSauna" onchange="filterSaunas()">
                                    <option value="">Todos</option>
                                    <option value="agendado">Agendado</option>
                                    <option value="em-uso">Em Uso</option>
                                    <option value="concluido">Concluído</option>
                                    <option value="cancelado">Cancelado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Filtrar por Data</label>
                                <input type="date" class="form-control" id="filtroDataSauna" onchange="filterSaunas()">
                            </div>
                        </div>
                        <table class="table" id="saunasTable">
                            <thead>
                                <tr>
                                    <th>Morador</th>
                                    <th>Apartamento</th>
                                    <th>Tipo</th>
                                    <th>Data</th>
                                    <th>Horário</th>
                                    <th>Tempo (min)</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredSaunas.map(sauna => `
                                    <tr>
                                        <td>${sauna.morador}</td>
                                        <td>${sauna.apto}</td>
                                        <td>${sauna.tipo === 'umida' ? 'Úmida' : 'Seca'}</td>
                                        <td>${formatDate(sauna.data)}</td>
                                        <td>${sauna.horaInicio} ${sauna.horaFim ? ' - ' + sauna.horaFim : ''}</td>
                                        <td>${sauna.tempoUso || '-'}</td>
                                        <td>
                                            <span class="status-badge status-${sauna.status}">
                                                ${formatStatusSauna(sauna.status)}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editSauna('${sauna.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            ${sauna.status === 'em-uso' ? `
                                            <button class="btn btn-sm btn-success" onclick="concluirSauna('${sauna.id}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            ` : ''}
                                            ${sauna.status === 'agendado' ? `
                                            <button class="btn btn-sm btn-warning" onclick="iniciarSauna('${sauna.id}')">
                                                <i class="fas fa-play"></i>
                                            </button>
                                            ` : ''}
                                            ${podeExcluirRegistros() ? `
                                            <button class="btn btn-sm btn-danger" onclick="deleteSauna('${sauna.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        // ========== MÓDULO CONTAS A PAGAR ==========
        function loadContasContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes &&
                !currentUser.permissoes.includes('*') &&
                !currentUser.permissoes.includes('contas')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Selecione um condomínio</strong> para acessar o módulo de contas a pagar.
                    </div>
                `;
                return;
            }
            const filteredContas = contas.filter(c => c.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Contas a Pagar - ${currentCondominio.nome}</h3>
                        <button class="btn btn-primary" onclick="openContaModal()">
                            <i class="fas fa-plus"></i> Nova Conta
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Filtrar por Status</label>
                                <select class="form-control" id="filtroStatusConta" onchange="filterContas()">
                                    <option value="">Todos</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="pago">Pago</option>
                                    <option value="atrasado">Atrasado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Filtrar por Categoria</label>
                                <select class="form-control" id="filtroCategoriaConta" onchange="filterContas()">
                                    <option value="">Todas</option>
                                    <option value="manutencao">Manutenção</option>
                                    <option value="limpeza">Limpeza</option>
                                    <option value="seguranca">Segurança</option>
                                    <option value="administrativo">Administrativo</option>
                                    <option value="energia">Energia</option>
                                    <option value="agua">Água</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                        </div>
                        <table class="table" id="contasTable">
                            <thead>
                                <tr>
                                    <th>Descrição</th>
                                    <th>Valor</th>
                                    <th>Vencimento</th>
                                    <th>Categoria</th>
                                    <th>Fornecedor</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredContas.map(conta => `
                                    <tr>
                                        <td>${conta.descricao}</td>
                                        <td>R$ ${conta.valor.toFixed(2)}</td>
                                        <td>${formatDate(conta.vencimento)}</td>
                                        <td>${formatCategoriaConta(conta.categoria)}</td>
                                        <td>${conta.fornecedor || '-'}</td>
                                        <td>
                                            <span class="status-badge status-${conta.status}">
                                                ${formatStatusConta(conta.status)}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editConta('${conta.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-success" onclick="marcarContaComoPaga('${conta.id}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            ${podeExcluirRegistros() ? `
                                            <button class="btn btn-sm btn-danger" onclick="deleteConta('${conta.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        // ========== MÓDULO LEMBRETES ==========
        function loadLembretesContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes &&
                !currentUser.permissoes.includes('*') &&
                !currentUser.permissoes.includes('lembretes')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            if (!currentCondominio) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Selecione um condomínio</strong> para acessar o módulo de lembretes.
                    </div>
                `;
                return;
            }
            const filteredLembretes = lembretes.filter(l => l.condominioId === currentCondominio.id);
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Lembretes - ${currentCondominio.nome}</h3>
                        <button class="btn btn-primary" onclick="openLembreteModal()">
                            <i class="fas fa-plus"></i> Novo Lembrete
                        </button>
                    </div>
                    <div class="card-body">
                        ${filteredLembretes.length > 0 ? `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Título</th>
                                    <th>Descrição</th>
                                    <th>Início</th>
                                    <th>Fim</th>
                                    <th>Prioridade</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredLembretes.map(lembrete => `
                                    <tr>
                                        <td>${lembrete.titulo}</td>
                                        <td>${lembrete.descricao || '-'}</td>
                                        <td>${formatDate(lembrete.dataInicio)}</td>
                                        <td>${lembrete.dataFim ? formatDate(lembrete.dataFim) : '—'}</td>
                                        <td>
                                            <span class="badge ${lembrete.prioridade === 'alta' ? 'badge-danger' : lembrete.prioridade === 'media' ? 'badge-warning' : 'badge-info'}">
                                                ${lembrete.prioridade === 'alta' ? 'Alta' : lembrete.prioridade === 'media' ? 'Média' : 'Baixa'}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" onclick="editLembrete('${lembrete.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            ${podeExcluirRegistros() ? `
                                            <button class="btn btn-sm btn-danger" onclick="deleteLembrete('${lembrete.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ` : '<p>Nenhum lembrete cadastrado para este condomínio.</p>'}
                    </div>
                </div>
            `;
        }
        // ========== MÓDULO RELATÓRIOS ==========
        function loadRelatoriosContent() {
            const moduleContent = document.getElementById('moduleContent');
            if (currentUser.permissoes &&
                !currentUser.permissoes.includes('*') &&
                !currentUser.permissoes.includes('relatorios')) {
                moduleContent.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Acesso negado!</strong> Você não tem permissão para acessar este módulo.
                    </div>
                `;
                return;
            }
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const firstDayStr = firstDay.toISOString().split('T')[0];
            const lastDayStr = lastDay.toISOString().split('T')[0];
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Relatórios - ${currentCondominio ? currentCondominio.nome : 'Todos os condomínios'}</h3>
                    </div>
                    <div class="card-body">
                        <div class="report-filters">
                            <h4>Filtros do Relatório</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tipo de Relatório</label>
                                    <select class="form-control" id="reportType">
                                        <option value="agendamentos">Agendamentos</option>
                                        <option value="contas">Contas a Pagar</option>
                                        <option value="usuarios">Usuários</option>
                                        <option value="moradores">Moradores</option>
                                        <option value="limpeza">Limpeza</option>
                                        <option value="sauna">Sauna</option>
                                        <option value="horas-extras">Horas Extras</option>
                                        <option value="compras">Compras</option> <!-- Adicionado -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Período Inicial</label>
                                    <input type="date" class="form-control" id="reportStartDate" value="${firstDayStr}">
                                </div>
                                <div class="form-group">
                                    <label>Período Final</label>
                                    <input type="date" class="form-control" id="reportEndDate" value="${lastDayStr}">
                                </div>
                            </div>
                            ${currentCondominio ? `
                            <div class="form-group">
                                <label>Condomínio</label>
                                <select class="form-control" id="reportCondominio">
                                    <option value="${currentCondominio.id}">${currentCondominio.nome}</option>
                                </select>
                            </div>
                            ` : ''}
                            <div class="report-actions">
                                <button class="btn btn-primary" onclick="generateReport()">
                                    <i class="fas fa-chart-bar"></i> Gerar Relatório
                                </button>
                                <button class="btn btn-success" onclick="exportReport()">
    <i class="fas fa-download"></i> Exportar TXT
</button>
<button class="btn btn-info" onclick="exportBackupJSON()" style="margin-left: 8px;">
    <i class="fas fa-file-export"></i> Backup JSON
</button>
                            </div>
                        </div>
                        <div class="report-preview" id="reportPreview">
                            <p>Selecione os filtros e clique em "Gerar Relatório"</p>
                        </div>
                    </div>
                </div>
            `;
        }
        // ========== FUNÇÕES AUXILIARES ==========
        function getEspacoNome(espacoId) {
            const espacos = {
                'salao-social': 'Salão Social',
                'churrasqueira': 'Churrasqueira',
                'quiosque': 'Quiosque',
                'pergolado': 'Pergolado',
                'sauna': 'Sauna',
                'area-comum': 'Área Comum'
            };
            return espacos[espacoId] || espacoId;
        }
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }
        function getCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function formatUserType(userType) {
            const types = {
                'sindico': 'Síndico',
                'subsindico': 'Subsíndico',
                'zelador': 'Zelador',
                'portaria': 'Portaria',
                'prestador': 'Prestador de Serviço',
                'morador': 'Morador'
            };
            return types[userType] || userType;
        }
        function formatStatusAgendamento(status) {
            const statusMap = {
                'agendado': 'Agendado',
                'em-uso': 'Em Uso',
                'liberado': 'Liberado',
                'cancelado': 'Cancelado'
            };
            return statusMap[status] || status;
        }
        function formatStatusSauna(status) {
            const statusMap = {
                'agendado': 'Agendado',
                'em-uso': 'Em Uso',
                'concluido': 'Concluído',
                'cancelado': 'Cancelado'
            };
            return statusMap[status] || status;
        }
        function formatCategoriaConta(categoria) {
            const categorias = {
                'manutencao': 'Manutenção',
                'limpeza': 'Limpeza',
                'seguranca': 'Segurança',
                'administrativo': 'Administrativo',
                'energia': 'Energia',
                'agua': 'Água',
                'outros': 'Outros'
            };
            return categorias[categoria] || categoria;
        }
        function formatStatusConta(status) {
            const statusMap = {
                'pendente': 'Pendente',
                'pago': 'Pago',
                'atrasado': 'Atrasado'
            };
            return statusMap[status] || status;
        }
        function getMonthName(month) {
            const months = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return months[month];
        }
        // ========== FUNÇÕES DE CALENDÁRIO ==========
         // ========== LISTA DE FERIADOS ==========
const FERIADOS_NACIONAIS = [
    '01-01', // Ano Novo
    '21-04', // Tiradentes
    '01-05', // Dia do Trabalho
    '07-09', // Independência
    '12-10', // N. Sra. Aparecida
    '02-11', // Finados
    '15-11', // Proclamação da República
    '25-12'  // Natal
];

const FERIADOS_JARAGUA = [
    '25-07'  // Aniversário de Jaraguá do Sul
    // Adicione outros se souber (ex: padroeira, etc)
];

function isFeriadoNacional(dataStr) {
    const [ano, mes, dia] = dataStr.split('-');
    const mmdd = `${dia}-${mes}`;
    return FERIADOS_NACIONAIS.includes(mmdd);
}

function isFeriadoJaragua(dataStr) {
    const [ano, mes, dia] = dataStr.split('-');
    const mmdd = `${dia}-${mes}`;
    return FERIADOS_JARAGUA.includes(mmdd);
}
        function generateCalendar(month, year) {
    const calendarGrid = document.getElementById('calendarGrid');
    if (!calendarGrid) return;
    document.getElementById('calendarTitle').textContent = `${getMonthName(month)} ${year}`;
    calendarGrid.innerHTML = '';

    const daysOfWeek = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
    daysOfWeek.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'calendar-day-header';
        dayHeader.textContent = day;
        calendarGrid.appendChild(dayHeader);
    });

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const firstDayOfWeek = firstDay.getDay();
    const prevMonthLastDay = new Date(year, month, 0).getDate();

    // Gera dias do mês anterior (cinza claro)
    for (let i = firstDayOfWeek - 1; i >= 0; i--) {
        const day = document.createElement('div');
        day.className = 'calendar-day other-month';
        day.innerHTML = `<div class="day-number">${prevMonthLastDay - i}</div>`;
        calendarGrid.appendChild(day);
    }

    // Gera dias do mês atual
    for (let dia = 1; dia <= lastDay.getDate(); dia++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
        const hoje = new Date();
        const isToday = hoje.getDate() === dia && hoje.getMonth() === month && hoje.getFullYear() === year;

        // ✅ Verifica se tem agendamento
        const agendamentosDoDia = agendamentos.filter(a =>
            a.data === dateStr && a.condominioId === (currentCondominio ? currentCondominio.id : '')
        );
        const temAgendamento = agendamentosDoDia.length > 0;

        // ✅ Verifica feriados
        const ehFeriadoNacional = isFeriadoNacional(dateStr);
        const ehFeriadoJaragua = isFeriadoJaragua(dateStr);

     // ✅ Define classes e estilos
let classes = 'calendar-day';
let bgColor = '#ffffff';      // branco (padrão)
let borderColor = '#e0e0e0';  // cinza claro (padrão)
let borderStyle = '1px solid';

if (ehFeriadoNacional) {
    bgColor = '#ffebee';
    borderColor = '#f44336';
} else if (ehFeriadoJaragua) {
    bgColor = '#fff3e0';
    borderColor = '#ff9800';
} else if (temAgendamento) {
    bgColor = '#e3f2fd';
    borderColor = '#2196f3';
}

// ✅ PRIORIDADE: HOJE — sempre destaca, mesmo em feriado ou com agendamento
if (isToday) {
    classes += ' today';
    bgColor = '#fffde7';       // 🟡 Amarelo suave (Yellow 50)
    borderColor = '#ffd54f';   // 🟡 Borda amarela suave (Yellow 300)
}

        const dayDiv = document.createElement('div');
        dayDiv.className = classes;
        dayDiv.style.backgroundColor = bgColor;
        dayDiv.style.border = `${borderStyle} ${borderColor}`;
        dayDiv.style.borderRadius = '4px';
        dayDiv.innerHTML = `<div class="day-number">${dia}</div>`;

       // ✅ Adiciona eventos do dia — com PRIMEIRO NOME do responsável
agendamentosDoDia.forEach(event => {
    // Extrai primeiro nome (ex: "João Silva" → "João")
    const primeiroNome = event.responsavel.split(' ')[0] || event.responsavel;
    
    const eventElement = document.createElement('div');
    eventElement.className = `event-item ${event.espaco}`;
    
    // ✅ Agora mostra: "João — 101 — 14:00"
    eventElement.textContent = `${primeiroNome} — ${event.unidade} — ${event.horaInicio}`;
    
    // Tooltip completo ao passar o mouse
    eventElement.title = `${getEspacoNome(event.espaco)}: ${event.responsavel} (${event.unidade}) | ${event.horaInicio}–${event.horaFim}`;
    
    // Estilo compacto para caber no calendário
    Object.assign(eventElement.style, {
        fontSize: '9px',
        padding: '1px 3px',
        margin: '1px 0',
        borderRadius: '3px',
        overflow: 'hidden',
        textOverflow: 'ellipsis',
        whiteSpace: 'nowrap',
        fontWeight: '500'
    });
    
    dayDiv.appendChild(eventElement);
});

        dayDiv.addEventListener('click', function() {
            openAgendamentoModalForDate(dateStr);
        });

        calendarGrid.appendChild(dayDiv);
    }

    // Gera dias do próximo mês (cinza claro)
    const totalCells = 42;
    const daysSoFar = firstDayOfWeek + lastDay.getDate();
    const nextMonthDays = totalCells - daysSoFar;
    for (let i = 1; i <= nextMonthDays; i++) {
        const day = document.createElement('div');
        day.className = 'calendar-day other-month';
        day.innerHTML = `<div class="day-number">${i}</div>`;
        calendarGrid.appendChild(day);
    }
}
        function changeCalendarMonth(direction) {
            currentCalendarMonth += direction;
            if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            } else if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            }
            generateCalendar(currentCalendarMonth, currentCalendarYear);
        }
        function changeCalendarView(view) {
            document.querySelectorAll('.calendar-view-options .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            alert(`Visualização alterada para: ${view}`);
        }
        function showAgendamentoActions(agendamento, element) {
            const existingModal = document.querySelector('.agendamento-actions-modal');
            if (existingModal) {
                existingModal.remove();
            }
            const modal = document.createElement('div');
            modal.className = 'agendamento-actions-modal';
            modal.innerHTML = `
                <button onclick="editAgendamento('${agendamento.id}')">Editar</button>
                <button onclick="updateAgendamentoStatus('${agendamento.id}', 'liberado')">Marcar como Liberado</button>
                <button onclick="updateAgendamentoStatus('${agendamento.id}', 'cancelado')">Cancelar</button>
            `;
            const rect = element.getBoundingClientRect();
            modal.style.position = 'fixed';
            modal.style.top = `${rect.bottom + window.scrollY}px`;
            modal.style.left = `${rect.left + window.scrollX}px`;
            document.body.appendChild(modal);
            const closeModal = function(e) {
                if (!modal.contains(e.target)) {
                    modal.remove();
                    document.removeEventListener('click', closeModal);
                }
            };
            setTimeout(() => {
                document.addEventListener('click', closeModal);
            }, 100);
        }
        async function updateAgendamentoStatus(agendamentoId, status) {
            try {
                await db.collection('agendamentos').doc(agendamentoId).update({
                    status: status,
                    dataAtualizacao: new Date().toISOString()
                });
                await loadSystemData();
                if (currentModule === 'agendamentos') {
                    loadAgendamentosContent();
                }
                alert(`Agendamento ${status === 'liberado' ? 'marcado como liberado' : 'cancelado'} com sucesso!`);
            } catch (error) {
                console.error('Erro ao atualizar status do agendamento:', error);
                alert('Erro ao atualizar status do agendamento. Tente novamente.');
            }
        }
        function filterAgendamentos() {
            const espaco = document.getElementById('filtroEspaco').value;
            const status = document.getElementById('filtroStatus').value;
            const data = document.getElementById('filtroData').value;
            let filteredAgendamentos = agendamentos.filter(a =>
                a.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (espaco) {
                filteredAgendamentos = filteredAgendamentos.filter(a => a.espaco === espaco);
            }
            if (status) {
                filteredAgendamentos = filteredAgendamentos.filter(a => a.status === status);
            }
            if (data) {
                filteredAgendamentos = filteredAgendamentos.filter(a => a.data === data);
            }
            const tbody = document.querySelector('#agendamentosTable tbody');
            tbody.innerHTML = '';
            if (filteredAgendamentos.length > 0) {
                filteredAgendamentos.forEach(agendamento => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${getEspacoNome(agendamento.espaco)}</td>
                        <td>${agendamento.responsavel}</td>
                        <td>${formatDate(agendamento.data)}</td>
                        <td>${agendamento.horaInicio} - ${agendamento.horaFim}</td>
                        <td>${agendamento.unidade}</td>
                        <td>
                            <span class="status-badge status-${agendamento.status}">
                                ${formatStatusAgendamento(agendamento.status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editAgendamento('${agendamento.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${podeExcluirRegistros() ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteAgendamento('${agendamento.id}')">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum agendamento encontrado com os filtros aplicados.</td></tr>';
            }
        }
      function loadAgendamentosList() {
    const tbody = document.querySelector('#agendamentosTable tbody');
    if (!tbody) return;
    
    const filtroEspaco = document.getElementById('filtroEspaco')?.value || '';
    const filtroStatus = document.getElementById('filtroStatus')?.value || '';
    const filtroData = document.getElementById('filtroData')?.value || '';
    
    // Filtrar apenas agendamentos ATIVOS (não concluídos ou cancelados)
    let filteredAgendamentos = agendamentos.filter(a => 
        a.condominioId === currentCondominio.id &&
        a.status !== 'liberado' && 
        a.status !== 'concluido' && 
        a.status !== 'cancelado'
    );
    
    // Aplicar filtros adicionais
    if (filtroEspaco) {
        filteredAgendamentos = filteredAgendamentos.filter(a => a.espaco === filtroEspaco);
    }
    if (filtroStatus) {
        filteredAgendamentos = filteredAgendamentos.filter(a => a.status === filtroStatus);
    }
    if (filtroData) {
        filteredAgendamentos = filteredAgendamentos.filter(a => a.data === filtroData);
    }
    
    // ORDENAR POR DATA (mais próximo primeiro) e horário
    filteredAgendamentos.sort((a, b) => {
        const dateA = new Date(a.data + 'T' + a.horaInicio);
        const dateB = new Date(b.data + 'T' + b.horaInicio);
        return dateA - dateB; // Ordem crescente = mais próximo primeiro
    });
    
    if (filteredAgendamentos.length > 0) {
        tbody.innerHTML = filteredAgendamentos.map(agendamento => `
            <tr>
                <td>${getEspacoNome(agendamento.espaco)}</td>
                <td>${agendamento.responsavel}</td>
                <td>${formatDate(agendamento.data)}</td>
                <td>${agendamento.horaInicio} - ${agendamento.horaFim}</td>
                <td>${agendamento.unidade}</td>
                <td><span class="status-badge status-${agendamento.status}">${formatStatusAgendamento(agendamento.status)}</span></td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="editAgendamento('${agendamento.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    ${podeExcluirRegistros() ? `
                    <button class="btn btn-sm btn-danger" onclick="deleteAgendamento('${agendamento.id}')">
                        <i class="fas fa-trash"></i>
                    </button>` : ''}
                </td>
            </tr>
        `).join('');
    } else {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum agendamento ativo encontrado com os filtros aplicados.</td></tr>';
    }
}
        function filterLimpezas() {
            const espaco = document.getElementById('filtroEspacoLimpeza').value;
            const status = document.getElementById('filtroStatusLimpeza').value;
            const data = document.getElementById('filtroDataLimpeza').value;
            let filteredLimpezas = limpezas.filter(l =>
                l.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (espaco) {
                filteredLimpezas = filteredLimpezas.filter(l => l.espaco === espaco);
            }
            if (status) {
                filteredLimpezas = filteredLimpezas.filter(l => l.status === status);
            }
            if (data) {
                filteredLimpezas = filteredLimpezas.filter(l => l.data === data);
            }
            const tbody = document.querySelector('#limpezasTable tbody');
            tbody.innerHTML = '';
            if (filteredLimpezas.length > 0) {
                filteredLimpezas.forEach(limpeza => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${limpeza.responsavel}</td>
                        <td>${getEspacoNome(limpeza.espaco)}</td>
                        <td>${formatDate(limpeza.data)}</td>
                        <td>${limpeza.horaInicio} ${limpeza.horaFim ? ' - ' + limpeza.horaFim : ''}</td>
                        <td>${limpeza.tempoUso || '-'}</td>
                        <td>
                            <span class="badge ${limpeza.status === 'concluido' ? 'badge-success' : 'badge-warning'}">
                                ${limpeza.status === 'concluido' ? 'Concluído' : 'Em Andamento'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editLimpeza('${limpeza.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${limpeza.status !== 'concluido' ? `
                            <button class="btn btn-sm btn-success" onclick="concluirLimpeza('${limpeza.id}')">
                                <i class="fas fa-check"></i>
                            </button>
                            ` : ''}
                            ${podeExcluirRegistros() ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteLimpeza('${limpeza.id}')">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum registro de limpeza encontrado com os filtros aplicados.</td></tr>';
            }
        }
        function filterSaunas() {
            const status = document.getElementById('filtroStatusSauna').value;
            const data = document.getElementById('filtroDataSauna').value;
            let filteredSaunas = saunas.filter(s =>
                s.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (status) {
                filteredSaunas = filteredSaunas.filter(s => s.status === status);
            }
            if (data) {
                filteredSaunas = filteredSaunas.filter(s => s.data === data);
            }
            const tbody = document.querySelector('#saunasTable tbody');
            tbody.innerHTML = '';
            if (filteredSaunas.length > 0) {
                filteredSaunas.forEach(sauna => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${sauna.morador}</td>
                        <td>${sauna.apto}</td>
                        <td>${formatDate(sauna.data)}</td>
                        <td>${sauna.horaInicio} ${sauna.horaFim ? ' - ' + sauna.horaFim : ''}</td>
                        <td>${sauna.tempoUso || '-'}</td>
                        <td>
                            <span class="status-badge status-${sauna.status}">
                                ${formatStatusSauna(sauna.status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editSauna('${sauna.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${sauna.status === 'em-uso' ? `
                            <button class="btn btn-sm btn-success" onclick="concluirSauna('${sauna.id}')">
                                <i class="fas fa-check"></i>
                            </button>
                            ` : ''}
                            ${sauna.status === 'agendado' ? `
                            <button class="btn btn-sm btn-warning" onclick="iniciarSauna('${sauna.id}')">
                                <i class="fas fa-play"></i>
                            </button>
                            ` : ''}
                            ${podeExcluirRegistros() ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteSauna('${sauna.id}')">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum agendamento de sauna encontrado com os filtros aplicados.</td></tr>';
            }
        }
        // ✅ Função para fazer backup completo do condomínio atual (JSON)
async function exportBackupJSON() {
    if (!currentCondominio) {
        alert('⚠️ Selecione um condomínio primeiro.');
        return;
    }
    
    try {
        alert('🔍 Iniciando backup... Isso pode levar alguns segundos.');
        
        const backup = {
            metadata: {
                condominio: currentCondominio.nome,
                dataBackup: new Date().toISOString(),
                geradoPor: currentUser.nome || currentUser.usuario,
                versao: '1.0'
            },
            dados: {}
        };

        // 🔁 Listar coleções por condomínio
        const colecoes = [
            'moradores', 'agendamentos', 'limpezas', 'saunas', 'contas',
            'lembretes', 'horasExtras', 'compras', 'vales', 'ocorrencias',
            'prestadores', 'palavrasChave', 'confraternizacoes'
        ];

        for (let colecao of colecoes) {
            const snapshot = await db.collection(colecao)
                .where('condominioId', '==', currentCondominio.id)
                .get();
            backup.dados[colecao] = [];
            snapshot.forEach(doc => {
                backup.dados[colecao].push({ id: doc.id, ...doc.data() });
            });
        }

        // 🔁 Coleções globais (se necessário)
        const usuarioSnapshot = await db.collection('usuarios').doc(currentUser.id).get();
        backup.dados.usuarioLogado = usuarioSnapshot.exists ? { id: usuarioSnapshot.id, ...usuarioSnapshot.data() } : null;

        // 💾 Exportar como arquivo JSON
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_${currentCondominio.nome.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert(`✅ Backup concluído!
Arquivo: ${a.download}
Coleções: ${Object.keys(backup.dados).length}
Registros: ${Object.values(backup.dados).reduce((sum, arr) => sum + arr.length, 0)}`);

    } catch (err) {
        console.error('Erro no backup:', err);
        alert('❌ Falha ao gerar backup. Verifique sua conexão.');
    }
}
        // ========== FUNÇÕES DE AGENDAMENTOS ==========
        function openAgendamentoModal() {
            document.getElementById('agendamentoModalTitle').textContent = 'Novo Agendamento';
            document.getElementById('editingAgendamentoId').value = '';
            document.getElementById('agendamentoForm').reset();
            document.getElementById('agendamentoData').value = '';
            document.getElementById('agendamentoDataInput').value = getCurrentDate();
            document.getElementById('agendamentoStatus').value = 'agendado';
            document.getElementById('agendamentoModal').style.display = 'flex';
        }
        function openAgendamentoModalForDate(dateStr) {
            openAgendamentoModal();
            document.getElementById('agendamentoData').value = dateStr;
            document.getElementById('agendamentoDataInput').value = dateStr;
        }
        function closeAgendamentoModal() {
            document.getElementById('agendamentoModal').style.display = 'none';
        }
        document.getElementById('agendamentoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condomínio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingAgendamentoId').value;
            const espaco = document.getElementById('agendamentoEspaco').value;
            const data = document.getElementById('agendamentoDataInput').value;
            const agendamentoExistente = agendamentos.find(a =>
                a.condominioId === currentCondominio.id &&
                a.espaco === espaco &&
                a.data === data &&
                a.id != editingId
            );
            if (agendamentoExistente) {
                alert(`Já existe um agendamento para ${getEspacoNome(espaco)} na data ${formatDate(data)}. Cada espaço só pode ter um agendamento por dia.`);
                return;
            }
            const agendamentoData = {
                espaco: espaco,
                data: data,
                horaInicio: document.getElementById('agendamentoHoraInicio').value,
                horaFim: document.getElementById('agendamentoHoraFim').value,
                responsavel: document.getElementById('agendamentoResponsavel').value,
                unidade: document.getElementById('agendamentoUnidade').value,
                status: document.getElementById('agendamentoStatus').value,
                observacoes: document.getElementById('agendamentoObservacoes').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('agendamentos').doc(editingId).update(agendamentoData);
                } else {
                    await db.collection('agendamentos').add(agendamentoData);
                }
                await loadSystemData();
                closeAgendamentoModal();
                if (currentModule === 'agendamentos') {
                    loadAgendamentosContent();
                }
                alert('Agendamento salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar agendamento:', error);
                alert('Erro ao salvar agendamento. Tente novamente.');
            }
        });
        function editAgendamento(id) {
            const agendamento = agendamentos.find(a => a.id === id);
            if (!agendamento) return;
            document.getElementById('agendamentoModalTitle').textContent = 'Editar Agendamento';
            document.getElementById('editingAgendamentoId').value = agendamento.id;
            document.getElementById('agendamentoEspaco').value = agendamento.espaco;
            document.getElementById('agendamentoDataInput').value = agendamento.data;
            document.getElementById('agendamentoHoraInicio').value = agendamento.horaInicio;
            document.getElementById('agendamentoHoraFim').value = agendamento.horaFim;
            document.getElementById('agendamentoResponsavel').value = agendamento.responsavel;
            document.getElementById('agendamentoUnidade').value = agendamento.unidade;
            document.getElementById('agendamentoStatus').value = agendamento.status;
            document.getElementById('agendamentoObservacoes').value = agendamento.observacoes || '';
            closeAgendamentosConcluidosModal();
            document.getElementById('agendamentoModal').style.display = 'flex';
        }
        async function deleteAgendamento(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este agendamento?')) return;
            try {
                await db.collection('agendamentos').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'agendamentos') {
                    loadAgendamentosContent();
                }
                alert('Agendamento excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir agendamento:', error);
                alert('Erro ao excluir agendamento. Tente novamente.');
            }
        }
        // ========== FUNÇÕES DE CONTAS A PAGAR ==========
        function openContaModal() {
            document.getElementById('contaModalTitle').textContent = 'Nova Conta a Pagar';
            document.getElementById('editingContaId').value = '';
            document.getElementById('contaForm').reset();
            const dataPadrao = new Date();
            dataPadrao.setDate(dataPadrao.getDate() + 30);
            document.getElementById('contaVencimento').value = dataPadrao.toISOString().split('T')[0];
            document.getElementById('contaStatus').value = 'pendente';
            document.getElementById('contaModal').style.display = 'flex';
        }
        function closeContaModal() {
            document.getElementById('contaModal').style.display = 'none';
        }
        document.getElementById('contaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condomínio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingContaId').value;
            const contaData = {
                descricao: document.getElementById('contaDescricao').value,
                valor: parseFloat(document.getElementById('contaValor').value),
                vencimento: document.getElementById('contaVencimento').value,
                categoria: document.getElementById('contaCategoria').value,
                fornecedor: document.getElementById('contaFornecedor').value,
                status: document.getElementById('contaStatus').value,
                observacoes: document.getElementById('contaObservacoes').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('contas').doc(editingId).update(contaData);
                } else {
                    await db.collection('contas').add(contaData);
                }
                await loadSystemData();
                closeContaModal();
                if (currentModule === 'contas') {
                    loadContasContent();
                }
                alert('Conta salva com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar conta:', error);
                alert('Erro ao salvar conta. Tente novamente.');
            }
        });
        function editConta(id) {
            const conta = contas.find(c => c.id === id);
            if (!conta) return;
            document.getElementById('contaModalTitle').textContent = 'Editar Conta a Pagar';
            document.getElementById('editingContaId').value = conta.id;
            document.getElementById('contaDescricao').value = conta.descricao;
            document.getElementById('contaValor').value = conta.valor;
            document.getElementById('contaVencimento').value = conta.vencimento;
            document.getElementById('contaCategoria').value = conta.categoria;
            document.getElementById('contaFornecedor').value = conta.fornecedor || '';
            document.getElementById('contaStatus').value = conta.status;
            document.getElementById('contaObservacoes').value = conta.observacoes || '';
            document.getElementById('contaModal').style.display = 'flex';
        }
        async function deleteConta(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir esta conta?')) return;
            try {
                await db.collection('contas').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'contas') {
                    loadContasContent();
                }
                alert('Conta excluída com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir conta:', error);
                alert('Erro ao excluir conta. Tente novamente.');
            }
        }
        async function marcarContaComoPaga(id) {
            try {
                await db.collection('contas').doc(id).update({
                    status: 'pago',
                    dataAtualizacao: new Date().toISOString()
                });
                await loadSystemData();
                if (currentModule === 'contas') {
                    loadContasContent();
                } else if (currentModule === 'dashboard') {
                    loadDashboardContent();
                }
                alert('Conta marcada como paga com sucesso!');
            } catch (error) {
                console.error('Erro ao marcar conta como paga:', error);
                alert('Erro ao marcar conta como paga. Tente novamente.');
            }
        }
        // ========== FUNÇÕES DE LEMBRETES ==========
        function openLembreteModal() {
            document.getElementById('lembreteModalTitle').textContent = 'Novo Lembrete';
            document.getElementById('editingLembreteId').value = '';
            document.getElementById('lembreteForm').reset();
            document.getElementById('lembreteDataInicio').value = getCurrentDate();
            document.getElementById('lembreteDataFim').value = '';
            document.getElementById('lembretePrioridade').value = 'media';
            document.getElementById('lembreteModal').style.display = 'flex';
        }
        function closeLembreteModal() {
            document.getElementById('lembreteModal').style.display = 'none';
        }
        document.getElementById('lembreteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condomínio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingLembreteId').value;
            const lembreteData = {
                titulo: document.getElementById('lembreteTitulo').value,
                descricao: document.getElementById('lembreteDescricao').value,
                dataInicio: document.getElementById('lembreteDataInicio').value,
                dataFim: document.getElementById('lembreteDataFim').value || null,
                prioridade: document.getElementById('lembretePrioridade').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id,
                criadoPorNome: currentUser.nome || currentUser.usuario,
            };
            try {
                if (editingId) {
                    await db.collection('lembretes').doc(editingId).update(lembreteData);
                } else {
                    await db.collection('lembretes').add(lembreteData);
                }
                await loadSystemData();
                closeLembreteModal();
                if (currentModule === 'dashboard') {
                    loadDashboardContent();
                }
                loadTickerContent();
                alert('Lembrete salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar lembrete:', error);
                alert('Erro ao salvar lembrete. Tente novamente.');
            }
        });
        function editLembrete(id) {
            const lembrete = lembretes.find(l => l.id === id);
            if (!lembrete) return;
            document.getElementById('lembreteModalTitle').textContent = 'Editar Lembrete';
            document.getElementById('editingLembreteId').value = lembrete.id;
            document.getElementById('lembreteTitulo').value = lembrete.titulo;
            document.getElementById('lembreteDescricao').value = lembrete.descricao || '';
            document.getElementById('lembreteDataInicio').value = lembrete.dataInicio;
            document.getElementById('lembreteDataFim').value = lembrete.dataFim || '';
            document.getElementById('lembretePrioridade').value = lembrete.prioridade || 'media';
            document.getElementById('lembreteModal').style.display = 'flex';
        }
        async function deleteLembrete(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este lembrete?')) return;
            try {
                await db.collection('lembretes').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'dashboard') {
                    loadDashboardContent();
                }
                loadTickerContent();
                alert('Lembrete excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir lembrete:', error);
                alert('Erro ao excluir lembrete. Tente novamente.');
            }
        }
        // ========== FUNÇÕES DE LIMPEZA ==========
        function openLimpezaModal() {
            document.getElementById('limpezaModalTitle').textContent = 'Novo Registro de Limpeza';
            document.getElementById('editingLimpezaId').value = '';
            document.getElementById('limpezaForm').reset();
            document.getElementById('limpezaData').value = getCurrentDate();
            const now = new Date();
            document.getElementById('limpezaHoraInicio').value = now.toTimeString().substring(0, 5);
            document.getElementById('limpezaStatus').value = 'em-andamento';
            document.getElementById('btnConcluirLimpeza').style.display = 'none';
            document.getElementById('limpezaModal').style.display = 'flex';
        }
        function closeLimpezaModal() {
            document.getElementById('limpezaModal').style.display = 'none';
        }
        function editLimpeza(id) {
            const limpeza = limpezas.find(l => l.id === id);
            if (!limpeza) return;
            document.getElementById('limpezaModalTitle').textContent = 'Editar Registro de Limpeza';
            document.getElementById('editingLimpezaId').value = limpeza.id;
            document.getElementById('limpezaResponsavel').value = limpeza.responsavel;
            document.getElementById('limpezaEspaco').value = limpeza.espaco;
            document.getElementById('limpezaData').value = limpeza.data;
            document.getElementById('limpezaHoraInicio').value = limpeza.horaInicio;
            document.getElementById('limpezaHoraFim').value = limpeza.horaFim || '';
            document.getElementById('limpezaTempoUso').value = limpeza.tempoUso || '';
            document.getElementById('limpezaObservacoes').value = limpeza.observacoes || '';
            document.getElementById('limpezaStatus').value = limpeza.status;
            if (limpeza.status !== 'concluido') {
                document.getElementById('btnConcluirLimpeza').style.display = 'inline-block';
            } else {
                document.getElementById('btnConcluirLimpeza').style.display = 'none';
            }
            document.getElementById('limpezaModal').style.display = 'flex';
        }
        document.getElementById('limpezaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condomínio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingLimpezaId').value;
            const limpezaData = {
                responsavel: document.getElementById('limpezaResponsavel').value,
                espaco: document.getElementById('limpezaEspaco').value,
                data: document.getElementById('limpezaData').value,
                horaInicio: document.getElementById('limpezaHoraInicio').value,
                horaFim: document.getElementById('limpezaHoraFim').value,
                tempoUso: document.getElementById('limpezaTempoUso').value,
                observacoes: document.getElementById('limpezaObservacoes').value,
                status: document.getElementById('limpezaStatus').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('limpezas').doc(editingId).update(limpezaData);
                } else {
                    await db.collection('limpezas').add(limpezaData);
                }
                await loadSystemData();
                closeLimpezaModal();
                if (currentModule === 'limpeza') {
                    loadLimpezaContent();
                }
                alert('Registro de limpeza salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar registro de limpeza:', error);
                alert('Erro ao salvar registro de limpeza. Tente novamente.');
            }
        });
        async function concluirLimpeza(id = null) {
            let limpezaId = id || document.getElementById('editingLimpezaId').value;
            if (!limpezaId) {
                alert('Nenhum registro de limpeza selecionado!');
                return;
            }
            const horaFim = new Date().toTimeString().substring(0, 5);
            const limpeza = limpezas.find(l => l.id === limpezaId);
            if (!limpeza) {
                alert('Registro de limpeza não encontrado!');
                return;
            }
            const inicio = new Date(`2000-01-01T${limpeza.horaInicio}`);
            const fim = new Date(`2000-01-01T${horaFim}`);
            const tempoUso = Math.round((fim - inicio) / (1000 * 60));
            try {
                await db.collection('limpezas').doc(limpezaId).update({
                    horaFim: horaFim,
                    tempoUso: tempoUso,
                    status: 'concluido',
                    dataAtualizacao: new Date().toISOString()
                });
                await loadSystemData();
                closeLimpezaModal();
                if (currentModule === 'limpeza') {
                    loadLimpezaContent();
                }
                alert('Limpeza concluída com sucesso! Tempo de uso: ' + tempoUso + ' minutos');
            } catch (error) {
                console.error('Erro ao concluir limpeza:', error);
                alert('Erro ao concluir limpeza. Tente novamente.');
            }
        }
        async function deleteLimpeza(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este registro de limpeza?')) return;
            try {
                await db.collection('limpezas').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'limpeza') {
                    loadLimpezaContent();
                }
                alert('Registro de limpeza excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir registro de limpeza:', error);
                alert('Erro ao excluir registro de limpeza. Tente novamente.');
            }
        }
        // ========== FUNÇÕES DE SAUNA ==========
        function openSaunaModal() {
            document.getElementById('saunaModalTitle').textContent = 'Novo Agendamento de Sauna';
            document.getElementById('editingSaunaId').value = '';
            document.getElementById('saunaForm').reset();
            document.getElementById('saunaData').value = getCurrentDate();
            document.getElementById('saunaTipo').value = 'umida';
            document.getElementById('saunaStatus').value = 'agendado';
            document.getElementById('btnConcluirSauna').style.display = 'none';
            document.getElementById('saunaModal').style.display = 'flex';
        }
        function closeSaunaModal() {
            document.getElementById('saunaModal').style.display = 'none';
        }
        function editSauna(id) {
            const sauna = saunas.find(s => s.id === id);
            if (!sauna) return;
            document.getElementById('saunaModalTitle').textContent = 'Editar Agendamento de Sauna';
            document.getElementById('editingSaunaId').value = sauna.id;
            document.getElementById('saunaMorador').value = sauna.morador;
            document.getElementById('saunaApto').value = sauna.apto;
            document.getElementById('saunaTipo').value = sauna.tipo || 'umida';
            document.getElementById('saunaData').value = sauna.data;
            document.getElementById('saunaHoraInicio').value = sauna.horaInicio;
            document.getElementById('saunaHoraFim').value = sauna.horaFim || '';
            document.getElementById('saunaTempoUso').value = sauna.tempoUso || '';
            document.getElementById('saunaObservacoes').value = sauna.observacoes || '';
            document.getElementById('saunaStatus').value = sauna.status;
            if (sauna.status === 'em-uso') {
                document.getElementById('btnConcluirSauna').style.display = 'inline-block';
            } else {
                document.getElementById('btnConcluirSauna').style.display = 'none';
            }
            document.getElementById('saunaModal').style.display = 'flex';
        }
        document.getElementById('saunaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condomínio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingSaunaId').value;
            const saunaData = {
                morador: document.getElementById('saunaMorador').value,
                apto: document.getElementById('saunaApto').value,
                tipo: document.getElementById('saunaTipo').value,
                data: document.getElementById('saunaData').value,
                horaInicio: document.getElementById('saunaHoraInicio').value,
                horaFim: document.getElementById('saunaHoraFim').value,
                tempoUso: document.getElementById('saunaTempoUso').value,
                observacoes: document.getElementById('saunaObservacoes').value,
                status: document.getElementById('saunaStatus').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('saunas').doc(editingId).update(saunaData);
                } else {
                    await db.collection('saunas').add(saunaData);
                }
                await loadSystemData();
                closeSaunaModal();
                if (currentModule === 'sauna') {
                    loadSaunaContent();
                }
                alert('Agendamento de sauna salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar agendamento de sauna:', error);
                alert('Erro ao salvar agendamento de sauna. Tente novamente.');
            }
        });
        async function iniciarSauna(id) {
            try {
                await db.collection('saunas').doc(id).update({
                    status: 'em-uso',
                    dataAtualizacao: new Date().toISOString()
                });
                await loadSystemData();
                if (currentModule === 'sauna') {
                    loadSaunaContent();
                }
                alert('Uso da sauna iniciado!');
            } catch (error) {
                console.error('Erro ao iniciar sauna:', error);
                alert('Erro ao iniciar sauna. Tente novamente.');
            }
        }
        async function concluirSauna(id = null) {
            let saunaId = id || document.getElementById('editingSaunaId').value;
            if (!saunaId) {
                alert('Nenhum agendamento de sauna selecionado!');
                return;
            }
            const horaFim = new Date().toTimeString().substring(0, 5);
            const sauna = saunas.find(s => s.id === saunaId);
            if (!sauna) {
                alert('Agendamento de sauna não encontrado!');
                return;
            }
            const inicio = new Date(`2000-01-01T${sauna.horaInicio}`);
            const fim = new Date(`2000-01-01T${horaFim}`);
            const tempoUso = Math.round((fim - inicio) / (1000 * 60));
            try {
                await db.collection('saunas').doc(saunaId).update({
                    horaFim: horaFim,
                    tempoUso: tempoUso,
                    status: 'concluido',
                    dataAtualizacao: new Date().toISOString()
                });
                await loadSystemData();
                closeSaunaModal();
                if (currentModule === 'sauna') {
                    loadSaunaContent();
                }
                alert('Uso da sauna concluído com sucesso! Tempo de uso: ' + tempoUso + ' minutos');
            } catch (error) {
                console.error('Erro ao concluir sauna:', error);
                alert('Erro ao concluir sauna. Tente novamente.');
            }
        }
        async function deleteSauna(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este agendamento de sauna?')) return;
            try {
                await db.collection('saunas').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'sauna') {
                    loadSaunaContent();
                }
                alert('Agendamento de sauna excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir agendamento de sauna:', error);
                alert('Erro ao excluir agendamento de sauna. Tente novamente.');
            }
        }
        // ========== FUNÇÕES DE USUÁRIOS ==========
        function openUserModal() {
            document.getElementById('userModalTitle').textContent = 'Cadastrar Usuário';
            document.getElementById('editingUserId').value = '';
            document.getElementById('userForm').reset();
            document.getElementById('userSenha').required = true;
            document.getElementById('senhaObrigatoria').style.display = 'inline';
            document.getElementById('senhaInfo').style.display = 'none';
            loadCondominiosForPermissions();
            loadModulesForPermissions();
            document.getElementById('userModal').style.display = 'flex';
        }
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }
        function loadCondominiosForPermissions() {
            const container = document.getElementById('condominiosPermitidos');
            container.innerHTML = '';
            condominios.forEach(condominio => {
                const item = document.createElement('div');
                item.className = 'permission-item';
                item.innerHTML = `
                    <input type="checkbox" id="condominio-${condominio.id}" value="${condominio.id}">
                    <label for="condominio-${condominio.id}">${condominio.nome}</label>
                `;
                container.appendChild(item);
            });
        }
        function loadModulesForPermissions() {
            const container = document.getElementById('permissoesUsuario');
            container.innerHTML = '';
            modules.forEach(module => {
                const item = document.createElement('div');
                item.className = 'permission-item';
                item.innerHTML = `
                    <input type="checkbox" id="module-${module.id}" value="${module.id}">
                    <label for="module-${module.id}">${module.name}</label>
                `;
                container.appendChild(item);
            });
        }
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const editingId = document.getElementById('editingUserId').value;
            const userData = {
                nome: document.getElementById('userNome').value,
                usuario: document.getElementById('userUsuario').value,
                email: document.getElementById('userEmail').value,
                telefone: document.getElementById('userTelefone').value,
                tipo: document.getElementById('userTipo').value,
                status: 'ativo',
                criadoPor: currentUser.id || currentUser.usuario,
                dataAtualizacao: new Date().toISOString()
            };
            const senha = document.getElementById('userSenha').value;
            if (!editingId || senha) {
                userData.senha = senha;
            }
            if (!editingId) {
                userData.dataCriacao = new Date().toISOString();
            }
            const condominiosPermitidos = [];
            document.querySelectorAll('#condominiosPermitidos input:checked').forEach(checkbox => {
                condominiosPermitidos.push(checkbox.value);
            });
            userData.condominios = condominiosPermitidos;
            const modulosPermitidos = [];
            document.querySelectorAll('#permissoesUsuario input:checked').forEach(checkbox => {
                modulosPermitidos.push(checkbox.value);
            });
            userData.permissoes = modulosPermitidos;
            try {
                if (editingId) {
                    await db.collection('usuarios').doc(editingId).update(userData);
                } else {
                    await db.collection('usuarios').add(userData);
                }
                await loadSystemData();
                closeUserModal();
                if (currentModule === 'usuarios') {
                    loadUsuariosContent();
                }
                alert('Usuário salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar usuário:', error);
                alert('Erro ao salvar usuário. Tente novamente.');
            }
        });
        function editUser(id) {
    const usuario = usuarios.find(u => u.id === id);
    if (!usuario) return;

    document.getElementById('userModalTitle').textContent = 'Editar Usuário';
    document.getElementById('editingUserId').value = usuario.id;
    document.getElementById('userNome').value = usuario.nome;
    document.getElementById('userUsuario').value = usuario.usuario;
    document.getElementById('userEmail').value = usuario.email || '';
    document.getElementById('userTelefone').value = usuario.telefone || '';
    document.getElementById('userSenha').value = '';
    document.getElementById('userSenha').required = false;
    document.getElementById('senhaObrigatoria').style.display = 'none';
    document.getElementById('senhaInfo').style.display = 'block';

    // ✅ CORREÇÃO: Define o tipo de usuário salvo no <select>
    const tipoSelect = document.getElementById('userTipo');
    tipoSelect.value = usuario.tipo || '';  // ← Define o valor salvo

    loadCondominiosForPermissions();
    if (usuario.condominios) {
        usuario.condominios.forEach(condominioId => {
            const checkbox = document.getElementById(`condominio-${condominioId}`);
            if (checkbox) checkbox.checked = true;
        });
    }

    loadModulesForPermissions();
    if (usuario.permissoes) {
        usuario.permissoes.forEach(moduleId => {
            const checkbox = document.getElementById(`module-${moduleId}`);
            if (checkbox) checkbox.checked = true;
        });
    }

    document.getElementById('userModal').style.display = 'flex';
}
        async function deleteUser(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este usuário?')) return;
            try {
                await db.collection('usuarios').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'usuarios') {
                    loadUsuariosContent();
                }
                alert('Usuário excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir usuário:', error);
                alert('Erro ao excluir usuário. Tente novamente.');
            }
        }
        // ========== FUNÇÕES DE CONDOMÍNIOS ==========
        function openCondominioModal() {
            document.getElementById('condominioModalTitle').textContent = 'Cadastrar Condomínio';
            document.getElementById('editingCondominioId').value = '';
            document.getElementById('condominioForm').reset();
            document.getElementById('condominioModal').style.display = 'flex';
        }
        function closeCondominioModal() {
            document.getElementById('condominioModal').style.display = 'none';
        }
        document.getElementById('condominioForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const editingId = document.getElementById('editingCondominioId').value;
            const condominioData = {
                nome: document.getElementById('condominioNome').value,
                endereco: document.getElementById('condominioEndereco').value,
                cidade: document.getElementById('condominioCidade').value,
                estado: document.getElementById('condominioEstado').value,
                cep: document.getElementById('condominioCEP').value,
                telefone: document.getElementById('condominioTelefone').value,
                cnpj: document.getElementById('condominioCNPJ').value,
                unidades: parseInt(document.getElementById('condominioUnidades').value) || 0,
                status: document.getElementById('condominioStatus').value,
                criadoPor: currentUser.id || currentUser.usuario,
                dataAtualizacao: new Date().toISOString()
            };
            if (!editingId) {
                condominioData.dataCriacao = new Date().toISOString();
            }
            try {
                if (editingId) {
                    await db.collection('condominios').doc(editingId).update(condominioData);
                } else {
                    await db.collection('condominios').add(condominioData);
                }
                await loadSystemData();
                closeCondominioModal();
                if (currentModule === 'condominios') {
                    loadCondominiosContent();
                }
                alert('Condomínio salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar condomínio:', error);
                alert('Erro ao salvar condomínio. Tente novamente.');
            }
        });
        function editCondominio(id) {
            const condominio = condominios.find(c => c.id === id);
            if (!condominio) return;
            document.getElementById('condominioModalTitle').textContent = 'Editar Condomínio';
            document.getElementById('editingCondominioId').value = condominio.id;
            document.getElementById('condominioNome').value = condominio.nome;
            document.getElementById('condominioEndereco').value = condominio.endereco;
            document.getElementById('condominioCidade').value = condominio.cidade;
            document.getElementById('condominioEstado').value = condominio.estado;
            document.getElementById('condominioCEP').value = condominio.cep || '';
            document.getElementById('condominioTelefone').value = condominio.telefone || '';
            document.getElementById('condominioCNPJ').value = condominio.cnpj || '';
            document.getElementById('condominioUnidades').value = condominio.unidades || '';
            document.getElementById('condominioStatus').value = condominio.status || 'ativo';
            document.getElementById('condominioModal').style.display = 'flex';
        }
        async function deleteCondominio(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este condomínio?')) return;
            try {
                await db.collection('condominios').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'condominios') {
                    loadCondominiosContent();
                }
                alert('Condomínio excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir condomínio:', error);
                alert('Erro ao excluir condomínio. Tente novamente.');
            }
        }
        // ========== FUNÇÕES PARA MORADORES ==========
        function openMoradorModal() {
            document.getElementById('moradorModalTitle').textContent = 'Cadastrar Morador';
            document.getElementById('editingMoradorId').value = '';
            document.getElementById('moradorForm').reset();
            document.getElementById('moradorModal').style.display = 'flex';
        }
        function closeMoradorModal() {
            document.getElementById('moradorModal').style.display = 'none';
        }
        document.getElementById('moradorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentCondominio) {
                alert('Selecione um condomínio primeiro!');
                return;
            }
            const editingId = document.getElementById('editingMoradorId').value;
            const moradorData = {
                nome: document.getElementById('moradorNome').value,
                apto: document.getElementById('moradorApto').value,
                telefone: document.getElementById('moradorTelefone').value,
                garagem: document.getElementById('moradorGaragem').value,
                vaga: document.getElementById('moradorVaga').value,
                placa: document.getElementById('moradorPlaca').value.trim().toUpperCase(),
                observacoes: document.getElementById('moradorObservacoes').value,
                condominioId: currentCondominio.id,
                condominioNome: currentCondominio.nome,
                criadoPor: currentUser.id || currentUser.usuario,
                criadoEm: new Date().toISOString()
            };
            try {
                if (editingId) {
                    await db.collection('moradores').doc(editingId).update(moradorData);
                } else {
                    await db.collection('moradores').add(moradorData);
                }
                await loadSystemData();
                closeMoradorModal();
                if (currentModule === 'moradores') {
                    loadMoradoresContent();
                }
                alert('Morador salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar morador:', error);
                alert('Erro ao salvar morador. Tente novamente.');
            }
        });
        function editMorador(id) {
            const morador = moradores.find(m => m.id === id);
            if (!morador) return;
            document.getElementById('moradorModalTitle').textContent = 'Editar Morador';
            document.getElementById('editingMoradorId').value = morador.id;
            document.getElementById('moradorNome').value = morador.nome;
            document.getElementById('moradorApto').value = morador.apto;
            document.getElementById('moradorTelefone').value = morador.telefone || '';
            document.getElementById('moradorGaragem').value = morador.garagem || '';
            document.getElementById('moradorVaga').value = morador.vaga || '';
            document.getElementById('moradorPlaca').value = morador.placa || '';
            document.getElementById('moradorObservacoes').value = morador.observacoes || '';
            document.getElementById('moradorModal').style.display = 'flex';
        }
        async function deleteMorador(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir este morador?')) return;
            try {
                await db.collection('moradores').doc(id).delete();
                await loadSystemData();
                if (currentModule === 'moradores') {
                    loadMoradoresContent();
                }
                alert('Morador excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir morador:', error);
                alert('Erro ao excluir morador. Tente novamente.');
            }
        }
        // ✅ Logout automático ao fechar/sair — sem popup irritante
let unloadTriggered = false;

function autoLogout() {
    if (!currentUser || unloadTriggered) return;
    unloadTriggered = true;

    // Atualiza status no Firebase (marca como offline)
    if (presenceRef) {
        presenceRef.update({
            online: false,
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(err => console.warn("Erro ao atualizar presença:", err));
    }

    // Limpa dados locais
    localStorage.removeItem('currentUser');

    // Reseta estado da aplicação
    currentUser = null;
    currentCondominio = null;
    vales = []; usuarios = []; horasExtras = []; moradores = [];
    agendamentos = []; limpezas = []; saunas = []; contas = [];
    lembretes = []; compras = []; palavrasChave = [];

    // Mostra login se ainda estiver na página
    if (document.readyState !== 'unloading') {
        showLoginPage();
    }
}

// ✅ Logout automático SOMENTE ao fechar a janela/aba (não ao minimizar ou trocar)
let userManuallyLoggedOut = false;

function safeAutoLogout() {
    if (userManuallyLoggedOut || !currentUser || !currentUser.id) return;

    // Atualiza presença no Firebase (marca como offline)
    if (presenceRef) {
        presenceRef.update({
            online: false,
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(console.warn);
    }

    // Limpa dados locais
    localStorage.removeItem('currentUser');
    
    // Reseta estado global
    currentUser = null;
    currentCondominio = null;
    // ... (outros arrays: vales = []; usuarios = []; etc.)

    // Mostra login apenas se ainda estiver na página
    if (document.readyState !== 'unloading') {
        showLoginPage();
    }
}

// Detecta saída REAL (fechar ou recarregar)
window.addEventListener('beforeunload', function(e) {
    if (currentUser && currentUser.id && !userManuallyLoggedOut) {
        // Apenas marca que vai sair — NÃO mostra alerta irritante!
        // O logout real ocorrerá no `pagehide` abaixo, mas só se for fechamento (não troca de aba)
        return; // não exibe popup (modernamente evitamos isso)
    }
});

        // ========== PRESENCE SYSTEM ==========
        function setupPresence() {
            if (!currentUser) return;
            const userPresenceRef = db.collection('presence').doc(currentUser.id);
            presenceRef = userPresenceRef;
            const onClose = () => {
                if (presenceRef) {
                    presenceRef.update({
                        online: false,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            };
            userPresenceRef.set({
                userId: currentUser.id,
                nome: currentUser.nome || currentUser.usuario,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                online: true
            }, { merge: true });
            const keepAlive = setInterval(() => {
                if (presenceRef) {
                    presenceRef.update({
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                        online: true
                    });
                }
            }, 30000);
            window.addEventListener('beforeunload', onClose);
            window.addEventListener('pagehide', onClose);
            window.addEventListener('beforeunload', () => {
                clearInterval(keepAlive);
            });
        }
        async function updateOnlineCount() {
    // 🔒 Proteção extra: só executa se usuário estiver logado
    if (!currentUser || !currentUser.id) {
        document.getElementById('onlineCount').textContent = '0';
        return;
    }

    try {
        const cutoff = new Date(Date.now() - 60000); // 60 segundos atrás
        const snapshot = await db.collection('presence')
            .where('lastSeen', '>=', firebase.firestore.Timestamp.fromDate(cutoff))
            .where('online', '==', true)
            .get();

        const onlineUsers = [];
        snapshot.forEach(doc => {
            const userData = doc.data();
            // ✅ Só adiciona outros usuários (não inclui o próprio)
            if (userData.userId && userData.userId !== currentUser.id) {
                onlineUsers.push(userData);
            }
        });

        const count = onlineUsers.length;
        document.getElementById('onlineCount').textContent = count;

        if (count > 0) {
            const userNames = onlineUsers.map(user => user.nome || 'Usuário').join(', ');
            document.querySelector('.online-indicator').title = `Online: ${userNames}`;
        } else {
            document.querySelector('.online-indicator').title = 'Ninguém mais online';
        }
    } catch (error) {
        console.error('Erro ao atualizar contagem online:', error);
        document.getElementById('onlineCount').textContent = '0';
    }
}
                function showOnlineUsers() {
            const cutoff = new Date(Date.now() - 60000);
            db.collection('presence')
                .where('lastSeen', '>=', firebase.firestore.Timestamp.fromDate(cutoff))
                .where('online', '==', true)
                .get()
                .then(snapshot => {
                    const onlineUsers = [];
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        onlineUsers.push(userData.nome);
                    });
                    if (onlineUsers.length > 0) {
                        // Corrigido: Usando \n para quebra de linha
                        alert(`Usuários Online:\n${onlineUsers.join('\n')}`);
                    } else {
                        alert('Nenhum outro usuário online no momento.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar usuários online:', error);
                    alert('Erro ao carregar lista de usuários online.');
                });
        }
        // ========== REALTIME LISTENERS ==========
        function setupRealtimeListeners() {
              // Listener para agendamentos (atualização automática de status)
    db.collection('agendamentos').onSnapshot((snapshot) => {
        snapshot.docChanges().forEach((change) => {
            if (change.type === 'modified') {
                // Recarrega os dados quando um agendamento é modificado
                loadSystemData().then(() => {
                    if (currentModule === 'dashboard') {
                        loadDashboardContent();
                    }
                    if (currentModule === 'agendamentos') {
                        loadAgendamentosList();
                    }
                });
            }
        });
    });
            const globalCollections = ['usuarios', 'condominios'];
            globalCollections.forEach(collection => {
                db.collection(collection).onSnapshot(() => {
                    if (document.getElementById('mainSystem').style.display !== 'none') {
                        loadSystemData().then(() => {
                            if (currentModule) loadModuleContent(currentModule);
                            loadTickerContent();
                        });
                    }
                });
            });
            if (currentCondominio) {
                const condominioCollections = ['moradores', 'confraternizacoes', 'horasExtras', 'palavrasChave', 'limpezas', 'saunas', 'agendamentos', 'contas', 'lembretes', 'ocorrencias', 'prestadores', 'compras', 'tarefas' ]; // <-- Adicionado 'compras'
                condominioCollections.forEach(collection => {
                    db.collection(collection)
    .where('condominioId', '==', currentCondominio.id)
    .onSnapshot(() => {
        if (document.getElementById('mainSystem').style.display !== 'none') {
            loadSystemData().then(() => {
                if (currentModule) loadModuleContent(currentModule);
                loadTickerContent();
                // ✅ Atualiza os cards da Dashboard se estiver nela
                if (currentModule === 'dashboard') {
                    atualizarCardsPalavrasChave(); // ← sua função já existe!
                }
                // ✅ Atualiza a tabela se estiver no módulo de palavras-chave
                if (currentModule === 'palavras-chave') {
                    loadPalavrasChaveContent();
                }
            });
        }
    });
                });
            }
            db.collection('presence').onSnapshot(() => {
                updateOnlineCount();
            });
        }
        // ========== FUNÇÕES DE LOGIN ==========
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
         document.getElementById('palavraChaveTexto')?.addEventListener('input', function() {
    const palavras = this.value.split(',').map(p => p.trim()).filter(p => p);
    document.getElementById('palavraChaveCount').textContent = palavras.length;
});
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            document.getElementById('loginBtnText').style.display = 'none';
            document.getElementById('loginLoading').style.display = 'inline-block';
            document.getElementById('loginBtn').disabled = true;
            try {
                const usuariosSnapshot = await db.collection('usuarios').where('usuario', '==', username).get();
                if (usuariosSnapshot.empty) {
                    throw new Error('Usuário não encontrado');
                }
                let userFound = null;
                usuariosSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.senha === password) {
                        userFound = {
                            id: doc.id,
                            ...userData
                        };
                    }
                });
                if (!userFound) {
                    throw new Error('Senha incorreta');
                }
                if (password === 'admin123' || password === '0000') {
                    currentUser = userFound;
                    document.getElementById('changePasswordModal').style.display = 'flex';
                } else {
                    currentUser = userFound;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    await loadSystemData();
                    showMainSystem();
                    setupPresence();
                    setupRealtimeListeners();
                    setInterval(updateOnlineCount, 10000);
                }
            } catch (error) {
                console.error('Erro no login:', error);
                document.getElementById('loginStatus').textContent = error.message || 'Erro ao fazer login';
                document.getElementById('loginStatus').style.color = 'red';
            } finally {
                document.getElementById('loginBtnText').style.display = 'inline';
                document.getElementById('loginLoading').style.display = 'none';
                document.getElementById('loginBtn').disabled = false;
            }
        });
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (newPassword !== confirmPassword) {
                alert('As senhas não coincidem!');
                return;
            }
            if (newPassword.length < 6) {
                alert('A senha deve ter pelo menos 6 caracteres!');
                return;
            }
            try {
                await db.collection('usuarios').doc(currentUser.id).update({
                    senha: newPassword,
                    primeiroLogin: false
                });
                document.getElementById('changePasswordModal').style.display = 'none';
                currentUser.senha = newPassword;
                currentUser.primeiroLogin = false;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                await loadSystemData();
                showMainSystem();
                setupPresence();
                setupRealtimeListeners();
                setInterval(updateOnlineCount, 10000);
                alert('Senha alterada com sucesso!');
            } catch (error) {
                console.error('Erro ao alterar senha:', error);
                alert('Erro ao alterar senha. Tente novamente.');
            }
        });
        document.getElementById('logoutBtn').addEventListener('click', function() {
    if (confirm('Deseja realmente sair do sistema?')) {
        
        if (presenceRef) {
            presenceRef.update({
                online: false,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        localStorage.removeItem('currentUser');
        currentUser = null;
        currentCondominio = null;
        showLoginPage();
    }
});
        document.getElementById('sidebarToggle').addEventListener('click', function() {
    const sidebar = document.querySelector('.sidebar');
    const mainContent = document.querySelector('.main-content');
    const isExpanded = sidebar.classList.contains('expanded');

    if (isExpanded) {
        // Fecha o menu
        sidebar.classList.remove('expanded');
        sidebar.style.width = '70px';
        mainContent.style.marginLeft = '70px';
        document.querySelectorAll('.sidebar-menu a span').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.sidebar-menu a i').forEach(el => el.style.marginRight = '0');
    } else {
        // Abre o menu
        sidebar.classList.add('expanded');
        sidebar.style.width = '280px';
        mainContent.style.marginLeft = '280px';
        document.querySelectorAll('.sidebar-menu a span').forEach(el => el.style.display = 'inline');
        document.querySelectorAll('.sidebar-menu a i').forEach(el => el.style.marginRight = '10px');
    }
});
        async function handleCondominioChange(condominioId) {
            if (!condominioId) {
                currentCondominio = null;
            } else {
                currentCondominio = condominios.find(c => c.id === condominioId);
            }
            const condominioSelectTop = document.getElementById('condominioSelectTop');
            const currentCondominioBadge = document.getElementById('currentCondominioBadge');
            if (condominioSelectTop) condominioSelectTop.value = condominioId || '';
            if (currentCondominioBadge) {
                currentCondominioBadge.textContent = currentCondominio ? currentCondominio.nome : 'Nenhum condomínio selecionado';
            }
            await loadSystemData();
            if (currentModule) {
                loadModuleContent(currentModule);
            }
            loadTickerContent();
        }
        // Evento de mudança no seletor da top bar
        document.getElementById('condominioSelectTop').addEventListener('change', function() {
            handleCondominioChange(this.value);
        });
        // ========== FUNÇÕES DE RELATÓRIOS ==========
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            let reportContent = '';
            switch(reportType) {
                case 'agendamentos':
                    reportContent = generateAgendamentosReport(startDate, endDate);
                    break;
                case 'usuarios':
                    reportContent = generateUsuariosReport();
                    break;
                case 'moradores':
                    reportContent = generateMoradoresReport();
                    break;
                case 'limpeza':
                    reportContent = generateLimpezaReport(startDate, endDate);
                    break;
                case 'horas-extras':
                    reportContent = generateHorasExtrasReport(startDate, endDate);
                    break;
                case 'sauna':
                    reportContent = generateSaunaReport(startDate, endDate);
                    break;
                case 'contas':
                    reportContent = generateContasReport(startDate, endDate);
                    break;
                case 'compras': // <-- Novo Caso
                    reportContent = generateComprasReport(startDate, endDate);
                    break;
            }
            document.getElementById('reportPreview').innerHTML = reportContent;
        }
        function generateAgendamentosReport(startDate, endDate) {
            let filteredAgendamentos = agendamentos.filter(a =>
                a.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (startDate) {
                filteredAgendamentos = filteredAgendamentos.filter(a => a.data >= startDate);
            }
            if (endDate) {
                filteredAgendamentos = filteredAgendamentos.filter(a => a.data <= endDate);
            }
            let report = `<h4>Relatório de Agendamentos</h4>`;
            report += `<p>Período: ${startDate || 'Início'} a ${endDate || 'Fim'}</p>`;
            report += `<p>Condomínio: ${currentCondominio ? currentCondominio.nome : 'Todos'}</p>`;
            report += `<p>Total de agendamentos: ${filteredAgendamentos.length}</p>`;
            report += `<div class="report-line"><strong>Data | Espaço | Solicitante | Unidade | Horário | Status</strong></div>`;
            filteredAgendamentos.forEach(agendamento => {
                report += `<div class="report-line">`;
                report += `${formatDate(agendamento.data)} | `;
                report += `${getEspacoNome(agendamento.espaco)} | `;
                report += `${agendamento.responsavel} | `;
                report += `${agendamento.unidade} | `;
                report += `${agendamento.horaInicio}-${agendamento.horaFim} | `;
                report += `${formatStatusAgendamento(agendamento.status)}`;
                report += `</div>`;
            });
            return report;
        }
        function generateUsuariosReport() {
            let report = `<h4>Relatório de Usuários</h4>`;
            report += `<p>Total de usuários: ${usuarios.length}</p>`;
            report += `<div class="report-line"><strong>Nome | Usuário | Tipo | E-mail | Status</strong></div>`;
            usuarios.forEach(usuario => {
                report += `<div class="report-line">`;
                report += `${usuario.nome} | `;
                report += `${usuario.usuario} | `;
                report += `${formatUserType(usuario.tipo)} | `;
                report += `${usuario.email || 'N/A'} | `;
                report += `${usuario.status === 'ativo' ? 'Ativo' : 'Inativo'}`;
                report += `</div>`;
            });
            return report;
        }
        function generateMoradoresReport() {
            const filteredMoradores = currentCondominio ?
                moradores.filter(m => m.condominioId === currentCondominio.id) :
                moradores;
            let report = `<h4>Relatório de Moradores</h4>`;
            report += `<p>Condomínio: ${currentCondominio ? currentCondominio.nome : 'Todos'}</p>`;
            report += `<p>Total de moradores: ${filteredMoradores.length}</p>`;
            report += `<div class="report-line"><strong>Morador | Apartamento | Telefone | Garagem | Vaga</strong></div>`;
            filteredMoradores.forEach(morador => {
                report += `<div class="report-line">`;
                report += `${morador.nome} | `;
                report += `${morador.apto} | `;
                report += `${morador.telefone || '-'} | `;
                report += `${morador.garagem || '-'} | `;
                report += `${morador.vaga || '-'}`;
                report += `</div>`;
            });
            return report;
        }
        function generateLimpezaReport(startDate, endDate) {
            let filteredLimpezas = limpezas.filter(l =>
                l.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (startDate) {
                filteredLimpezas = filteredLimpezas.filter(l => l.data >= startDate);
            }
            if (endDate) {
                filteredLimpezas = filteredLimpezas.filter(l => l.data <= endDate);
            }
            let report = `<h4>Relatório de Limpeza</h4>`;
            report += `<p>Período: ${startDate || 'Início'} a ${endDate || 'Fim'}</p>`;
            report += `<p>Condomínio: ${currentCondominio ? currentCondominio.nome : 'Todos'}</p>`;
            report += `<p>Total de registros: ${filteredLimpezas.length}</p>`;
            report += `<div class="report-line"><strong>Data | Responsável | Espaço | Horário | Tempo | Status</strong></div>`;
            filteredLimpezas.forEach(limpeza => {
                report += `<div class="report-line">`;
                report += `${formatDate(limpeza.data)} | `;
                report += `${limpeza.responsavel} | `;
                report += `${getEspacoNome(limpeza.espaco)} | `;
                report += `${limpeza.horaInicio} ${limpeza.horaFim ? '-' + limpeza.horaFim : ''} | `;
                report += `${limpeza.tempoUso || '-'} min | `;
                report += `${limpeza.status === 'concluido' ? 'Concluído' : 'Em Andamento'}`;
                report += `</div>`;
            });
            return report;
        }
        function generateHorasExtrasReport(startDate, endDate) {
            let filteredHorasExtras = horasExtras.filter(h =>
                h.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (startDate) {
                filteredHorasExtras = filteredHorasExtras.filter(h => h.data >= startDate);
            }
            if (endDate) {
                filteredHorasExtras = filteredHorasExtras.filter(h => h.data <= endDate);
            }
            const totalHoras = filteredHorasExtras.reduce((sum, h) => sum + h.quantidade, 0);
            let report = `<h4>Relatório de Horas Extras</h4>`;
            report += `<p>Período: ${startDate || 'Início'} a ${endDate || 'Fim'}</p>`;
            report += `<p>Condomínio: ${currentCondominio ? currentCondominio.nome : 'Todos'}</p>`;
            report += `<p>Total de registros: ${filteredHorasExtras.length}</p>`;
            report += `<p>Total de horas: ${totalHoras}</p>`;
            report += `<div class="report-line"><strong>Data | Funcionário | Matrícula | Quantidade (h) | Condomínio</strong></div>`;
            filteredHorasExtras.forEach(horaExtra => {
                report += `<div class="report-line">`;
                report += `${formatDate(horaExtra.data)} | `;
                report += `${horaExtra.funcionario} | `;
                report += `${horaExtra.matricula} | `;
                report += `${horaExtra.quantidade} | `;
                report += `${horaExtra.condominioNome}`;
                report += `</div>`;
            });
            return report;
        }
        function generateSaunaReport(startDate, endDate) {
            let filteredSaunas = saunas.filter(s =>
                s.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (startDate) {
                filteredSaunas = filteredSaunas.filter(s => s.data >= startDate);
            }
            if (endDate) {
                filteredSaunas = filteredSaunas.filter(s => s.data <= endDate);
            }
            let report = `<h4>Relatório de Sauna</h4>`;
            report += `<p>Período: ${startDate || 'Início'} a ${endDate || 'Fim'}</p>`;
            report += `<p>Condomínio: ${currentCondominio ? currentCondominio.nome : 'Todos'}</p>`;
            report += `<p>Total de agendamentos: ${filteredSaunas.length}</p>`;
            report += `<div class="report-line"><strong>Data | Morador | Apartamento | Horário | Tempo | Status</strong></div>`;
            filteredSaunas.forEach(sauna => {
                report += `<div class="report-line">`;
                report += `${formatDate(sauna.data)} | `;
                report += `${sauna.morador} | `;
                report += `${sauna.apto} | `;
                report += `${sauna.horaInicio} ${sauna.horaFim ? '-' + sauna.horaFim : ''} | `;
                report += `${sauna.tempoUso || '-'} min | `;
                report += `${formatStatusSauna(sauna.status)}`;
                report += `</div>`;
            });
            return report;
        }
        function generateContasReport(startDate, endDate) {
            let filteredContas = contas.filter(c =>
                c.condominioId === (currentCondominio ? currentCondominio.id : '')
            );
            if (startDate) {
                filteredContas = filteredContas.filter(c => c.vencimento >= startDate);
            }
            if (endDate) {
                filteredContas = filteredContas.filter(c => c.vencimento <= endDate);
            }
            const total = filteredContas.reduce((sum, conta) => sum + conta.valor, 0);
            let report = `<h4>Relatório de Contas a Pagar</h4>`;
            report += `<p>Período: ${startDate || 'Início'} a ${endDate || 'Fim'}</p>`;
            report += `<p>Condomínio: ${currentCondominio ? currentCondominio.nome : 'Todos'}</p>`;
            report += `<p>Total de contas: ${filteredContas.length}</p>`;
            report += `<p>Valor total: R$ ${total.toFixed(2)}</p>`;
            report += `<div class="report-line"><strong>Vencimento | Descrição | Valor | Categoria | Status</strong></div>`;
            filteredContas.forEach(conta => {
                report += `<div class="report-line">`;
                report += `${formatDate(conta.vencimento)} | `;
                report += `${conta.descricao} | `;
                report += `R$ ${conta.valor.toFixed(2)} | `;
                report += `${formatCategoriaConta(conta.categoria)} | `;
                report += `${formatStatusConta(conta.status)}`;
                report += `</div>`;
            });
            return report;
        }
        // ========== RELATÓRIO DE COMPRAS ==========
        function generateComprasReport(startDate, endDate) {
    let filteredCompras = compras.filter(c => c.condominioId === (currentCondominio ? currentCondominio.id : ''));
    if (startDate) filteredCompras = filteredCompras.filter(c => c.dataFatura >= startDate);
    if (endDate) filteredCompras = filteredCompras.filter(c => c.dataFatura <= endDate);

    const total = filteredCompras.reduce((sum, c) => sum + (c.valorTotal || c.itens.reduce((s, i) => s + i.quantidade * i.valorUnitario, 0)), 0);
    let report = `<h4>Relatório de Compras</h4>`;
    report += `<p>Período: ${startDate || 'Início'} a ${endDate || 'Fim'}</p>`;
    report += `<p>Condomínio: ${currentCondominio ? currentCondominio.nome : 'Todos'}</p>`;
    report += `<p>Total de compras: ${filteredCompras.length}</p>`;
    report += `<p>Valor total: R$ ${total.toFixed(2)}</p>`;
    report += `<div class="report-line"><strong>Fornecedor | Data Fatura | Vencimento | Valor | Status | Obs.</strong></div>`;
    filteredCompras.forEach(c => {
        const valor = c.valorTotal || c.itens.reduce((s, i) => s + i.quantidade * i.valorUnitario, 0);
        report += `<div class="report-line">`;
        report += `${c.fornecedor} | `;
        report += `${formatDate(c.dataFatura)} | `;
        report += `${formatDate(c.vencimento)} | `;
        report += `R$ ${valor.toFixed(2)} | `;
        report += `${formatStatusCompra(c.status)} | `;
        report += `${(c.observacoes || '').substring(0, 50)}${c.observacoes && c.observacoes.length > 50 ? '...' : ''}`;
        report += `</div>`;
    });
    return report;
}

        function exportReport() {
            const reportPreview = document.getElementById('reportPreview').innerText;
            const blob = new Blob([reportPreview], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'relatorio.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        // ========== FUNÇÕES DE ORDENAÇÃO PARA MORADORES ==========
        let currentMoradoresSort = { field: 'apto', direction: 'asc' };
        function loadMoradoresTableData(moradoresArray) {
            const tbody = document.getElementById('moradoresTbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            moradoresArray.forEach(morador => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${morador.nome}</td>
                    <td>${morador.apto}</td>
                    <td>${morador.telefone || '-'}</td>
                    <td>${morador.garagem || '-'}</td>
                    <td>${morador.vaga || '-'}</td>
                    <td>${morador.placa || '—'}</td> 
                    <td>${morador.observacoes || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editMorador('${morador.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${podeExcluirRegistros() ? `
                        <button class="btn btn-sm btn-danger" onclick="deleteMorador('${morador.id}')">
                            <i class="fas fa-trash"></i>
                        </button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        function sortMoradores(field) {
            if (currentMoradoresSort.field === field) {
                currentMoradoresSort.direction = currentMoradoresSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentMoradoresSort.field = field;
                currentMoradoresSort.direction = 'asc';
            }
            const filteredMoradores = moradores.filter(m => m.condominioId === currentCondominio.id);
            const sortedMoradores = filteredMoradores.sort((a, b) => {
                let valueA = a[field];
                let valueB = b[field];
                if (field === 'apto') {
                    valueA = extractNumberFromApto(valueA);
                    valueB = extractNumberFromApto(valueB);
                }
                if (valueA < valueB) return currentMoradoresSort.direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return currentMoradoresSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            loadMoradoresTableData(sortedMoradores);
            updateSortIcons(field);
        }
        function extractNumberFromApto(apto) {
            if (!apto) return 0;
            const match = apto.toString().match(/\d+/);
            return match ? parseInt(match[0]) : 0;
        }
        function updateSortIcons(activeField) {
            document.querySelectorAll('#moradoresTable th i').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            const activeHeader = document.querySelector(`#moradoresTable th[onclick="sortMoradores('${activeField}')"] i`);
            if (activeHeader) {
                activeHeader.className = currentMoradoresSort.direction === 'asc'
                    ? 'fas fa-sort-up'
                    : 'fas fa-sort-down';
            }
        }
        // ✅ Função para atualizar status de agendamentos automaticamente
async function atualizarStatusAutomatico() {
    if (!currentCondominio) return;

    const agora = new Date();
    const dataHoje = agora.toISOString().split('T')[0]; // ex: "2025-11-29"
    const horaAgora = agora.getHours().toString().padStart(2, '0') + ':' + 
                      agora.getMinutes().toString().padStart(2, '0'); // ex: "12:05"

    // Filtra agendamentos ATIVOS de HOJE no condomínio atual
    const agendamentosAtivos = agendamentos.filter(a => 
        a.condominioId === currentCondominio.id &&
        a.data === dataHoje &&
        ['agendado', 'em-uso'].includes(a.status)
    );

    for (const ag of agendamentosAtivos) {
        // Compara horaAgora com ag.horaFim (ambos no formato "HH:mm")
        if (horaAgora >= ag.horaFim) {
            try {
                // Atualiza no Firestore
                await db.collection('agendamentos').doc(ag.id).update({
                    status: 'liberado',
                    dataAtualizacao: new Date().toISOString()
                });
                console.log(`✅ Agendamento ${ag.id} atualizado para 'liberado' automaticamente.`);
            } catch (err) {
                console.error('Erro ao atualizar agendamento automaticamente:', ag.id, err);
            }
        }
    }

    // Após atualizar, recarrega os dados para manter a interface sincronizada
    await loadSystemData();
    if (currentModule === 'dashboard') loadDashboardContent();
    if (currentModule === 'agendamentos') loadAgendamentosList(); // ← Usa a função correta!
}
        // ========== INICIALIZAÇÃO ==========
        document.getElementById('newPassword')?.addEventListener('input', function() {
            const password = this.value;
            const strengthBar = document.getElementById('passwordStrength');
            let strength = 0;
            if (password.length >= 6) strength++;
            if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
            if (password.match(/\d/)) strength++;
            if (password.match(/[^a-zA-Z\d]/)) strength++;
            strengthBar.className = 'password-strength ';
            if (strength <= 1) strengthBar.className += 'strength-weak';
            else if (strength === 2) strengthBar.className += 'strength-fair';
            else if (strength === 3) strengthBar.className += 'strength-good';
            else if (strength >= 4) strengthBar.className += 'strength-strong';
        });
        // --- CONTROLE DE EXCLUSÃO ATUALIZADO ---
        function updateDeleteButtonsState() {
            const canDelete = podeExcluirRegistros();
            document.querySelectorAll('button.btn-danger, a.btn-danger').forEach(btn => {
                try {
                    btn.disabled = !canDelete;
                    if (!canDelete) {
                        btn.classList.add('disabled');
                        btn.style.opacity = '0.6';
                        btn.style.pointerEvents = 'none';
                    } else {
                        btn.classList.remove('disabled');
                        btn.style.opacity = '';
                        btn.style.pointerEvents = 'auto';
                    }
                } catch (err) {}
            });
        }
        const observer = new MutationObserver(function() {
            updateDeleteButtonsState();
        });
        observer.observe(document.body, { childList: true, subtree: true });
        // --- Módulo: Ocorrências (básico) ---
        async function loadOcorrenciasContent() {
            currentModule = 'ocorrencias';
            document.querySelectorAll('.sidebar-menu a').forEach(item => item.classList.remove('active'));
            const activeItem = document.querySelector(`.sidebar-menu a[onclick="changeModule('ocorrencias')"]`);
            if (activeItem) activeItem.classList.add('active');
            const moduleContent = document.getElementById('moduleContent');
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <span>Ocorrências</span>
                        <div>
                            <button class="btn btn-primary" onclick="openOcorrenciaModal()">Nova Ocorrência</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table" id="ocorrenciasTable">
                            <thead><tr><th>Morador</th><th>Apto</th><th>Data/Hora</th><th>Descrição</th><th>Status</th><th>Ações</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <!-- Modal Ocorrência -->
                <div id="ocorrenciaModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Ocorrência</h3>
                            <button type="button" onclick="closeOcorrenciaModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
                        </div>
                        <form id="ocorrenciaForm">
                            <input type="hidden" id="editingOcorrenciaId" />
                            <div class="form-group"><label>Morador</label><input type="text" id="ocorrenciaMorador" class="form-control" required></div>
                            <div class="form-group"><label>Apartamento</label><input type="text" id="ocorrenciaApto" class="form-control" required></div>
                            <div class="form-group"><label>Descrição</label><textarea id="ocorrenciaDescricao" class="form-control" rows="3"></textarea></div>
                            <div class="form-group"><label>Status</label>
                                <select id="ocorrenciaStatus" class="form-control">
                                    <option value="aberta">Aberta</option>
                                    <option value="andamento">Em andamento</option>
                                    <option value="resolvida">Resolvida</option>
                                </select>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Salvar</button>
                                <button type="button" class="btn" onclick="closeOcorrenciaModal()">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div> 
                     <!-- Modal Detalhado de Ocorrência (COLOQUE DIRETAMENTE NO HTML, após #prestadorModal) -->
<div id="ocorrenciaDetailModal" class="modal">
    <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> Detalhes da Ocorrência</h3>
            <button type="button" onclick="closeOcorrenciaDetailModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        <div class="card" style="margin-top: 15px;">
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Morador *</label>
                        <input type="text" id="ocorrenciaDetailMorador" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Apartamento *</label>
                        <input type="text" id="ocorrenciaDetailApto" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Descrição *</label>
                    <textarea id="ocorrenciaDetailDescricao" class="form-control" rows="4" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data/Hora da Ocorrência</label>
                        <input type="text" id="ocorrenciaDetailDataHora" class="form-control" readonly>
                        <small class="text-muted">Esta data não pode ser alterada</small>
                    </div>
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="ocorrenciaDetailStatus" class="form-control">
                            <option value="aberta">Aberta</option>
                            <option value="andamento">Em andamento</option>
                            <option value="resolvida">Resolvida</option>
                            <option value="cancelada">Cancelada</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Observações (interna — equipe)</label>
                    <textarea id="ocorrenciaDetailObservacoes" class="form-control" rows="3" placeholder="Ex: contato realizado, providências tomadas..."></textarea>
                </div>
                <input type="hidden" id="ocorrenciaDetailId">
                <input type="hidden" id="ocorrenciaDetailDataOriginal"> <!-- preserva timestamp original -->
            </div>
        </div>
        <!-- Histórico -->
        <div class="card" style="margin-top: 15px;">
            <div class="card-header">
                <h4><i class="fas fa-history"></i> Histórico</h4>
            </div>
            <div class="card-body" id="ocorrenciaDetailHistorico">
                <p class="text-muted">Carregando histórico...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-success" onclick="saveOcorrenciaDetail()">
                <i class="fas fa-save"></i> Salvar Alterações
            </button>
            <button type="button" class="btn btn-secondary" onclick="closeOcorrenciaDetailModal()">
                Fechar
            </button>
        </div>
    </div>
</div>
            `;
            const tbody = document.querySelector('#ocorrenciasTable tbody');
            tbody.innerHTML = '<tr><td colspan="6">Carregando...</td></tr>';
            try {
                const snapshot = await db.collection('ocorrencias').get();
                const docs = [];
                snapshot.forEach(doc => docs.push({id: doc.id, ...doc.data()}));
                tbody.innerHTML = '';
                docs.forEach(doc => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${doc.morador || ''}</td>
                        <td>${doc.apto || ''}</td>
                        <td>${doc.dataHora ? new Date(doc.dataHora.seconds ? doc.dataHora.toDate() : doc.dataHora).toLocaleString() : ''}</td>
                        <td>${(doc.descricao||'').substring(0,120)}</td>
                        <td>${doc.status || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editOcorrencia('${doc.id}')"><i class="fas fa-edit"></i></button>
                            ${podeExcluirRegistros() ? `
                            <button class="btn btn-sm btn-danger" onclick="safeDeleteOcorrencia('${doc.id}')"><i class="fas fa-trash"></i></button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="6">Erro ao carregar ocorrências.</td></tr>';
                console.error(err);
            }
        }
        function openOcorrenciaModal() {
            document.getElementById('ocorrenciaModal').style.display = 'flex';
            document.getElementById('editingOcorrenciaId').value = '';
            document.getElementById('ocorrenciaMorador').value = '';
            document.getElementById('ocorrenciaApto').value = '';
            document.getElementById('ocorrenciaDescricao').value = '';
            document.getElementById('ocorrenciaStatus').value = 'aberta';
        }
        function closeOcorrenciaModal() { document.getElementById('ocorrenciaModal').style.display = 'none'; }
        document.addEventListener('submit', async function(e) {
            if (e.target && e.target.id === 'ocorrenciaForm') {
                e.preventDefault();
                const id = document.getElementById('editingOcorrenciaId').value;
                const doc = {
                    morador: document.getElementById('ocorrenciaMorador').value,
                    apto: document.getElementById('ocorrenciaApto').value,
                    descricao: document.getElementById('ocorrenciaDescricao').value,
                    status: document.getElementById('ocorrenciaStatus').value,
                    dataHora: new Date()
                };
                try {
                    if (id) {
                        await db.collection('ocorrencias').doc(id).update(doc);
                    } else {
                        await db.collection('ocorrencias').add(doc);
                    }
                    closeOcorrenciaModal();
                    await loadOcorrenciasContent();
                } catch (err) {
                    alert('Erro ao salvar ocorrência: ' + err.message);
                }
            }
            if (e.target && e.target.id === 'prestadorForm') {
                e.preventDefault();
                const id = document.getElementById('editingPrestadorId').value;
                const doc = {
                    nome: document.getElementById('prestadorNome').value,
                                        data: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('prestadorData').value + 'T00:00:00-03:00')),
                    entrada: document.getElementById('prestadorEntrada').value,
                    saida: document.getElementById('prestadorSaida').value,
                    observacoes: document.getElementById('prestadorObservacoes').value,
                    status: document.getElementById('prestadorStatus').value,
                    dataAtualizacao: new Date()
                };
                try {
                    if (id) {
                        await db.collection('prestadores').doc(id).update(doc);
                    } else {
                        await db.collection('prestadores').add(doc);
                    }
                    closePrestadorModal();
                    await loadPrestadoresContent();
                } catch (err) {
                    alert('Erro ao salvar prestador: ' + (err.message || err));
                }
            }
        });
        function editOcorrencia(id) {
    db.collection('ocorrencias').doc(id).get().then(doc => {
        if (!doc.exists) return alert('Registro não encontrado');
        const data = doc.data();

        // ✅ Abre um modal dedicado só para essa ocorrência
        openOcorrenciaDetailModal(id, data);
    }).catch(err => {
        console.error('Erro ao carregar ocorrência:', err);
        alert('Erro ao carregar os dados da ocorrência.');
    });
}
        async function safeDeleteOcorrencia(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Confirma exclusão?')) return;
            await db.collection('ocorrencias').doc(id).delete();
            await loadOcorrenciasContent();
        }
        // --- Módulo: Prestadores de Serviço (básico) ---
        async function loadPrestadoresContent() {
            currentModule = 'prestadores';
            document.querySelectorAll('.sidebar-menu a').forEach(item => item.classList.remove('active'));
            const activeItem = document.querySelector(`.sidebar-menu a[onclick="changeModule('prestadores')"]`);
            if (activeItem) activeItem.classList.add('active');
            const moduleContent = document.getElementById('moduleContent');
            moduleContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <span>Prestadores de Serviço</span>
                        <div>
                            <button class="btn btn-primary" onclick="openPrestadorModal()">Novo Prestador</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table" id="prestadoresTable">
                            <thead><tr><th>Nome</th><th>Data</th><th>Entrada</th><th>Saída</th><th>Observações</th><th>Status</th><th>Ações</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Modal Prestador -->
                <div id="prestadorModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Prestador de Serviço</h3>
                            <button type="button" onclick="closePrestadorModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
                        </div>
                        <form id="prestadorForm">
                            <input type="hidden" id="editingPrestadorId" />
                            <div class="form-group"><label>Nome</label><input type="text" id="prestadorNome" class="form-control" required></div>
                            <div class="form-group"><label>Data</label><input type="date" id="prestadorData" class="form-control" required readonly></div>
                            <div class="form-row"><div class="form-group"><label>Entrada</label><input type="time" id="prestadorEntrada" class="form-control"></div>
                            <div class="form-group"><label>Saída</label><input type="time" id="prestadorSaida" class="form-control"></div></div>
                            <div class="form-group"><label>Observações</label><textarea id="prestadorObservacoes" class="form-control" rows="3"></textarea></div>
                            <div class="form-group"><label>Status</label>
                                <select id="prestadorStatus" class="form-control">
                                    <option value="adiado">Adiado</option>
                                    <option value="concluido">Concluído</option>
                                    <option value="andamento">Em andamento</option>
                                </select>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Salvar</button>
                                <button type="button" class="btn" onclick="closePrestadorModal()">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
                   <!-- Modal Detalhado de Ocorrência -->
<div id="ocorrenciaDetailModal" class="modal">
    <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> Detalhes da Ocorrência</h3>
            <button type="button" onclick="closeOcorrenciaDetailModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        <div class="card" style="margin-top: 15px;">
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Morador *</label>
                        <input type="text" id="ocorrenciaDetailMorador" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Apartamento *</label>
                        <input type="text" id="ocorrenciaDetailApto" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Descrição *</label>
                    <textarea id="ocorrenciaDetailDescricao" class="form-control" rows="4" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Data/Hora da Ocorrência</label>
                        <input type="text" id="ocorrenciaDetailDataHora" class="form-control" readonly>
                        <small class="text-muted">Esta data não pode ser alterada</small>
                    </div>
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="ocorrenciaDetailStatus" class="form-control">
                            <option value="aberta">Aberta</option>
                            <option value="andamento">Em andamento</option>
                            <option value="resolvida">Resolvida</option>
                            <option value="cancelada">Cancelada</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Observações (interna — equipe)</label>
                    <textarea id="ocorrenciaDetailObservacoes" class="form-control" rows="3" placeholder="Ex: contato realizado, providências tomadas..."></textarea>
                </div>
                <input type="hidden" id="ocorrenciaDetailId">
                <input type="hidden" id="ocorrenciaDetailDataOriginal"> <!-- preserva timestamp original -->
            </div>
        </div>

        <!-- Histórico -->
        <div class="card" style="margin-top: 15px;">
            <div class="card-header">
                <h4><i class="fas fa-history"></i> Histórico</h4>
            </div>
            <div class="card-body" id="ocorrenciaDetailHistorico">
                <p class="text-muted">Carregando histórico...</p>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-success" onclick="saveOcorrenciaDetail()">
                <i class="fas fa-save"></i> Salvar Alterações
            </button>
            <button type="button" class="btn btn-secondary" onclick="closeOcorrenciaDetailModal()">
                Fechar
            </button>
        </div>
    </div>
</div>
            `;
            const tbody = document.querySelector('#prestadoresTable tbody');
            tbody.innerHTML = '<tr><td colspan="7">Carregando...</td></tr>';
            try {
                const snapshot = await db.collection('prestadores').get();
                const docs = [];
                snapshot.forEach(doc => docs.push({id: doc.id, ...doc.data()}));
                tbody.innerHTML = '';
                docs.forEach(doc => {
                    const tr = document.createElement('tr');
                   // 🔧 Substitua a parte que começa com "let dataStr = '';" até o final do bloco
let dataStr = '';
if (doc.data) {
    let dateObj;
    // 1. Firestore Timestamp (padrão real)
    if (doc.data.seconds) {
        dateObj = doc.data.toDate();
    }
    // 2. Objeto com _seconds (armazenado manualmente)
    else if (doc.data._seconds) {
        dateObj = new Date(doc.data._seconds * 1000);
    }
    // 3. String ISO ou YYYY-MM-DD
    else if (typeof doc.data === 'string') {
        // Garante que seja interpretado como data local (horário de Brasília)
        const datePart = doc.data.split('T')[0]; // Pega só YYYY-MM-DD
        dateObj = new Date(datePart + 'T00:00:00-03:00');
    }
    // 4. Número (timestamp em ms)
    else if (typeof doc.data === 'number') {
        dateObj = new Date(doc.data);
    }
    // 5. Fallback
    else {
        dateObj = null;
    }
    dataStr = dateObj ? dateObj.toLocaleDateString('pt-BR') : '—';
}
                    tr.innerHTML = `
                        <td>${doc.nome || ''}</td>
                        <td>${dataStr}</td>
                        <td>${doc.entrada || ''}</td>
                        <td>${doc.saida || ''}</td>
                        <td>${(doc.observacoes||'').substring(0,120)}</td>
                        <td>${doc.status || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editPrestador('${doc.id}')"><i class="fas fa-edit"></i></button>
                            ${podeExcluirRegistros() ? `
                            <button class="btn btn-sm btn-danger" onclick="safeDeletePrestador('${doc.id}')"><i class="fas fa-trash"></i></button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="7">Erro ao carregar prestadores.</td></tr>';
                console.error(err);
            }
        }
        function openPrestadorModal() {
            document.getElementById('prestadorModal').style.display = 'flex';
            document.getElementById('editingPrestadorId').value = '';
            document.getElementById('prestadorNome').value = '';
            const hoje = new Date();
            const yyyy = hoje.getFullYear();
            const mm = String(hoje.getMonth()+1).padStart(2,'0');
            const dd = String(hoje.getDate()).padStart(2,'0');
            document.getElementById('prestadorData').value = `${yyyy}-${mm}-${dd}`;
            document.getElementById('prestadorEntrada').value = '';
            document.getElementById('prestadorSaida').value = '';
            document.getElementById('prestadorObservacoes').value = '';
            document.getElementById('prestadorStatus').value = 'andamento';
        }
        function closePrestadorModal() { document.getElementById('prestadorModal').style.display = 'none'; }
        function editPrestador(id) {
            db.collection('prestadores').doc(id).get().then(doc => {
                if (!doc.exists) return alert('Registro não encontrado');
                const data = doc.data();
                document.getElementById('editingPrestadorId').value = id;
                document.getElementById('prestadorNome').value = data.nome || '';
                if (data.data) {
                    const d = data.data.seconds
    ? data.data.toDate()
    : new Date(data.data + 'T00:00:00-03:00'); // Força horário de Brasília
                    const yyyy = d.getFullYear(), mm = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
                    document.getElementById('prestadorData').value = `${yyyy}-${mm}-${dd}`;
                } else {
                    const hoje = new Date(); document.getElementById('prestadorData').value = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}-${String(hoje.getDate()).padStart(2,'0')}`;
                }
                document.getElementById('prestadorEntrada').value = data.entrada || '';
                document.getElementById('prestadorSaida').value = data.saida || '';
                document.getElementById('prestadorObservacoes').value = data.observacoes || '';
                document.getElementById('prestadorStatus').value = data.status || 'andamento';
                document.getElementById('prestadorModal').style.display = 'flex';
            });
        }
        async function safeDeletePrestador(id) {
            if (!podeExcluirRegistros()) {
                alert('Somente síndico ou subsíndico podem excluir registros.');
                return;
            }
            if (!confirm('Confirma exclusão?')) return;
            await db.collection('prestadores').doc(id).delete();
            await loadPrestadoresContent();
        }
        const originalLoadModuleContent = loadModuleContent;
        loadModuleContent = function(moduleId) {
            originalLoadModuleContent.apply(this, arguments);
            setTimeout(()=> updateDeleteButtonsState(), 100);
        };
    

    // ========== FUNÇÕES DE CONFRATERNIZAÇÃO ==========

function openConfraternizacaoModal() {
    document.getElementById('confraternizacaoModalTitle').textContent = 'Nova Inscrição';
    document.getElementById('editingConfraternizacaoId').value = '';
    document.getElementById('confraternizacaoForm').reset();
    document.getElementById('confraternizacaoApto').value = '';
    carregarMoradoresSelect();
    document.getElementById('confraternizacaoModal').style.display = 'flex';
}

function closeConfraternizacaoModal() {
    document.getElementById('confraternizacaoModal').style.display = 'none';
}
async function confirmarPagamentoConfraternizacao(id) {
    if (!confirm('Deseja marcar esta inscrição como PAGA?')) return;
    try {
        await db.collection('confraternizacoes').doc(id).update({
            status: 'pago',
            dataAtualizacao: new Date().toISOString()
        });
        loadConfraternizacaoData();
        alert('Inscrição marcada como paga com sucesso!');
    } catch (err) {
        console.error('Erro ao confirmar pagamento:', err);
        alert('Erro ao confirmar pagamento. Tente novamente.');
    }
}
function carregarMoradoresSelect() {
    const select = document.getElementById('confraternizacaoMorador');
    select.innerHTML = '<option value="">Selecione...</option>';
    const moradoresFiltrados = moradores.filter(m => m.condominioId === currentCondominio.id);
    moradoresFiltrados.sort((a, b) => extractNumberFromApto(a.apto) - extractNumberFromApto(b.apto));
    moradoresFiltrados.forEach(morador => {
        const option = document.createElement('option');
        option.value = morador.id;
        option.textContent = `${morador.nome} — ${morador.apto}`;
        option.dataset.apto = morador.apto;
        select.appendChild(option);
    });
}

function preencherAptoAutomatico() {
    const select = document.getElementById('confraternizacaoMorador');
    const aptoInput = document.getElementById('confraternizacaoApto');
    const option = select.options[select.selectedIndex];
    aptoInput.value = option ? option.dataset.apto || '' : '';
    calcularTotalConfraternizacao();
}
function exportarRelatorioWord() {
    const content = document.getElementById('relatorioConfraternizacaoContent').innerHTML;
    const html = `
        <html>
        <head>
            <style>
                body { font-family: Arial, sans-serif; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                th { background-color: #3498db; color: white; }
                .status-pago { background: #d5f5e3; padding: 2px 6px; border-radius: 4px; }
                .status-pendente { background: #fef9e7; padding: 2px 6px; border-radius: 4px; }
                .status-cancelado { background: #fdecea; padding: 2px 6px; border-radius: 4px; }
            </style>
        </head>
        <body>${content}</body>
        </html>
    `;
    const converted = htmlDocx.asBlob(html, { orientation: 'portrait', margins: { top: 720, right: 720, bottom: 720, left: 720 } });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(converted);
    link.download = `relatorio_confraternizacao_${currentCondominio.nome.replace(/\s+/g, '_')}.docx`;
    link.click();
}
function calcularTotalConfraternizacao() {
    const adultos = parseInt(document.getElementById('confraternizacaoAdultos').value) || 0;
    const criancas7a12 = parseInt(document.getElementById('confraternizacaoCriancas7a12').value) || 0;
    const total = (adultos * 80) + (criancas7a12 * 40);
    document.getElementById('confraternizacaoTotal').value = `R$ ${total.toFixed(2).replace('.', ',')}`;
}

document.getElementById('confraternizacaoForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    if (!currentCondominio) {
        alert('Selecione um condomínio primeiro!');
        return;
    }
    const editingId = document.getElementById('editingConfraternizacaoId').value;
    const moradorId = document.getElementById('confraternizacaoMorador').value;
    const moradorSelecionado = moradores.find(m => m.id === moradorId);
    if (!moradorSelecionado) {
        alert('Selecione um morador válido.');
        return;
    }
    const adultos = parseInt(document.getElementById('confraternizacaoAdultos').value) || 0;
    const criancas7a12 = parseInt(document.getElementById('confraternizacaoCriancas7a12').value) || 0;
    const criancasMenor6 = parseInt(document.getElementById('confraternizacaoCriancasMenor6').value) || 0;
    const total = (adultos * 80) + (criancas7a12 * 40);
    const status = document.getElementById('confraternizacaoStatus').value;
    const data = {
        morador: moradorSelecionado.nome,
        apto: moradorSelecionado.apto,
        adultos: adultos,
        criancas7a12: criancas7a12,
        criancasMenor6: criancasMenor6,
        total: total,
        status: status,
        condominioId: currentCondominio.id,
        condominioNome: currentCondominio.nome,
        criadoPor: currentUser.id || currentUser.usuario,
        criadoEm: new Date().toISOString()
    };
    try {
        if (editingId) {
            await db.collection('confraternizacoes').doc(editingId).update(data);
        } else {
            await db.collection('confraternizacoes').add(data);
        }
        closeConfraternizacaoModal();
        loadConfraternizacaoData();
        alert(editingId ? 'Registro atualizado!' : 'Inscrição salva com sucesso!');
    } catch (err) {
        console.error('Erro ao salvar confraternização:', err);
        alert('Erro ao salvar. Tente novamente.');
    }
});

function editConfraternizacao(id) {
    db.collection('confraternizacoes').doc(id).get().then(doc => {
        if (!doc.exists) {
            alert('Registro não encontrado.');
            return;
        }
        const data = doc.data();
        document.getElementById('confraternizacaoModalTitle').textContent = 'Editar Inscrição';
        document.getElementById('editingConfraternizacaoId').value = id;
        document.getElementById('confraternizacaoAdultos').value = data.adultos || 0;
        document.getElementById('confraternizacaoCriancas7a12').value = data.criancas7a12 || 0;
        document.getElementById('confraternizacaoCriancasMenor6').value = data.criancasMenor6 || 0;
        document.getElementById('confraternizacaoStatus').value = data.status;
        calcularTotalConfraternizacao();
        carregarMoradoresSelect();
        // Selecionar morador correspondente
        setTimeout(() => {
            const select = document.getElementById('confraternizacaoMorador');
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].textContent.includes(data.morador) && select.options[i].textContent.includes(data.apto)) {
                    select.selectedIndex = i;
                    preencherAptoAutomatico();
                    break;
                }
            }
        }, 100);
        document.getElementById('confraternizacaoModal').style.display = 'flex';
    });
}

async function deleteConfraternizacao(id) {
    if (!podeExcluirRegistros()) {
        alert('Somente síndico ou subsíndico podem excluir registros.');
        return;
    }
    if (!confirm('Tem certeza que deseja excluir esta inscrição?')) return;
    try {
        await db.collection('confraternizacoes').doc(id).delete();
        loadConfraternizacaoData();
        alert('Inscrição excluída com sucesso!');
    } catch (err) {
        console.error('Erro ao excluir:', err);
        alert('Erro ao excluir. Tente novamente.');
    }
}
// ========== MÓDULO CONFRATERNIZAÇÃO ==========
function loadConfraternizacaoContent() {
    const moduleContent = document.getElementById('moduleContent');
    if (!currentCondominio) {
        moduleContent.innerHTML = `<div class="alert alert-warning"><strong>Selecione um condomínio</strong> para acessar o módulo de Confraternização.</div>`;
        return;
    }
    moduleContent.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h3>Confraternização - ${currentCondominio.nome}</h3>
                <div>
                    <button class="btn btn-primary" onclick="openConfraternizacaoModal()">
                        <i class="fas fa-plus"></i> Novo Registro
                    </button>
                    <button class="btn btn-info" onclick="gerarRelatorioConfraternizacao()" style="margin-left: 8px;">
                        <i class="fas fa-file-alt"></i> Visualizar Relatório
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="stats-container">
                    <div class="stat-card-modern">
                        <div class="stat-card-header"><h3>Total de Pessoas</h3></div>
                        <div class="stat-card-content">
                            <div class="stat-value" id="totalPessoas">0</div>
                            <div class="stat-label">Participantes</div>
                        </div>
                    </div>
                    <div class="stat-card-modern" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);">
                        <div class="stat-card-header"><h3>Valor Arrecadado</h3></div>
                        <div class="stat-card-content">
                            <div class="stat-value" id="valorPago">R$ 0,00</div>
                            <div class="stat-label">Status: Pago</div>
                        </div>
                    </div>
                    <div class="stat-card-modern" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                        <div class="stat-card-header"><h3>Pendente</h3></div>
                        <div class="stat-card-content">
                            <div class="stat-value" id="valorPendente">R$ 0,00</div>
                            <div class="stat-label">Aguardando pagamento</div>
                        </div>
                    </div>
                    <div class="stat-card-modern" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">
                        <div class="stat-card-header"><h3>Total de Registros</h3></div>
                        <div class="stat-card-content">
                            <div class="stat-value" id="totalRegistros">0</div>
                            <div class="stat-label">Famílias cadastradas</div>
                        </div>
                    </div>
                </div>
                <table class="table" id="confraternizacaoTable">
                    <thead>
                        <tr>
                            <th>Morador</th>
                            <th>Apto</th>
                            <th>Adultos (R$80)</th>
                            <th>Crianças 7-12 (R$40)</th>
                            <th>Menores 6 (Grátis)</th>
                            <th>Total Pago</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="confraternizacaoTbody">
                        <tr><td colspan="8" class="text-center">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
         
        <!-- Modal de Relatório -->
        <div id="relatorioConfraternizacaoModal" class="modal">
            <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
                <div class="modal-header">
                    <h3>Relatório de Confraternização - ${currentCondominio.nome}</h3>
                    <button type="button" onclick="document.getElementById('relatorioConfraternizacaoModal').style.display='none'" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
                </div>
                <div id="relatorioConfraternizacaoContent" class="card" style="margin-top: 10px; padding: 20px;">
                    <p>Gerando relatório...</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" onclick="exportarRelatorioWord()">
                        <i class="fas fa-file-word"></i> Exportar para Word
                    </button>
                    <button class="btn" onclick="document.getElementById('relatorioConfraternizacaoModal').style.display='none'">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    `;
    loadConfraternizacaoData();
}
function loadConfraternizacaoData() {
    db.collection('confraternizacoes')
        .where('condominioId', '==', currentCondominio.id)
        .get()
        .then(snapshot => {
            const registros = [];
            snapshot.forEach(doc => registros.push({ id: doc.id, ...doc.data() }));
            
            // Atualiza cards
            const totalPessoas = registros.reduce((sum, r) => 
                sum + (r.adultos || 0) + (r.criancas7a12 || 0) + (r.criancasMenor6 || 0), 0);
            const valorPago = registros
                .filter(r => r.status === 'pago')
                .reduce((sum, r) => sum + (r.total || 0), 0);
            const valorPendente = registros
                .filter(r => r.status === 'pendente')
                .reduce((sum, r) => sum + (r.total || 0), 0);
            
            document.getElementById('totalPessoas').textContent = totalPessoas;
            document.getElementById('valorPago').textContent = `R$ ${valorPago.toFixed(2).replace('.', ',')}`;
            document.getElementById('valorPendente').textContent = `R$ ${valorPendente.toFixed(2).replace('.', ',')}`;
            document.getElementById('totalRegistros').textContent = registros.length;
            
            // Atualiza tabela
            const tbody = document.getElementById('confraternizacaoTbody');
            if (registros.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum registro encontrado.</td></tr>';
                return;
            }
            tbody.innerHTML = registros.map(r => `
                <tr>
                    <td>${r.morador}</td>
                    <td>${r.apto}</td>
                    <td>${r.adultos || 0}</td>
                    <td>${r.criancas7a12 || 0}</td>
                    <td>${r.criancasMenor6 || 0}</td>
                    <td>R$ ${(r.total || 0).toFixed(2).replace('.', ',')}</td>
                    <td>
                        <span class="status-badge status-${r.status}">
                            ${formatStatusConfraternizacao(r.status)}
                        </span>
                    </td>
                    <td>
    <button class="btn btn-sm btn-info" onclick="editConfraternizacao('${r.id}')">
        <i class="fas fa-edit"></i>
    </button>
    ${r.status === 'pendente' ? `
    <button class="btn btn-sm btn-success" onclick="confirmarPagamentoConfraternizacao('${r.id}')">
        <i class="fas fa-check"></i> Pagar
    </button>` : ''}
    ${podeExcluirRegistros() ? `
    <button class="btn btn-sm btn-danger" onclick="deleteConfraternizacao('${r.id}')">
        <i class="fas fa-trash"></i>
    </button>` : ''}
</td>
                </tr>
            `).join('');
        })
        .catch(err => {
            console.error('Erro ao carregar confraternizações:', err);
            document.getElementById('confraternizacaoTbody').innerHTML = '<tr><td colspan="8" class="text-center">Erro ao carregar dados.</td></tr>';
        });
}

function formatStatusConfraternizacao(status) {
    const map = {
        'pago': 'Pago',
        'pendente': 'Pendente',
        'cancelado': 'Cancelado'
    };
    return map[status] || status;
}
// Confirmar pagamento
async function confirmarPagamentoConfraternizacao(id) {
    if (!confirm('Deseja marcar esta inscrição como PAGA?')) return;
    try {
        await db.collection('confraternizacoes').doc(id).update({
            status: 'pago',
            dataAtualizacao: new Date().toISOString()
        });
        loadConfraternizacaoData();
        alert('Inscrição marcada como paga com sucesso!');
    } catch (err) {
        console.error('Erro ao confirmar pagamento:', err);
        alert('Erro ao confirmar pagamento. Tente novamente.');
    }
}

// ========== FUNÇÕES PARA PALAVRAS-CHAVE MERCADO LIVRE ==========

function openPalavraChaveModal() {
    document.getElementById('palavraChaveModalTitle').textContent = 'Nova Palavra-chave';
    document.getElementById('editingPalavraChaveId').value = '';
    document.getElementById('palavraChaveForm').reset();
    document.getElementById('palavraChaveCount').textContent = '0';
    carregarMoradoresNoSelect();
    document.getElementById('palavraChaveModal').style.display = 'flex';
}

function closePalavraChaveModal() {
    document.getElementById('palavraChaveModal').style.display = 'none';
}

// Função para carregar moradores no select
function carregarMoradoresNoSelect() {
    const select = document.getElementById('palavraChaveMorador');
    if (!select || !currentCondominio) return;

    select.innerHTML = '<option value="">Selecione um morador...</option>';
    const moradoresDoCondominio = moradores
        .filter(m => m.condominioId === currentCondominio.id)
        .sort((a, b) => extractNumberFromApto(a.apto) - extractNumberFromApto(b.apto));

    moradoresDoCondominio.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = `${m.nome} — Apto ${m.apto}`;
        opt.dataset.apto = m.apto;
        select.appendChild(opt);
    });
}
function editPalavraChave(id) {
    const pc = palavrasChave.find(p => p.id === id);
    if (!pc) return alert('Registro não encontrado.');

    openPalavraChaveModal(); // carrega moradores
    setTimeout(() => {
        document.getElementById('palavraChaveModalTitle').textContent = 'Editar Palavras-chave';
        document.getElementById('editingPalavraChaveId').value = pc.id;
        document.getElementById('palavraChaveMorador').value = pc.moradorId;
        document.getElementById('palavraChaveTexto').value = pc.palavrasChave.join(', ');
        document.getElementById('palavraChaveObservacoes').value = pc.observacoes || '';
        document.getElementById('palavraChaveCount').textContent = pc.palavrasChave.length;
    }, 100);
}
async function deletePalavraChave(id) {
    if (!podeExcluirRegistros()) {
        return alert('Somente síndico ou subsíndico podem excluir.');
    }
    if (!confirm('Excluir palavras-chave deste morador?')) return;

    try {
        await db.collection('palavrasChave').doc(id).delete();
        await loadSystemData();

        if (currentModule === 'dashboard') atualizarCardsPalavrasChave();
        if (currentModule === 'palavras-chave') loadPalavrasChaveContent();

        alert('Palavras-chave excluídas com sucesso!');
    } catch (err) {
        console.error(err);
        alert('Erro ao excluir.');
    }
}
// Contador de palavras-chave
document.getElementById('palavraChaveTexto').addEventListener('input', function() {
    const texto = this.value;
    const palavras = texto.split(',').filter(p => p.trim() !== '');
    document.getElementById('palavraChaveCount').textContent = palavras.length;
});

// Submit do formulário de palavras-chave
document.getElementById('palavraChaveForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    if (!currentCondominio) return alert('Selecione um condomínio primeiro!');

    const editingId = document.getElementById('editingPalavraChaveId').value;
    const moradorId = document.getElementById('palavraChaveMorador').value;
    const texto = document.getElementById('palavraChaveTexto').value.trim();
    const observacoes = document.getElementById('palavraChaveObservacoes').value.trim();

    if (!moradorId) return alert('Selecione um morador.');
    if (!texto) return alert('Digite pelo menos uma palavra-chave.');

    const palavras = texto.split(',').map(p => p.trim()).filter(p => p);
    if (palavras.length === 0) return alert('Nenhuma palavra válida encontrada.');

    const morador = moradores.find(m => m.id === moradorId);
    if (!morador) return alert('Morador não encontrado.');

    const data = {
        moradorId: moradorId,
        moradorNome: morador.nome,
        moradorApto: morador.apto,
        palavrasChave: palavras,
        observacoes: observacoes,
        condominioId: currentCondominio.id,
        condominioNome: currentCondominio.nome,
        criadoPor: currentUser.id || currentUser.usuario,
        criadoEm: new Date().toISOString()
    };

    try {
        if (editingId) {
            await db.collection('palavrasChave').doc(editingId).update(data);
        } else {
            await db.collection('palavrasChave').add(data);
        }

        await loadSystemData(); // recarrega `palavrasChave`
        closePalavraChaveModal();

        // ✅ Atualiza automaticamente os cards da Dashboard, se estiver nela
        if (currentModule === 'dashboard') {
            atualizarCardsPalavrasChave();
        }
        // ✅ Atualiza a tabela se estiver no módulo específico
        if (currentModule === 'palavras-chave') {
            loadPalavrasChaveContent();
        }

        alert(editingId ? 'Palavras-chave atualizadas com sucesso!' : 'Palavras-chave salvas com sucesso!');
    } catch (err) {
        console.error('Erro ao salvar palavras-chave:', err);
        alert('Erro ao salvar. Verifique sua conexão e tente novamente.');
    }
});
// Gerar relatório visual
function gerarRelatorioConfraternizacao() {
    const modal = document.getElementById('relatorioConfraternizacaoModal');
    const content = document.getElementById('relatorioConfraternizacaoContent');
    content.innerHTML = '<p>Carregando dados...</p>';
    modal.style.display = 'flex';
    
    db.collection('confraternizacoes')
        .where('condominioId', '==', currentCondominio.id)
        .get()
        .then(snapshot => {
            const registros = [];
            snapshot.forEach(doc => registros.push({ id: doc.id, ...doc.data() }));

            const totalPessoas = registros.reduce((sum, r) => 
                sum + (r.adultos || 0) + (r.criancas7a12 || 0) + (r.criancasMenor6 || 0), 0);
            const valorPago = registros.filter(r => r.status === 'pago').reduce((sum, r) => sum + (r.total || 0), 0);
            const valorTotal = registros.reduce((sum, r) => sum + (r.total || 0), 0);

            let html = `
                <h2 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">Relatório de Confraternização</h2>
                <p style="text-align: center; font-size: 18px; margin-bottom: 30px;">Condomínio: <strong>${currentCondominio.nome}</strong></p>
                <div style="display: flex; justify-content: space-around; margin-bottom: 30px; flex-wrap: wrap;">
                    <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; text-align: center; min-width: 180px; margin: 5px;">
                        <h3 style="color: #2980b9;">Total de Pessoas</h3>
                        <p style="font-size: 24px; font-weight: bold;">${totalPessoas}</p>
                    </div>
                    <div style="background: #d5f5e3; padding: 15px; border-radius: 8px; text-align: center; min-width: 180px; margin: 5px;">
                        <h3 style="color: #27ae60;">Valor Arrecadado</h3>
                        <p style="font-size: 24px; font-weight: bold;">R$ ${valorPago.toFixed(2).replace('.', ',')}</p>
                    </div>
                    <div style="background: #fdebd0; padding: 15px; border-radius: 8px; text-align: center; min-width: 180px; margin: 5px;">
                        <h3 style="color: #e67e22;">Valor Total</h3>
                        <p style="font-size: 24px; font-weight: bold;">R$ ${valorTotal.toFixed(2).replace('.', ',')}</p>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #3498db; color: white;">
                            <th style="padding: 10px; border: 1px solid #ccc;">Morador</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">Apto</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">Adultos</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">Crianças 7-12</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">Menores 6</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">Total (R$)</th>
                            <th style="padding: 10px; border: 1px solid #ccc;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${registros.map(r => `
                            <tr style="background-color: ${r.status === 'pago' ? '#ebf5fb' : '#fef9e7'};">
                                <td style="padding: 10px; border: 1px solid #ccc;">${r.morador}</td>
                                <td style="padding: 10px; border: 1px solid #ccc;">${r.apto}</td>
                                <td style="padding: 10px; border: 1px solid #ccc; text-align: center;">${r.adultos || 0}</td>
                                <td style="padding: 10px; border: 1px solid #ccc; text-align: center;">${r.criancas7a12 || 0}</td>
                                <td style="padding: 10px; border: 1px solid #ccc; text-align: center;">${r.criancasMenor6 || 0}</td>
                                <td style="padding: 10px; border: 1px solid #ccc; text-align: right;">${(r.total || 0).toFixed(2).replace('.', ',')}</td>
                                <td style="padding: 10px; border: 1px solid #ccc; text-align: center;">
                                    <span class="status-badge status-${r.status}">${formatStatusConfraternizacao(r.status)}</span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <p style="margin-top: 20px; text-align: right; font-style: italic;">Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
            `;

            content.innerHTML = html;
        })
        .catch(err => {
            content.innerHTML = `<p style="color: red;">Erro ao gerar relatório: ${err.message}</p>`;
        });
}

// Exportar para Word
// 📦 Substitua TUDO dentro da função exportarRelatorioWord por este código robusto:
function exportarRelatorioWord() {
    const contentEl = document.getElementById('relatorioConfraternizacaoContent');
    if (!contentEl || !contentEl.innerHTML.trim()) {
        alert('Nenhum dado para exportar.');
        return;
    }

    // Extrai dados da tabela (opcional: pode usar innerHTML direto, mas assim controlamos melhor)
    const table = contentEl.querySelector('table');
    if (!table) {
        alert('Relatório sem tabela. Gere o relatório primeiro.');
        return;
    }

    // Gera XML básico de documento Word (.docx é ZIP com estrutura fixa)
    const docxTemplate = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:body>
    <w:p><w:r><w:t>Relatório de Confraternização</w:t></w:r></w:p>
    <w:p><w:r><w:t>Condomínio: ${currentCondominio ? currentCondominio.nome : 'N/A'}</w:t></w:r></w:p>
    <w:p><w:r><w:t>Data: ${new Date().toLocaleDateString('pt-BR')}</w:t></w:r></w:p>
    <w:p><w:r><w:br/></w:r></w:p>
    ${tableToWordXML(table)}
  </w:body>
</w:document>`;

    // Cria estrutura mínima de .docx (ZIP com arquivos obrigatórios)
    const zip = new JSZip();

    // word/document.xml
    zip.file("word/document.xml", docxTemplate);

    // _rels/.rels
    zip.file("_rels/.rels", `<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`);

    // [Content_Types].xml
    zip.file("[Content_Types].xml", `<?xml version="1.0" encoding="UTF-8"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="xml" ContentType="application/xml"/>
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>`);

    // word/_rels/document.xml.rels
    zip.folder("word").file("_rels/document.xml.rels", `<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/officeDocument/2006/relationships"/>`);

    // word/styles.xml (básico)
    zip.folder("word").file("styles.xml", `<?xml version="1.0" encoding="UTF-8"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:style w:type="paragraph" w:default="1" w:styleId="Normal">
    <w:name w:val="Normal"/>
    <w:rPr><w:sz w:val="22"/></w:rPr>
  </w:style>
</w:styles>`);

    // Gera o arquivo
    zip.generateAsync({ type: "blob" })
        .then(function (blob) {
            saveAs(blob, `Confraternizacao_${(currentCondominio?.nome || 'Relatorio').replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.docx`);
            alert('✅ Relatório exportado com sucesso!');
        })
        .catch(function (err) {
            console.error('Erro ao gerar DOCX:', err);
            alert('❌ Falha ao gerar relatório. Verifique o console.');
        });
}

// ✨ Função auxiliar: converte <table> HTML → XML de tabela do Word
function tableToWordXML(table) {
    let xml = '<w:tbl><w:tblPr><w:tblW w:w="0" w:type="auto"/></w:tblPr>';
    
    // Linhas
    for (let i = 0; i < table.rows.length; i++) {
        const row = table.rows[i];
        xml += '<w:tr>';
        
        for (let j = 0; j < row.cells.length; j++) {
            const cell = row.cells[j];
            const text = cell.innerText.replace(/&/g, '&amp;').replace(/</g, '<').replace(/>/g, '>');
            const bgColor = getComputedStyle(cell).backgroundColor;
            let bgHex = '';
            if (bgColor && bgColor !== 'rgba(0, 0, 0, 0)') {
                const rgb = bgColor.match(/\d+/g);
                if (rgb && rgb.length >= 3) {
                    bgHex = '#' + rgb.slice(0,3).map(x => {
                        const h = parseInt(x).toString(16);
                        return h.length === 1 ? '0' + h : h;
                    }).join('');
                }
            }

            xml += `<w:tc>`;
            if (bgHex) {
                xml += `<w:tcPr><w:shd w:val="clear" w:color="auto" w:fill="${bgHex.substring(1)}"/></w:tcPr>`;
            }
            xml += `<w:p><w:r><w:t>${text}</w:t></w:r></w:p></w:tc>`;
        }
        xml += '</w:tr>';
    }
    xml += '</w:tbl>';
    return xml;
}
// ✅ AVISO AO FECHAR A PÁGINA SEM LOGOUT
window.addEventListener('beforeunload', function(e) {
    if (currentUser && currentUser.id) {
        const mensagem = 'Atenção: ao fechar esta página, sua sessão será encerrada automaticamente.';
        e.returnValue = mensagem; // compatibilidade com browsers antigos
        return mensagem;
    }
});
  function gerenciarPalavrasChave() {
    alert("Aqui você pode gerenciar as palavras-chave do Mercado Livre para cada morador.\n\nFuncionalidades:\n• Cadastrar palavras-chave por morador\n• Acompanhar produtos de interesse\n• Receber alertas de promoções\n\nEsta funcionalidade será implementada em breve!");
}
 // Função nomeada para poder removê-la depois
function beforeUnloadHandler(e) {
    if (currentUser && currentUser.id) {
        const mensagem = 'Atenção: ao fechar esta página, sua sessão será encerrada automaticamente.';
        e.returnValue = mensagem;
        return mensagem;
    }
}

// ========== FUNÇÃO AUXILIAR PARA ATUALIZAR CARD ==========
function atualizarCardEspaco(nomeEspaco, status, agendamento) {
    // Encontrar todos os cards de espaço
    const cards = document.querySelectorAll('.sauna-card-reduzido');
    
    cards.forEach(card => {
        const titulo = card.querySelector('h3');
        if (titulo && titulo.textContent === nomeEspaco) {
            const statusElement = card.querySelector('.sauna-status-reduzido');
            const userDetails = card.querySelector('.user-details-reduzido');
            
            if (statusElement && userDetails) {
                // Atualizar status
                statusElement.textContent = status;
                
                // Atualizar cor baseada no status
                if (status.includes('EM USO')) {
                    statusElement.style.background = 'rgba(231, 76, 60, 0.9)';
                } else if (status.includes('PREPARANDO')) {
                    statusElement.style.background = 'rgba(243, 156, 18, 0.9)';
                } else if (status.includes('AGENDADO')) {
                    statusElement.style.background = 'rgba(52, 152, 219, 0.9)';
                } else {
                    statusElement.style.background = 'rgba(46, 204, 113, 0.9)';
                }
                
                // Atualizar detalhes do usuário
                if (agendamento) {
                    userDetails.innerHTML = `
                        <strong>${agendamento.responsavel}</strong>
                        <div class="apto-info-reduzido">Apto: ${agendamento.unidade}</div>
                        <div class="time-info-reduzido">${agendamento.horaInicio} - ${agendamento.horaFim}</div>
                    `;
                } else {
                    userDetails.innerHTML = '<div class="available-text-reduzido">LIVRE AGORA</div>';
                }
            }
        }
    });
}

// ========== FUNÇÃO AUXILIAR PARA SUBTRAIR HORAS ==========
function subtrairHoras(hora, horas) {
    const [h, m] = hora.split(':').map(Number);
    let totalMinutos = h * 60 + m;
    totalMinutos -= horas * 60;
    
    if (totalMinutos < 0) totalMinutos += 24 * 60;
    
    const novaHora = Math.floor(totalMinutos / 60).toString().padStart(2, '0');
    const novosMinutos = (totalMinutos % 60).toString().padStart(2, '0');
    
    return `${novaHora}:${novosMinutos}`;
}

// ========== FUNÇÃO PARA OBTER COR DO ESPAÇO ==========
function getEspacoColor(espacoId) {
    const colors = {
        'salao-social': '#3498db',
        'churrasqueira': '#e74c3c',
        'quiosque': '#2ecc71',
        'pergolado': '#9b59b6'
    };
    return colors[espacoId] || '#95a5a6';
}

// ========== FUNÇÃO PARA OBTER ÍCONE DO ESPAÇO ==========
function getEspacoIcon(espacoId) {
    const icons = {
        'salao-social': 'fas fa-warehouse',
        'churrasqueira': 'fas fa-fire',
        'quiosque': 'fas fa-tree',
        'pergolado': 'fas fa-umbrella'
    };
    return icons[espacoId] || 'fas fa-question';
}
// ========== FUNÇÃO PARA CARREGAR MORADORES NO SELECT ==========
function carregarMoradoresNoSelect() {
    const selectMorador = document.getElementById('palavraChaveMorador');
    if (!selectMorador) return;
    
    // Limpar options existentes (exceto a primeira)
    selectMorador.innerHTML = '<option value="">Selecione...</option>';
    
    if (!currentCondominio) {
        console.log('❌ Nenhum condomínio selecionado');
        return;
    }
    
    // Filtrar moradores do condomínio atual
    const moradoresFiltrados = moradores.filter(m => m.condominioId === currentCondominio.id);
    
    if (moradoresFiltrados.length === 0) {
        selectMorador.innerHTML += '<option value="" disabled>Nenhum morador cadastrado</option>';
        return;
    }
    
    // Ordenar moradores por apartamento
    const moradoresOrdenados = moradoresFiltrados.sort((a, b) => {
        const numA = extractNumberFromApto(a.apto);
        const numB = extractNumberFromApto(b.apto);
        return numA - numB;
    });
    
    // Adicionar moradores ao select
    moradoresOrdenados.forEach(morador => {
        const option = document.createElement('option');
        option.value = morador.id; // Usar ID do morador
        option.textContent = `${morador.nome} - Apto ${morador.apto}`;
        option.setAttribute('data-apto', morador.apto); // Guardar apto como data attribute
        selectMorador.appendChild(option);
    });
    
    console.log(`✅ ${moradoresOrdenados.length} moradores carregados no select`);
}
// ========== FUNÇÃO PARA ATUALIZAR CONTADOR DE PALAVRAS ==========
function atualizarContadorPalavrasChave() {
    const texto = document.getElementById('palavraChaveTexto').value;
    const palavras = texto.split(',').filter(p => p.trim() !== '');
    document.getElementById('palavraChaveCount').textContent = palavras.length;
}

function atualizarCardsPalavrasChave() {
    // ✅ Busca todos os cards e filtra pelo título com "Palavras-chave Mercado Livre"
    const cards = document.querySelectorAll('.card');
    let targetCard = null;
    for (let card of cards) {
        const h3 = card.querySelector('.card-header h3');
        if (h3 && h3.textContent.includes('Palavras-chave Mercado Livre')) {
            targetCard = card;
            break;
        }
    }

    if (!targetCard || !currentCondominio) return;

    const container = targetCard.querySelector('.stats-container');
    if (!container) return;

    const pcs = palavrasChave.filter(pc => pc.condominioId === currentCondominio.id);
    const btnVerTodas = targetCard.querySelector('button[onclick*="palavras-chave"]');

    if (pcs.length === 0) {
        container.innerHTML = `
            <div class="mercado-livre-card" onclick="openPalavraChaveModal()" style="background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%);">
                <div class="mercado-livre-header">
                    <i class="fas fa-plus-circle" style="font-size: 2em; margin-bottom: 8px; color: #2c3e50;"></i>
                    <h3>Adicionar Primeira</h3>
                </div>
                <div class="mercado-livre-content">
                    <div style="text-align: center; color: #2c3e50; font-size: 0.9em;">
                        Clique para cadastrar sua primeira palavra-chave
                    </div>
                </div>
            </div>
        `;
        if (btnVerTodas) btnVerTodas.style.display = 'none';
        return;
    }

    // Mostra até 3 cards
    const htmlCards = pcs.slice(0, 3).map(pc => `
        <div class="mercado-livre-card" onclick="editPalavraChave('${pc.id}')">
            <div class="mercado-livre-header">
                <i class="fas fa-tags" style="font-size: 1.5em; margin-bottom: 8px; color: #2c3e50;"></i>
                <h3>Palavras-chave</h3>
            </div>
            <div class="mercado-livre-content">
                <div class="morador-info">${pc.moradorNome}</div>
                <div class="apto-info">Apto: ${pc.moradorApto}</div>
                ${pc.palavrasChave.slice(0, 2).map(p => `<div class="palavra-chave-item">${p}</div>`).join('')}
                ${pc.palavrasChave.length > 2 ? `<div class="palavra-chave-item">+${pc.palavrasChave.length - 2} mais...</div>` : ''}
            </div>
        </div>
    `).join('');

    container.innerHTML = htmlCards;

    if (btnVerTodas) {
        btnVerTodas.style.display = pcs.length > 3 ? 'inline-block' : 'none';
        btnVerTodas.textContent = `Ver todas (${pcs.length})`;
    }
   }


// Atualiza o margin do conteúdo principal ao expandir/encolher
const mainContent = document.querySelector('.main-content');
if (!mainContent.classList.contains('expanded')) {
    mainContent.style.marginLeft = '70px';
}


// ✅ CORREÇÃO: Toggle de expansão do menu (móvel e desktop) — posicionado corretamente
document.addEventListener('DOMContentLoaded', function() {
    const expandBtn = document.getElementById('sidebarExpandBtn');
    if (expandBtn) {
        expandBtn.addEventListener('click', function() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            sidebar.classList.toggle('expanded');
            if (sidebar.classList.contains('expanded')) {
                mainContent.classList.add('expanded');
                this.title = 'Encolher menu';
                this.classList.remove('fa-chevron-right');
                this.classList.add('fa-chevron-left');
            } else {
                mainContent.classList.remove('expanded');
                this.title = 'Expandir menu';
                this.classList.remove('fa-chevron-left');
                this.classList.add('fa-chevron-right');
            }
        });
    }

    // Garantir margem inicial correta
    const mainContent = document.querySelector('.main-content');
    if (mainContent && !mainContent.classList.contains('expanded')) {
        mainContent.style.marginLeft = '70px';
    }
});
 // 📄 Função para gerar relatório de Horas Extras em PDF
async function gerarRelatorioHorasExtrasPDF() {
    // 🔹 1. Pegar datas do formulário
    const dataInicioStr = document.getElementById('relatorioDataInicio').value;
    const dataFimStr = document.getElementById('relatorioDataFim').value;

    if (!dataInicioStr || !dataFimStr) {
        alert('⚠️ Preencha as datas de início e fim.');
        return;
    }

    const dataInicio = new Date(dataInicioStr);
    const dataFim = new Date(dataFimStr);
    dataFim.setHours(23, 59, 59, 999); // Inclui todo o dia final

    if (dataInicio > dataFim) {
        alert('⚠️ A data inicial não pode ser maior que a final.');
        return;
    }

    // 🔹 2. Filtrar horas extras no período
    const horasFiltradas = horasExtras.filter(h => {
        const dataH = new Date(h.data);
        return h.condominioId === currentCondominio.id && dataH >= dataInicio && dataH <= dataFim;
    });

    if (horasFiltradas.length === 0) {
        alert('🔍 Nenhuma hora extra encontrada no período selecionado.');
        return;
    }

    // 🔹 3. Calcular total
    const totalHoras = horasFiltradas.reduce((sum, h) => sum + (h.quantidade || 0), 0);

    // 🔹 4. Preparar dados para o PDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // ✅ Estilos e cores
    const primary = '#2c3e50';
    const secondary = '#3498db';
    const accent = '#e74c3c';
    const light = '#ecf0f1';

    // 🔹 Cabeçalho
    doc.setFillColor(primary);
    doc.rect(0, 0, 210, 40, 'F'); // Fundo escuro no topo (210mm = largura A4)
    doc.setTextColor('#ffffff');
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text('Relatório de Horas Extras', 15, 20);

    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.text(`Condomínio: ${currentCondominio.nome}`, 15, 28);
    doc.text(`Período: ${formatDate(dataInicioStr)} a ${formatDate(dataFimStr)}`, 15, 34);

    doc.setTextColor(accent);
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text(`Total de Horas: ${totalHoras.toFixed(2)} h`, 150, 20);

    // 🔹 Linha divisória
    doc.setDrawColor(secondary);
    doc.setLineWidth(0.5);
    doc.line(10, 42, 200, 42);

    // 🔹 Tabela
    doc.setTextColor('#333');
    doc.setFontSize(10);
    let y = 50;

    // Cabeçalhos da tabela
    const headers = ['Funcionário', 'Data', 'Regime', 'Horário', 'Horas'];
    const colWidths = [50, 25, 25, 35, 20];
    const startX = 10;

    doc.setFillColor('#f0f3f5');
    doc.rect(startX, y - 5, 190, 8, 'F'); // Fundo cinza claro
    doc.setTextColor('#2c3e50');
    doc.setFont('helvetica', 'bold');
    let cursorX = startX;
    headers.forEach((header, i) => {
        doc.text(header, cursorX + 2, y);
        cursorX += colWidths[i];
    });
    y += 8;

    // Linhas de dados
    doc.setFont('helvetica', 'normal');
    for (let i = 0; i < horasFiltradas.length; i++) {
        const h = horasFiltradas[i];
        const bgColor = i % 2 === 0 ? '#ffffff' : '#fafafa';
        doc.setFillColor(bgColor);
        doc.rect(startX, y - 4, 190, 7, 'F');

        doc.text(h.funcionario || '—', startX + 2, y);
        doc.text(formatDate(h.data), startX + 52, y);
        doc.text(h.regime === '12-36' ? '12/36' : h.regime === '8h' ? '8h' : 'Outro', startX + 77, y);
        doc.text(`${h.entradaReal || ''} - ${h.saidaReal || ''}`, startX + 102, y);
        doc.text(`${(h.quantidade || 0).toFixed(2)}h`, startX + 137, y);

        y += 7;

        // Quebra de página se necessário
        if (y > 280) {
            doc.addPage();
            y = 20;
        }
    }

    // 🔹 Rodapé
    doc.setFontSize(9);
    doc.setTextColor('#7f8c8d');
    const dataAtual = new Date().toLocaleDateString('pt-BR');
    const usuario = currentUser.nome || currentUser.usuario;
    doc.text(`Relatório gerado por ${usuario} em ${dataAtual}`, 15, 290);

    // 🔹 Adicionar logotipo/texto discreto (opcional)
    doc.setFontSize(8);
    doc.text('Sistema Multi Condomínios — Relatório Confidencial', 150, 290);

    // 🔹 Salvar PDF
    const nomeArquivo = `HorasExtras_${currentCondominio.nome.replace(/\s+/g, '_')}_${dataInicioStr}_a_${dataFimStr}.pdf`;
    doc.save(nomeArquivo);

    alert(`✅ Relatório gerado com sucesso!\nTotal: ${horasFiltradas.length} registros\nHoras: ${totalHoras.toFixed(2)} h`);
} 
// ✅ Abre o modal detalhado com os dados da ocorrência
function openOcorrenciaDetailModal(id, data) {
    document.getElementById('ocorrenciaDetailId').value = id;
    
    // ✅ Preserva a data/hora original como timestamp (Firestore Timestamp)
    document.getElementById('ocorrenciaDetailDataOriginal').value = JSON.stringify({
        seconds: data.dataHora?.seconds || data.dataHora?._seconds,
        nanoseconds: data.dataHora?.nanoseconds || 0
    });

    // Formata data para exibição legível (não editável)
    const dataOriginal = data.dataHora?.toDate 
        ? data.dataHora.toDate() 
        : data.dataHora?._seconds 
            ? new Date(data.dataHora._seconds * 1000)
            : new Date(data.dataHora || Date.now());
    
    document.getElementById('ocorrenciaDetailDataHora').value = dataOriginal.toLocaleString('pt-BR');

    // Preenche campos
    document.getElementById('ocorrenciaDetailMorador').value = data.morador || '';
    document.getElementById('ocorrenciaDetailApto').value = data.apto || '';
    document.getElementById('ocorrenciaDetailDescricao').value = data.descricao || '';
    document.getElementById('ocorrenciaDetailStatus').value = data.status || 'aberta';
    document.getElementById('ocorrenciaDetailObservacoes').value = data.observacoes || '';

    // Carrega histórico (se houver)
    loadOcorrenciaHistorico(id);

    // Mostra modal
    document.getElementById('ocorrenciaDetailModal').style.display = 'flex';
}

// ✅ Fecha o modal detalhado
function closeOcorrenciaDetailModal() {
    document.getElementById('ocorrenciaDetailModal').style.display = 'none';
}

// ✅ Salva edição SEM alterar data original
async function saveOcorrenciaDetail() {
    const id = document.getElementById('ocorrenciaDetailId').value;
    if (!id) return alert('ID da ocorrência não encontrado.');

    const dataOriginalStr = document.getElementById('ocorrenciaDetailDataOriginal').value;
    let dataOriginal = null;
    try {
        const parsed = JSON.parse(dataOriginalStr);
        dataOriginal = new Date(parsed.seconds * 1000);
    } catch (e) {
        console.warn('⚠️ Data original inválida — usando agora');
        dataOriginal = new Date();
    }

    const docData = {
        morador: document.getElementById('ocorrenciaDetailMorador').value.trim(),
        apto: document.getElementById('ocorrenciaDetailApto').value.trim(),
        descricao: document.getElementById('ocorrenciaDetailDescricao').value.trim(),
        status: document.getElementById('ocorrenciaDetailStatus').value,
        observacoes: document.getElementById('ocorrenciaDetailObservacoes').value.trim(),
        // ✅ dataHora ORIGINAL PRESERVADA
        dataHora: firebase.firestore.Timestamp.fromDate(dataOriginal),
        // ✅ dataEdicao registrada apenas se mudou algo
        editadoEm: firebase.firestore.Timestamp.now(),
        editadoPor: currentUser.id,
        editadoPorNome: currentUser.nome || currentUser.usuario
    };

    try {
        await db.collection('ocorrencias').doc(id).update(docData);
        alert('✅ Ocorrência atualizada com sucesso!');
        closeOcorrenciaDetailModal();
        loadOcorrenciasContent(); // recarrega tabela
    } catch (err) {
        console.error('Erro ao salvar ocorrência:', err);
        alert('❌ Erro ao salvar. Verifique sua conexão.');
    }
}

// ✅ Carrega histórico (melhorar depois com subcoleção, mas já mostra edição)
async function loadOcorrenciaHistorico(id) {
    const historicoDiv = document.getElementById('ocorrenciaDetailHistorico');
    try {
        const doc = await db.collection('ocorrencias').doc(id).get();
        if (!doc.exists) {
            historicoDiv.innerHTML = '<p class="text-muted">Registro não encontrado.</p>';
            return;
        }
        const data = doc.data();
        let html = '';

        // Registro original
        const dataAbertura = data.dataHora?.toDate 
            ? data.dataHora.toDate().toLocaleString('pt-BR')
            : 'Data inválida';
        
        html += `
            <div class="alert alert-info">
                <strong>✅ Aberta em:</strong> ${dataAbertura}<br>
                <strong>Morador:</strong> ${data.morador || '—'} — Apto ${data.apto || '—'}<br>
                <strong>Descrição:</strong> ${data.descricao || '—'}
            </div>
        `;

        // Se foi editada
        if (data.editadoEm) {
            const dataEdicao = data.editadoEm?.toDate 
                ? data.editadoEm.toDate().toLocaleString('pt-BR')
                : 'Data inválida';
            html += `
                <div class="alert alert-warning">
                    <strong>✏️ Editada em:</strong> ${dataEdicao}<br>
                    <strong>Por:</strong> ${data.editadoPorNome || '—'}<br>
                    <strong>Status atual:</strong> 
                    <span class="badge badge-${data.status === 'resolvida' ? 'success' : data.status === 'andamento' ? 'warning' : data.status === 'cancelada' ? 'danger' : 'info'}">
                        ${formatStatusOcorrencia(data.status)}
                    </span>
                </div>
            `;
        }

        historicoDiv.innerHTML = html || '<p class="text-muted">Sem histórico disponível.</p>';
    } catch (err) {
        console.error('Erro ao carregar histórico:', err);
        historicoDiv.innerHTML = '<p class="text-danger">❌ Erro ao carregar histórico.</p>';
    }
}

// ✅ Função auxiliar para formatar status
function formatStatusOcorrencia(status) {
    const map = {
        'aberta': 'Aberta',
        'andamento': 'Em andamento',
        'resolvida': 'Resolvida',
        'cancelada': 'Cancelada'
    };
    return map[status] || status;
}
 // 📄 Exportar lista de agendamentos concluídos para PDF
function exportarAgendamentosConcluidosPDF() {
    // 🔹 1. Filtrar dados (como antes)
    const dataLimite = new Date();
    dataLimite.setMonth(dataLimite.getMonth() - 18);

    let registros = agendamentos.filter(a =>
        a.condominioId === currentCondominio.id &&
        (a.status === 'liberado' || a.status === 'concluido' || a.status === 'cancelado') &&
        new Date(a.data) >= dataLimite
    );

    const espaco = document.getElementById('filtroConcluidosEspaco')?.value || '';
    const dataIni = document.getElementById('filtroConcluidosDataIni')?.value || '';
    const dataFim = document.getElementById('filtroConcluidosDataFim')?.value || '';
    const nomeFiltro = (document.getElementById('filtroConcluidosNome')?.value || '').toLowerCase();
    const aptoFiltro = (document.getElementById('filtroConcluidosApto')?.value || '').toLowerCase();

    if (espaco) registros = registros.filter(a => a.espaco === espaco);
    if (dataIni) registros = registros.filter(a => a.data >= dataIni);
    if (dataFim) registros = registros.filter(a => a.data <= dataFim);
    if (nomeFiltro) registros = registros.filter(a => a.responsavel.toLowerCase().includes(nomeFiltro));
    if (aptoFiltro) registros = registros.filter(a => a.unidade.toLowerCase().includes(aptoFiltro));

    if (registros.length === 0) {
        alert('⚠️ Nenhum agendamento para exportar.');
        return;
    }

    registros.sort((a, b) => new Date(b.data) - new Date(a.data));

    // 🔹 2. Criar HTML do relatório (estilizado, sem erros)
    const hoje = new Date().toLocaleDateString('pt-BR');
    const usuario = currentUser?.nome || currentUser?.usuario || 'Usuário';
    const condominio = currentCondominio?.nome || 'Condomínio';

    let html = `
    <div id="printArea">
        <style>
            @media print {
                @page { size: A4; margin: 10mm; }
                body { -webkit-print-color-adjust: exact; }
            }
            body { font-family: 'Segoe UI', Arial, sans-serif; }
            .header {
                text-align: center;
                border-bottom: 3px solid #2c3e50;
                padding-bottom: 15px;
                margin-bottom: 20px;
            }
            .title {
                font-size: 22px;
                font-weight: bold;
                color: #2c3e50;
                margin: 0;
            }
            .subtitle {
                font-size: 14px;
                color: #666;
                margin: 5px 0;
            }
            .highlight {
                background-color: #FFF9E6;
                padding: 2px 6px;
                border-radius: 4px;
                font-weight: bold;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
            }
            th {
                background-color: #2c3e50;
                color: white;
                padding: 10px;
                text-align: left;
                font-weight: bold;
            }
            td {
                padding: 8px 10px;
                border-bottom: 1px solid #eee;
            }
            tr:nth-child(even) { background-color: #f9f9f9; }
            .status-liberado { color: #27ae60; font-weight: bold; }
            .status-cancelado { color: #e74c3c; font-weight: bold; }
            .status-concluido { color: #2980b9; font-weight: bold; }
            .footer {
                margin-top: 30px;
                padding-top: 15px;
                border-top: 1px solid #ccc;
                font-size: 12px;
                color: #777;
                text-align: right;
            }
        </style>

        <div class="header">
            <h1 class="title">Relatório de Agendamentos Concluídos</h1>
            <p class="subtitle">Condomínio: <strong>${condominio}</strong></p>
            <p class="subtitle">Filtrado em: <span class="highlight">${hoje}</span> — Usuário: <strong>${usuario}</strong></p>
            <p class="subtitle">Período: Últimos 18 meses (${registros.length} registros)</p>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Espaço</th>
                    <th>Solicitante</th>
                    <th>Data</th>
                    <th>Horário</th>
                    <th>Apto</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                ${registros.map(a => `
                <tr>
                    <td>${getEspacoNome(a.espaco)}</td>
                    <td>${a.responsavel}</td>
                    <td>${formatDate(a.data)}</td>
                    <td>${a.horaInicio} – ${a.horaFim}</td>
                    <td>${a.unidade}</td>
                    <td><span class="status-${a.status}">${formatStatusAgendamento(a.status)}</span></td>
                </tr>
                `).join('')}
            </tbody>
        </table>

        <div class="footer">
            Sistema Multi Condomínios — Relatório gerado em ${hoje}
        </div>
    </div>
    `;

    // 🔹 3. Inserir HTML temporário e imprimir
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    printWindow.document.write(html);
    printWindow.document.close();

    // Aguarda carregar e imprime
    printWindow.onload = function() {
        printWindow.focus();
        printWindow.print();
        // Opcional: fecha janela após 2s (ou deixa aberta)
        setTimeout(() => printWindow.close(), 2000);
    };
}
// ✅ Abre o modal com os detalhes completos do agendamento
function verDetalhesAgendamento(id) {
    const agendamento = agendamentos.find(a => a.id === id);
    if (!agendamento) {
        alert('Agendamento não encontrado.');
        return;
    }

    // Preenche os campos
    document.getElementById('detalheEspaco').textContent = getEspacoNome(agendamento.espaco);
    document.getElementById('detalheResponsavel').textContent = agendamento.responsavel || '—';
    document.getElementById('detalheUnidade').textContent = agendamento.unidade || '—';
    document.getElementById('detalheData').textContent = formatDate(agendamento.data);
    document.getElementById('detalheHorario').textContent = `${agendamento.horaInicio} – ${agendamento.horaFim}`;
    
    const statusEl = document.getElementById('detalheStatus');
    statusEl.textContent = formatStatusAgendamento(agendamento.status);
    statusEl.className = `status-badge status-${agendamento.status}`;
    
    document.getElementById('detalheObservacoes').textContent = agendamento.observacoes || 'Nenhuma observação.';
    
    // Busca nome do criador
    let criador = 'Sistema';
    if (agendamento.criadoPor) {
        const usuario = usuarios.find(u => u.id === agendamento.criadoPor);
        criador = usuario ? (usuario.nome || usuario.usuario) : agendamento.criadoPor;
    }
    document.getElementById('detalheCriadoPor').textContent = criador;

    // Formata data de criação
    let dataCriacao = '—';
    if (agendamento.criadoEm) {
        const d = new Date(agendamento.criadoEm);
        dataCriacao = d.toLocaleString('pt-BR');
    }
    document.getElementById('detalheCriadoEm').textContent = dataCriacao;

    // Abre o modal
    document.getElementById('detalhesAgendamentoModal').style.display = 'flex';
}

// ✅ Fecha o modal de detalhes
function closeDetalhesAgendamentoModal() {
    document.getElementById('detalhesAgendamentoModal').style.display = 'none';
}
// ========== MÓDULO TAREFAS ==========
let tarefas = [];

// Carrega tarefas do condomínio atual
async function loadTarefas() {
    if (!currentCondominio) {
        tarefas = [];
        return;
    }
    try {
        const snapshot = await db.collection('tarefas')
            .where('condominioId', '==', currentCondominio.id)
            .get();
        tarefas = [];
        snapshot.forEach(doc => tarefas.push({ id: doc.id, ...doc.data() }));
    } catch (err) {
        console.error('Erro ao carregar tarefas:', err);
        alert('Erro ao carregar tarefas.');
    }
}

// Abre o modal para nova tarefa
function openTarefaModal() {
    document.getElementById('tarefaModalTitle').textContent = 'Nova Tarefa';
    document.getElementById('editingTarefaId').value = '';
    document.getElementById('tarefaForm').reset();
    document.getElementById('tarefaDataUnica').value = getCurrentDate();
    document.getElementById('diasSemanaContainer').style.display = 'none';
    document.getElementById('tarefaModal').style.display = 'flex';
}

// Fecha o modal
function closeTarefaModal() {
    document.getElementById('tarefaModal').style.display = 'none';
}

// Alterna exibição dos dias da semana conforme tipo
function toggleDiasSemana() {
    const tipo = document.getElementById('tarefaTipo').value;
    const container = document.getElementById('diasSemanaContainer');
    const dataInput = document.getElementById('tarefaDataUnica');
    if (tipo === 'recorrente') {
        container.style.display = 'block';
        dataInput.required = false;
    } else {
        container.style.display = 'none';
        dataInput.required = true;
    }
}

// Salva ou edita tarefa
document.getElementById('tarefaForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    if (!currentCondominio) return alert('Selecione um condomínio primeiro!');
    
    const editingId = document.getElementById('editingTarefaId').value;
    const titulo = document.getElementById('tarefaTitulo').value.trim();
    const descricao = document.getElementById('tarefaDescricao').value.trim();
    const tipo = document.getElementById('tarefaTipo').value;
    
    let dataUnica = null;
    let diasSemana = [];
    
    if (tipo === 'unica') {
        dataUnica = document.getElementById('tarefaDataUnica').value;
        if (!dataUnica) return alert('Informe a data.');
    } else {
        diasSemana = Array.from(document.querySelectorAll('input[name="diaSemana"]:checked'))
            .map(cb => cb.value);
        if (diasSemana.length === 0) return alert('Selecione pelo menos um dia da semana.');
    }

    const tarefaData = {
        titulo,
        descricao,
        tipo,
        dataUnica,
        diasSemana,
        condominioId: currentCondominio.id,
        condominioNome: currentCondominio.nome,
        criadoPor: currentUser.id || currentUser.usuario,
        criadoEm: new Date().toISOString(),
        historicoConclusao: []
    };

    try {
        if (editingId) {
            await db.collection('tarefas').doc(editingId).update(tarefaData);
        } else {
            await db.collection('tarefas').add(tarefaData);
        }
        await loadTarefas();
        closeTarefaModal();
        if (currentModule === 'tarefas') loadTarefasContent();
        if (currentModule === 'dashboard') loadDashboardContent();
        alert(editingId ? 'Tarefa atualizada!' : 'Tarefa criada com sucesso!');
    } catch (err) {
        console.error('Erro ao salvar tarefa:', err);
        alert('Erro ao salvar tarefa. Tente novamente.');
    }
});

// Edita tarefa
function editTarefa(id) {
    const tarefa = tarefas.find(t => t.id === id);
    if (!tarefa) return;
    
    openTarefaModal();
    setTimeout(() => {
        document.getElementById('tarefaModalTitle').textContent = 'Editar Tarefa';
        document.getElementById('editingTarefaId').value = tarefa.id;
        document.getElementById('tarefaTitulo').value = tarefa.titulo;
        document.getElementById('tarefaDescricao').value = tarefa.descricao || '';
        document.getElementById('tarefaTipo').value = tarefa.tipo;
        toggleDiasSemana();
        
        if (tarefa.tipo === 'unica') {
            document.getElementById('tarefaDataUnica').value = tarefa.dataUnica;
        } else if (tarefa.tipo === 'recorrente') {
            tarefa.diasSemana.forEach(dia => {
                const cb = document.querySelector(`input[name="diaSemana"][value="${dia}"]`);
                if (cb) cb.checked = true;
            });
        }
    }, 100);
}

// Exclui tarefa
async function deleteTarefa(id) {
    if (!podeExcluirRegistros()) {
        return alert('Somente síndico ou subsíndico podem excluir.');
    }
    if (!confirm('Excluir esta tarefa permanentemente?')) return;
    
    try {
        await db.collection('tarefas').doc(id).delete();
        await loadTarefas();
        if (currentModule === 'tarefas') loadTarefasContent();
        if (currentModule === 'dashboard') loadDashboardContent();
        alert('Tarefa excluída.');
    } catch (err) {
        console.error('Erro ao excluir tarefa:', err);
        alert('Erro ao excluir.');
    }
}

// Marca como concluída HOJE
async function concluirTarefa(id) {
    const tarefa = tarefas.find(t => t.id === id);
    if (!tarefa) return alert('Tarefa não encontrada.');
    
    const agora = new Date();
    const itemConclusao = {
        concluidoPor: currentUser.id,
        concluidoPorNome: currentUser.nome || currentUser.usuario,
        dataConclusao: agora.toISOString(),
        dataReal: agora.toISOString().split('T')[0]  // apenas YYYY-MM-DD
    };
    
    try {
        const ref = db.collection('tarefas').doc(id);
        // Adiciona ao histórico de conclusões
        await ref.update({
            historicoConclusao: firebase.firestore.FieldValue.arrayUnion(itemConclusao)
        });
        await loadTarefas();
        if (currentModule === 'tarefas') loadTarefasContent();
        if (currentModule === 'dashboard') loadDashboardContent();
        alert('✅ Tarefa marcada como concluída!');
    } catch (err) {
        console.error('Erro ao concluir tarefa:', err);
        alert('Erro ao concluir. Tente novamente.');
    }
}

// Verifica se tarefa deve aparecer HOJE
function tarefaEhHoje(tarefa) {
    const hoje = new Date().toISOString().split('T')[0]; // ex: "2025-12-18"
    const hojeSemana = new Date().getDay(); // 0 = dom, 1 = seg ... 6 = sab
    const diasMap = { dom:0, seg:1, ter:2, qua:3, qui:4, sex:5, sab:6 };
    
    if (tarefa.tipo === 'unica') {
        return tarefa.dataUnica === hoje;
    } else if (tarefa.tipo === 'recorrente') {
        return tarefa.diasSemana.some(dia => diasMap[dia] === hojeSemana);
    }
    return false;
}

// Verifica se já foi concluída HOJE
function jaConcluiuHoje(tarefa) {
    if (!tarefa.historicoConclusao || !Array.isArray(tarefa.historicoConclusao)) return false;
    const hoje = new Date().toISOString().split('T')[0];
    return tarefa.historicoConclusao.some(item => 
        item.dataReal === hoje
    );
}

// Carrega conteúdo do módulo "Tarefas"
function loadTarefasContent() {
    const moduleContent = document.getElementById('moduleContent');
    if (!currentCondominio) {
        moduleContent.innerHTML = `<div class="alert alert-warning">Selecione um condomínio primeiro.</div>`;
        return;
    }
    
    // Filtra tarefas do condomínio
    const minhasTarefas = tarefas.filter(t => t.condominioId === currentCondominio.id);
    
    moduleContent.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h3>Tarefas - ${currentCondominio.nome}</h3>
                <button class="btn btn-primary" onclick="openTarefaModal()">
                    <i class="fas fa-plus"></i> Nova Tarefa
                </button>
            </div>
            <div class="card-body">
                ${minhasTarefas.length > 0 ? `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Título</th>
                            <th>Tipo</th>
                            <th>Dias/Data</th>
                            <th>Concluída Hoje?</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${minhasTarefas.map(t => `
                            <tr style="${jaConcluiuHoje(t) ? 'background-color: #ebf5fb;' : ''}">
                                <td><strong>${t.titulo}</strong><br><small>${t.descricao || ''}</small></td>
                                <td>${t.tipo === 'unica' ? 'Única' : 'Recorrente'}</td>
                                <td>
                                    ${t.tipo === 'unica' 
                                        ? formatDate(t.dataUnica) 
                                        : t.diasSemana.map(d => d.substring(0,3)).join(', ')}
                                </td>
                                <td>
                                    ${jaConcluiuHoje(t) 
                                        ? `<span class="badge badge-success">✅ Sim</span>` 
                                        : `<span class="badge badge-warning">❌ Não</span>`}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="editTarefa('${t.id}')"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-success" 
                                            onclick="concluirTarefa('${t.id}')" 
                                            ${jaConcluiuHoje(t) ? 'disabled' : ''}>
                                        ✅ Concluir
                                    </button>
                                    ${podeExcluirRegistros() ? `
                                    <button class="btn btn-sm btn-danger" onclick="deleteTarefa('${t.id}')"><i class="fas fa-trash"></i></button>` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ` : `
                <div class="alert alert-info">
                    <h5>Nenhuma tarefa cadastrada</h5>
                    <p>Clique no botão abaixo para criar sua primeira tarefa.</p>
                    <button class="btn btn-primary" onclick="openTarefaModal()">
                        <i class="fas fa-plus"></i> Nova Tarefa
                    </button>
                </div>
                `}
            </div>
        </div>
    `;
}

// Atualiza Dashboard com tarefas do dia
function atualizarTarefasDashboard() {
    // Verifica se já existe seção de tarefas (evita duplicar)
    let container = document.getElementById('dashboardTarefasContainer');
    if (!container) {
        // Cria container só uma vez
        const dashboardBody = document.querySelector('#moduleContent .card-body');
        if (!dashboardBody) return;
        
        container = document.createElement('div');
        container.id = 'dashboardTarefasContainer';
        container.innerHTML = `
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3><i class="fas fa-tasks"></i> Tarefas de Hoje</h3>
                    <button class="btn btn-primary btn-sm" onclick="openTarefaModal()">
                        <i class="fas fa-plus"></i> Nova
                    </button>
                </div>
                <div class="card-body">
                    <div id="dashboardTarefasLista"></div>
                </div>
            </div>
        `;
        dashboardBody.appendChild(container);
    }
    
    // Filtra tarefas de hoje
    const tarefasHoje = tarefas
        .filter(t => t.condominioId === (currentCondominio?.id || ''))
        .filter(tarefaEhHoje);
    
    const lista = document.getElementById('dashboardTarefasLista');
    if (tarefasHoje.length === 0) {
        lista.innerHTML = `<div class="alert alert-info"><i class="fas fa-check-circle"></i> Nenhuma tarefa pendente para hoje.</div>`;
        return;
    }
    
    // Gera cards modernos
    lista.innerHTML = tarefasHoje.map(t => `
        <div class="stat-card-modern" style="background: linear-gradient(135deg, #5dade2 0%, #3498db 100%); margin-bottom: 15px;">
            <div class="stat-card-header">
                <h3>${t.titulo}</h3>
            </div>
            <div class="stat-card-content">
                <p style="font-size: 0.9em; opacity: 0.9;">${t.descricao || ''}</p>
                <div style="margin-top: 10px;">
                    ${jaConcluiuHoje(t) 
                        ? `<span class="badge badge-success" style="font-size: 0.9em;">✅ Concluída hoje</span>`
                        : `<button class="btn btn-success btn-sm" 
                                   onclick="concluirTarefa('${t.id}')">
                             ✅ Marcar como concluída
                           </button>`
                    }
                    <button class="btn btn-info btn-sm" style="margin-left: 5px;" onclick="editTarefa('${t.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    ${podeExcluirRegistros() ? `
                    <button class="btn btn-danger btn-sm" style="margin-left: 5px;" onclick="deleteTarefa('${t.id}')">
                        <i class="fas fa-trash"></i>
                    </button>` : ''}
                </div>
            </div>
        </div>
    `).join('');
} 
</script>
</body>
</html>
